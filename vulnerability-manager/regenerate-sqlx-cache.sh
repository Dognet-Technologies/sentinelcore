#!/bin/bash
# Script per rigenerare la cache SQLx dopo modifiche ai query
# Richiede PostgreSQL in esecuzione

set -e

echo "ğŸ”„ Regenerating SQLx query cache..."
echo ""

# Check if DATABASE_URL is set
if [ -z "$DATABASE_URL" ]; then
    echo "âš ï¸  DATABASE_URL not set, using default..."
    export DATABASE_URL="postgresql://vlnman:DogNET@localhost:5432/vulnerability_manager"
    echo "   Using: $DATABASE_URL"
    echo ""
fi

# Check if PostgreSQL is running
echo "ğŸ” Checking PostgreSQL connection..."
if ! psql "$DATABASE_URL" -c "SELECT 1" > /dev/null 2>&1; then
    echo ""
    echo "âŒ Cannot connect to PostgreSQL!"
    echo ""
    echo "Please ensure PostgreSQL is running and accessible:"
    echo "   1. Start PostgreSQL: sudo systemctl start postgresql"
    echo "   2. Create database: psql -U postgres -c \"CREATE DATABASE vulnerability_manager;\""
    echo "   3. Create user: psql -U postgres -c \"CREATE USER vlnman WITH PASSWORD 'changeme';\""
    echo "   4. Grant privileges: psql -U postgres -c \"GRANT ALL PRIVILEGES ON DATABASE vulnerability_manager TO vlnman;\""
    echo ""
    echo "Or set DATABASE_URL environment variable to your connection string."
    exit 1
fi

echo "âœ… PostgreSQL connection successful"
echo ""

# Run migrations
echo "ğŸ“Š Running database migrations..."
if ! cargo install sqlx-cli --no-default-features --features postgres 2>/dev/null; then
    echo "âš ï¸  sqlx-cli already installed or installation failed, continuing..."
fi

sqlx database create 2>/dev/null || echo "Database already exists"
sqlx migrate run

echo ""
echo "âœ… Migrations complete"
echo ""

# Prepare queries (generate cache)
echo "ğŸ”§ Generating query cache..."
cargo sqlx prepare -- --lib

echo ""
echo "âœ… SQLx cache regenerated successfully!"
echo ""
echo "ğŸ“ Cache files saved in: .sqlx/"
echo "ğŸ’¡ Now you can run: ../build-deb.sh"
echo ""
echo "Don't forget to commit the updated .sqlx/ directory:"
echo "   git add .sqlx/"
echo "   git commit -m \"chore: Update SQLx query cache\""
echo ""
