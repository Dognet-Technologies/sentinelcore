-- Migration 100: Fix extract_mentions function
-- Fixes the REPLACE function error on text array

CREATE OR REPLACE FUNCTION extract_mentions(comment_text TEXT)
RETURNS JSON AS $$
DECLARE
    mention_pattern TEXT := '@\w+';
    mentioned_users JSON;
BEGIN
    SELECT json_agg(DISTINCT u.id)
    INTO mentioned_users
    FROM regexp_matches(comment_text, mention_pattern, 'g') AS m(username),
         users u
    WHERE LOWER(u.username) = LOWER(REPLACE(m.username[1], '@', ''));

    RETURN COALESCE(mentioned_users, '[]'::JSON);
END;
$$ LANGUAGE plpgsql;
