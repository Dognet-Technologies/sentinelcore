-- Migration: Populate Compliance Framework Definitions
-- Completes framework definitions with actual controls and mappings

-- PCI-DSS 4.0 controls
UPDATE compliance_frameworks SET controls = jsonb_build_array(
  jsonb_build_object(
    'id', '1.1', 'name', 'Firewall configuration standards', 
    'description', 'Establish and implement firewall and router configuration standards',
    'category', 'Network', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-200']
  ),
  jsonb_build_object(
    'id', '2.1', 'name', 'Default security parameters',
    'description', 'Remove or rename all default access routes and methods',
    'category', 'Installation', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-798']
  ),
  jsonb_build_object(
    'id', '2.2.1', 'name', 'Security configuration documentation',
    'description', 'Ensure security configuration standards are documented',
    'category', 'Configuration', 'severity', 'high', 'cwe_ids', ARRAY['CWE-16']
  ),
  jsonb_build_object(
    'id', '2.3', 'name', 'Security hardening standards',
    'description', 'Prepare an inventory of system components',
    'category', 'Hardening', 'severity', 'high', 'cwe_ids', ARRAY['CWE-16']
  ),
  jsonb_build_object(
    'id', '6.1', 'name', 'Vulnerability scanning',
    'description', 'Confirm that all system components are protected from known vulnerabilities',
    'category', 'Vulnerability', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-1035']
  ),
  jsonb_build_object(
    'id', '6.2', 'name', 'Security patches and updates',
    'description', 'Ensure that all security patches for system components are installed within one month',
    'category', 'Patching', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-1035']
  ),
  jsonb_build_object(
    'id', '6.3.1', 'name', 'Code review processes',
    'description', 'Code review processes must be defined, documented, and implemented',
    'category', 'Development', 'severity', 'high', 'cwe_ids', ARRAY['CWE-1104']
  ),
  jsonb_build_object(
    'id', '8.2', 'name', 'User authentication',
    'description', 'Ensure user identity is authenticated using strong authentication methods',
    'category', 'Authentication', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-287']
  ),
  jsonb_build_object(
    'id', '8.3', 'name', 'Multi-factor authentication',
    'description', 'Use multi-factor authentication for all access to production',
    'category', 'Authentication', 'severity', 'high', 'cwe_ids', ARRAY['CWE-287']
  ),
  jsonb_build_object(
    'id', '10.2', 'name', 'Access logging and monitoring',
    'description', 'Automated audit trails must be implemented for all access',
    'category', 'Logging', 'severity', 'high', 'cwe_ids', ARRAY['CWE-778']
  )
) WHERE name = 'PCI-DSS';

-- ISO 27001 A.12.6 controls (Cryptography and management)
UPDATE compliance_frameworks SET controls = jsonb_build_array(
  jsonb_build_object(
    'id', 'A.5.1.1', 'name', 'Policies for information security',
    'description', 'Information security policies shall be documented, approved and communicated',
    'category', 'Policy', 'severity', 'medium', 'cwe_ids', ARRAY['CWE-16']
  ),
  jsonb_build_object(
    'id', 'A.6.1.1', 'name', 'Information security responsibilities',
    'description', 'All information security responsibilities shall be clearly defined',
    'category', 'Organization', 'severity', 'medium', 'cwe_ids', ARRAY[]::text[]
  ),
  jsonb_build_object(
    'id', 'A.7.1.1', 'name', 'Access control policy',
    'description', 'Access control shall be based on the business requirement of least privilege',
    'category', 'Access Control', 'severity', 'high', 'cwe_ids', ARRAY['CWE-269']
  ),
  jsonb_build_object(
    'id', 'A.8.1.1', 'name', 'Asset inventory',
    'description', 'Assets shall be identified and an inventory of all important assets maintained',
    'category', 'Asset Management', 'severity', 'high', 'cwe_ids', ARRAY[]::text[]
  ),
  jsonb_build_object(
    'id', 'A.9.2.1', 'name', 'User registration and access rights',
    'description', 'Granting and revoking access to information and systems shall be documented',
    'category', 'Access Control', 'severity', 'high', 'cwe_ids', ARRAY['CWE-269']
  ),
  jsonb_build_object(
    'id', 'A.10.1.1', 'name', 'Cryptography policy',
    'description', 'Cryptography shall be used to protect the confidentiality and integrity of information',
    'category', 'Cryptography', 'severity', 'high', 'cwe_ids', ARRAY['CWE-327']
  ),
  jsonb_build_object(
    'id', 'A.12.6.1', 'name', 'Management of technical vulnerabilities',
    'description', 'Timely information on technical vulnerabilities must be obtained and assessed',
    'category', 'Vulnerability', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-1035']
  ),
  jsonb_build_object(
    'id', 'A.12.6.2', 'name', 'Restrictions on software installation',
    'description', 'Procedures shall govern the installation of software on systems',
    'category', 'Change Management', 'severity', 'high', 'cwe_ids', ARRAY['CWE-94']
  ),
  jsonb_build_object(
    'id', 'A.13.1.3', 'name', 'Segregation of networks',
    'description', 'Groups of information services, users and information systems shall be segregated',
    'category', 'Network', 'severity', 'high', 'cwe_ids', ARRAY['CWE-200']
  ),
  jsonb_build_object(
    'id', 'A.14.1.1', 'name', 'Information security requirements in supplier relationships',
    'description', 'Security requirements shall be established and agreed in agreements with suppliers',
    'category', 'Supplier Management', 'severity', 'medium', 'cwe_ids', ARRAY[]::text[]
  )
) WHERE name = 'ISO27001';

-- HIPAA Security Rule controls (ยง164.308, ยง164.312, ยง164.313)
UPDATE compliance_frameworks SET controls = jsonb_build_array(
  jsonb_build_object(
    'id', '164.308(a)(1)', 'name', 'Security Management Process',
    'description', 'Implement policies and procedures to manage the selection and development of security measures',
    'category', 'Administrative', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-16']
  ),
  jsonb_build_object(
    'id', '164.308(a)(3)(ii)(B)', 'name', 'Authorization and Supervision',
    'description', 'Implement policies and procedures for granting access to ePHI',
    'category', 'Access Control', 'severity', 'high', 'cwe_ids', ARRAY['CWE-269']
  ),
  jsonb_build_object(
    'id', '164.308(a)(5)(ii)(C)', 'name', 'Risk Analysis',
    'description', 'Conduct periodic vulnerability assessments and risk analysis',
    'category', 'Risk Management', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-1035']
  ),
  jsonb_build_object(
    'id', '164.312(a)(1)', 'name', 'Access Controls',
    'description', 'Implement technical policies and procedures to manage access to information systems',
    'category', 'Technical', 'severity', 'high', 'cwe_ids', ARRAY['CWE-287']
  ),
  jsonb_build_object(
    'id', '164.312(a)(2)(i)', 'name', 'Unique User Identification',
    'description', 'Assign unique identifiers to each user and control user access',
    'category', 'Authentication', 'severity', 'high', 'cwe_ids', ARRAY['CWE-287']
  ),
  jsonb_build_object(
    'id', '164.312(b)', 'name', 'Audit Controls',
    'description', 'Implement hardware, software, and procedural mechanisms to record and examine access',
    'category', 'Logging', 'severity', 'high', 'cwe_ids', ARRAY['CWE-778']
  ),
  jsonb_build_object(
    'id', '164.312(c)(1)', 'name', 'Integrity',
    'description', 'Implement policies and procedures to ensure the integrity of ePHI',
    'category', 'Data Integrity', 'severity', 'high', 'cwe_ids', ARRAY['CWE-345']
  ),
  jsonb_build_object(
    'id', '164.312(e)(1)', 'name', 'Encryption and Decryption',
    'description', 'Encryption and decryption mechanisms shall protect ePHI',
    'category', 'Cryptography', 'severity', 'high', 'cwe_ids', ARRAY['CWE-327']
  ),
  jsonb_build_object(
    'id', '164.308(a)(8)', 'name', 'Evaluation',
    'description', 'Perform a periodic evaluation of information security practices',
    'category', 'Evaluation', 'severity', 'medium', 'cwe_ids', ARRAY[]::text[]
  ),
  jsonb_build_object(
    'id', '164.308(a)(1)(ii)(A)', 'name', 'Sanction Policy',
    'description', 'Ensure policy and procedures for sanctions are enforced',
    'category', 'Administrative', 'severity', 'medium', 'cwe_ids', ARRAY[]::text[]
  )
) WHERE name = 'HIPAA';

-- SOC 2 Type II Trust Service Criteria
UPDATE compliance_frameworks SET controls = jsonb_build_array(
  jsonb_build_object(
    'id', 'CC1.1', 'name', 'Governance Objectives',
    'description', 'Organization has established governance objectives and infrastructure to support',
    'category', 'Governance', 'severity', 'high', 'cwe_ids', ARRAY[]::text[]
  ),
  jsonb_build_object(
    'id', 'CC6.1', 'name', 'Logical and Physical Access Controls',
    'description', 'The entity restricts logical and physical access to information systems and related assets',
    'category', 'Access Control', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-287']
  ),
  jsonb_build_object(
    'id', 'CC6.2', 'name', 'Authentication and Authorization',
    'description', 'Prior to issuing system credentials, identity and the appropriateness of access are verified',
    'category', 'Authentication', 'severity', 'critical', 'cwe_ids', ARRAY['CWE-287']
  ),
  jsonb_build_object(
    'id', 'CC7.2', 'name', 'System Monitoring and Logging',
    'description', 'System monitoring and logging is performed and retained for investigation of anomalies',
    'category', 'Logging', 'severity', 'high', 'cwe_ids', ARRAY['CWE-778']
  ),
  jsonb_build_object(
    'id', 'CC9.1', 'name', 'Logical Security',
    'description', 'The entity restricts access to information system resources',
    'category', 'Access Control', 'severity', 'high', 'cwe_ids', ARRAY['CWE-269']
  ),
  jsonb_build_object(
    'id', 'CC9.2', 'name', 'System Configuration',
    'description', 'Prior to deployment, system components are configured to prevent unauthorized access',
    'category', 'Configuration', 'severity', 'high', 'cwe_ids', ARRAY['CWE-16']
  )
) WHERE name = 'SOC2';

-- Create index on controls for performance
CREATE INDEX IF NOT EXISTS idx_compliance_frameworks_controls ON compliance_frameworks USING GIN (controls);
