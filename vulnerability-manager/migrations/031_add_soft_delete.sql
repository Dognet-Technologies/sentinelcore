-- Add soft delete support to vulnerabilities, teams, and assets tables
-- Migration 031: Add deleted_at columns

-- Add deleted_at to vulnerabilities table
ALTER TABLE vulnerabilities
ADD COLUMN deleted_at TIMESTAMPTZ DEFAULT NULL;

-- Add deleted_at to teams table
ALTER TABLE teams
ADD COLUMN deleted_at TIMESTAMPTZ DEFAULT NULL;

-- Add deleted_at to assets table
ALTER TABLE assets
ADD COLUMN deleted_at TIMESTAMPTZ DEFAULT NULL;

-- Create indexes for soft delete queries (improves performance of WHERE deleted_at IS NULL)
CREATE INDEX idx_vulnerabilities_deleted_at ON vulnerabilities(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_teams_deleted_at ON teams(deleted_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_assets_deleted_at ON assets(deleted_at) WHERE deleted_at IS NULL;

-- Add comment explaining soft delete pattern
COMMENT ON COLUMN vulnerabilities.deleted_at IS 'Timestamp when record was soft-deleted. NULL means active record.';
COMMENT ON COLUMN teams.deleted_at IS 'Timestamp when record was soft-deleted. NULL means active record.';
COMMENT ON COLUMN assets.deleted_at IS 'Timestamp when record was soft-deleted. NULL means active record.';
