-- Migration 034: Add Cascading Soft Delete Triggers
-- Automatically soft-delete related records when parent is deleted

-- ============================================
-- Soft delete cascading for Assets
-- ============================================

CREATE OR REPLACE FUNCTION soft_delete_asset_vulnerabilities()
RETURNS TRIGGER AS $$
BEGIN
    -- When an asset is soft-deleted, soft-delete all its vulnerabilities
    IF NEW.deleted_at IS NOT NULL AND OLD.deleted_at IS NULL THEN
        UPDATE vulnerabilities 
        SET deleted_at = NEW.deleted_at 
        WHERE asset_id = NEW.id AND deleted_at IS NULL;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_soft_delete_asset_vulnerabilities ON assets;
CREATE TRIGGER trigger_soft_delete_asset_vulnerabilities
AFTER UPDATE OF deleted_at ON assets
FOR EACH ROW
EXECUTE FUNCTION soft_delete_asset_vulnerabilities();

-- ============================================
-- Soft delete cascading for Teams
-- ============================================

CREATE OR REPLACE FUNCTION soft_delete_team_vulnerabilities()
RETURNS TRIGGER AS $$
BEGIN
    -- When a team is soft-deleted, nullify team assignments on vulnerabilities
    IF NEW.deleted_at IS NOT NULL AND OLD.deleted_at IS NULL THEN
        UPDATE vulnerabilities 
        SET assigned_team_id = NULL 
        WHERE assigned_team_id = NEW.id;
        
        -- Also soft-delete resolutions for this team
        UPDATE resolutions 
        SET deleted_at = NEW.deleted_at 
        WHERE team_id = NEW.id AND deleted_at IS NULL;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_soft_delete_team_vulnerabilities ON teams;
CREATE TRIGGER trigger_soft_delete_team_vulnerabilities
AFTER UPDATE OF deleted_at ON teams
FOR EACH ROW
EXECUTE FUNCTION soft_delete_team_vulnerabilities();

-- ============================================
-- Add deleted_at to resolutions table
-- ============================================

ALTER TABLE resolutions
ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ DEFAULT NULL;

CREATE INDEX IF NOT EXISTS idx_resolutions_deleted_at ON resolutions(deleted_at) 
WHERE deleted_at IS NULL;

-- ============================================
-- Add comments
-- ============================================

COMMENT ON FUNCTION soft_delete_asset_vulnerabilities() 
IS 'Automatically soft-delete vulnerabilities when asset is deleted';

COMMENT ON FUNCTION soft_delete_team_vulnerabilities() 
IS 'Automatically handle vulnerability assignments when team is deleted';

COMMENT ON TRIGGER trigger_soft_delete_asset_vulnerabilities ON assets 
IS 'Trigger for cascading soft delete of asset vulnerabilities';

COMMENT ON TRIGGER trigger_soft_delete_team_vulnerabilities ON teams 
IS 'Trigger for handling team deletions';

COMMENT ON COLUMN resolutions.deleted_at 
IS 'Timestamp when record was soft-deleted. NULL means active record.';
