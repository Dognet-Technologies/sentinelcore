-- Migration 006: Convert TIMESTAMP to TIMESTAMPTZ
-- PostgreSQL TIMESTAMP doesn't store timezone, SQLx maps it to NaiveDateTime
-- TIMESTAMPTZ stores timezone, SQLx maps it to DateTime<Utc>
-- This ensures type compatibility with Rust models

-- ============================================
-- 1. Users table
-- ============================================

ALTER TABLE users
    ALTER COLUMN created_at TYPE TIMESTAMPTZ USING created_at AT TIME ZONE 'UTC',
    ALTER COLUMN updated_at TYPE TIMESTAMPTZ USING updated_at AT TIME ZONE 'UTC',
    ALTER COLUMN last_login TYPE TIMESTAMPTZ USING last_login AT TIME ZONE 'UTC',
    ALTER COLUMN account_locked_until TYPE TIMESTAMPTZ USING account_locked_until AT TIME ZONE 'UTC';

-- ============================================
-- 2. User Sessions table
-- ============================================

ALTER TABLE user_sessions
    ALTER COLUMN created_at TYPE TIMESTAMPTZ USING created_at AT TIME ZONE 'UTC',
    ALTER COLUMN last_activity TYPE TIMESTAMPTZ USING last_activity AT TIME ZONE 'UTC',
    ALTER COLUMN expires_at TYPE TIMESTAMPTZ USING expires_at AT TIME ZONE 'UTC',
    ALTER COLUMN revoked_at TYPE TIMESTAMPTZ USING revoked_at AT TIME ZONE 'UTC';

-- ============================================
-- 3. Audit Logs table
-- ============================================

ALTER TABLE audit_logs
    ALTER COLUMN created_at TYPE TIMESTAMPTZ USING created_at AT TIME ZONE 'UTC';

-- ============================================
-- 4. Reputation Events table
-- ============================================

ALTER TABLE reputation_events
    ALTER COLUMN created_at TYPE TIMESTAMPTZ USING created_at AT TIME ZONE 'UTC';

-- ============================================
-- 5. Vulnerabilities table
-- ============================================

ALTER TABLE vulnerabilities
    ALTER COLUMN created_at TYPE TIMESTAMPTZ USING created_at AT TIME ZONE 'UTC',
    ALTER COLUMN updated_at TYPE TIMESTAMPTZ USING updated_at AT TIME ZONE 'UTC',
    ALTER COLUMN discovered_at TYPE TIMESTAMPTZ USING discovered_at AT TIME ZONE 'UTC';

-- ============================================
-- 6. Assets table
-- ============================================

ALTER TABLE assets
    ALTER COLUMN created_at TYPE TIMESTAMPTZ USING created_at AT TIME ZONE 'UTC',
    ALTER COLUMN updated_at TYPE TIMESTAMPTZ USING updated_at AT TIME ZONE 'UTC';

-- ============================================
-- 7. Teams table (if exists)
-- ============================================

DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'teams') THEN
        ALTER TABLE teams
            ALTER COLUMN created_at TYPE TIMESTAMPTZ USING created_at AT TIME ZONE 'UTC',
            ALTER COLUMN updated_at TYPE TIMESTAMPTZ USING updated_at AT TIME ZONE 'UTC';
    END IF;
END $$;

-- ============================================
-- 8. Resolutions table (if exists)
-- ============================================

DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'resolutions') THEN
        ALTER TABLE resolutions
            ALTER COLUMN created_at TYPE TIMESTAMPTZ USING created_at AT TIME ZONE 'UTC',
            ALTER COLUMN updated_at TYPE TIMESTAMPTZ USING updated_at AT TIME ZONE 'UTC';
    END IF;
END $$;

-- ============================================
-- 9. Network devices table (if exists)
-- ============================================

DO $$
BEGIN
    -- Convert discovered_at if column exists
    IF EXISTS (SELECT 1 FROM information_schema.columns
               WHERE table_name = 'network_devices' AND column_name = 'discovered_at') THEN
        ALTER TABLE network_devices
            ALTER COLUMN discovered_at TYPE TIMESTAMPTZ USING discovered_at AT TIME ZONE 'UTC';
    END IF;

    -- Convert last_seen if column exists
    IF EXISTS (SELECT 1 FROM information_schema.columns
               WHERE table_name = 'network_devices' AND column_name = 'last_seen') THEN
        ALTER TABLE network_devices
            ALTER COLUMN last_seen TYPE TIMESTAMPTZ USING last_seen AT TIME ZONE 'UTC';
    END IF;
END $$;

-- ============================================
-- 10. Network connections table (if exists)
-- ============================================

DO $$
BEGIN
    -- Convert discovered_at if column exists
    IF EXISTS (SELECT 1 FROM information_schema.columns
               WHERE table_name = 'network_connections' AND column_name = 'discovered_at') THEN
        ALTER TABLE network_connections
            ALTER COLUMN discovered_at TYPE TIMESTAMPTZ USING discovered_at AT TIME ZONE 'UTC';
    END IF;
END $$;

-- ============================================
-- 11. Update default values for new records
-- ============================================

-- Users
ALTER TABLE users
    ALTER COLUMN created_at SET DEFAULT NOW(),
    ALTER COLUMN updated_at SET DEFAULT NOW();

-- User Sessions
ALTER TABLE user_sessions
    ALTER COLUMN created_at SET DEFAULT NOW(),
    ALTER COLUMN last_activity SET DEFAULT NOW();

-- Audit Logs
ALTER TABLE audit_logs
    ALTER COLUMN created_at SET DEFAULT NOW();

-- Reputation Events
ALTER TABLE reputation_events
    ALTER COLUMN created_at SET DEFAULT NOW();

-- Vulnerabilities
ALTER TABLE vulnerabilities
    ALTER COLUMN created_at SET DEFAULT NOW(),
    ALTER COLUMN updated_at SET DEFAULT NOW();

-- Assets
ALTER TABLE assets
    ALTER COLUMN created_at SET DEFAULT NOW(),
    ALTER COLUMN updated_at SET DEFAULT NOW();

-- Teams (if exists)
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'teams') THEN
        ALTER TABLE teams
            ALTER COLUMN created_at SET DEFAULT NOW(),
            ALTER COLUMN updated_at SET DEFAULT NOW();
    END IF;
END $$;

COMMENT ON COLUMN users.created_at IS 'Timestamp with timezone (UTC)';
COMMENT ON COLUMN user_sessions.expires_at IS 'Session expiration timestamp with timezone (UTC)';
COMMENT ON COLUMN audit_logs.created_at IS 'Audit log creation timestamp with timezone (UTC)';
