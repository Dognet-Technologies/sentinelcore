-- Migration 007: Security tables for IP whitelist and user permissions
-- Created: 2025-11-20

-- IP Whitelist table
CREATE TABLE IF NOT EXISTS ip_whitelist (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ip_address VARCHAR(45) NOT NULL,
    cidr_mask INTEGER DEFAULT 32,
    description TEXT,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    team_id UUID REFERENCES teams(id) ON DELETE CASCADE,
    is_active BOOLEAN DEFAULT true,
    expires_at TIMESTAMPTZ,
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_ip_whitelist_ip ON ip_whitelist(ip_address);
CREATE INDEX idx_ip_whitelist_user ON ip_whitelist(user_id);
CREATE INDEX idx_ip_whitelist_team ON ip_whitelist(team_id);
CREATE INDEX idx_ip_whitelist_active ON ip_whitelist(is_active);

-- User Permissions table
CREATE TABLE IF NOT EXISTS user_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    permission VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id UUID,
    is_active BOOLEAN DEFAULT true,
    expires_at TIMESTAMPTZ,
    granted_by UUID NOT NULL REFERENCES users(id),
    granted_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    revoked_at TIMESTAMPTZ,
    revoked_by UUID REFERENCES users(id),
    revoked_reason TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_user_permissions_user ON user_permissions(user_id);
CREATE INDEX idx_user_permissions_permission ON user_permissions(permission);
CREATE INDEX idx_user_permissions_resource ON user_permissions(resource_type, resource_id);
CREATE INDEX idx_user_permissions_active ON user_permissions(is_active);

-- Add comments
COMMENT ON TABLE ip_whitelist IS 'IP addresses allowed to access the system';
COMMENT ON TABLE user_permissions IS 'Granular permissions assigned to users';

COMMENT ON COLUMN ip_whitelist.cidr_mask IS 'CIDR mask for IP range (32 for single IP)';
COMMENT ON COLUMN user_permissions.permission IS 'Permission name (e.g., read, write, delete, admin)';
COMMENT ON COLUMN user_permissions.resource_type IS 'Type of resource (e.g., vulnerability, asset, report)';
COMMENT ON COLUMN user_permissions.resource_id IS 'Specific resource ID, NULL for global permissions';
