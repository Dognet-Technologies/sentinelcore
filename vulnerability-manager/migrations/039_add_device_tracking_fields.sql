-- Migration: Add Device Tracking and Scanning Fields
-- File: migrations/039_add_device_tracking_fields.sql
-- Purpose: Add fields for device scanning, compliance tracking, and model information

-- Add device model and manufacturer details
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS model VARCHAR(255);
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS manufacturer VARCHAR(255);

-- Add scanning tracking fields
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS last_scan_date TIMESTAMPTZ;
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS next_scan_date TIMESTAMPTZ;
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS scan_status VARCHAR(50) DEFAULT 'unknown'
    CHECK (scan_status IN ('pending', 'running', 'completed', 'failed', 'unknown'));

-- Add compliance tracking
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS compliance_score INTEGER
    CHECK (compliance_score >= 0 AND compliance_score <= 100);

-- Add assignment tracking
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS assignment_date TIMESTAMPTZ;

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_network_devices_scan_status ON network_devices(scan_status);
CREATE INDEX IF NOT EXISTS idx_network_devices_last_scan ON network_devices(last_scan_date DESC);
CREATE INDEX IF NOT EXISTS idx_network_devices_compliance ON network_devices(compliance_score);

-- Update assignment_date when assigned_user_id or assigned_team_id changes
CREATE OR REPLACE FUNCTION update_device_assignment_date()
RETURNS TRIGGER AS $$
BEGIN
    IF (NEW.assigned_user_id IS DISTINCT FROM OLD.assigned_user_id)
       OR (NEW.assigned_team_id IS DISTINCT FROM OLD.assigned_team_id) THEN
        NEW.assignment_date = NOW();
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_device_assignment_date
    BEFORE UPDATE ON network_devices
    FOR EACH ROW
    EXECUTE FUNCTION update_device_assignment_date();

-- Comments
COMMENT ON COLUMN network_devices.model IS 'Device model name/number';
COMMENT ON COLUMN network_devices.manufacturer IS 'Device manufacturer (same as vendor, for compatibility)';
COMMENT ON COLUMN network_devices.last_scan_date IS 'Last vulnerability scan timestamp';
COMMENT ON COLUMN network_devices.next_scan_date IS 'Scheduled next scan timestamp';
COMMENT ON COLUMN network_devices.scan_status IS 'Current scanning status: pending, running, completed, failed, unknown';
COMMENT ON COLUMN network_devices.compliance_score IS 'Compliance score 0-100 based on policy adherence';
COMMENT ON COLUMN network_devices.assignment_date IS 'Timestamp when device was assigned to user/team';
