-- Migration: Add Missing Vulnerability Columns
-- Description: Add columns needed for NVD enrichment, EPSS tracking, and team assignment
-- Author: SentinelCore Team
-- Date: 2024-12-12

-- Add first_detected column for tracking when vulnerability was first seen
ALTER TABLE vulnerabilities
ADD COLUMN IF NOT EXISTS first_detected TIMESTAMPTZ DEFAULT NOW();

-- Add NVD enrichment tracking
ALTER TABLE vulnerabilities
ADD COLUMN IF NOT EXISTS nvd_enriched_at TIMESTAMPTZ;

-- Add CVSS vector string for detailed vulnerability scoring
ALTER TABLE vulnerabilities
ADD COLUMN IF NOT EXISTS cvss_vector VARCHAR(100);

-- Add EPSS update tracking
ALTER TABLE vulnerabilities
ADD COLUMN IF NOT EXISTS epss_updated_at TIMESTAMPTZ;

-- Add team assignment for vulnerability ownership
ALTER TABLE vulnerabilities
ADD COLUMN IF NOT EXISTS assigned_to_team_id UUID REFERENCES teams(id) ON DELETE SET NULL;

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_first_detected ON vulnerabilities(first_detected DESC);
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_nvd_enriched_at ON vulnerabilities(nvd_enriched_at DESC);
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_epss_updated_at ON vulnerabilities(epss_updated_at DESC);
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_assigned_to_team ON vulnerabilities(assigned_to_team_id);

-- Comments for documentation
COMMENT ON COLUMN vulnerabilities.first_detected IS 'Timestamp when this vulnerability was first detected in the system';
COMMENT ON COLUMN vulnerabilities.nvd_enriched_at IS 'Timestamp when NVD enrichment was last performed';
COMMENT ON COLUMN vulnerabilities.cvss_vector IS 'CVSS vector string (e.g., CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)';
COMMENT ON COLUMN vulnerabilities.epss_updated_at IS 'Timestamp when EPSS score was last updated';
COMMENT ON COLUMN vulnerabilities.assigned_to_team_id IS 'Team responsible for remediating this vulnerability';

-- Update existing records to set first_detected from created_at if not already set
UPDATE vulnerabilities
SET first_detected = created_at
WHERE first_detected IS NULL;
