-- Migration: Auto-Assignment Tracking
-- Tracks auto-assignment jobs and their results

-- Table to track auto-assignment job executions
CREATE TABLE IF NOT EXISTS auto_assignment_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    status VARCHAR(50) NOT NULL DEFAULT 'running', -- running, completed, failed
    vulnerabilities_processed INTEGER DEFAULT 0,
    vulnerabilities_assigned INTEGER DEFAULT 0,
    error_message TEXT,
    triggered_by UUID REFERENCES users(id) ON DELETE SET NULL, -- NULL if triggered by cron
    trigger_type VARCHAR(50) NOT NULL DEFAULT 'manual', -- manual, scheduled
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table to track individual vulnerability auto-assignments
CREATE TABLE IF NOT EXISTS auto_assignment_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_id UUID REFERENCES auto_assignment_jobs(id) ON DELETE CASCADE,
    vulnerability_id UUID NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    assigned_to_user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    assigned_to_team_id UUID REFERENCES teams(id) ON DELETE SET NULL,
    matched_skills TEXT[] DEFAULT '{}',
    assignment_reason TEXT,
    confidence_score DECIMAL(5,2), -- 0.00 to 100.00
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(job_id, vulnerability_id)
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_auto_assignment_jobs_started_at ON auto_assignment_jobs(started_at DESC);
CREATE INDEX IF NOT EXISTS idx_auto_assignment_jobs_status ON auto_assignment_jobs(status);
CREATE INDEX IF NOT EXISTS idx_auto_assignment_jobs_triggered_by ON auto_assignment_jobs(triggered_by);
CREATE INDEX IF NOT EXISTS idx_auto_assignment_history_job_id ON auto_assignment_history(job_id);
CREATE INDEX IF NOT EXISTS idx_auto_assignment_history_vulnerability_id ON auto_assignment_history(vulnerability_id);
CREATE INDEX IF NOT EXISTS idx_auto_assignment_history_assigned_to_user_id ON auto_assignment_history(assigned_to_user_id);
CREATE INDEX IF NOT EXISTS idx_auto_assignment_history_assigned_to_team_id ON auto_assignment_history(assigned_to_team_id);

-- Comments
COMMENT ON TABLE auto_assignment_jobs IS 'Tracks execution of auto-assignment jobs for vulnerabilities based on skills';
COMMENT ON TABLE auto_assignment_history IS 'Tracks individual vulnerability assignments made by auto-assignment engine';
COMMENT ON COLUMN auto_assignment_history.matched_skills IS 'Skills that matched for this assignment';
COMMENT ON COLUMN auto_assignment_history.confidence_score IS 'Confidence score (0-100) for the assignment match';
COMMENT ON COLUMN auto_assignment_history.assignment_reason IS 'Human-readable explanation of why this assignment was made';

-- Update system_settings descriptions
UPDATE system_settings
SET description = 'Number of days before unassigned vulnerabilities are auto-assigned based on user/team skills. Set to 0 to disable delay.'
WHERE setting_key = 'auto_assignment_delay_days';

UPDATE system_settings
SET description = 'Enable/disable automatic vulnerability assignment based on skills. When enabled, vulnerabilities older than delay_days without assignment will be auto-assigned.'
WHERE setting_key = 'auto_assignment_enabled';
