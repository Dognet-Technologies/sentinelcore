-- Migration: Add Risk-Based Remediation Engine fields
-- File: migrations/035_add_rbre_fields.sql
-- Purpose: Add business-critical fields to network_devices table for RBRE

-- Create custom types for RBRE
CREATE TYPE asset_criticality AS ENUM ('mission_critical', 'core_business', 'supporto', 'lab_test');
CREATE TYPE exposure_level AS ENUM ('internet_facing', 'dmz', 'internal', 'segmented');
CREATE TYPE device_use_case AS ENUM (
    'web_server', 'database', 'endpoint', 'iot', 'load_balancer',
    'firewall', 'router', 'switch', 'nas', 'other'
);
CREATE TYPE data_classification AS ENUM ('public', 'internal', 'sensitive', 'critical');
CREATE TYPE remediation_difficulty AS ENUM ('trivial', 'easy', 'medium', 'hard', 'very_hard');

-- Add columns to network_devices table
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS business_criticality asset_criticality DEFAULT 'supporto';
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS exposure_level exposure_level DEFAULT 'internal';
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS device_use_case device_use_case DEFAULT 'other';
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS data_classification data_classification DEFAULT 'internal';

-- Required fields for RBRE
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS compensating_controls TEXT;
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS patch_availability BOOLEAN DEFAULT false;
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS remediation_difficulty remediation_difficulty DEFAULT 'medium';
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS deployment_impact VARCHAR(255);

-- Optional fields
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS owner_team_id UUID REFERENCES teams(id) ON DELETE SET NULL;
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS compliance_requirements TEXT[];
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS device_notes TEXT;
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS is_data_processor BOOLEAN DEFAULT false;

-- Fields for tracking remediation
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS rbs_last_calculated TIMESTAMPTZ;
ALTER TABLE network_devices ADD COLUMN IF NOT EXISTS cached_risk_score INTEGER;

-- Create remediation_plans table
CREATE TABLE IF NOT EXISTS remediation_plans (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(500) NOT NULL,
    description TEXT,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(50) NOT NULL DEFAULT 'draft', -- draft, approved, in_progress, completed
    
    -- Plan structure
    total_devices INTEGER NOT NULL DEFAULT 0,
    critical_count INTEGER NOT NULL DEFAULT 0,
    high_count INTEGER NOT NULL DEFAULT 0,
    medium_count INTEGER NOT NULL DEFAULT 0,
    low_count INTEGER NOT NULL DEFAULT 0,
    
    -- Metrics
    estimated_hours_total DECIMAL(10,2) DEFAULT 0,
    estimated_start_date DATE,
    estimated_completion_date DATE,
    
    -- Targeting
    device_ids UUID[] NOT NULL DEFAULT '{}',
    exclude_device_ids UUID[] DEFAULT '{}',
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create remediation_plan_phases table
CREATE TABLE IF NOT EXISTS remediation_plan_phases (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    plan_id UUID NOT NULL REFERENCES remediation_plans(id) ON DELETE CASCADE,
    phase_number INTEGER NOT NULL,
    phase_name VARCHAR(255) NOT NULL,
    description TEXT,
    target_severity VARCHAR(50), -- 'critical', 'high', 'medium', 'low'
    estimated_start_date DATE,
    estimated_end_date DATE,
    assigned_team_id UUID REFERENCES teams(id) ON DELETE SET NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'pending', -- pending, in_progress, completed, failed
    
    device_count INTEGER DEFAULT 0,
    vulnerability_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create remediation_plan_items table (individual vulnerabilities/devices in plan)
CREATE TABLE IF NOT EXISTS remediation_plan_items (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    plan_id UUID NOT NULL REFERENCES remediation_plans(id) ON DELETE CASCADE,
    phase_id UUID NOT NULL REFERENCES remediation_plan_phases(id) ON DELETE CASCADE,
    device_id UUID NOT NULL REFERENCES network_devices(id) ON DELETE CASCADE,
    vulnerability_id UUID NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    
    -- Scoring breakdown
    rps_score DECIMAL(5,2) NOT NULL DEFAULT 0, -- Remediation Priority Score (0-100)
    technical_severity DECIMAL(4,2) NOT NULL DEFAULT 0, -- 0-1
    exploit_probability DECIMAL(4,2) NOT NULL DEFAULT 0, -- EPSS, 0-1
    asset_criticality_score DECIMAL(4,2) NOT NULL DEFAULT 0, -- 0-1
    exposure_factor DECIMAL(4,2) NOT NULL DEFAULT 0, -- 0-1
    threat_context DECIMAL(4,2) NOT NULL DEFAULT 0, -- 0-1
    time_factor DECIMAL(4,2) NOT NULL DEFAULT 0, -- 0-1
    
    -- Explanation
    rps_explanation TEXT,
    
    -- Remediation metadata
    remediation_difficulty remediation_difficulty DEFAULT 'medium',
    estimated_hours SMALLINT DEFAULT 0,
    assigned_to UUID REFERENCES users(id) ON DELETE SET NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'pending', -- pending, in_progress, completed, failed
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create indexes for performance
CREATE INDEX idx_network_devices_business_criticality ON network_devices(business_criticality);
CREATE INDEX idx_network_devices_exposure_level ON network_devices(exposure_level);
CREATE INDEX idx_network_devices_use_case ON network_devices(device_use_case);
CREATE INDEX idx_remediation_plans_status ON remediation_plans(status);
CREATE INDEX idx_remediation_plans_created_by ON remediation_plans(created_by);
CREATE INDEX idx_remediation_plan_phases_plan ON remediation_plan_phases(plan_id);
CREATE INDEX idx_remediation_plan_phases_status ON remediation_plan_phases(status);
CREATE INDEX idx_remediation_plan_items_plan ON remediation_plan_items(plan_id);
CREATE INDEX idx_remediation_plan_items_phase ON remediation_plan_items(phase_id);
CREATE INDEX idx_remediation_plan_items_device ON remediation_plan_items(device_id);
CREATE INDEX idx_remediation_plan_items_rps ON remediation_plan_items(rps_score DESC);

-- Update triggers
CREATE TRIGGER update_network_devices_rbs_at BEFORE UPDATE ON network_devices
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_remediation_plans_updated_at BEFORE UPDATE ON remediation_plans
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_remediation_plan_phases_updated_at BEFORE UPDATE ON remediation_plan_phases
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_remediation_plan_items_updated_at BEFORE UPDATE ON remediation_plan_items
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Comments
COMMENT ON COLUMN network_devices.business_criticality IS 'Asset business impact: mission_critical, core_business, supporto, lab_test';
COMMENT ON COLUMN network_devices.exposure_level IS 'Network exposure: internet_facing, dmz, internal, segmented';
COMMENT ON COLUMN network_devices.device_use_case IS 'Primary function of device';
COMMENT ON COLUMN network_devices.data_classification IS 'Data sensitivity level processed by device';
COMMENT ON COLUMN network_devices.compensating_controls IS 'Security controls mitigating vulnerabilities';
COMMENT ON COLUMN network_devices.patch_availability IS 'Whether patch is available for vulnerabilities';
COMMENT ON COLUMN network_devices.remediation_difficulty IS 'Operational impact and complexity of patching';
COMMENT ON COLUMN network_devices.deployment_impact IS 'Description of operational impact of remediation';

COMMENT ON TABLE remediation_plans IS 'Tracks generated remediation plans';
COMMENT ON TABLE remediation_plan_phases IS 'Phased approach to vulnerability remediation';
COMMENT ON TABLE remediation_plan_items IS 'Individual remediation tasks with RPS scores and explanations';
