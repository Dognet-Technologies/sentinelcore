-- Migration 038: Fix vulnerabilities asset linking
-- Connects existing vulnerabilities to assets by IP/hostname

BEGIN;

-- Update vulnerabilities that have matching assets by IP or hostname
UPDATE vulnerabilities v
SET asset_id = a.id
FROM assets a
WHERE v.asset_id IS NULL
  AND (
    (v.ip_address IS NOT NULL AND v.ip_address = a.ip_address) OR
    (v.hostname IS NOT NULL AND v.hostname = a.hostname)
  );

-- Add more realistic vulnerabilities with proper asset links
INSERT INTO vulnerabilities (
    title, description, cvss_score, epss_score, ip_address, hostname,
    port, protocol, status, severity, cve_id, remediation, source, discovered_at, asset_id
)
SELECT
    'Critical RCE in Web Server',
    'Remote code execution vulnerability in Apache that allows unauthenticated attackers to execute arbitrary code.',
    9.8,
    0.95,
    '192.168.1.10',
    'webserver01.local',
    80,
    'HTTP',
    'open',
    'critical',
    'CVE-2024-00001',
    'Apply security patches immediately and restrict access to port 80.',
    'Nessus Scan',
    NOW() - INTERVAL '3 days',
    a.id
FROM assets a
WHERE a.hostname = 'webserver01.local'
LIMIT 1;

INSERT INTO vulnerabilities (
    title, description, cvss_score, epss_score, ip_address, hostname,
    port, protocol, status, severity, cve_id, remediation, source, discovered_at, asset_id
)
SELECT
    'Critical Database Privilege Escalation',
    'Privilege escalation in PostgreSQL allowing unauthorized access to sensitive data.',
    9.5,
    0.92,
    '192.168.1.11',
    'dbserver01.local',
    5432,
    'TCP',
    'open',
    'critical',
    'CVE-2024-00002',
    'Update to latest PostgreSQL patch and disable default accounts.',
    'Manual Scan',
    NOW() - INTERVAL '4 days',
    a.id
FROM assets a
WHERE a.hostname = 'dbserver01.local'
LIMIT 1;

INSERT INTO vulnerabilities (
    title, description, cvss_score, epss_score, ip_address, hostname,
    port, protocol, status, severity, cve_id, remediation, source, discovered_at, asset_id
)
SELECT
    'High: Unpatched Apache Module',
    'Missing security update in mod_ssl module.',
    7.5,
    0.68,
    '192.168.1.10',
    'webserver01.local',
    443,
    'HTTPS',
    'open',
    'high',
    'CVE-2023-99999',
    'Apply Apache security updates.',
    'Nessus Scan',
    NOW() - INTERVAL '5 days',
    a.id
FROM assets a
WHERE a.hostname = 'webserver01.local'
LIMIT 1;

INSERT INTO vulnerabilities (
    title, description, cvss_score, epss_score, ip_address, hostname,
    port, protocol, status, severity, cve_id, remediation, source, discovered_at, asset_id
)
SELECT
    'Medium: Weak Cipher Suites',
    'Database server supports deprecated cipher suites.',
    5.3,
    0.42,
    '192.168.1.11',
    'dbserver01.local',
    5432,
    'TCP',
    'open',
    'medium',
    'CVE-2023-88888',
    'Configure database to use only strong cipher suites.',
    'Manual Scan',
    NOW() - INTERVAL '6 days',
    a.id
FROM assets a
WHERE a.hostname = 'dbserver01.local'
LIMIT 1;

-- Add network_scans for recent_scans count
INSERT INTO network_scans (scan_name, scan_type, target_range, status, devices_found, started_at, completed_at, created_by)
SELECT
    'Weekly Network Scan',
    'nessus',
    '192.168.1.0/24',
    'completed',
    2,
    NOW() - INTERVAL '2 days',
    NOW() - INTERVAL '2 days' + INTERVAL '2 hours',
    u.id
FROM users u
WHERE u.username = 'admin'
LIMIT 1;

INSERT INTO network_scans (scan_name, scan_type, target_range, status, devices_found, started_at, completed_at, created_by)
SELECT
    'Critical Assets Scan',
    'openvas',
    '192.168.1.0/24',
    'completed',
    2,
    NOW() - INTERVAL '4 days',
    NOW() - INTERVAL '4 days' + INTERVAL '3 hours',
    u.id
FROM users u
WHERE u.username = 'admin'
LIMIT 1;

INSERT INTO network_scans (scan_name, scan_type, target_range, status, devices_found, started_at, completed_at, created_by)
SELECT
    'Compliance Scan',
    'nessus',
    '192.168.1.0/24',
    'completed',
    2,
    NOW() - INTERVAL '6 days',
    NOW() - INTERVAL '6 days' + INTERVAL '4 hours',
    u.id
FROM users u
WHERE u.username = 'admin'
LIMIT 1;

COMMIT;
