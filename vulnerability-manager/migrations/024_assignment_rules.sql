-- Migration: Assignment Rules System
-- Enables rule-based automatic assignment of vulnerabilities to teams

CREATE TABLE IF NOT EXISTS assignment_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    priority INTEGER NOT NULL DEFAULT 100,
    is_enabled BOOLEAN NOT NULL DEFAULT true,
    
    -- Rule conditions (stored as JSONB for flexibility)
    -- Example: {"vulnerability": {"severity": "critical"}, "asset": {"tags": ["production"]}}
    conditions JSONB NOT NULL DEFAULT '{}',
    
    -- Assignment target
    team_id UUID REFERENCES teams(id) ON DELETE CASCADE,
    team_member_role VARCHAR(100),  -- e.g., 'Senior Engineer', 'Engineer', 'Team Leader'
    require_skill_match BOOLEAN DEFAULT false,
    required_skills TEXT[] DEFAULT '{}',  -- e.g., ['kubernetes', 'docker']
    
    -- Load balancing strategy
    load_balancing_strategy VARCHAR(50) DEFAULT 'round_robin',  -- round_robin, least_loaded, random
    
    -- Assignment metadata
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table to track which rule matched each vulnerability assignment
CREATE TABLE IF NOT EXISTS vulnerability_rule_matches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vulnerability_id UUID NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    rule_id UUID NOT NULL REFERENCES assignment_rules(id) ON DELETE CASCADE,
    matched_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(vulnerability_id, rule_id)
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_assignment_rules_enabled ON assignment_rules(is_enabled);
CREATE INDEX IF NOT EXISTS idx_assignment_rules_priority ON assignment_rules(priority DESC);
CREATE INDEX IF NOT EXISTS idx_assignment_rules_team_id ON assignment_rules(team_id);
CREATE INDEX IF NOT EXISTS idx_assignment_rules_created_by ON assignment_rules(created_by);
CREATE INDEX IF NOT EXISTS idx_vulnerability_rule_matches_vuln_id ON vulnerability_rule_matches(vulnerability_id);
CREATE INDEX IF NOT EXISTS idx_vulnerability_rule_matches_rule_id ON vulnerability_rule_matches(rule_id);
CREATE INDEX IF NOT EXISTS idx_vulnerability_rule_matches_matched_at ON vulnerability_rule_matches(matched_at DESC);

-- Comments for documentation
COMMENT ON TABLE assignment_rules IS 'Rules engine for automatic vulnerability assignment to teams/members';
COMMENT ON COLUMN assignment_rules.conditions IS 'JSONB filter conditions for rule matching (e.g., severity, asset type, tags)';
COMMENT ON COLUMN assignment_rules.load_balancing_strategy IS 'Strategy for distributing work among team members';
COMMENT ON TABLE vulnerability_rule_matches IS 'Audit trail of which rules matched each vulnerability';

-- Seed basic assignment rules for common scenarios
INSERT INTO assignment_rules (name, description, priority, conditions, team_id, load_balancing_strategy, is_enabled, created_by)
SELECT 
    'Critical vulnerabilities to seniors' as name,
    'All critical vulnerabilities assigned to Senior Engineers' as description,
    1000 as priority,
    jsonb_build_object('vulnerability', jsonb_build_object('severity', 'critical')) as conditions,
    teams.id as team_id,
    'least_loaded' as load_balancing_strategy,
    true as is_enabled,
    users.id as created_by
FROM teams
CROSS JOIN users
WHERE teams.name = 'Infrastructure Team'
  AND users.role = 'admin'
LIMIT 1
ON CONFLICT DO NOTHING;

INSERT INTO assignment_rules (name, description, priority, conditions, team_id, load_balancing_strategy, is_enabled, created_by)
SELECT 
    'Web vulnerabilities to Web Team' as name,
    'Vulnerabilities affecting web assets routed to Web Team' as description,
    500 as priority,
    jsonb_build_object('asset', jsonb_build_object('tags', jsonb_build_array('web'))) as conditions,
    teams.id as team_id,
    'round_robin' as load_balancing_strategy,
    true as is_enabled,
    users.id as created_by
FROM teams
CROSS JOIN users
WHERE teams.name = 'Web Team'
  AND users.role = 'admin'
LIMIT 1
ON CONFLICT DO NOTHING;
