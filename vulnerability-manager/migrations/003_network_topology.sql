-- Migration: Network Topology Tables
-- File: migrations/003_network_topology.sql

-- Create device types
CREATE TYPE device_type AS ENUM ('router', 'switch', 'firewall', 'server', 'workstation', 'iot', 'printer', 'unknown');
CREATE TYPE device_status AS ENUM ('online', 'offline', 'unknown');

-- Create network_devices table
CREATE TABLE network_devices (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    ip_address INET NOT NULL,
    mac_address VARCHAR(17),
    hostname VARCHAR(255),
    device_type device_type NOT NULL DEFAULT 'unknown',
    device_status device_status NOT NULL DEFAULT 'unknown',
    vendor VARCHAR(255),
    os_name VARCHAR(255),
    os_version VARCHAR(100),
    open_ports INTEGER[],
    services JSONB,
    first_seen TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    last_seen TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(ip_address)
);

-- Create network_links table
CREATE TABLE network_links (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    source_device_id UUID NOT NULL REFERENCES network_devices(id) ON DELETE CASCADE,
    target_device_id UUID NOT NULL REFERENCES network_devices(id) ON DELETE CASCADE,
    link_type VARCHAR(50) NOT NULL,
    latency_ms REAL,
    hop_count INTEGER,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(source_device_id, target_device_id)
);

-- Create network_scans table
CREATE TABLE network_scans (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    scan_name VARCHAR(255) NOT NULL,
    scan_type VARCHAR(50) NOT NULL,
    target_range VARCHAR(100) NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    devices_found INTEGER DEFAULT 0,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create device_vulnerabilities association table
CREATE TABLE device_vulnerabilities (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    device_id UUID NOT NULL REFERENCES network_devices(id) ON DELETE CASCADE,
    vulnerability_id UUID NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    discovered_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(device_id, vulnerability_id)
);

-- Create remediation_tasks table
CREATE TABLE remediation_tasks (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    device_id UUID NOT NULL REFERENCES network_devices(id) ON DELETE CASCADE,
    vulnerability_id UUID NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    task_type VARCHAR(50) NOT NULL,
    script TEXT,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    output TEXT,
    error_message TEXT,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create indexes
CREATE INDEX idx_network_devices_ip ON network_devices USING gist (ip_address inet_ops);
CREATE INDEX idx_network_devices_status ON network_devices(device_status);
CREATE INDEX idx_network_devices_type ON network_devices(device_type);
CREATE INDEX idx_network_links_source ON network_links(source_device_id);
CREATE INDEX idx_network_links_target ON network_links(target_device_id);
CREATE INDEX idx_network_scans_status ON network_scans(status);
CREATE INDEX idx_device_vulnerabilities_device ON device_vulnerabilities(device_id);
CREATE INDEX idx_device_vulnerabilities_vuln ON device_vulnerabilities(vulnerability_id);
CREATE INDEX idx_remediation_tasks_status ON remediation_tasks(status);
CREATE INDEX idx_remediation_tasks_device ON remediation_tasks(device_id);

-- Update trigger for network_devices
CREATE TRIGGER update_network_devices_updated_at BEFORE UPDATE ON network_devices
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Comments
COMMENT ON TABLE network_devices IS 'Stores discovered network devices from scans';
COMMENT ON TABLE network_links IS 'Stores network topology links between devices';
COMMENT ON TABLE network_scans IS 'Stores network scan history and status';
COMMENT ON TABLE device_vulnerabilities IS 'Associates vulnerabilities with network devices';
COMMENT ON TABLE remediation_tasks IS 'Tracks remediation tasks for device vulnerabilities';
