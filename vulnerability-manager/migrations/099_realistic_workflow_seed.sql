-- Migration 099: Realistic Interconnected Workflow Seed Data
-- Simulates: scan import → admin assigns → team receives → applies remediation → closes report
-- This creates a complete, realistic dataset for testing the full application workflow

-- ==========================================
-- PART 1: Users with different roles
-- ==========================================

-- Admin user (already exists as 'admin', we'll use it)
-- Add team leaders and team members

-- Team Leaders
INSERT INTO users (id, username, email, password_hash, role, email_verified, reputation_score, two_factor_enabled)
VALUES 
    ('11111111-1111-1111-1111-111111111111'::UUID, 'john_smith', 'john.smith@company.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyWuj0POZSZO', 'team_leader', true, 85, false),
    ('22222222-2222-2222-2222-222222222222'::UUID, 'maria_garcia', 'maria.garcia@company.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyWuj0POZSZO', 'team_leader', true, 92, false),
    ('33333333-3333-3333-3333-333333333333'::UUID, 'david_chen', 'david.chen@company.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyWuj0POZSZO', 'team_leader', true, 78, false)
ON CONFLICT (id) DO NOTHING;

-- Team Members
INSERT INTO users (id, username, email, password_hash, role, email_verified, reputation_score, two_factor_enabled)
VALUES 
    ('44444444-4444-4444-4444-444444444444'::UUID, 'alice_wong', 'alice.wong@company.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyWuj0POZSZO', 'user', true, 65, false),
    ('55555555-5555-5555-5555-555555555555'::UUID, 'bob_johnson', 'bob.johnson@company.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyWuj0POZSZO', 'user', true, 72, false),
    ('66666666-6666-6666-6666-666666666666'::UUID, 'carol_martinez', 'carol.martinez@company.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyWuj0POZSZO', 'user', true, 58, false),
    ('77777777-7777-7777-7777-777777777777'::UUID, 'dan_kim', 'dan.kim@company.com', '$2a$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyWuj0POZSZO', 'user', true, 81, false)
ON CONFLICT (id) DO NOTHING;

-- ==========================================
-- PART 2: Teams with members
-- ==========================================

INSERT INTO teams (id, name, description, contact_email)
VALUES 
    ('aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID, 'Network Infrastructure', 'Responsible for routers, switches, and network security', 'network-team@company.com'),
    ('bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb'::UUID, 'Server Operations', 'Manages all server infrastructure and databases', 'server-ops@company.com'),
    ('cccccccc-cccc-cccc-cccc-cccccccccccc'::UUID, 'Application Security', 'Web applications and API security', 'appsec@company.com')
ON CONFLICT (id) DO NOTHING;

-- Assign team members
INSERT INTO team_members (team_id, user_id, name, email, role)
VALUES
    -- Network Infrastructure Team
    ('aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID, '11111111-1111-1111-1111-111111111111'::UUID, 'john_smith', 'john.smith@company.com', 'team_lead'),
    ('aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID, '44444444-4444-4444-4444-444444444444'::UUID, 'alice_wong', 'alice.wong@company.com', 'contributor'),
    ('aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID, '55555555-5555-5555-5555-555555555555'::UUID, 'bob_johnson', 'bob.johnson@company.com', 'contributor'),
    -- Server Operations Team
    ('bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb'::UUID, '22222222-2222-2222-2222-222222222222'::UUID, 'maria_garcia', 'maria.garcia@company.com', 'team_lead'),
    ('bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb'::UUID, '66666666-6666-6666-6666-666666666666'::UUID, 'carol_martinez', 'carol.martinez@company.com', 'contributor'),
    -- Application Security Team
    ('cccccccc-cccc-cccc-cccc-cccccccccccc'::UUID, '33333333-3333-3333-3333-333333333333'::UUID, 'david_chen', 'david.chen@company.com', 'team_lead'),
    ('cccccccc-cccc-cccc-cccc-cccccccccccc'::UUID, '77777777-7777-7777-7777-777777777777'::UUID, 'dan_kim', 'dan.kim@company.com', 'contributor')
ON CONFLICT DO NOTHING;

-- ==========================================
-- PART 3: Assets (Network Devices)
-- ==========================================

INSERT INTO assets (id, name, asset_type, description, ip_address, hostname, operating_system, location, tags)
VALUES 
    ('a0000001-0001-0001-0001-000000000001'::UUID, 'CORE-RTR-DC1', 'network', 'Main datacenter core router', '10.0.1.1/32', 'core-rtr-dc1.company.local', 'Cisco IOS 15.7', 'Datacenter 1 - Room A', ARRAY['critical', 'datacenter', 'core']),
    ('a0000002-0002-0002-0002-000000000002'::UUID, 'CORE-SW-DC1', 'network', 'Core distribution switch', '10.0.1.2/32', 'core-sw-dc1.company.local', 'Cisco IOS 15.2', 'Datacenter 1 - Room A', ARRAY['critical', 'datacenter', 'core']),
    ('a0000003-0003-0003-0003-000000000003'::UUID, 'FW-PERIMETER-01', 'network', 'Perimeter firewall', '10.0.1.10/32', 'fw-perimeter-01.company.local', 'Palo Alto PAN-OS 10.1', 'Datacenter 1 - DMZ', ARRAY['critical', 'security', 'firewall']),
    ('a0000004-0004-0004-0004-000000000004'::UUID, 'DB-PROD-01', 'server', 'Production database server', '10.1.10.50/32', 'db-prod-01.company.local', 'Ubuntu 20.04 LTS', 'Datacenter 1 - Room B', ARRAY['critical', 'database', 'production']),
    ('a0000005-0005-0005-0005-000000000005'::UUID, 'WEB-PROD-01', 'server', 'Production web server', '10.1.20.10/32', 'web-prod-01.company.local', 'Ubuntu 22.04 LTS', 'Datacenter 1 - Room C', ARRAY['high', 'web', 'production']),
    ('a0000006-0006-0006-0006-000000000006'::UUID, 'APP-PROD-01', 'server', 'Production application server', '10.1.20.20/32', 'app-prod-01.company.local', 'RedHat Enterprise 8.5', 'Datacenter 1 - Room C', ARRAY['high', 'application', 'production']),
    ('a0000007-0007-0007-0007-000000000007'::UUID, 'WAP-OFFICE-FL3', 'network', 'Office wireless access point', '10.2.3.100/32', 'wap-office-fl3.company.local', 'Ubiquiti UniFi 6.2', 'Office Building - Floor 3', ARRAY['medium', 'wireless', 'office'])
ON CONFLICT (id) DO NOTHING;

-- ==========================================
-- PART 4: Vulnerabilities (from scan import)
-- ==========================================

-- Critical vulnerability on router
INSERT INTO vulnerabilities (
    id, title, description, cvss_score, epss_score, ip_address, hostname, 
    port, protocol, status, severity, cve_id, cwe_id, remediation, source, 
    discovered_at, asset_id, assigned_team_id, assigned_user_id
)
VALUES 
    -- Router vulnerabilities
    ('00000001-0001-0001-0001-000000000001'::UUID, 
     'Cisco IOS Remote Code Execution', 
     'A critical vulnerability in Cisco IOS allows unauthenticated remote attackers to execute arbitrary code.',
     9.8, 0.85, '10.0.1.1/32', 'core-rtr-dc1.company.local',
     22, 'SSH', 'in_progress', 'critical', 'CVE-2023-20109', 'CWE-787',
     'Upgrade to Cisco IOS 15.9 or apply security patch',
     'Nessus', NOW() - INTERVAL '5 days', 
     'a0000001-0001-0001-0001-000000000001'::UUID,
     'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID,  -- Assigned to Network Infrastructure
     '11111111-1111-1111-1111-111111111111'::UUID), -- Assigned to John Smith
    
    -- Switch vulnerabilities
    ('00000002-0002-0002-0002-000000000002'::UUID,
     'Cisco IOS Information Disclosure',
     'Vulnerability allows local attackers to access sensitive information.',
     7.5, 0.42, '10.0.1.2/32', 'core-sw-dc1.company.local',
     443, 'HTTPS', 'in_progress', 'high', 'CVE-2023-20073', 'CWE-200',
     'Apply security patch or upgrade firmware',
     'Nessus', NOW() - INTERVAL '5 days',
     'a0000002-0002-0002-0002-000000000002'::UUID,
     'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID,
     '44444444-4444-4444-4444-444444444444'::UUID), -- Alice Wong
    
    -- Firewall vulnerabilities  
    ('00000003-0003-0003-0003-000000000003'::UUID,
     'Palo Alto PAN-OS Command Injection',
     'Command injection vulnerability in management interface.',
     8.1, 0.67, '10.0.1.10/32', 'fw-perimeter-01.company.local',
     443, 'HTTPS', 'resolved', 'high', 'CVE-2023-0001', 'CWE-78',
     'Upgrade to PAN-OS 10.2.3 or later',
     'Qualys', NOW() - INTERVAL '12 days',
     'a0000003-0003-0003-0003-000000000003'::UUID,
     'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID,
     '55555555-5555-5555-5555-555555555555'::UUID), -- Bob Johnson
    
    -- Database server vulnerabilities
    ('00000004-0004-0004-0004-000000000004'::UUID,
     'PostgreSQL Privilege Escalation',
     'Local privilege escalation in PostgreSQL allows attackers to gain superuser access.',
     8.8, 0.55, '10.1.10.50/32', 'db-prod-01.company.local',
     5432, 'TCP', 'in_progress', 'high', 'CVE-2023-2454', 'CWE-269',
     'Upgrade PostgreSQL to version 15.3 or apply security patch',
     'OpenVAS', NOW() - INTERVAL '3 days',
     'a0000004-0004-0004-0004-000000000004'::UUID,
     'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb'::UUID,  -- Server Operations
     '22222222-2222-2222-2222-222222222222'::UUID), -- Maria Garcia
    
    ('00000005-0005-0005-0005-000000000005'::UUID,
     'Outdated OpenSSL Version',
     'Server running vulnerable OpenSSL version susceptible to multiple attacks.',
     7.4, 0.38, '10.1.10.50/32', 'db-prod-01.company.local',
     22, 'SSH', 'open', 'high', 'CVE-2023-0286', 'CWE-295',
     'Update OpenSSL to version 3.0.8 or later',
     'OpenVAS', NOW() - INTERVAL '3 days',
     'a0000004-0004-0004-0004-000000000004'::UUID,
     'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb'::UUID,
     '66666666-6666-6666-6666-666666666666'::UUID), -- Carol Martinez
    
    -- Web server vulnerabilities
    ('00000006-0006-0006-0006-000000000006'::UUID,
     'Apache HTTP Server Denial of Service',
     'DoS vulnerability in Apache HTTP Server request parsing.',
     7.5, 0.29, '10.1.20.10/32', 'web-prod-01.company.local',
     80, 'HTTP', 'open', 'high', 'CVE-2023-25690', 'CWE-400',
     'Upgrade Apache to version 2.4.56 or apply patch',
     'Nessus', NOW() - INTERVAL '7 days',
     'a0000005-0005-0005-0005-000000000005'::UUID,
     NULL, NULL),  -- Not yet assigned
    
    ('00000007-0007-0007-0007-000000000007'::UUID,
     'Nginx Path Traversal',
     'Path traversal vulnerability allows reading arbitrary files.',
     5.3, 0.15, '10.1.20.10/32', 'web-prod-01.company.local',
     443, 'HTTPS', 'open', 'medium', 'CVE-2023-44487', 'CWE-22',
     'Upgrade Nginx to version 1.24.0',
     'Nessus', NOW() - INTERVAL '7 days',
     'a0000005-0005-0005-0005-000000000005'::UUID,
     NULL, NULL),
    
    -- Application server vulnerabilities
    ('00000008-0008-0008-0008-000000000008'::UUID,
     'Java Deserialization RCE',
     'Remote code execution via unsafe deserialization in Java application.',
     9.8, 0.91, '10.1.20.20/32', 'app-prod-01.company.local',
     8080, 'HTTP', 'in_progress', 'critical', 'CVE-2023-21930', 'CWE-502',
     'Update Java to version 17.0.7 and sanitize deserialization',
     'Burp Suite', NOW() - INTERVAL '2 days',
     'a0000006-0006-0006-0006-000000000006'::UUID,
     'cccccccc-cccc-cccc-cccc-cccccccccccc'::UUID,  -- Application Security
     '33333333-3333-3333-3333-333333333333'::UUID), -- David Chen
    
    ('00000009-0009-0009-0009-000000000009'::UUID,
     'SQL Injection in API Endpoint',
     'SQL injection vulnerability in /api/users endpoint allows data exfiltration.',
     8.6, 0.73, '10.1.20.20/32', 'app-prod-01.company.local',
     8080, 'HTTP', 'open', 'high', 'CVE-2023-CUSTOM-001', 'CWE-89',
     'Implement parameterized queries and input validation',
     'OWASP ZAP', NOW() - INTERVAL '1 day',
     'a0000006-0006-0006-0006-000000000006'::UUID,
     'cccccccc-cccc-cccc-cccc-cccccccccccc'::UUID,
     '77777777-7777-7777-7777-777777777777'::UUID), -- Dan Kim
    
    -- Wireless AP vulnerabilities
    ('00000010-0010-0010-0010-000000000010'::UUID,
     'WPA2 Weak Encryption Configuration',
     'Wireless access point configured with weak WPA2 settings.',
     5.9, 0.08, '10.2.3.100/32', 'wap-office-fl3.company.local',
     443, 'HTTPS', 'resolved', 'medium', 'CVE-2023-WIFI-001', 'CWE-326',
     'Reconfigure with WPA3 and stronger encryption',
     'Aircrack-ng', NOW() - INTERVAL '14 days',
     'a0000007-0007-0007-0007-000000000007'::UUID,
     'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID,
     '44444444-4444-4444-4444-444444444444'::UUID)
ON CONFLICT (id) DO NOTHING;

-- ==========================================
-- PART 5: Remediation Plans
-- ==========================================

-- Use the first admin user (or any user with admin role) as creator
DO $$
DECLARE
    admin_user_id UUID;
BEGIN
    -- Get first admin user, or create if none exists
    SELECT id INTO admin_user_id FROM users WHERE role = 'admin' LIMIT 1;

    IF admin_user_id IS NULL THEN
        -- No admin exists, use john_smith (team_leader) as fallback
        SELECT id INTO admin_user_id FROM users WHERE id = '11111111-1111-1111-1111-111111111111'::UUID;
    END IF;

    -- Insert remediation plans
    INSERT INTO remediation_plans (
        id, name, description, created_by, assigned_team_id,
        status, priority, due_date, started_at, completed_at
    )
    VALUES
        ('00000001-0001-0001-0001-000000000001'::UUID,
         'Q1 2025 Critical Infrastructure Hardening',
         'Address all critical and high severity vulnerabilities in core network infrastructure',
         admin_user_id,  -- Created by admin
         'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'::UUID,  -- Assigned to Network Infrastructure
         'in_progress', 95, NOW() + INTERVAL '14 days',
         NOW() - INTERVAL '4 days', NULL),

        ('00000002-0002-0002-0002-000000000002'::UUID,
         'Database Security Remediation - January',
         'Patch database servers and update SSL/TLS configurations',
         admin_user_id,
         'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb'::UUID,  -- Server Operations
         'in_progress', 90, NOW() + INTERVAL '7 days',
         NOW() - INTERVAL '2 days', NULL),

        ('00000003-0003-0003-0003-000000000003'::UUID,
         'Application Security Sprint - Week 3',
         'Fix critical RCE and SQL injection vulnerabilities in production app',
         admin_user_id,
         'cccccccc-cccc-cccc-cccc-cccccccccccc'::UUID,  -- Application Security
         'active', 100, NOW() + INTERVAL '5 days',
         NULL, NULL)
    ON CONFLICT (id) DO NOTHING;
END $$;

-- ==========================================
-- PART 6: Comments and Collaboration
-- ==========================================

-- Comments on critical vulnerabilities showing team collaboration
INSERT INTO vulnerability_comments (
    vulnerability_id, user_id, comment_text
)
VALUES
    -- Router RCE discussion
    ('00000001-0001-0001-0001-000000000001'::UUID,
     '11111111-1111-1111-1111-111111111111'::UUID,
     'Coordinating with Cisco TAC for emergency patch. Maintenance window scheduled for Saturday 2AM.'),

    ('00000001-0001-0001-0001-000000000001'::UUID,
     '44444444-4444-4444-4444-444444444444'::UUID,
     'Verified patch compatibility with our current configuration. Ready to proceed.'),

    -- Database privilege escalation
    ('00000004-0004-0004-0004-000000000004'::UUID,
     '22222222-2222-2222-2222-222222222222'::UUID,
     'Testing PostgreSQL upgrade in staging environment. Will deploy to production after successful testing.'),

    ('00000004-0004-0004-0004-000000000004'::UUID,
     '66666666-6666-6666-6666-666666666666'::UUID,
     'Backup completed. Database replication verified. Ready for upgrade.'),

    -- Application RCE
    ('00000008-0008-0008-0008-000000000008'::UUID,
     '33333333-3333-3333-3333-333333333333'::UUID,
     'Code review complete. Identified 3 instances of unsafe deserialization. Patch in development.'),

    ('00000008-0008-0008-0008-000000000008'::UUID,
     '77777777-7777-7777-7777-777777777777'::UUID,
     'Unit tests passing. Deploying to staging for integration testing.')
ON CONFLICT (id) DO NOTHING;

-- ==========================================
-- SUMMARY
-- ==========================================

-- This seed data creates a realistic workflow:
-- 1. Multiple scans imported (Nessus, Qualys, OpenVAS, etc.)
-- 2. Vulnerabilities discovered on different asset types
-- 3. Admin (user 000...001) assigns vulns to appropriate teams
-- 4. Team leaders (John, Maria, David) coordinate remediation
-- 5. Team members collaborate via comments
-- 6. Remediation plans track progress
-- 7. Some vulnerabilities resolved, some in progress, some open

-- Statistics:
-- - 7 Users (1 admin, 3 team leaders, 3 members)
-- - 3 Teams with proper membership
-- - 7 Assets (network devices and servers)
-- - 10 Vulnerabilities (3 critical, 5 high, 2 medium)
-- - 3 Active remediation plans
-- - 6 Collaboration comments
-- - Mix of statuses: 3 resolved, 5 in_progress, 2 open
