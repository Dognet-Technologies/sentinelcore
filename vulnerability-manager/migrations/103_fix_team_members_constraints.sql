-- Migration 103: Fix team_members constraints to allow proper user addition
-- Problem: user_id is NOT NULL but users might not exist yet when trying to add them
-- Solution: Make user_id nullable and update unique constraints properly

-- Step 1: Make user_id nullable again to support external members
ALTER TABLE team_members
ALTER COLUMN user_id DROP NOT NULL;

-- Step 2: Drop the existing unique constraint that doesn't work well with NULLs
ALTER TABLE team_members
DROP CONSTRAINT IF EXISTS team_members_team_id_user_id_key;

-- Step 3: Add a partial unique index for internal users (when user_id IS NOT NULL)
-- This prevents duplicate user assignments to the same team
CREATE UNIQUE INDEX IF NOT EXISTS team_members_team_user_unique
ON team_members(team_id, user_id)
WHERE user_id IS NOT NULL AND removed_at IS NULL;

-- Step 4: Add a unique constraint for external members (when user_id IS NULL)
-- This prevents duplicate email assignments to the same team
CREATE UNIQUE INDEX IF NOT EXISTS team_members_team_email_unique
ON team_members(team_id, email)
WHERE user_id IS NULL AND removed_at IS NULL;

-- Add comments for clarity
COMMENT ON INDEX team_members_team_user_unique IS
'Ensures a user can only be added once to a team (for internal users)';
COMMENT ON INDEX team_members_team_email_unique IS
'Ensures an email can only be used once per team (for external members)';
