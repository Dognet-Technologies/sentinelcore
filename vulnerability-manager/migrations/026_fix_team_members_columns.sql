-- Migration Fix: Team Members Missing Columns
-- Adds missing columns from migration 026 that failed

-- Add missing columns individually (PostgreSQL 9.6+ supports IF NOT EXISTS)
DO $$
BEGIN
    -- Add role column if not exists
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'team_members' AND column_name = 'role'
    ) THEN
        ALTER TABLE team_members ADD COLUMN role VARCHAR(50) DEFAULT 'contributor';
    END IF;

    -- Add joined_at column if not exists
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'team_members' AND column_name = 'joined_at'
    ) THEN
        ALTER TABLE team_members ADD COLUMN joined_at TIMESTAMPTZ DEFAULT NOW();
    END IF;

    -- Add removed_at column if not exists
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'team_members' AND column_name = 'removed_at'
    ) THEN
        ALTER TABLE team_members ADD COLUMN removed_at TIMESTAMPTZ;
    END IF;
END $$;

-- Create missing indexes if they don't exist
CREATE INDEX IF NOT EXISTS idx_team_members_role ON team_members(role);
CREATE INDEX IF NOT EXISTS idx_team_members_active ON team_members(team_id) WHERE removed_at IS NULL;

-- Recreate the view to include all columns
DROP VIEW IF EXISTS active_team_members;
CREATE OR REPLACE VIEW active_team_members AS
SELECT
    tm.id,
    tm.team_id,
    tm.user_id,
    tm.name,
    tm.email,
    tm.role,
    tm.joined_at,
    tm.created_at,
    u.username,
    u.email as user_email,
    u.avatar_url,
    u.reputation_score
FROM team_members tm
LEFT JOIN users u ON tm.user_id = u.id
WHERE tm.removed_at IS NULL;

-- Add comments for clarity
COMMENT ON COLUMN team_members.role IS 'Role within the team: contributor, team_lead, or viewer';
COMMENT ON COLUMN team_members.joined_at IS 'When the user joined the team';
COMMENT ON COLUMN team_members.removed_at IS 'Soft delete timestamp (NULL means active member)';
