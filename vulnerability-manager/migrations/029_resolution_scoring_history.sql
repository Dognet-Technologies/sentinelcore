-- Migration: Resolution Scoring and History
-- Tracks vulnerability resolutions, user performance metrics, and team statistics

-- Table for vulnerability resolution tracking
CREATE TABLE IF NOT EXISTS vulnerability_resolutions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vulnerability_id UUID NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    
    -- Resolution details
    resolved_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    resolved_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    resolution_method VARCHAR(255) NOT NULL,  -- patched, mitigated, accepted, etc.
    resolution_notes TEXT,
    
    -- Timeline metrics
    assigned_at TIMESTAMPTZ NOT NULL,
    resolved_at_actual TIMESTAMPTZ NOT NULL,
    time_to_resolve_hours DECIMAL(10, 2),
    
    -- SLA tracking
    sla_due_date TIMESTAMPTZ,
    sla_met BOOLEAN,
    sla_overdue_hours DECIMAL(10, 2),
    
    -- Verification
    verified_by UUID REFERENCES users(id) ON DELETE SET NULL,
    verified_at TIMESTAMPTZ,
    
    -- Scoring
    resolution_score INTEGER DEFAULT 0,  -- Points earned for resolution
    quality_rating INTEGER,  -- 1-5 rating
    quality_notes TEXT,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table for user resolution statistics
CREATE TABLE IF NOT EXISTS user_resolution_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    
    -- Counters
    total_resolutions INTEGER DEFAULT 0,
    verified_resolutions INTEGER DEFAULT 0,
    unverified_resolutions INTEGER DEFAULT 0,
    
    -- Scoring
    total_resolution_score INTEGER DEFAULT 0,
    average_resolution_score DECIMAL(10, 2) DEFAULT 0,
    
    -- Time metrics
    average_time_to_resolve_hours DECIMAL(10, 2) DEFAULT 0,
    fastest_resolution_hours DECIMAL(10, 2),
    slowest_resolution_hours DECIMAL(10, 2),
    
    -- SLA metrics
    sla_met_count INTEGER DEFAULT 0,
    sla_missed_count INTEGER DEFAULT 0,
    sla_compliance_percentage DECIMAL(5, 2) DEFAULT 0,
    
    -- Quality metrics
    average_quality_rating DECIMAL(3, 2) DEFAULT 0,
    high_quality_resolutions INTEGER DEFAULT 0,  -- rating >= 4
    
    -- Streak tracking
    current_resolution_streak INTEGER DEFAULT 0,
    max_resolution_streak INTEGER DEFAULT 0,
    
    -- Period tracking
    resolutions_this_month INTEGER DEFAULT 0,
    resolutions_this_quarter INTEGER DEFAULT 0,
    
    last_updated TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table for team resolution statistics
CREATE TABLE IF NOT EXISTS team_resolution_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    team_id UUID NOT NULL UNIQUE REFERENCES teams(id) ON DELETE CASCADE,
    
    -- Counters
    total_resolutions INTEGER DEFAULT 0,
    verified_resolutions INTEGER DEFAULT 0,
    
    -- Scoring
    total_team_resolution_score INTEGER DEFAULT 0,
    average_resolution_score DECIMAL(10, 2) DEFAULT 0,
    
    -- Time metrics
    average_time_to_resolve_hours DECIMAL(10, 2) DEFAULT 0,
    
    -- SLA metrics
    sla_met_count INTEGER DEFAULT 0,
    sla_missed_count INTEGER DEFAULT 0,
    sla_compliance_percentage DECIMAL(5, 2) DEFAULT 0,
    
    -- Quality metrics
    average_quality_rating DECIMAL(3, 2) DEFAULT 0,
    
    -- Member stats
    active_contributors INTEGER DEFAULT 0,
    top_performer_user_id UUID,
    
    resolutions_this_month INTEGER DEFAULT 0,
    resolutions_this_quarter INTEGER DEFAULT 0,
    
    last_updated TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table for daily/weekly/monthly resolution activity
CREATE TABLE IF NOT EXISTS resolution_activity (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    team_id UUID REFERENCES teams(id) ON DELETE CASCADE,
    
    activity_date DATE NOT NULL,
    activity_type VARCHAR(50) NOT NULL,  -- resolution, verification, quality_improvement
    count INTEGER DEFAULT 1,
    score_earned INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_vulnerability_resolutions_vuln_id ON vulnerability_resolutions(vulnerability_id);
CREATE INDEX IF NOT EXISTS idx_vulnerability_resolutions_resolved_by ON vulnerability_resolutions(resolved_by);
CREATE INDEX IF NOT EXISTS idx_vulnerability_resolutions_verified_by ON vulnerability_resolutions(verified_by);
CREATE INDEX IF NOT EXISTS idx_vulnerability_resolutions_resolved_at ON vulnerability_resolutions(resolved_at);
CREATE INDEX IF NOT EXISTS idx_vulnerability_resolutions_sla_met ON vulnerability_resolutions(sla_met);
CREATE INDEX IF NOT EXISTS idx_user_resolution_stats_user_id ON user_resolution_stats(user_id);
CREATE INDEX IF NOT EXISTS idx_user_resolution_stats_score ON user_resolution_stats(total_resolution_score DESC);
CREATE INDEX IF NOT EXISTS idx_team_resolution_stats_team_id ON team_resolution_stats(team_id);
CREATE INDEX IF NOT EXISTS idx_team_resolution_stats_score ON team_resolution_stats(total_team_resolution_score DESC);
CREATE INDEX IF NOT EXISTS idx_resolution_activity_user_id ON resolution_activity(user_id, activity_date);
CREATE INDEX IF NOT EXISTS idx_resolution_activity_team_id ON resolution_activity(team_id, activity_date);

-- Create view for user resolution leaderboard
CREATE OR REPLACE VIEW resolution_leaderboard AS
SELECT 
    u.id,
    u.username,
    u.avatar_url,
    urs.total_resolutions,
    urs.verified_resolutions,
    urs.total_resolution_score,
    urs.average_resolution_score,
    urs.average_time_to_resolve_hours,
    urs.sla_compliance_percentage,
    urs.average_quality_rating,
    urs.current_resolution_streak,
    ROW_NUMBER() OVER (ORDER BY urs.total_resolution_score DESC) as rank
FROM user_resolution_stats urs
JOIN users u ON urs.user_id = u.id
WHERE u.id IS NOT NULL
ORDER BY urs.total_resolution_score DESC;

-- Create view for team resolution leaderboard
CREATE OR REPLACE VIEW team_resolution_leaderboard AS
SELECT 
    t.id,
    t.name,
    trs.total_resolutions,
    trs.verified_resolutions,
    trs.total_team_resolution_score,
    trs.average_resolution_score,
    trs.average_time_to_resolve_hours,
    trs.sla_compliance_percentage,
    trs.average_quality_rating,
    trs.active_contributors,
    ROW_NUMBER() OVER (ORDER BY trs.total_team_resolution_score DESC) as rank
FROM team_resolution_stats trs
JOIN teams t ON trs.team_id = t.id
ORDER BY trs.total_team_resolution_score DESC;

COMMENT ON TABLE vulnerability_resolutions IS 'Tracks each vulnerability resolution with metrics';
COMMENT ON TABLE user_resolution_stats IS 'Aggregated user resolution statistics and performance';
COMMENT ON TABLE team_resolution_stats IS 'Aggregated team resolution statistics';
COMMENT ON TABLE resolution_activity IS 'Daily/weekly activity log for trending';
