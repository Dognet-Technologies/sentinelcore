-- Migration: Compliance Reporting System
-- Description: Tables for compliance report generation and storage (PCI-DSS, ISO 27001, SOC2, HIPAA)
-- Author: SentinelCore Team
-- Date: 2024-12-12

-- Table: compliance_reports
-- Purpose: Store generated compliance reports with metadata and scores
CREATE TABLE IF NOT EXISTS compliance_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    framework VARCHAR(50) NOT NULL,
    version VARCHAR(20),
    status VARCHAR(50) NOT NULL DEFAULT 'draft',
    scope JSONB DEFAULT '[]',
    score DECIMAL(5,2) NOT NULL DEFAULT 0.00,
    total_controls INTEGER NOT NULL DEFAULT 0,
    passed_controls INTEGER NOT NULL DEFAULT 0,
    failed_controls INTEGER NOT NULL DEFAULT 0,
    findings INTEGER NOT NULL DEFAULT 0,
    critical_findings INTEGER NOT NULL DEFAULT 0,
    high_findings INTEGER NOT NULL DEFAULT 0,
    medium_findings INTEGER NOT NULL DEFAULT 0,
    low_findings INTEGER NOT NULL DEFAULT 0,
    report_data JSONB NOT NULL DEFAULT '{}',
    generated_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    generated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    valid_from TIMESTAMPTZ,
    valid_to TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table: compliance_findings
-- Purpose: Store individual compliance findings linked to vulnerabilities
CREATE TABLE IF NOT EXISTS compliance_findings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    report_id UUID NOT NULL REFERENCES compliance_reports(id) ON DELETE CASCADE,
    control_id VARCHAR(100) NOT NULL,
    control_name TEXT NOT NULL,
    control_description TEXT,
    status VARCHAR(50) NOT NULL,
    vulnerabilities INTEGER NOT NULL DEFAULT 0,
    vulnerability_ids UUID[] DEFAULT '{}',
    severity VARCHAR(50) NOT NULL DEFAULT 'info',
    evidence TEXT,
    recommendation TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table: compliance_frameworks
-- Purpose: Define compliance frameworks with controls and requirements
CREATE TABLE IF NOT EXISTS compliance_frameworks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL UNIQUE,
    version VARCHAR(20),
    description TEXT,
    controls JSONB NOT NULL DEFAULT '[]',
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_compliance_reports_framework ON compliance_reports(framework);
CREATE INDEX IF NOT EXISTS idx_compliance_reports_status ON compliance_reports(status);
CREATE INDEX IF NOT EXISTS idx_compliance_reports_generated_by ON compliance_reports(generated_by);
CREATE INDEX IF NOT EXISTS idx_compliance_reports_generated_at ON compliance_reports(generated_at DESC);
CREATE INDEX IF NOT EXISTS idx_compliance_findings_report_id ON compliance_findings(report_id);
CREATE INDEX IF NOT EXISTS idx_compliance_findings_control_id ON compliance_findings(control_id);
CREATE INDEX IF NOT EXISTS idx_compliance_findings_status ON compliance_findings(status);
CREATE INDEX IF NOT EXISTS idx_compliance_frameworks_name ON compliance_frameworks(name);

-- Comments for documentation
COMMENT ON TABLE compliance_reports IS 'Compliance assessment reports for various frameworks (PCI-DSS, ISO 27001, SOC2, HIPAA)';
COMMENT ON COLUMN compliance_reports.framework IS 'Compliance framework name (e.g., PCI-DSS, ISO27001, SOC2, HIPAA)';
COMMENT ON COLUMN compliance_reports.score IS 'Overall compliance score (0-100)';
COMMENT ON COLUMN compliance_reports.scope IS 'Assets or systems included in this compliance assessment';
COMMENT ON COLUMN compliance_reports.report_data IS 'Full report data including executive summary and detailed findings';

COMMENT ON TABLE compliance_findings IS 'Individual compliance control findings with vulnerability mappings';
COMMENT ON COLUMN compliance_findings.control_id IS 'Compliance control identifier (e.g., PCI-DSS 6.2, ISO 27001 A.12.6.1)';
COMMENT ON COLUMN compliance_findings.vulnerability_ids IS 'Array of vulnerability UUIDs that violate this control';

COMMENT ON TABLE compliance_frameworks IS 'Compliance framework definitions with controls and requirements';

-- Seed basic compliance frameworks
INSERT INTO compliance_frameworks (name, version, description, controls, is_active) VALUES
('PCI-DSS', '4.0', 'Payment Card Industry Data Security Standard', '[]'::jsonb, true),
('ISO27001', '2022', 'ISO/IEC 27001 Information Security Management', '[]'::jsonb, true),
('SOC2', 'Type II', 'Service Organization Control 2', '[]'::jsonb, true),
('HIPAA', '2023', 'Health Insurance Portability and Accountability Act', '[]'::jsonb, true)
ON CONFLICT (name) DO NOTHING;
