-- Migration: System Metadata Table
-- Description: Key-value store for system-wide metadata and tracking information
-- Author: SentinelCore Team
-- Date: 2024-12-12

-- Table: system_metadata
-- Purpose: Store system-wide metadata like last update timestamps, API sync status, etc.
CREATE TABLE IF NOT EXISTS system_metadata (
    key VARCHAR(255) PRIMARY KEY,
    value TEXT NOT NULL,
    description TEXT,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create index for performance
CREATE INDEX IF NOT EXISTS idx_system_metadata_updated_at ON system_metadata(updated_at DESC);

-- Comments for documentation
COMMENT ON TABLE system_metadata IS 'System-wide metadata and configuration values';
COMMENT ON COLUMN system_metadata.key IS 'Unique identifier for the metadata entry (e.g., last_epss_update, last_nvd_sync)';
COMMENT ON COLUMN system_metadata.value IS 'Metadata value stored as text';
COMMENT ON COLUMN system_metadata.description IS 'Human-readable description of what this metadata represents';

-- Seed initial metadata entries
INSERT INTO system_metadata (key, value, description) VALUES
('last_epss_update', '1970-01-01T00:00:00Z', 'Timestamp of last EPSS score update'),
('last_nvd_sync', '1970-01-01T00:00:00Z', 'Timestamp of last NVD CVE database sync'),
('system_version', '1.0.0', 'Current system version'),
('database_version', '020', 'Current database migration version')
ON CONFLICT (key) DO NOTHING;
