-- Migration: Convert ip_address fields from VARCHAR to INET
-- File: migrations/002_convert_to_inet.sql

-- Convert user_sessions.ip_address to INET
ALTER TABLE user_sessions 
ALTER COLUMN ip_address TYPE INET USING ip_address::INET;

-- Convert audit_logs.ip_address to INET (if exists)
DO $$ 
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.columns 
               WHERE table_name = 'audit_logs' AND column_name = 'ip_address') THEN
        ALTER TABLE audit_logs 
        ALTER COLUMN ip_address TYPE INET USING ip_address::INET;
    END IF;
END $$;

-- Convert vulnerabilities.ip_address to INET
ALTER TABLE vulnerabilities 
ALTER COLUMN ip_address TYPE INET USING ip_address::INET;

-- Convert assets.ip_address to INET (if exists)
DO $$ 
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.columns 
               WHERE table_name = 'assets' AND column_name = 'ip_address') THEN
        ALTER TABLE assets 
        ALTER COLUMN ip_address TYPE INET USING ip_address::INET;
    END IF;
END $$;

-- Convert ip_whitelist.ip_address to INET (if table exists)
DO $$ 
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables 
               WHERE table_name = 'ip_whitelist') THEN
        ALTER TABLE ip_whitelist 
        ALTER COLUMN ip_address TYPE INET USING ip_address::INET;
    END IF;
END $$;

-- Add helpful comment
COMMENT ON COLUMN user_sessions.ip_address IS 'Client IP address stored as INET type for network operations';
COMMENT ON COLUMN vulnerabilities.ip_address IS 'Target IP address stored as INET type for network operations';

-- Create index for better performance on IP queries
CREATE INDEX IF NOT EXISTS idx_user_sessions_ip_address ON user_sessions USING gist (ip_address inet_ops);
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_ip_address ON vulnerabilities USING gist (ip_address inet_ops);