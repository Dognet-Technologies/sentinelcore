-- Optional features tables (notification settings, API keys, device vulnerabilities)
-- These are used by some handlers but are not critical for core functionality

-- User notification settings
CREATE TABLE IF NOT EXISTS user_notification_settings (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    email_enabled BOOLEAN NOT NULL DEFAULT true,
    push_enabled BOOLEAN NOT NULL DEFAULT false,
    critical_alerts BOOLEAN NOT NULL DEFAULT true,
    weekly_report BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- User API keys for programmatic access
CREATE TABLE IF NOT EXISTS user_api_keys (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    key_hash VARCHAR(255) NOT NULL,
    key_prefix VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    last_used_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    UNIQUE(key_hash)
);

CREATE INDEX IF NOT EXISTS idx_user_api_keys_user_id ON user_api_keys(user_id);
CREATE INDEX IF NOT EXISTS idx_user_api_keys_key_prefix ON user_api_keys(key_prefix);

-- Device vulnerabilities for network scanning feature
CREATE TABLE IF NOT EXISTS device_vulnerabilities (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    device_id UUID REFERENCES assets(id) ON DELETE CASCADE,
    vulnerability_id UUID REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    remediation_status VARCHAR(50) DEFAULT 'open',
    remediated_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(device_id, vulnerability_id)
);

-- Add remediation_status column if it doesn't exist (for existing tables)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'device_vulnerabilities'
        AND column_name = 'remediation_status'
    ) THEN
        ALTER TABLE device_vulnerabilities
        ADD COLUMN remediation_status VARCHAR(50) DEFAULT 'open';
    END IF;
END $$;

-- Add remediated_at column if it doesn't exist (for existing tables)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'device_vulnerabilities'
        AND column_name = 'remediated_at'
    ) THEN
        ALTER TABLE device_vulnerabilities
        ADD COLUMN remediated_at TIMESTAMPTZ;
    END IF;
END $$;

CREATE INDEX IF NOT EXISTS idx_device_vulnerabilities_device_id ON device_vulnerabilities(device_id);
CREATE INDEX IF NOT EXISTS idx_device_vulnerabilities_vuln_id ON device_vulnerabilities(vulnerability_id);
CREATE INDEX IF NOT EXISTS idx_device_vulnerabilities_status ON device_vulnerabilities(remediation_status);
