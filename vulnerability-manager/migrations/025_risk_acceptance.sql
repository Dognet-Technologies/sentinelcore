-- Migration: Risk Acceptance Workflow
-- Enables documented risk acceptance with approval and expiration tracking

CREATE TABLE IF NOT EXISTS risk_acceptances (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vulnerability_id UUID NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    
    -- Acceptance details
    accepted_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    accepted_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    -- Justification and controls
    justification TEXT NOT NULL,
    mitigating_controls TEXT NOT NULL,
    
    -- Approval workflow
    approval_status VARCHAR(50) NOT NULL DEFAULT 'pending',  -- pending, approved, rejected
    approved_by UUID REFERENCES users(id) ON DELETE SET NULL,
    approval_comment TEXT,
    approved_at TIMESTAMPTZ,
    
    -- Risk acceptance period
    valid_from TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    expires_at TIMESTAMPTZ NOT NULL,  -- Mandatory expiration date
    renewal_reminder_sent BOOLEAN DEFAULT false,
    renewal_reminder_sent_at TIMESTAMPTZ,
    
    -- Audit and tracking
    requires_quarterly_review BOOLEAN DEFAULT true,
    last_review_date TIMESTAMPTZ,
    next_review_date TIMESTAMPTZ,
    review_notes TEXT,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table for risk acceptance approval history
CREATE TABLE IF NOT EXISTS risk_acceptance_approvals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    risk_acceptance_id UUID NOT NULL REFERENCES risk_acceptances(id) ON DELETE CASCADE,
    
    -- Approver information
    approver_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    approver_role VARCHAR(100) NOT NULL,  -- e.g., 'CISO', 'Security Manager', 'Team Leader'
    
    -- Approval decision
    status VARCHAR(50) NOT NULL,  -- approved, rejected, pending
    comment TEXT,
    approved_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table for risk acceptance review cycles
CREATE TABLE IF NOT EXISTS risk_acceptance_reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    risk_acceptance_id UUID NOT NULL REFERENCES risk_acceptances(id) ON DELETE CASCADE,
    
    -- Review information
    reviewed_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    reviewed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    -- Review decision
    decision VARCHAR(50) NOT NULL,  -- renew, renew_with_conditions, revoke, escalate
    decision_notes TEXT,
    
    -- Next review schedule
    next_review_date TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_risk_acceptances_vuln_id ON risk_acceptances(vulnerability_id);
CREATE INDEX IF NOT EXISTS idx_risk_acceptances_accepted_by ON risk_acceptances(accepted_by);
CREATE INDEX IF NOT EXISTS idx_risk_acceptances_approval_status ON risk_acceptances(approval_status);
CREATE INDEX IF NOT EXISTS idx_risk_acceptances_expires_at ON risk_acceptances(expires_at);
CREATE INDEX IF NOT EXISTS idx_risk_acceptances_next_review ON risk_acceptances(next_review_date);
CREATE INDEX IF NOT EXISTS idx_risk_acceptance_approvals_acceptance_id ON risk_acceptance_approvals(risk_acceptance_id);
CREATE INDEX IF NOT EXISTS idx_risk_acceptance_approvals_approver_id ON risk_acceptance_approvals(approver_id);
CREATE INDEX IF NOT EXISTS idx_risk_acceptance_approvals_status ON risk_acceptance_approvals(status);
CREATE INDEX IF NOT EXISTS idx_risk_acceptance_reviews_acceptance_id ON risk_acceptance_reviews(risk_acceptance_id);
CREATE INDEX IF NOT EXISTS idx_risk_acceptance_reviews_reviewed_by ON risk_acceptance_reviews(reviewed_by);

-- Comments for documentation
COMMENT ON TABLE risk_acceptances IS 'Documented risk acceptance for vulnerabilities that cannot be remediated';
COMMENT ON COLUMN risk_acceptances.justification IS 'Business justification for accepting the risk';
COMMENT ON COLUMN risk_acceptances.mitigating_controls IS 'Compensating controls deployed to mitigate the risk';
COMMENT ON COLUMN risk_acceptances.approval_status IS 'Status of the approval workflow (pending, approved, rejected)';
COMMENT ON COLUMN risk_acceptances.expires_at IS 'Mandatory expiration date - acceptance must be renewed or revoked';
COMMENT ON COLUMN risk_acceptances.requires_quarterly_review IS 'Whether this risk acceptance requires quarterly review';
COMMENT ON TABLE risk_acceptance_approvals IS 'Approval chain for risk acceptance (CISO, etc.)';
COMMENT ON TABLE risk_acceptance_reviews IS 'Periodic reviews and renewals of risk acceptances';
