-- Migration: SOAR Webhook Integration
-- Description: Tables for SOAR webhook automation (Splunk SOAR, Cortex XSOAR, Sentinel)
-- Author: SentinelCore Team
-- Date: 2024-12-12

-- Table: soar_webhooks
-- Purpose: Store webhook configurations for SOAR platform integrations
CREATE TABLE IF NOT EXISTS soar_webhooks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    url TEXT NOT NULL,
    method VARCHAR(10) NOT NULL DEFAULT 'POST',
    headers JSONB DEFAULT '{}',
    payload_template TEXT NOT NULL,
    trigger_on TEXT[] NOT NULL DEFAULT '{}',
    is_enabled BOOLEAN NOT NULL DEFAULT true,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Table: soar_webhook_executions
-- Purpose: Log webhook execution history for debugging and audit
CREATE TABLE IF NOT EXISTS soar_webhook_executions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    webhook_id UUID NOT NULL REFERENCES soar_webhooks(id) ON DELETE CASCADE,
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB,
    request_payload TEXT,
    response_status INTEGER,
    response_body TEXT,
    error_message TEXT,
    execution_time_ms INTEGER,
    executed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_soar_webhooks_enabled ON soar_webhooks(is_enabled);
CREATE INDEX IF NOT EXISTS idx_soar_webhooks_created_by ON soar_webhooks(created_by);
CREATE INDEX IF NOT EXISTS idx_soar_webhook_executions_webhook_id ON soar_webhook_executions(webhook_id);
CREATE INDEX IF NOT EXISTS idx_soar_webhook_executions_event_type ON soar_webhook_executions(event_type);
CREATE INDEX IF NOT EXISTS idx_soar_webhook_executions_executed_at ON soar_webhook_executions(executed_at DESC);

-- Comments for documentation
COMMENT ON TABLE soar_webhooks IS 'SOAR webhook configurations for automation platforms (Splunk SOAR, Cortex XSOAR, Sentinel)';
COMMENT ON COLUMN soar_webhooks.trigger_on IS 'Array of event types that trigger this webhook (e.g., vulnerability_created, sla_breach)';
COMMENT ON COLUMN soar_webhooks.payload_template IS 'Jinja2-style template for webhook payload with variable substitution';
COMMENT ON COLUMN soar_webhooks.headers IS 'Custom HTTP headers for webhook requests (e.g., Authorization, Content-Type)';

COMMENT ON TABLE soar_webhook_executions IS 'Execution history and logs for SOAR webhook calls';
COMMENT ON COLUMN soar_webhook_executions.execution_time_ms IS 'Time taken to execute webhook in milliseconds';
