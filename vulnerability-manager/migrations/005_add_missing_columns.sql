-- Migration 005: Add Missing Columns for Model Compatibility
-- Adds columns that Rust models expect but weren't in previous migrations

-- ============================================
-- 1. Add phone_number to users table
-- ============================================

ALTER TABLE users
ADD COLUMN IF NOT EXISTS phone_number VARCHAR(20);

COMMENT ON COLUMN users.phone_number IS 'User phone number for contact and 2FA SMS';

-- ============================================
-- 2. Add device_info and last_activity to user_sessions
-- ============================================

ALTER TABLE user_sessions
ADD COLUMN IF NOT EXISTS device_info JSONB,
ADD COLUMN IF NOT EXISTS last_activity TIMESTAMP DEFAULT NOW();

COMMENT ON COLUMN user_sessions.device_info IS 'Device information JSON (browser, OS, device type)';
COMMENT ON COLUMN user_sessions.last_activity IS 'Last activity timestamp for session timeout tracking';

-- ============================================
-- 3. Add bio column to users (referenced in models)
-- ============================================

ALTER TABLE users
ADD COLUMN IF NOT EXISTS bio TEXT;

COMMENT ON COLUMN users.bio IS 'User biography or description';

-- ============================================
-- 4. Create index on last_activity for session cleanup
-- ============================================

CREATE INDEX IF NOT EXISTS idx_user_sessions_last_activity ON user_sessions(last_activity);

-- ============================================
-- 5. Update existing sessions with last_activity
-- ============================================

UPDATE user_sessions
SET last_activity = created_at
WHERE last_activity IS NULL;
