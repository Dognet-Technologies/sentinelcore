-- Migration: Password Expiration Policy
-- Enables configurable password expiration and policy enforcement

-- Add password expiration columns to users table
ALTER TABLE users
    ADD COLUMN IF NOT EXISTS last_password_change TIMESTAMPTZ DEFAULT NOW(),
    ADD COLUMN IF NOT EXISTS password_expires_at TIMESTAMPTZ,
    ADD COLUMN IF NOT EXISTS requires_password_change BOOLEAN DEFAULT false;

-- Create system-wide password policy table
CREATE TABLE IF NOT EXISTS password_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Policy settings
    policy_name VARCHAR(255) NOT NULL,
    enabled BOOLEAN DEFAULT true,
    
    -- Expiration settings
    password_expiration_days INTEGER DEFAULT 90,
    password_warning_days INTEGER DEFAULT 14,
    max_password_age INTEGER DEFAULT 180,
    
    -- Complexity requirements
    min_length INTEGER DEFAULT 8,
    max_length INTEGER DEFAULT 128,
    require_uppercase BOOLEAN DEFAULT true,
    require_lowercase BOOLEAN DEFAULT true,
    require_numbers BOOLEAN DEFAULT true,
    require_special_chars BOOLEAN DEFAULT true,
    
    -- History and reuse prevention
    password_history_count INTEGER DEFAULT 5,
    prevent_password_reuse BOOLEAN DEFAULT true,
    
    -- Lockout policy
    failed_login_attempts_allowed INTEGER DEFAULT 5,
    lockout_duration_minutes INTEGER DEFAULT 15,
    
    -- Session policy
    session_timeout_minutes INTEGER DEFAULT 30,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create per-user policy overrides
CREATE TABLE IF NOT EXISTS user_password_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    password_policy_id UUID NOT NULL REFERENCES password_policies(id) ON DELETE RESTRICT,
    
    -- User-specific overrides (NULL means use policy default)
    password_expiration_days_override INTEGER,
    password_warning_days_override INTEGER,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create password history table for preventing reuse
CREATE TABLE IF NOT EXISTS password_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    password_hash VARCHAR(255) NOT NULL,
    set_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_password_policies_enabled ON password_policies(enabled);
CREATE INDEX IF NOT EXISTS idx_user_password_policies_user_id ON user_password_policies(user_id);
CREATE INDEX IF NOT EXISTS idx_user_password_policies_policy_id ON user_password_policies(password_policy_id);
CREATE INDEX IF NOT EXISTS idx_password_history_user_id ON password_history(user_id);
CREATE INDEX IF NOT EXISTS idx_password_history_set_at ON password_history(set_at);
CREATE INDEX IF NOT EXISTS idx_users_requires_password_change ON users(requires_password_change) WHERE requires_password_change = true;

-- Create view for active password policy
CREATE OR REPLACE VIEW user_effective_password_policy AS
SELECT 
    u.id as user_id,
    COALESCE(upp.password_expiration_days_override, pp.password_expiration_days, 90) as password_expiration_days,
    COALESCE(upp.password_warning_days_override, pp.password_warning_days, 14) as password_warning_days,
    pp.password_history_count,
    pp.failed_login_attempts_allowed,
    pp.lockout_duration_minutes,
    pp.session_timeout_minutes,
    u.last_password_change,
    u.password_expires_at,
    u.requires_password_change
FROM users u
LEFT JOIN user_password_policies upp ON u.id = upp.user_id
LEFT JOIN password_policies pp ON upp.password_policy_id = pp.id OR pp.enabled = true
WHERE pp.id IS NOT NULL OR pp.id IS NULL;

-- Insert default password policy
INSERT INTO password_policies (
    policy_name,
    enabled,
    password_expiration_days,
    password_warning_days,
    min_length,
    require_uppercase,
    require_lowercase,
    require_numbers,
    require_special_chars,
    password_history_count,
    failed_login_attempts_allowed
) VALUES (
    'Default Policy',
    true,
    90,
    14,
    8,
    true,
    true,
    true,
    true,
    5,
    5
) ON CONFLICT DO NOTHING;

COMMENT ON TABLE password_policies IS 'System-wide password policies';
COMMENT ON TABLE user_password_policies IS 'Per-user policy overrides';
COMMENT ON TABLE password_history IS 'Password history for preventing reuse';
COMMENT ON COLUMN users.last_password_change IS 'When user last changed password';
COMMENT ON COLUMN users.password_expires_at IS 'When user password will expire';
COMMENT ON COLUMN users.requires_password_change IS 'Force user to change password on next login';
