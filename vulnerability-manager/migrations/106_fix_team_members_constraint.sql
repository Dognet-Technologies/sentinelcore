-- Migration 106: Fix team_members constraints for ON CONFLICT
-- This ensures the correct UNIQUE constraint exists for upsert operations

-- Step 1: Drop existing constraint if it exists (might be malformed)
ALTER TABLE team_members
DROP CONSTRAINT IF EXISTS team_members_team_user_unique;

-- Step 2: Drop old index if exists
DROP INDEX IF EXISTS idx_team_members_team_user;

-- Step 3: Recreate the UNIQUE constraint properly
ALTER TABLE team_members
ADD CONSTRAINT team_members_team_user_unique
UNIQUE (team_id, user_id);

-- Step 4: Create index for performance
CREATE INDEX idx_team_members_team_user
ON team_members(team_id, user_id);

-- Verify the constraint exists
DO $$
DECLARE
    constraint_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO constraint_count
    FROM pg_constraint
    WHERE conname = 'team_members_team_user_unique';

    IF constraint_count = 0 THEN
        RAISE EXCEPTION 'Constraint team_members_team_user_unique was not created!';
    ELSE
        RAISE NOTICE 'Constraint team_members_team_user_unique created successfully';
    END IF;
END $$;
