-- Migration 107: Network Discovery Settings
-- Create network_ranges table for configurable network scanning

-- Table for configured network ranges to scan
CREATE TABLE IF NOT EXISTS network_ranges (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    network_range CIDR NOT NULL UNIQUE,
    description TEXT,
    is_local_network BOOLEAN DEFAULT FALSE,
    enabled BOOLEAN DEFAULT TRUE,
    last_scan_at TIMESTAMPTZ,
    last_ping_scan_at TIMESTAMPTZ,
    last_deep_scan_at TIMESTAMPTZ,
    hosts_found INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Index for faster queries
CREATE INDEX IF NOT EXISTS idx_network_ranges_enabled ON network_ranges(enabled) WHERE enabled = TRUE;
CREATE INDEX IF NOT EXISTS idx_network_ranges_local ON network_ranges(is_local_network) WHERE is_local_network = TRUE;

-- Comments
COMMENT ON TABLE network_ranges IS 'Network ranges configured for automatic discovery scanning';
COMMENT ON COLUMN network_ranges.network_range IS 'Network range in CIDR notation (e.g., 192.168.1.0/24)';
COMMENT ON COLUMN network_ranges.is_local_network IS 'TRUE if this is the local network where SentinelCore is running';
COMMENT ON COLUMN network_ranges.last_scan_at IS 'Timestamp of last scan (ping or deep)';
COMMENT ON COLUMN network_ranges.last_ping_scan_at IS 'Timestamp of last ping scan (host discovery)';
COMMENT ON COLUMN network_ranges.last_deep_scan_at IS 'Timestamp of last deep scan (port + service detection)';
COMMENT ON COLUMN network_ranges.hosts_found IS 'Number of hosts discovered in this network during last scan';

-- Add system settings for scan scheduling
INSERT INTO system_settings (setting_key, setting_value, description)
VALUES
    ('network_discovery.ping_interval_minutes', '60', 'Interval in minutes between ping scans for host discovery (default: 60)')
ON CONFLICT (setting_key) DO NOTHING;

INSERT INTO system_settings (setting_key, setting_value, description)
VALUES
    ('network_discovery.deep_scan_hour', '2', 'Hour of day (0-23) to run daily deep scan (default: 2 = 02:00)')
ON CONFLICT (setting_key) DO NOTHING;

INSERT INTO system_settings (setting_key, setting_value, description)
VALUES
    ('network_discovery.auto_scan_enabled', 'true', 'Enable/disable automatic network scanning (default: true)')
ON CONFLICT (setting_key) DO NOTHING;

INSERT INTO system_settings (setting_key, setting_value, description)
VALUES
    ('network_discovery.offline_threshold_days', '7', 'Days after last_seen before marking device as offline (default: 7)')
ON CONFLICT (setting_key) DO NOTHING;

-- Trigger to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_network_ranges_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_network_ranges_updated_at
    BEFORE UPDATE ON network_ranges
    FOR EACH ROW
    EXECUTE FUNCTION update_network_ranges_updated_at();
