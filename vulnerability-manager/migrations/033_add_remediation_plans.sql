-- Create remediation_plans table
CREATE TABLE IF NOT EXISTS remediation_plans (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    assigned_team_id UUID REFERENCES teams(id) ON DELETE SET NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'draft',
    priority INTEGER NOT NULL DEFAULT 50 CHECK (priority >= 0 AND priority <= 100),
    due_date TIMESTAMPTZ,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_remediation_plans_created_by ON remediation_plans(created_by);
CREATE INDEX IF NOT EXISTS idx_remediation_plans_assigned_team_id ON remediation_plans(assigned_team_id);
CREATE INDEX IF NOT EXISTS idx_remediation_plans_status ON remediation_plans(status);
CREATE INDEX IF NOT EXISTS idx_remediation_plans_priority ON remediation_plans(priority);
CREATE INDEX IF NOT EXISTS idx_remediation_plans_due_date ON remediation_plans(due_date);

-- Create updated_at trigger
CREATE TRIGGER update_remediation_plans_updated_at
    BEFORE UPDATE ON remediation_plans
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Add comments
COMMENT ON TABLE remediation_plans IS 'Tracks remediation plans for addressing vulnerabilities';
COMMENT ON COLUMN remediation_plans.status IS 'Status: draft, active, in_progress, completed, cancelled';
COMMENT ON COLUMN remediation_plans.priority IS 'Priority level from 0-100, higher is more important';
