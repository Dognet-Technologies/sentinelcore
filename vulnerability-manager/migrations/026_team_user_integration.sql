-- Migration: Team User Integration
-- Links users to teams with role-based membership

-- Add columns to team_members to support user assignments
ALTER TABLE team_members
    ADD COLUMN user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    ADD COLUMN role VARCHAR(50) DEFAULT 'contributor',  -- contributor, team_lead, viewer
    ADD COLUMN joined_at TIMESTAMPTZ DEFAULT NOW(),
    ADD COLUMN removed_at TIMESTAMPTZ;

-- Create index for user-team relationships
CREATE INDEX IF NOT EXISTS idx_team_members_user_id ON team_members(user_id);
CREATE INDEX IF NOT EXISTS idx_team_members_team_user ON team_members(team_id, user_id);
CREATE INDEX IF NOT EXISTS idx_team_members_role ON team_members(role);
CREATE INDEX IF NOT EXISTS idx_team_members_active ON team_members(team_id) WHERE removed_at IS NULL;

-- Create view for active team members (excluding soft-deleted)
CREATE OR REPLACE VIEW active_team_members AS
SELECT 
    tm.id,
    tm.team_id,
    tm.user_id,
    tm.name,
    tm.email,
    tm.role,
    tm.joined_at,
    tm.created_at,
    u.username,
    u.email as user_email,
    u.avatar_url,
    u.reputation_score
FROM team_members tm
LEFT JOIN users u ON tm.user_id = u.id
WHERE tm.removed_at IS NULL;

-- Add comment for clarity
COMMENT ON COLUMN team_members.user_id IS 'Reference to the actual user in the system';
COMMENT ON COLUMN team_members.role IS 'Role within the team: contributor, team_lead, or viewer';
COMMENT ON COLUMN team_members.joined_at IS 'When the user joined the team';
COMMENT ON COLUMN team_members.removed_at IS 'Soft delete timestamp (NULL means active member)';
