-- Migration: Add skills to users and teams for auto-assignment
-- Enables skill-based vulnerability assignment and skip email verification

-- Add skills column to users table
ALTER TABLE users ADD COLUMN IF NOT EXISTS skills TEXT[] DEFAULT '{}';

-- Add skills column to teams table
ALTER TABLE teams ADD COLUMN IF NOT EXISTS skills TEXT[] DEFAULT '{}';

-- Add skip_email_verification flag to track if email was verified on creation
ALTER TABLE users ADD COLUMN IF NOT EXISTS email_verification_skipped BOOLEAN DEFAULT false;

-- Create indexes for skills-based queries
CREATE INDEX IF NOT EXISTS idx_users_skills ON users USING GIN(skills);
CREATE INDEX IF NOT EXISTS idx_teams_skills ON teams USING GIN(skills);

-- Add comments for documentation
COMMENT ON COLUMN users.skills IS 'User technical skills for auto-assignment (e.g., kubernetes, docker, web, database, network)';
COMMENT ON COLUMN teams.skills IS 'Team specialized skills for auto-assignment (e.g., web, database, infrastructure, application)';
COMMENT ON COLUMN users.email_verification_skipped IS 'True if admin created user with skip email verification flag';

-- Create table for predefined skills catalog (optional but useful)
CREATE TABLE IF NOT EXISTS skills_catalog (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,
    category VARCHAR(50) NOT NULL, -- e.g., 'web', 'database', 'network', 'application', 'infrastructure'
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Seed common skills
INSERT INTO skills_catalog (name, category, description) VALUES
    ('web', 'application', 'Web application vulnerabilities (XSS, CSRF, SQLi)'),
    ('database', 'infrastructure', 'Database security and SQL injection vulnerabilities'),
    ('network', 'infrastructure', 'Network and firewall configuration vulnerabilities'),
    ('kubernetes', 'infrastructure', 'Kubernetes and container orchestration security'),
    ('docker', 'infrastructure', 'Docker container security'),
    ('cloud-aws', 'infrastructure', 'AWS cloud security (S3, IAM, EC2, etc.)'),
    ('cloud-azure', 'infrastructure', 'Azure cloud security'),
    ('cloud-gcp', 'infrastructure', 'Google Cloud Platform security'),
    ('api', 'application', 'REST API and GraphQL security'),
    ('authentication', 'application', 'Authentication and authorization vulnerabilities'),
    ('cryptography', 'application', 'Cryptographic implementation vulnerabilities'),
    ('mobile', 'application', 'Mobile application security (iOS, Android)'),
    ('windows', 'infrastructure', 'Windows OS security'),
    ('linux', 'infrastructure', 'Linux OS security'),
    ('iot', 'infrastructure', 'IoT device security'),
    ('scada', 'infrastructure', 'SCADA and industrial control systems'),
    ('webapp', 'application', 'Web application security'),
    ('devsecops', 'application', 'DevSecOps and CI/CD security')
ON CONFLICT (name) DO NOTHING;

-- Create settings table if not exists for auto-assignment configuration
CREATE TABLE IF NOT EXISTS system_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT NOT NULL,
    description TEXT,
    updated_by UUID REFERENCES users(id) ON DELETE SET NULL,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Add auto-assignment delay setting
INSERT INTO system_settings (setting_key, setting_value, description) VALUES
    ('auto_assignment_delay_days', '7', 'Number of days before unassigned vulnerabilities are auto-assigned based on skills')
ON CONFLICT (setting_key) DO NOTHING;

-- Add auto-assignment enabled setting
INSERT INTO system_settings (setting_key, setting_value, description) VALUES
    ('auto_assignment_enabled', 'false', 'Enable/disable automatic vulnerability assignment based on skills')
ON CONFLICT (setting_key) DO NOTHING;
