-- Verify that vulnerabilities have correct assigned_user_name and assigned_team_name
-- This query shows what the frontend should receive

SELECT
    v.id,
    v.title,
    v.assigned_user_id,
    u.username as assigned_user_name,
    v.assigned_team_id,
    t.name as assigned_team_name,
    v.status,
    v.severity
FROM vulnerabilities v
LEFT JOIN users u ON v.assigned_user_id = u.id
LEFT JOIN teams t ON v.assigned_team_id = t.id
WHERE v.deleted_at IS NULL
  AND (v.assigned_user_id IS NOT NULL OR v.assigned_team_id IS NOT NULL)
ORDER BY v.created_at DESC
LIMIT 20;

-- Count vulnerabilities without names
SELECT
    COUNT(*) as total_assigned,
    COUNT(CASE WHEN v.assigned_user_id IS NOT NULL AND u.username IS NULL THEN 1 END) as missing_user_names,
    COUNT(CASE WHEN v.assigned_team_id IS NOT NULL AND t.name IS NULL THEN 1 END) as missing_team_names
FROM vulnerabilities v
LEFT JOIN users u ON v.assigned_user_id = u.id
LEFT JOIN teams t ON v.assigned_team_id = t.id
WHERE v.deleted_at IS NULL
  AND (v.assigned_user_id IS NOT NULL OR v.assigned_team_id IS NOT NULL);
