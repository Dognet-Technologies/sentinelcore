#!/usr/bin/env python3
"""
Comprehensive test suite for all plugins
Tests: Multilingual Pack, Themes Extension, Vulnerabilities Export, Network Discovery
"""

import subprocess
import json
import sys
from typing import Dict, List, Any
from pathlib import Path


class PluginTester:
    def __init__(self):
        self.results = {
            "passed": 0,
            "failed": 0,
            "errors": []
        }
        self.plugins_dir = Path(__file__).parent
    
    def run_plugin(self, plugin_name: str, action: str, data: Dict[str, Any] = None) -> Dict[str, Any]:
        """Execute a plugin and return the response"""
        data = data or {}
        plugin_path = self.plugins_dir / plugin_name / "main.py"
        
        if not plugin_path.exists():
            raise FileNotFoundError(f"Plugin not found: {plugin_path}")
        
        request = {
            "action": action,
            "data": data
        }
        
        try:
            result = subprocess.run(
                ["python3", str(plugin_path), "--request", json.dumps(request)],
                cwd=str(plugin_path.parent),
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode != 0:
                raise RuntimeError(f"Plugin execution failed: {result.stderr}")
            
            return json.loads(result.stdout)
        except json.JSONDecodeError as e:
            raise ValueError(f"Invalid JSON response: {result.stdout}")
    
    def test(self, plugin_name: str, action: str, data: Dict[str, Any] = None, 
              expected_success: bool = True, description: str = "") -> bool:
        """Run a test and record result"""
        try:
            response = self.run_plugin(plugin_name, action, data)
            success = response.get("success", False)
            
            if success == expected_success:
                self.results["passed"] += 1
                status = "✓ PASS"
            else:
                self.results["failed"] += 1
                status = "✗ FAIL"
                self.results["errors"].append({
                    "plugin": plugin_name,
                    "action": action,
                    "description": description,
                    "expected": expected_success,
                    "got": success,
                    "response": response
                })
            
            print(f"{status} | {plugin_name}::{action} | {description or action}")
            return success == expected_success
        except Exception as e:
            self.results["failed"] += 1
            self.results["errors"].append({
                "plugin": plugin_name,
                "action": action,
                "description": description,
                "error": str(e)
            })
            print(f"✗ ERROR | {plugin_name}::{action} | {str(e)}")
            return False
    
    def test_multilingual_pack(self):
        """Test Multilingual Pack plugin"""
        print("\n" + "="*80)
        print("TESTING: Multilingual Pack")
        print("="*80)
        
        # Test 1: List languages
        self.test("multilingual_pack", "list_languages", 
                  description="List all supported languages (EN, ES, PT)")
        
        # Test 2: Get translations for English
        self.test("multilingual_pack", "get_translations",
                  {"language": "en"},
                  description="Get full English translations")
        
        # Test 3: Get translations for Spanish
        self.test("multilingual_pack", "get_translations",
                  {"language": "es"},
                  description="Get full Spanish translations")
        
        # Test 4: Get translations for Portuguese
        self.test("multilingual_pack", "get_translations",
                  {"language": "pt"},
                  description="Get full Portuguese translations")
        
        # Test 5: Get specific string in English
        self.test("multilingual_pack", "get_string",
                  {"language": "en", "key": "vulnerabilities.title"},
                  description="Get 'Vulnerabilities' in English")
        
        # Test 6: Get specific string in Spanish
        self.test("multilingual_pack", "get_string",
                  {"language": "es", "key": "vulnerabilities.critical"},
                  description="Get 'Crítica' (Critical) in Spanish")
        
        # Test 7: Get specific string in Portuguese
        self.test("multilingual_pack", "get_string",
                  {"language": "pt", "key": "dashboard.welcome"},
                  description="Get 'Bem-vindo' (Welcome) in Portuguese")
        
        # Test 8: Fallback to English when language not found
        self.test("multilingual_pack", "get_string",
                  {"language": "fr", "key": "common.save"},
                  description="Fallback to English for unsupported language")
        
        # Test 9: Validate language - valid
        self.test("multilingual_pack", "validate_language",
                  {"language": "es"},
                  description="Validate Spanish language code")
        
        # Test 10: Statistics
        self.test("multilingual_pack", "stats",
                  description="Get translation statistics")
        
        # Test 11: Plugin info
        self.test("multilingual_pack", "info",
                  description="Get plugin information")
    
    def test_themes_extension(self):
        """Test Themes Extension plugin"""
        print("\n" + "="*80)
        print("TESTING: Themes Extension")
        print("="*80)
        
        # Test 1: List themes
        self.test("themes_extension", "list_themes",
                  description="List all built-in themes")
        
        # Test 2: Get specific theme - Modern Dark
        self.test("themes_extension", "get_theme",
                  {"theme_id": "modern_dark"},
                  description="Get Modern Dark theme configuration")
        
        # Test 3: Get specific theme - Cyberpunk
        self.test("themes_extension", "get_theme",
                  {"theme_id": "cyberpunk"},
                  description="Get Cyberpunk theme with neon colors")
        
        # Test 4: Get specific theme - Solarized Dark
        self.test("themes_extension", "get_theme",
                  {"theme_id": "solarized_dark"},
                  description="Get Solarized Dark theme")
        
        # Test 5: Get Dracula theme
        self.test("themes_extension", "get_theme",
                  {"theme_id": "dracula"},
                  description="Get Dracula theme")
        
        # Test 6: Get Nord theme
        self.test("themes_extension", "get_theme",
                  {"theme_id": "nord"},
                  description="Get Nord theme")
        
        # Test 7: Create custom theme - Ocean Blue
        custom_ocean = {
            "id": "custom_ocean",
            "name": "Custom Ocean",
            "isDark": True,
            "palette": {
                "primary": {"main": "#0077BE"},
                "secondary": {"main": "#29B6F6"},
                "background": {"default": "#0D1B2A", "paper": "#1B263B"},
                "text": {"primary": "#E0E1DD", "secondary": "#778DA9"}
            }
        }
        self.test("themes_extension", "create_theme",
                  {"theme": custom_ocean},
                  description="Create custom Ocean Blue theme")
        
        # Test 8: Create custom theme - Dark Green
        custom_green = {
            "id": "custom_green",
            "name": "Dark Green",
            "isDark": True,
            "palette": {
                "primary": {"main": "#2D6A4F"},
                "secondary": {"main": "#52B788"},
                "background": {"default": "#1B4332", "paper": "#2D6A4F"},
                "text": {"primary": "#D8F3DC", "secondary": "#B7E4C7"}
            }
        }
        self.test("themes_extension", "create_theme",
                  {"theme": custom_green},
                  description="Create custom Dark Green theme")
        
        # Test 9: Validate valid theme
        valid_theme = {
            "name": "Test Theme",
            "isDark": True,
            "palette": {
                "primary": {"main": "#FF0000"},
                "secondary": {"main": "#00FF00"},
                "background": {"default": "#000000", "paper": "#111111"},
                "text": {"primary": "#FFFFFF", "secondary": "#CCCCCC"}
            }
        }
        self.test("themes_extension", "validate_theme",
                  {"theme": valid_theme},
                  description="Validate a well-formed theme")
        
        # Test 10: Plugin info
        self.test("themes_extension", "info",
                  description="Get plugin information")
    
    def test_vulnerabilities_export(self):
        """Test Vulnerabilities Export plugin"""
        print("\n" + "="*80)
        print("TESTING: Vulnerabilities Export")
        print("="*80)
        
        # Sample vulnerability data
        test_vulns = [
            {"id": "1", "title": "SQL Injection", "severity": "critical", "cvss": 9.8, "status": "open"},
            {"id": "2", "title": "XSS", "severity": "high", "cvss": 7.3, "status": "in_progress"},
            {"id": "3", "title": "Weak Password", "severity": "medium", "cvss": 5.5, "status": "closed"}
        ]
        
        # Test 1: Export to CSV
        self.test("vulnerabilities_export", "export_csv",
                  {"vulnerabilities": test_vulns},
                  description="Export 3 vulnerabilities to CSV format")
        
        # Test 2: Export to XML
        self.test("vulnerabilities_export", "export_xml",
                  {"vulnerabilities": test_vulns},
                  description="Export 3 vulnerabilities to XML format")
        
        # Test 3: Export to Excel
        self.test("vulnerabilities_export", "export_excel",
                  {"vulnerabilities": test_vulns},
                  description="Export 3 vulnerabilities to Excel format")
        
        # Test 4: Export to ODS
        self.test("vulnerabilities_export", "export_ods",
                  {"vulnerabilities": test_vulns},
                  description="Export 3 vulnerabilities to OpenOffice format")
        
        # Test 5: Export empty list to CSV
        self.test("vulnerabilities_export", "export_csv",
                  {"vulnerabilities": []},
                  description="Export empty vulnerability list to CSV")
        
        # Test 6: Export with nested data to CSV
        complex_vulns = [
            {
                "id": "c1",
                "title": "Complex Vuln",
                "severity": "critical",
                "details": {
                    "description": "Complex description",
                    "impact": "High impact",
                    "remediation": {"steps": ["step1", "step2"]}
                }
            }
        ]
        self.test("vulnerabilities_export", "export_csv",
                  {"vulnerabilities": complex_vulns},
                  description="Export vulnerability with nested data structures")
        
        # Test 7: Plugin info
        self.test("vulnerabilities_export", "info",
                  description="Get plugin information")
    
    def test_network_discovery(self):
        """Test Network Discovery plugin"""
        print("\n" + "="*80)
        print("TESTING: Network Discovery")
        print("="*80)
        
        # Test 1: Plugin info
        self.test("network_discovery", "info",
                  description="Get plugin information")
        
        # Test 2: Ping localhost (should succeed)
        self.test("network_discovery", "ping",
                  {"ip": "127.0.0.1"},
                  description="Ping localhost (127.0.0.1)")
    
    def print_summary(self):
        """Print test summary"""
        print("\n" + "="*80)
        print("TEST SUMMARY")
        print("="*80)
        print(f"✓ Passed: {self.results['passed']}")
        print(f"✗ Failed: {self.results['failed']}")
        total = self.results['passed'] + self.results['failed']
        percentage = (self.results['passed'] / total * 100) if total > 0 else 0
        print(f"Success Rate: {percentage:.1f}%")
        
        if self.results['errors']:
            print("\nFailed Tests:")
            for error in self.results['errors']:
                print(f"\n  Plugin: {error.get('plugin', 'unknown')}")
                print(f"  Action: {error.get('action', 'unknown')}")
                if error.get('description'):
                    print(f"  Description: {error['description']}")
                if error.get('error'):
                    print(f"  Error: {error['error']}")
                elif error.get('response'):
                    print(f"  Response: {json.dumps(error['response'], indent=4)}")
        
        return self.results['failed'] == 0
    
    def run_all_tests(self):
        """Run all plugin tests"""
        print("\n" + "#"*80)
        print("# SENTINELCORE PLUGIN TEST SUITE")
        print("#"*80)
        
        self.test_multilingual_pack()
        self.test_themes_extension()
        self.test_vulnerabilities_export()
        self.test_network_discovery()
        
        success = self.print_summary()
        return 0 if success else 1


def main():
    tester = PluginTester()
    exit_code = tester.run_all_tests()
    sys.exit(exit_code)


if __name__ == "__main__":
    main()
