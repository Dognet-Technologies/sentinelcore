// src/notifications/slack.rs
// Notifiche via Slack webhook

use super::NotificationPayload;
use reqwest::Client;
use serde_json::json;

pub async fn send_slack_notification(
    webhook_url: &str,
    payload: NotificationPayload,
) -> Result<(), Box<dyn std::error::Error>> {
    let client = Client::new();

    let color = match payload.severity.as_str() {
        "critical" => "#FF0000",
        "high" => "#FF6600",
        "medium" => "#FFCC00",
        "low" => "#00FF00",
        _ => "#808080",
    };

    let slack_message = json!({
        "text": format!("ðŸš¨ New {} Vulnerability Detected", payload.severity.to_uppercase()),
        "attachments": [{
            "color": color,
            "fields": [
                {
                    "title": "Title",
                    "value": payload.title,
                    "short": false
                },
                {
                    "title": "Severity",
                    "value": payload.severity.to_uppercase(),
                    "short": true
                },
                {
                    "title": "CVSS Score",
                    "value": format!("{:.1}", payload.cvss_score),
                    "short": true
                },
                {
                    "title": "IP Address",
                    "value": payload.ip_address,
                    "short": true
                },
                {
                    "title": "Assigned Team",
                    "value": payload.team_name.unwrap_or_else(|| "Unassigned".to_string()),
                    "short": true
                },
                {
                    "title": "Description",
                    "value": payload.description,
                    "short": false
                }
            ],
            "footer": "Sentinel Core Vulnerability Manager",
            "ts": chrono::Utc::now().timestamp()
        }]
    });

    client
        .post(webhook_url)
        .json(&slack_message)
        .send()
        .await?
        .error_for_status()?;

    Ok(())
}
