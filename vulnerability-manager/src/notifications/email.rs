// src/notifications/email.rs
// Notifiche via Email

use super::NotificationPayload;
use lettre::message::header::ContentType;
use lettre::transport::smtp::authentication::Credentials;
use lettre::{Message, SmtpTransport, Transport};

pub async fn send_email_notification(
    to_email: &str,
    payload: NotificationPayload,
) -> Result<(), Box<dyn std::error::Error>> {
    // Configurazione SMTP (da variabili d'ambiente)
    let smtp_server = std::env::var("SMTP_SERVER").unwrap_or_else(|_| "smtp.gmail.com".to_string());
    let smtp_username = std::env::var("SMTP_USERNAME").unwrap_or_else(|_| "your@email.com".to_string());
    let smtp_password = std::env::var("SMTP_PASSWORD").unwrap_or_else(|_| "password".to_string());

    let email_body = format!(
        r#"
<!DOCTYPE html>
<html>
<head>
    <style>
        body {{ font-family: Arial, sans-serif; }}
        .header {{ background-color: #{}; color: white; padding: 20px; }}
        .content {{ padding: 20px; }}
        .field {{ margin: 10px 0; }}
        .label {{ font-weight: bold; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>{} Vulnerability Detected</h1>
    </div>
    <div class="content">
        <div class="field">
            <span class="label">Title:</span> {}
        </div>
        <div class="field">
            <span class="label">Severity:</span> {}
        </div>
        <div class="field">
            <span class="label">CVSS Score:</span> {:.1}
        </div>
        <div class="field">
            <span class="label">IP Address:</span> {}
        </div>
        <div class="field">
            <span class="label">Assigned Team:</span> {}
        </div>
        <div class="field">
            <span class="label">Description:</span><br>
            {}
        </div>
        <hr>
        <p><small>Sentinel Core Vulnerability Manager</small></p>
    </div>
</body>
</html>
        "#,
        match payload.severity.as_str() {
            "critical" => "FF0000",
            "high" => "FF6600",
            "medium" => "FFCC00",
            "low" => "00FF00",
            _ => "808080",
        },
        payload.severity.to_uppercase(),
        payload.title,
        payload.severity.to_uppercase(),
        payload.cvss_score,
        payload.ip_address,
        payload.team_name.unwrap_or_else(|| "Unassigned".to_string()),
        payload.description
    );

    let email = Message::builder()
        .from(smtp_username.parse()?)
        .to(to_email.parse()?)
        .subject(format!("ðŸš¨ {} Vulnerability: {}", payload.severity.to_uppercase(), payload.title))
        .header(ContentType::TEXT_HTML)
        .body(email_body)?;

    let creds = Credentials::new(smtp_username, smtp_password);

    let mailer = SmtpTransport::relay(&smtp_server)?
        .credentials(creds)
        .build();

    mailer.send(&email)?;

    Ok(())
}
