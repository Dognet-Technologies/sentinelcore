// src/models/vulnerability.rs
use chrono::{DateTime, Utc};
use serde::{Deserialize, Deserializer, Serialize};
use uuid::Uuid;
use ipnetwork::IpNetwork;

// Custom deserializer for optional UUID that treats empty strings as None
fn deserialize_optional_uuid<'de, D>(deserializer: D) -> Result<Option<Uuid>, D::Error>
where
    D: Deserializer<'de>,
{
    let opt = Option::<String>::deserialize(deserializer)?;
    match opt {
        None => Ok(None),
        Some(s) if s.is_empty() => Ok(None),
        Some(s) => Uuid::parse_str(&s)
            .map(Some)
            .map_err(serde::de::Error::custom),
    }
}

#[derive(Debug, Serialize, Deserialize, Clone, PartialEq, Eq, sqlx::Type)]
#[sqlx(type_name = "vulnerability_status", rename_all = "snake_case")]
#[serde(rename_all = "snake_case")]
pub enum VulnerabilityStatus {
    Open,
    InProgress,
    Resolved,
    Closed,
}

impl VulnerabilityStatus {
    pub fn as_str(&self) -> &'static str {
        match self {
            Self::Open => "open",
            Self::InProgress => "in_progress",
            Self::Resolved => "resolved",
            Self::Closed => "closed",
        }
    }
}

#[derive(Debug, Serialize, Deserialize, Clone, PartialEq, Eq, sqlx::Type)]
#[sqlx(type_name = "vulnerability_severity", rename_all = "snake_case")]
#[serde(rename_all = "snake_case")]
pub enum VulnerabilitySeverity {
    Critical,
    High,
    Medium,
    Low,
    Info,
}

impl VulnerabilitySeverity {
    pub fn as_str(&self) -> &'static str {
        match self {
            Self::Critical => "critical",
            Self::High => "high",
            Self::Medium => "medium",
            Self::Low => "low",
            Self::Info => "info",
        }
    }

    pub fn from_cvss(score: f32) -> Self {
        match score {
            s if s >= 9.0 => Self::Critical,
            s if s >= 7.0 => Self::High,
            s if s >= 4.0 => Self::Medium,
            s if s >= 0.1 => Self::Low,
            _ => Self::Info,
        }
    }
}

#[derive(Debug, Serialize, Deserialize, Clone, sqlx::FromRow)]
pub struct Vulnerability {
    pub id: Uuid,
    pub title: String,
    pub description: String,
    pub cvss_score: f32,
    pub epss_score: Option<f32>,
    pub ip_address: IpNetwork,                 // INET type in database
    pub hostname: Option<String>,
    pub port: Option<i32>,
    pub protocol: Option<String>,
    pub status: VulnerabilityStatus,
    pub severity: VulnerabilitySeverity,
    pub cve_id: Option<String>,
    pub cwe_id: Option<String>,
    pub remediation: Option<String>,
    pub source: String,
    pub discovered_at: Option<DateTime<Utc>>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub asset_id: Option<Uuid>,
    pub assigned_team_id: Option<Uuid>,
    pub assigned_user_id: Option<Uuid>,  // Added for direct user assignment
    #[serde(skip_serializing_if = "Option::is_none")]
    pub assigned_user_name: Option<String>,  // JOIN from users table
    #[serde(skip_serializing_if = "Option::is_none")]
    pub assigned_team_name: Option<String>,  // JOIN from teams table
    #[serde(skip_serializing_if = "Option::is_none")]
    pub deleted_at: Option<DateTime<Utc>>,  // For soft delete tracking
}

#[derive(Debug, Serialize, Deserialize)]
pub struct NewVulnerability {
    pub title: String,
    pub description: String,
    pub cvss_score: f32,
    pub epss_score: Option<f32>,
    pub ip_address: IpNetwork,                 // INET type in database
    pub hostname: Option<String>,
    pub port: Option<i32>,
    pub protocol: Option<String>,
    pub cve_id: Option<String>,
    pub cwe_id: Option<String>,
    pub remediation: Option<String>,
    pub source: String,
    pub discovered_at: Option<DateTime<Utc>>,
    pub asset_id: Option<Uuid>,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct UpdateVulnerability {
    pub title: Option<String>,
    pub description: Option<String>,
    pub cvss_score: Option<f32>,
    pub epss_score: Option<f32>,
    pub status: Option<VulnerabilityStatus>,
    pub remediation: Option<String>,
    #[serde(default, deserialize_with = "deserialize_optional_uuid")]
    pub asset_id: Option<Uuid>,
    #[serde(default, deserialize_with = "deserialize_optional_uuid")]
    pub assigned_team_id: Option<Uuid>,
    #[serde(default, deserialize_with = "deserialize_optional_uuid")]
    pub assigned_user_id: Option<Uuid>,  // Added for user assignment
}

// FIXED: Corretto ip_address da String a Option<String> per il filtro
#[derive(Debug, Serialize, Deserialize, Default)]
pub struct VulnerabilityFilter {
    pub status: Option<VulnerabilityStatus>,
    pub severity: Option<VulnerabilitySeverity>,
    pub ip_address: Option<String>,            // FIXED: Option<String> per filtro di ricerca
    pub hostname: Option<String>,
    pub cve_id: Option<String>,
    pub assigned_team_id: Option<Uuid>,
    pub asset_id: Option<Uuid>,
}