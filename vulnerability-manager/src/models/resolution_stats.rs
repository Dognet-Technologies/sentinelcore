use chrono::{DateTime, Utc, NaiveDate};
use serde::{Deserialize, Serialize};
use uuid::Uuid;

#[derive(Debug, Serialize, Deserialize, Clone, sqlx::FromRow)]
pub struct VulnerabilityResolution {
    pub id: Uuid,
    pub vulnerability_id: Uuid,
    pub resolved_by: Uuid,
    pub resolved_at: DateTime<Utc>,
    pub resolution_method: String,
    pub resolution_notes: Option<String>,
    pub assigned_at: DateTime<Utc>,
    pub resolved_at_actual: DateTime<Utc>,
    pub time_to_resolve_hours: Option<String>,
    pub sla_due_date: Option<DateTime<Utc>>,
    pub sla_met: Option<bool>,
    pub sla_overdue_hours: Option<String>,
    pub verified_by: Option<Uuid>,
    pub verified_at: Option<DateTime<Utc>>,
    pub resolution_score: Option<i32>,
    pub quality_rating: Option<i32>,
    pub quality_notes: Option<String>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Serialize, Deserialize, Clone, sqlx::FromRow)]
pub struct UserResolutionStats {
    pub id: Uuid,
    pub user_id: Uuid,
    pub total_resolutions: Option<i32>,
    pub verified_resolutions: Option<i32>,
    pub unverified_resolutions: Option<i32>,
    pub total_resolution_score: Option<i32>,
    pub average_resolution_score: Option<String>,
    pub average_time_to_resolve_hours: Option<String>,
    pub fastest_resolution_hours: Option<String>,
    pub slowest_resolution_hours: Option<String>,
    pub sla_met_count: Option<i32>,
    pub sla_missed_count: Option<i32>,
    pub sla_compliance_percentage: Option<String>,
    pub average_quality_rating: Option<String>,
    pub high_quality_resolutions: Option<i32>,
    pub current_resolution_streak: Option<i32>,
    pub max_resolution_streak: Option<i32>,
    pub resolutions_this_month: Option<i32>,
    pub resolutions_this_quarter: Option<i32>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Serialize, Deserialize, Clone, sqlx::FromRow)]
pub struct TeamResolutionStats {
    pub id: Uuid,
    pub team_id: Uuid,
    pub total_resolutions: Option<i32>,
    pub verified_resolutions: Option<i32>,
    pub total_team_resolution_score: Option<i32>,
    pub average_resolution_score: Option<String>,
    pub average_time_to_resolve_hours: Option<String>,
    pub sla_met_count: Option<i32>,
    pub sla_missed_count: Option<i32>,
    pub sla_compliance_percentage: Option<String>,
    pub average_quality_rating: Option<String>,
    pub active_contributors: Option<i32>,
    pub top_performer_user_id: Option<Uuid>,
    pub resolutions_this_month: Option<i32>,
    pub resolutions_this_quarter: Option<i32>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Serialize, Deserialize, Clone, sqlx::FromRow)]
pub struct ResolutionActivity {
    pub id: Uuid,
    pub user_id: Option<Uuid>,
    pub team_id: Option<Uuid>,
    pub activity_date: NaiveDate,
    pub activity_type: String,
    pub count: Option<i32>,
    pub score_earned: Option<i32>,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Serialize, Deserialize, sqlx::FromRow)]
pub struct ResolutionLeaderboardEntry {
    pub id: Option<Uuid>,
    pub username: Option<String>,
    pub avatar_url: Option<String>,
    pub total_resolutions: Option<i32>,
    pub verified_resolutions: Option<i32>,
    pub total_resolution_score: Option<i32>,
    pub average_resolution_score: Option<String>,
    pub average_time_to_resolve_hours: Option<String>,
    pub sla_compliance_percentage: Option<String>,
    pub average_quality_rating: Option<String>,
    pub current_resolution_streak: Option<i32>,
    pub rank: Option<i64>,
}

#[derive(Debug, Serialize, Deserialize, sqlx::FromRow)]
pub struct TeamResolutionLeaderboardEntry {
    pub id: Option<Uuid>,
    pub name: Option<String>,
    pub total_resolutions: Option<i32>,
    pub verified_resolutions: Option<i32>,
    pub total_team_resolution_score: Option<i32>,
    pub average_resolution_score: Option<String>,
    pub average_time_to_resolve_hours: Option<String>,
    pub sla_compliance_percentage: Option<String>,
    pub average_quality_rating: Option<String>,
    pub active_contributors: Option<i32>,
    pub rank: Option<i64>,
}

// Request/Response types
#[derive(Debug, Serialize, Deserialize)]
pub struct CreateResolutionRequest {
    pub vulnerability_id: Uuid,
    pub resolution_method: String,
    pub resolution_notes: Option<String>,
    pub quality_rating: Option<i32>,
    pub quality_notes: Option<String>,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct VerifyResolutionRequest {
    pub quality_rating: Option<i32>,
    pub quality_notes: Option<String>,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct ResolutionStatsResponse {
    pub user_stats: Option<UserResolutionStats>,
    pub team_stats: Option<TeamResolutionStats>,
    pub recent_resolutions: Vec<VulnerabilityResolution>,
}
