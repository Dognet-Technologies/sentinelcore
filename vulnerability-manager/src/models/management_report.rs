// src/models/management_report.rs
// Modelli per il report di gestione vulnerabilità

use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use uuid::Uuid;

/// Struttura principale del report di gestione vulnerabilità
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct ManagementReport {
    pub report_id: Uuid,
    pub report_name: String,
    pub period_start: DateTime<Utc>,
    pub period_end: DateTime<Utc>,
    pub generated_at: DateTime<Utc>,
    pub generated_by: Uuid,

    pub executive_summary: ExecutiveSummary,
    pub management_metrics: ManagementMetrics,
    pub risk_analysis: RiskAnalysis,
    pub team_performance: Vec<TeamPerformance>,
    pub vulnerability_details: VulnerabilityDetails,
}

/// Executive Summary - Overview ad alto livello
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct ExecutiveSummary {
    /// Vulnerabilità totali nel periodo
    pub total_vulnerabilities: i64,
    /// Nuove vulnerabilità scoperte nel periodo
    pub new_vulnerabilities: i64,
    /// Vulnerabilità risolte/chiuse nel periodo
    pub resolved_vulnerabilities: i64,
    /// Vulnerabilità ancora aperte alla fine del periodo
    pub open_vulnerabilities: i64,
    /// In progress alla fine del periodo
    pub in_progress_vulnerabilities: i64,

    /// Rischio eliminato (somma CVSS vulnerabilità risolte)
    pub risk_eliminated: f64,
    /// Rischio residuo (somma CVSS vulnerabilità aperte)
    pub residual_risk: f64,

    /// Trend positivo (true se risolte > nuove)
    pub positive_trend: bool,
    /// Net change (resolved - new)
    pub net_change: i64,
}

/// Metriche di gestione e SLA
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct ManagementMetrics {
    /// Tempo medio di risoluzione per severità (giorni)
    pub avg_resolution_time: ResolutionTimeBySevert,

    /// SLA Compliance
    pub sla_compliance: SlaCompliance,

    /// Backlog aging
    pub backlog_aging: BacklogAging,

    /// MTTR (Mean Time To Resolve) complessivo in giorni
    pub overall_mttr: f64,
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct ResolutionTimeBySevert {
    pub critical: Option<f64>,  // giorni medi
    pub high: Option<f64>,
    pub medium: Option<f64>,
    pub low: Option<f64>,
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct SlaCompliance {
    /// Critical: % risolte entro 7 giorni
    pub critical_within_7d: f64,
    pub critical_total: i64,
    pub critical_compliant: i64,

    /// High: % risolte entro 30 giorni
    pub high_within_30d: f64,
    pub high_total: i64,
    pub high_compliant: i64,

    /// Medium: % risolte entro 90 giorni
    pub medium_within_90d: f64,
    pub medium_total: i64,
    pub medium_compliant: i64,
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct BacklogAging {
    /// Vulnerabilità aperte da 0-30 giorni
    pub age_0_30: i64,
    /// Vulnerabilità aperte da 31-60 giorni
    pub age_31_60: i64,
    /// Vulnerabilità aperte da 61-90 giorni
    pub age_61_90: i64,
    /// Vulnerabilità aperte da oltre 90 giorni
    pub age_over_90: i64,
}

/// Analisi del rischio
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct RiskAnalysis {
    /// Top 10 vulnerabilità aperte più critiche
    pub top_open_vulnerabilities: Vec<VulnerabilitySummary>,

    /// Top vulnerabilità risolte (maggior impatto eliminato)
    pub top_resolved_vulnerabilities: Vec<ResolvedVulnerabilitySummary>,

    /// Rischio per severità
    pub risk_by_severity: RiskBySeverity,

    /// Distribuzione del rischio per asset
    pub risk_by_asset: Vec<AssetRiskSummary>,
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct VulnerabilitySummary {
    pub id: Uuid,
    pub title: String,
    pub severity: String,
    pub cvss_score: f32,
    pub epss_score: Option<f32>,
    pub status: String,
    pub ip_address: String,
    pub hostname: Option<String>,
    pub days_open: i64,
    pub assigned_to: Option<String>,  // team o user name
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct ResolvedVulnerabilitySummary {
    pub id: Uuid,
    pub title: String,
    pub severity: String,
    pub cvss_score: f32,
    pub resolved_at: DateTime<Utc>,
    pub resolved_by: Option<String>,  // username
    pub days_to_resolve: i64,
    pub risk_eliminated: f32,  // CVSS score
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct RiskBySeverity {
    pub critical_cvss_total: f64,
    pub critical_count: i64,
    pub high_cvss_total: f64,
    pub high_count: i64,
    pub medium_cvss_total: f64,
    pub medium_count: i64,
    pub low_cvss_total: f64,
    pub low_count: i64,
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct AssetRiskSummary {
    pub asset_id: Option<Uuid>,
    pub asset_name: String,
    pub asset_type: Option<String>,
    pub open_vulns: i64,
    pub total_cvss: f64,
    pub critical_count: i64,
    pub high_count: i64,
}

/// Performance dei team
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct TeamPerformance {
    pub team_id: Option<Uuid>,
    pub team_name: String,
    pub vulnerabilities_assigned: i64,
    pub vulnerabilities_resolved: i64,
    pub avg_resolution_time: Option<f64>,
    pub risk_eliminated: f64,
    pub top_contributor: Option<String>,  // username del membro più attivo
}

/// Dettagli vulnerabilità
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct VulnerabilityDetails {
    /// Vulnerabilità aperte alla fine del periodo
    pub open: Vec<VulnerabilitySummary>,
    /// Vulnerabilità in progress alla fine del periodo
    pub in_progress: Vec<VulnerabilitySummary>,
    /// Vulnerabilità risolte durante il periodo
    pub resolved: Vec<ResolvedVulnerabilitySummary>,
}

/// Request per generare un management report
#[derive(Debug, Deserialize)]
pub struct GenerateManagementReportRequest {
    pub name: String,
    pub period_start: DateTime<Utc>,
    pub period_end: DateTime<Utc>,

    /// Filtri opzionali
    pub team_id: Option<Uuid>,
    pub severity_filter: Option<String>,  // "critical,high" etc
    pub asset_id: Option<Uuid>,

    /// Formato output
    pub format: String,  // "pdf", "json", "csv"
}
