// src/scanners/nessus.rs
// Nessus scanner plugin - parses Nessus .nessus XML vulnerability scan reports

use super::*;
use quick_xml::de::from_str;
use serde::Deserialize;

pub struct NessusPlugin;

const NESSUS_METADATA: ScannerMetadata = ScannerMetadata {
    name: "nessus",
    display_name: "Tenable Nessus",
    version: "1.0.0",
    description: "Imports vulnerability scan results from Nessus (.nessus files)",
    supported_formats: &["xml", "nessus"],
    vendor: "Tenable",
};

impl NessusPlugin {
    pub fn new() -> Self {
        Self
    }
}

// Nessus XML structure (simplified)
#[derive(Debug, Deserialize)]
struct NessusClientData {
    #[serde(rename = "Report")]
    reports: Vec<Report>,
}

#[derive(Debug, Deserialize)]
struct Report {
    #[serde(rename = "ReportHost", default)]
    hosts: Vec<ReportHost>,
}

#[derive(Debug, Deserialize)]
struct ReportHost {
    #[serde(rename = "@name")]
    name: String,

    #[serde(rename = "ReportItem", default)]
    items: Vec<ReportItem>,
}

#[derive(Debug, Deserialize)]
struct ReportItem {
    #[serde(rename = "@pluginID")]
    plugin_id: String,

    #[serde(rename = "@pluginName")]
    plugin_name: String,

    #[serde(rename = "@severity")]
    severity: u8,

    #[serde(rename = "@port")]
    port: Option<u16>,

    #[serde(rename = "@protocol")]
    protocol: Option<String>,

    #[serde(rename = "@svc_name")]
    service: Option<String>,

    #[serde(rename = "description")]
    description: Option<String>,

    #[serde(rename = "solution")]
    solution: Option<String>,

    #[serde(rename = "cve")]
    cve: Option<Vec<String>>,

    #[serde(rename = "cvss_base_score")]
    cvss_score: Option<f32>,

    #[serde(rename = "cvss_vector")]
    cvss_vector: Option<String>,
}

#[async_trait]
impl ScannerPlugin for NessusPlugin {
    fn metadata(&self) -> &ScannerMetadata {
        &NESSUS_METADATA
    }

    async fn parse(&self, data: &[u8], format: &str) -> Result<Vec<ParsedVulnerability>> {
        if !["xml", "nessus"].contains(&format) {
            anyhow::bail!("Nessus plugin only supports XML/nessus format");
        }

        let xml_str = std::str::from_utf8(data)?;

        // Try to parse as Nessus XML
        let report: NessusClientData = from_str(xml_str)
            .map_err(|e| anyhow::anyhow!("Failed to parse Nessus XML: {}", e))?;

        let mut vulnerabilities = Vec::new();

        for report in report.reports {
            for host in report.hosts {
                for item in host.items {
                    // Skip informational findings with severity 0
                    if item.severity == 0 {
                        continue;
                    }

                    vulnerabilities.push(ParsedVulnerability {
                        scanner_id: format!("NESSUS-{}", item.plugin_id),
                        title: item.plugin_name.clone(),
                        description: item.description.clone().unwrap_or_default(),
                        severity: Self::map_severity(item.severity),
                        cvss_score: item.cvss_score,
                        cvss_vector: item.cvss_vector,
                        cve_ids: item.cve.unwrap_or_default(),
                        cwe_ids: vec![],
                        tags: vec!["nessus".to_string()],
                        host: host.name.clone(),
                        port: item.port,
                        protocol: item.protocol,
                        service: item.service,
                        solution: item.solution,
                        references: vec![],
                        first_detected: Some(chrono::Utc::now()),
                        last_detected: Some(chrono::Utc::now()),
                        raw_data: None,
                    });
                }
            }
        }

        Ok(vulnerabilities)
    }

    fn validate(&self, data: &[u8], format: &str) -> Result<bool> {
        if !["xml", "nessus"].contains(&format) {
            return Ok(false);
        }

        let xml_str = std::str::from_utf8(data)?;

        // Check for Nessus-specific tags
        Ok(xml_str.contains("<NessusClientData") ||
           (xml_str.contains("<Report") && xml_str.contains("pluginID")))
    }
}

impl NessusPlugin {
    fn map_severity(severity: u8) -> VulnerabilitySeverity {
        match severity {
            4 => VulnerabilitySeverity::Critical,
            3 => VulnerabilitySeverity::High,
            2 => VulnerabilitySeverity::Medium,
            1 => VulnerabilitySeverity::Low,
            _ => VulnerabilitySeverity::Info,
        }
    }
}
