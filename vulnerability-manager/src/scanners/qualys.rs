// src/scanners/qualys.rs
// Qualys scanner plugin - parses Qualys XML vulnerability scan reports

use super::*;
use quick_xml::de::from_str;
use serde::Deserialize;

pub struct QualysPlugin;

const QUALYS_METADATA: ScannerMetadata = ScannerMetadata {
    name: "qualys",
    display_name: "Qualys Vulnerability Scanner",
    version: "1.0.0",
    description: "Imports vulnerability scan results from Qualys",
    supported_formats: &["xml"],
    vendor: "Qualys",
};

impl QualysPlugin {
    pub fn new() -> Self {
        Self
    }
}

// Qualys XML structure (simplified)
#[derive(Debug, Deserialize)]
struct QualysReport {
    #[serde(rename = "HOST_LIST")]
    host_list: Option<HostList>,
}

#[derive(Debug, Deserialize)]
struct HostList {
    #[serde(rename = "HOST", default)]
    hosts: Vec<Host>,
}

#[derive(Debug, Deserialize)]
struct Host {
    #[serde(rename = "IP")]
    ip: String,

    #[serde(rename = "DETECTION_LIST")]
    detection_list: Option<DetectionList>,
}

#[derive(Debug, Deserialize)]
struct DetectionList {
    #[serde(rename = "DETECTION", default)]
    detections: Vec<Detection>,
}

#[derive(Debug, Deserialize)]
struct Detection {
    #[serde(rename = "QID")]
    qid: String,

    #[serde(rename = "TYPE")]
    detection_type: String,

    #[serde(rename = "SEVERITY")]
    severity: Option<u8>,

    #[serde(rename = "PORT")]
    port: Option<u16>,

    #[serde(rename = "PROTOCOL")]
    protocol: Option<String>,

    #[serde(rename = "RESULTS")]
    results: Option<String>,
}

#[async_trait]
impl ScannerPlugin for QualysPlugin {
    fn metadata(&self) -> &ScannerMetadata {
        &QUALYS_METADATA
    }

    async fn parse(&self, data: &[u8], format: &str) -> Result<Vec<ParsedVulnerability>> {
        if format != "xml" {
            anyhow::bail!("Qualys plugin only supports XML format");
        }

        let xml_str = std::str::from_utf8(data)?;
        let report: QualysReport = from_str(xml_str)
            .map_err(|e| anyhow::anyhow!("Failed to parse Qualys XML: {}", e))?;

        let mut vulnerabilities = Vec::new();

        if let Some(host_list) = report.host_list {
            for host in host_list.hosts {
                if let Some(detection_list) = host.detection_list {
                    for detection in detection_list.detections {
                        vulnerabilities.push(ParsedVulnerability {
                            scanner_id: format!("QID-{}", detection.qid),
                            title: format!("Qualys Detection QID {}", detection.qid),
                            description: detection.results.clone().unwrap_or_default(),
                            severity: Self::map_severity(detection.severity),
                            cvss_score: None, // Qualys uses its own scoring
                            cvss_vector: None,
                            cve_ids: vec![],
                            cwe_ids: vec![],
                            tags: vec!["qualys".to_string(), detection.detection_type],
                            host: host.ip.clone(),
                            port: detection.port,
                            protocol: detection.protocol,
                            service: None,
                            solution: None,
                            references: vec![],
                            first_detected: Some(chrono::Utc::now()),
                            last_detected: Some(chrono::Utc::now()),
                            raw_data: None,
                        });
                    }
                }
            }
        }

        Ok(vulnerabilities)
    }

    fn validate(&self, data: &[u8], format: &str) -> Result<bool> {
        if format != "xml" {
            return Ok(false);
        }

        let xml_str = std::str::from_utf8(data)?;

        // Simple validation: check if it contains Qualys-specific tags
        Ok(xml_str.contains("<HOST_LIST>") && xml_str.contains("<DETECTION"))
    }
}

impl QualysPlugin {
    fn map_severity(severity: Option<u8>) -> VulnerabilitySeverity {
        match severity {
            Some(5) => VulnerabilitySeverity::Critical,
            Some(4) => VulnerabilitySeverity::High,
            Some(3) => VulnerabilitySeverity::Medium,
            Some(2) => VulnerabilitySeverity::Low,
            Some(1) => VulnerabilitySeverity::Info,
            _ => VulnerabilitySeverity::Info,
        }
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[tokio::test]
    async fn test_qualys_validation() {
        let plugin = QualysPlugin::new();

        let valid_xml = r#"<?xml version="1.0"?>
        <ASSET_DATA_REPORT>
            <HOST_LIST>
                <HOST>
                    <IP>192.168.1.1</IP>
                    <DETECTION_LIST>
                        <DETECTION>
                            <QID>12345</QID>
                        </DETECTION>
                    </DETECTION_LIST>
                </HOST>
            </HOST_LIST>
        </ASSET_DATA_REPORT>"#;

        assert!(plugin.validate(valid_xml.as_bytes(), "xml").unwrap());
    }
}
