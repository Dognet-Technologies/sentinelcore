// src/export/mod.rs
// Sistema di export report in vari formati

pub mod xml;
pub mod json;
pub mod csv;
pub mod pdf;

use serde::{Deserialize, Serialize};
use uuid::Uuid;
use chrono::{DateTime, Utc};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ExportData {
    pub report_id: Uuid,
    pub report_name: String,
    pub generated_at: DateTime<Utc>,
    pub vulnerabilities: Vec<VulnerabilityExport>,
    pub summary: ExportSummary,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct VulnerabilityExport {
    pub id: Uuid,
    pub title: String,
    pub description: String,
    pub cvss_score: f32,
    pub epss_score: Option<f32>,
    pub severity: String,
    pub ip_address: String,
    pub hostname: Option<String>,
    pub port: Option<i32>,
    pub protocol: Option<String>,
    pub status: String,
    pub cve_id: Option<String>,
    pub cwe_id: Option<String>,
    pub remediation: Option<String>,
    pub source: String,
    pub discovered_at: DateTime<Utc>,
    pub asset_name: Option<String>,
    pub assigned_team: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ExportSummary {
    pub total_vulnerabilities: usize,
    pub critical: usize,
    pub high: usize,
    pub medium: usize,
    pub low: usize,
    pub info: usize,
    pub open: usize,
    pub in_progress: usize,
    pub resolved: usize,
    pub closed: usize,
    pub average_cvss: f32,
}

impl ExportSummary {
    pub fn from_vulnerabilities(vulns: &[VulnerabilityExport]) -> Self {
        let total = vulns.len();
        let critical = vulns.iter().filter(|v| v.severity == "critical").count();
        let high = vulns.iter().filter(|v| v.severity == "high").count();
        let medium = vulns.iter().filter(|v| v.severity == "medium").count();
        let low = vulns.iter().filter(|v| v.severity == "low").count();
        let info = vulns.iter().filter(|v| v.severity == "info").count();

        let open = vulns.iter().filter(|v| v.status == "open").count();
        let in_progress = vulns.iter().filter(|v| v.status == "in_progress").count();
        let resolved = vulns.iter().filter(|v| v.status == "resolved").count();
        let closed = vulns.iter().filter(|v| v.status == "closed").count();

        let average_cvss = if total > 0 {
            vulns.iter().map(|v| v.cvss_score).sum::<f32>() / total as f32
        } else {
            0.0
        };

        Self {
            total_vulnerabilities: total,
            critical,
            high,
            medium,
            low,
            info,
            open,
            in_progress,
            resolved,
            closed,
            average_cvss,
        }
    }
}

#[derive(Debug, Clone)]
pub enum ExportFormat {
    Xml,
    Json,
    Csv,
    Pdf,
}

pub async fn export_report(
    data: ExportData,
    format: ExportFormat,
) -> Result<Vec<u8>, Box<dyn std::error::Error>> {
    match format {
        ExportFormat::Xml => xml::export_to_xml(data),
        ExportFormat::Json => json::export_to_json(data),
        ExportFormat::Csv => csv::export_to_csv(data),
        ExportFormat::Pdf => pdf::export_to_pdf(data),
    }
}
