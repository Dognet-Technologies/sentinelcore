// src/export/pdf.rs
// Export report in formato PDF

use super::{ExportData, ExportSummary};
use printpdf::*;
use std::fs::File;
use std::io::BufWriter;

pub fn export_to_pdf(data: ExportData) -> Result<Vec<u8>, Box<dyn std::error::Error>> {
    // Create PDF document
    let (doc, page1, layer1) = PdfDocument::new(
        &format!("Vulnerability Report - {}", data.report_name),
        Mm(210.0),
        Mm(297.0),
        "Layer 1",
    );

    let font = doc.add_builtin_font(BuiltinFont::Helvetica)?;
    let font_bold = doc.add_builtin_font(BuiltinFont::HelveticaBold)?;

    let current_layer = doc.get_page(page1).get_layer(layer1);

    // Title
    current_layer.use_text(
        &format!("Vulnerability Report: {}", data.report_name),
        24.0,
        Mm(20.0),
        Mm(270.0),
        &font_bold,
    );

    // Generated timestamp
    current_layer.use_text(
        &format!("Generated: {}", data.generated_at.format("%Y-%m-%d %H:%M:%S UTC")),
        12.0,
        Mm(20.0),
        Mm(260.0),
        &font,
    );

    // Summary section
    let mut y_pos = 245.0;
    current_layer.use_text("Summary", 18.0, Mm(20.0), Mm(y_pos), &font_bold);

    y_pos -= 10.0;
    let summary_lines = vec![
        format!("Total Vulnerabilities: {}", data.summary.total_vulnerabilities),
        format!("  Critical: {}", data.summary.critical),
        format!("  High: {}", data.summary.high),
        format!("  Medium: {}", data.summary.medium),
        format!("  Low: {}", data.summary.low),
        format!("  Info: {}", data.summary.info),
        format!("Average CVSS Score: {:.2}", data.summary.average_cvss),
        format!("Status - Open: {}, In Progress: {}, Resolved: {}, Closed: {}",
            data.summary.open, data.summary.in_progress,
            data.summary.resolved, data.summary.closed),
    ];

    for line in summary_lines {
        current_layer.use_text(&line, 11.0, Mm(20.0), Mm(y_pos), &font);
        y_pos -= 6.0;
    }

    // Vulnerabilities section
    y_pos -= 10.0;
    current_layer.use_text("Vulnerabilities", 18.0, Mm(20.0), Mm(y_pos), &font_bold);

    y_pos -= 10.0;
    for (idx, vuln) in data.vulnerabilities.iter().enumerate() {
        // Check if we need a new page
        if y_pos < 30.0 {
            let (page, layer) = doc.add_page(Mm(210.0), Mm(297.0), "Layer 1");
            let current_layer = doc.get_page(page).get_layer(layer);
            y_pos = 280.0;
        }

        current_layer.use_text(
            &format!("{}. {}", idx + 1, vuln.title),
            12.0,
            Mm(20.0),
            Mm(y_pos),
            &font_bold,
        );
        y_pos -= 6.0;

        let vuln_details = vec![
            format!("  CVSS: {:.1} | Severity: {} | Status: {}",
                vuln.cvss_score, vuln.severity, vuln.status),
            format!("  IP: {} | Port: {} | Protocol: {}",
                vuln.ip_address,
                vuln.port.map(|p| p.to_string()).unwrap_or_else(|| "N/A".to_string()),
                vuln.protocol.as_deref().unwrap_or("N/A")),
            format!("  CVE: {} | CWE: {}",
                vuln.cve_id.as_deref().unwrap_or("N/A"),
                vuln.cwe_id.as_deref().unwrap_or("N/A")),
        ];

        for detail in vuln_details {
            current_layer.use_text(&detail, 10.0, Mm(20.0), Mm(y_pos), &font);
            y_pos -= 5.0;
        }

        y_pos -= 3.0; // Extra space between vulnerabilities
    }

    // Save to bytes
    let mut buffer = Vec::new();
    doc.save(&mut BufWriter::new(&mut buffer))?;

    Ok(buffer)
}
