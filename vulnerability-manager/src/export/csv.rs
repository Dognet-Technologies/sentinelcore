// src/export/csv.rs
// Export report in formato CSV

use super::ExportData;
use csv::Writer;

pub fn export_to_csv(data: ExportData) -> Result<Vec<u8>, Box<dyn std::error::Error>> {
    let mut wtr = Writer::from_writer(vec![]);

    // Header
    wtr.write_record(&[
        "ID",
        "Title",
        "Description",
        "CVSS Score",
        "EPSS Score",
        "Severity",
        "IP Address",
        "Hostname",
        "Port",
        "Protocol",
        "Status",
        "CVE ID",
        "CWE ID",
        "Remediation",
        "Source",
        "Discovered At",
        "Asset Name",
        "Assigned Team",
    ])?;

    // Vulnerabilities
    for vuln in &data.vulnerabilities {
        wtr.write_record(&[
            vuln.id.to_string(),
            vuln.title.clone(),
            vuln.description.clone(),
            vuln.cvss_score.to_string(),
            vuln.epss_score
                .map(|s| s.to_string())
                .unwrap_or_default(),
            vuln.severity.clone(),
            vuln.ip_address.clone(),
            vuln.hostname.clone().unwrap_or_default(),
            vuln.port.map(|p| p.to_string()).unwrap_or_default(),
            vuln.protocol.clone().unwrap_or_default(),
            vuln.status.clone(),
            vuln.cve_id.clone().unwrap_or_default(),
            vuln.cwe_id.clone().unwrap_or_default(),
            vuln.remediation.clone().unwrap_or_default(),
            vuln.source.clone(),
            vuln.discovered_at.to_rfc3339(),
            vuln.asset_name.clone().unwrap_or_default(),
            vuln.assigned_team.clone().unwrap_or_default(),
        ])?;
    }

    let csv_bytes = wtr.into_inner()?;
    Ok(csv_bytes)
}
