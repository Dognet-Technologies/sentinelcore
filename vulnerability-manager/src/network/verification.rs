// src/network/verification.rs
// System requirements verification for network scanning

use anyhow::{Result, Context};
use std::process::Command;
use tracing::{info, warn, error};

/// Tool requirement information
#[derive(Debug, Clone)]
pub struct ToolRequirement {
    pub name: &'static str,
    pub required: bool,
    pub requires_root: bool,
    pub purpose: &'static str,
}

/// Verification results
#[derive(Debug)]
pub struct VerificationResults {
    pub all_required_tools_present: bool,
    pub has_sufficient_privileges: bool,
    pub missing_tools: Vec<String>,
    pub privilege_warnings: Vec<String>,
}

impl VerificationResults {
    /// Check if system is ready for network scanning
    pub fn is_ready(&self) -> bool {
        self.all_required_tools_present && self.has_sufficient_privileges
    }

    /// Get human-readable summary
    pub fn summary(&self) -> String {
        let mut lines = vec![];

        if !self.all_required_tools_present {
            lines.push(format!("âŒ Missing required tools: {}", self.missing_tools.join(", ")));
        } else {
            lines.push("âœ… All required tools are installed".to_string());
        }

        if !self.has_sufficient_privileges {
            for warning in &self.privilege_warnings {
                lines.push(format!("âš ï¸  {}", warning));
            }
        } else {
            lines.push("âœ… Sufficient privileges for network scanning".to_string());
        }

        lines.join("\n")
    }
}

/// Get list of required tools
pub fn get_required_tools() -> Vec<ToolRequirement> {
    vec![
        ToolRequirement {
            name: "arp-scan",
            required: true,
            requires_root: true,
            purpose: "ARP-based network device discovery",
        },
        ToolRequirement {
            name: "nmap",
            required: true,
            requires_root: true, // For -O flag (OS detection)
            purpose: "Port scanning and service detection",
        },
        ToolRequirement {
            name: "traceroute",
            required: false,
            requires_root: false,
            purpose: "Network path discovery",
        },
        ToolRequirement {
            name: "ip",
            required: false,
            requires_root: false,
            purpose: "Network interface information",
        },
    ]
}

/// Check if a tool is installed and accessible
fn check_tool_installed(tool_name: &str) -> bool {
    Command::new("which")
        .arg(tool_name)
        .output()
        .map(|output| output.status.success())
        .unwrap_or(false)
}

/// Check if running with root privileges
fn check_root_privileges() -> bool {
    // Check if UID is 0 (root)
    #[cfg(unix)]
    {
        unsafe { libc::getuid() == 0 }
    }

    #[cfg(not(unix))]
    {
        false
    }
}

/// Check if the process has CAP_NET_RAW capability (alternative to root)
#[cfg(target_os = "linux")]
fn check_net_raw_capability() -> bool {
    // Check if we can execute arp-scan/nmap without root by testing a simple command
    // This is a practical check rather than querying capabilities directly
    Command::new("arp-scan")
        .arg("--help")
        .output()
        .map(|output| output.status.success())
        .unwrap_or(false)
}

#[cfg(not(target_os = "linux"))]
fn check_net_raw_capability() -> bool {
    false
}

/// Perform comprehensive system verification
pub fn verify_system_requirements() -> Result<VerificationResults> {
    info!("ðŸ” Verifying network scanning system requirements...");

    let tools = get_required_tools();
    let mut missing_tools = Vec::new();
    let mut privilege_warnings = Vec::new();

    // Check tool availability
    for tool in &tools {
        info!("Checking for tool: {}", tool.name);

        let installed = check_tool_installed(tool.name);

        if !installed {
            let message = if tool.required {
                format!("{} (required for {})", tool.name, tool.purpose)
            } else {
                format!("{} (optional, for {})", tool.name, tool.purpose)
            };

            if tool.required {
                error!("âŒ Missing required tool: {}", tool.name);
                missing_tools.push(message);
            } else {
                warn!("âš ï¸  Missing optional tool: {}", tool.name);
            }
        } else {
            info!("âœ… Found: {}", tool.name);
        }
    }

    // Check privileges
    let is_root = check_root_privileges();
    let has_capabilities = check_net_raw_capability();
    let has_sufficient_privileges = is_root || has_capabilities;

    if is_root {
        info!("âœ… Running with root privileges");
    } else if has_capabilities {
        info!("âœ… Has CAP_NET_RAW capability");
    } else {
        warn!("âš ï¸  Not running with root privileges");
        privilege_warnings.push(
            "Network scanning requires root privileges or CAP_NET_RAW capability".to_string()
        );
        privilege_warnings.push(
            "ARP scans and OS detection will fail without elevated privileges".to_string()
        );
        privilege_warnings.push(
            "To fix: Run as root or set capabilities: sudo setcap cap_net_raw+ep /usr/bin/arp-scan".to_string()
        );
    }

    let results = VerificationResults {
        all_required_tools_present: missing_tools.is_empty(),
        has_sufficient_privileges,
        missing_tools,
        privilege_warnings,
    };

    // Log summary
    info!("\n{}", results.summary());

    if !results.is_ready() {
        warn!("âš ï¸  System is not fully ready for network scanning");
    } else {
        info!("âœ… System is ready for network scanning");
    }

    Ok(results)
}

/// Quick check if system is ready (for startup checks)
pub fn quick_check() -> bool {
    let required_tools = vec!["arp-scan", "nmap"];

    for tool in required_tools {
        if !check_tool_installed(tool) {
            return false;
        }
    }

    true
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_tool_requirements() {
        let tools = get_required_tools();
        assert!(tools.len() >= 2); // At least arp-scan and nmap

        let arp_scan = tools.iter().find(|t| t.name == "arp-scan");
        assert!(arp_scan.is_some());
        assert!(arp_scan.unwrap().required);
    }

    #[test]
    fn test_verification_results_ready() {
        let results = VerificationResults {
            all_required_tools_present: true,
            has_sufficient_privileges: true,
            missing_tools: vec![],
            privilege_warnings: vec![],
        };
        assert!(results.is_ready());

        let results_not_ready = VerificationResults {
            all_required_tools_present: false,
            has_sufficient_privileges: true,
            missing_tools: vec!["arp-scan".to_string()],
            privilege_warnings: vec![],
        };
        assert!(!results_not_ready.is_ready());
    }
}
