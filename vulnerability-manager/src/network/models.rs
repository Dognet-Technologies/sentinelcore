// src/network/models.rs
// Modelli per la network topology e scanning

use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use uuid::Uuid;

#[derive(Debug, Clone, Serialize, Deserialize, sqlx::Type)]
#[sqlx(type_name = "device_type", rename_all = "lowercase")]
pub enum DeviceType {
    Router,
    Switch,
    Firewall,
    Server,
    Workstation,
    IoT,
    Printer,
    Unknown,
}

#[derive(Debug, Clone, Serialize, Deserialize, sqlx::Type)]
#[sqlx(type_name = "device_status", rename_all = "lowercase")]
pub enum DeviceStatus {
    Online,
    Offline,
    Unknown,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkDevice {
    pub id: Uuid,
    pub ip_address: String,
    pub mac_address: Option<String>,
    pub hostname: Option<String>,
    pub device_type: DeviceType,
    pub device_status: DeviceStatus,
    pub vendor: Option<String>,
    pub os_name: Option<String>,
    pub os_version: Option<String>,
    pub open_ports: Option<Vec<i32>>,
    pub services: Option<serde_json::Value>,
    pub first_seen: DateTime<Utc>,
    pub last_seen: DateTime<Utc>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkLink {
    pub id: Uuid,
    pub source_device_id: Uuid,
    pub target_device_id: Uuid,
    pub link_type: String,
    pub latency_ms: Option<f32>,
    pub hop_count: Option<i32>,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkScan {
    pub id: Uuid,
    pub scan_name: String,
    pub scan_type: String, // arp-scan, nmap, traceroute
    pub target_range: String,
    pub status: String, // pending, running, completed, failed
    pub devices_found: i32,
    pub started_at: Option<DateTime<Utc>>,
    pub completed_at: Option<DateTime<Utc>>,
    pub created_by: Uuid,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkTopology {
    pub devices: Vec<NetworkDevice>,
    pub links: Vec<NetworkLink>,
    pub scan_info: Option<NetworkScan>,
}

// Request/Response DTOs
#[derive(Debug, Deserialize)]
pub struct StartScanRequest {
    pub scan_name: String,
    pub scan_type: String,
    pub target_range: String,
    pub include_port_scan: Option<bool>,
    pub include_os_detection: Option<bool>,
}

#[derive(Debug, Serialize)]
pub struct ScanProgress {
    pub scan_id: Uuid,
    pub status: String,
    pub progress_percent: f32,
    pub devices_found: i32,
    pub message: Option<String>,
}
