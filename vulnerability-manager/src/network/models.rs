// src/network/models.rs
// Modelli per la network topology e scanning

use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use uuid::Uuid;

#[derive(Debug, Clone, Serialize, Deserialize, sqlx::Type)]
#[sqlx(type_name = "device_type", rename_all = "lowercase")]
pub enum DeviceType {
    Router,
    Switch,
    Firewall,
    Server,
    Workstation,
    IoT,
    Printer,
    Unknown,
}

#[derive(Debug, Clone, Serialize, Deserialize, sqlx::Type)]
#[sqlx(type_name = "device_status", rename_all = "lowercase")]
pub enum DeviceStatus {
    Online,
    Offline,
    Unknown,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkDevice {
    pub id: Uuid,
    pub ip_address: String,
    pub mac_address: Option<String>,
    pub hostname: Option<String>,
    pub device_type: DeviceType,
    pub device_status: DeviceStatus,
    pub vendor: Option<String>,
    pub os_name: Option<String>,
    pub os_version: Option<String>,
    pub open_ports: Option<Vec<i32>>,
    pub services: Option<serde_json::Value>,
    pub first_seen: DateTime<Utc>,
    pub last_seen: DateTime<Utc>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkLink {
    pub id: Uuid,
    pub source_device_id: Uuid,
    pub target_device_id: Uuid,
    pub link_type: String,
    pub latency_ms: Option<f32>,
    pub hop_count: Option<i32>,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkScan {
    pub id: Uuid,
    pub scan_name: String,
    pub scan_type: String, // arp-scan, nmap, traceroute
    pub target_range: String,
    pub status: String, // pending, running, completed, failed
    pub devices_found: Option<i32>,
    pub started_at: Option<DateTime<Utc>>,
    pub completed_at: Option<DateTime<Utc>>,
    pub created_by: Uuid,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkTopology {
    pub devices: Vec<NetworkDevice>,
    pub links: Vec<NetworkLink>,
    pub scan_info: Option<NetworkScan>,
}

// Request/Response DTOs
#[derive(Debug, Deserialize)]
pub struct StartScanRequest {
    pub scan_name: String,
    pub scan_type: String,
    pub target_range: String,
    pub include_port_scan: Option<bool>,
    pub include_os_detection: Option<bool>,
}

#[derive(Debug, Serialize)]
pub struct ScanProgress {
    pub scan_id: Uuid,
    pub status: String,
    pub progress_percent: f32,
    pub devices_found: i32,
    pub message: Option<String>,
}

// Enhanced device model with vulnerability counts and assignment
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkDeviceWithVulnerabilities {
    pub id: Uuid,
    pub ip_address: String,
    pub mac_address: Option<String>,
    pub hostname: Option<String>,
    pub device_type: DeviceType,
    pub device_status: DeviceStatus,
    pub vendor: Option<String>,
    pub os_name: Option<String>,
    pub os_version: Option<String>,
    pub open_ports: Option<Vec<i32>>,
    pub services: Option<serde_json::Value>,
    pub first_seen: DateTime<Utc>,
    pub last_seen: DateTime<Utc>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,

    // Assignment fields
    pub assigned_user_id: Option<Uuid>,
    pub assigned_team_id: Option<Uuid>,
    pub owner: Option<String>,
    pub location: Option<String>,
    pub criticality: Option<String>,
    pub tags: Option<Vec<String>>,
    pub notes: Option<String>,
    pub is_internet_facing: Option<bool>,
    pub has_public_ip: Option<bool>,

    // Vulnerability summary
    pub vulnerabilities: VulnerabilitySummary,
}

#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct VulnerabilitySummary {
    pub total: i64,
    pub critical: i64,
    pub high: i64,
    pub medium: i64,
    pub low: i64,
    pub info: i64,
    pub epss_average: Option<f64>,
    pub epss_max: Option<f64>,
    pub cvss_average: Option<f64>,
    pub cvss_max: Option<f64>,
    pub risk_score_sum: Option<i64>,  // Sum of all risk scores
    pub risk_score_max: Option<i32>,  // Highest risk score
    pub risk_score_avg: Option<f64>,  // Average risk score
}

// Request to update device
#[derive(Debug, Deserialize)]
pub struct UpdateDeviceRequest {
    pub hostname: Option<String>,
    pub device_type: Option<DeviceType>,
    pub vendor: Option<String>,
    pub os_name: Option<String>,
    pub os_version: Option<String>,
    pub owner: Option<String>,
    pub location: Option<String>,
    pub criticality: Option<String>,
    pub tags: Option<Vec<String>>,
    pub notes: Option<String>,
    pub is_internet_facing: Option<bool>,
    pub has_public_ip: Option<bool>,
    pub assigned_user_id: Option<Uuid>,
    pub assigned_team_id: Option<Uuid>,
}

// Request to assign device to user/team
#[derive(Debug, Deserialize)]
pub struct DeviceAssignmentRequest {
    pub user_id: Option<Uuid>,
    pub team_id: Option<Uuid>,
}

// Request to bulk assign devices
#[derive(Debug, Deserialize)]
pub struct BulkAssignRequest {
    pub device_ids: Vec<Uuid>,
    pub user_id: Option<Uuid>,
    pub team_id: Option<Uuid>,
}

// Enhanced topology with vulnerability data
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct NetworkTopologyWithVulnerabilities {
    pub devices: Vec<NetworkDeviceWithVulnerabilities>,
    pub links: Vec<NetworkLink>,
    pub scan_info: Option<NetworkScan>,
}
