// src/api/mod.rs
// FIXED: Convertito completamente da Extension a State per Axum 0.6

use axum::{
    middleware,
    routing::{delete, get, post, put},
    Router,
    Json,
    http::StatusCode,
};
use serde_json::json;
use sqlx::PgPool;
use std::sync::Arc;
use tower_http::cors::{Any, CorsLayer};
use tower_http::services::ServeDir;
use crate::auth::{Auth, require_auth, require_admin};
use crate::config::Config;
use crate::handlers;
use crate::network;
use crate::state::AppState; // FIXED: Import from lib.rs

// Simple health check function
async fn health_check() -> Result<Json<serde_json::Value>, StatusCode> {
    Ok(Json(json!({
        "status": "healthy",
        "timestamp": chrono::Utc::now().to_rfc3339(),
        "version": env!("CARGO_PKG_VERSION")
    })))
}

pub fn create_router(pool: Arc<PgPool>, auth: Arc<Auth>, config: Arc<Config>) -> Router {
    // Create shared application state
    let state = AppState {
        pool: pool.clone(),
        auth: auth.clone(),
        config: config.clone(),
    };

    // Configurazione CORS per sicurezza
    let cors = CorsLayer::new()
        .allow_origin(Any)
        .allow_methods(Any)
        .allow_headers(Any);

    // Routes pubbliche (non richiedono autenticazione)
    let public_routes = Router::new()
        .route("/api/auth/login", post(handlers::auth::login))
        .route("/api/auth/forgot-password", post(handlers::auth::forgot_password))
        .route("/api/health", get(health_check))
        .with_state(state.clone());

    // Routes protette - richiedono autenticazione
    let protected_routes = Router::new()
        // Dashboard route
        .route("/api/dashboard/stats", get(handlers::dashboard::get_dashboard_stats))

        // User routes - il proprio profilo
        .route("/api/users/me", get(handlers::user::get_current_user))
        .route("/api/users/me", put(handlers::user::update_current_user))
        .route("/api/users/me/password", put(handlers::user::change_password))
        .route("/api/users/me/avatar", post(handlers::user::upload_avatar))
        .route("/api/users/me/sessions", get(handlers::user::get_user_sessions))
        .route("/api/users/me/sessions/:id", delete(handlers::user::revoke_session))
        .route("/api/users/me/2fa/enable", post(handlers::user::enable_two_factor))
        .route("/api/users/me/2fa/disable", post(handlers::user::disable_two_factor))
        .route("/api/users/me/2fa/verify", post(handlers::user::verify_two_factor))
        .route("/api/users/me/security", get(handlers::user::get_security_settings))
        .route("/api/users/me/security", put(handlers::user::update_security_settings))
        .route("/api/users/me/reputation", get(handlers::user::get_reputation_events))
        .route("/api/users/me/avatar", delete(handlers::user::delete_avatar))
        .route("/api/users/me/notifications", get(handlers::user::get_notification_settings))
        .route("/api/users/me/notifications", put(handlers::user::update_notification_settings))
        .route("/api/users/me/api-keys", get(handlers::user::list_api_keys))
        .route("/api/users/me/api-keys", post(handlers::user::create_api_key))
        .route("/api/users/me/api-keys/:key_id", delete(handlers::user::revoke_api_key))

        // Vulnerability routes
        .route("/api/vulnerabilities", get(handlers::vulnerability::list_vulnerabilities))
        .route("/api/vulnerabilities/:id", get(handlers::vulnerability::get_vulnerability))

        // Team routes (visualizzazione per utenti autenticati)
        .route("/api/teams", get(handlers::team::list_teams))
        .route("/api/teams/:id", get(handlers::team::get_team))
        .route("/api/teams/:id/members", get(handlers::team::get_team_members))

        // Asset routes (visualizzazione per utenti autenticati)
        .route("/api/assets", get(handlers::asset::list_assets))
        .route("/api/assets/:id", get(handlers::asset::get_asset))

        // Report routes (visualizzazione per utenti autenticati)
        .route("/api/reports", get(handlers::report::list_reports))
        .route("/api/reports/:id", get(handlers::report::get_report))
        .route("/api/reports/:id/download", get(handlers::report::download_report))

        // Plugin routes (visualizzazione per utenti autenticati)
        .route("/api/plugins", get(handlers::plugin::list_plugins))
        .route("/api/plugins/:id", get(handlers::plugin::get_plugin))

        // Network routes (tutti gli utenti autenticati possono usare)
        .route("/api/network/scan", post(network::handler::start_network_scan))
        .route("/api/network/scan/:scan_id", get(network::handler::get_scan_status))
        .route("/api/network/topology", get(network::handler::get_network_topology))
        .route("/api/network/devices/:device_id", get(network::handler::get_device_details))
        .route("/api/network/remediation", post(network::handler::execute_remediation))

        // Auth routes protette
        .route("/api/auth/logout", post(handlers::auth::logout))
        .route("/api/auth/refresh", post(handlers::auth::refresh_token))
        
        // FIXED: Middleware corretto per Axum 0.6 con State
        .layer(middleware::from_fn_with_state(state.clone(), require_auth))
        .with_state(state.clone());

    // Routes admin - richiedono ruolo admin
    let admin_routes = Router::new()
        // User management routes
        .route("/api/users", get(handlers::user::list_users))
        .route("/api/users", post(handlers::user::create_user))
        .route("/api/users/:id", get(handlers::user::get_user))
        .route("/api/users/:id", put(handlers::user::update_user))
        .route("/api/users/:id", delete(handlers::user::delete_user))
        .route("/api/users/:id/lock", post(handlers::user::lock_user))
        .route("/api/users/:id/unlock", post(handlers::user::unlock_user))
        .route("/api/users/:id/sessions", get(handlers::user::get_user_sessions_admin))
        .route("/api/users/:id/sessions/revoke-all", post(handlers::user::revoke_all_user_sessions))
        
        // Vulnerability management routes
        .route("/api/vulnerabilities", post(handlers::vulnerability::create_vulnerability))
        .route("/api/vulnerabilities/:id", put(handlers::vulnerability::update_vulnerability))
        .route("/api/vulnerabilities/:id", delete(handlers::vulnerability::delete_vulnerability))
        .route("/api/vulnerabilities/:id/assign", post(handlers::vulnerability::assign_to_team))

        // Team management routes (admin only)
        .route("/api/teams", post(handlers::team::create_team))
        .route("/api/teams/:id", put(handlers::team::update_team))
        .route("/api/teams/:id", delete(handlers::team::delete_team))
        .route("/api/teams/:id/members", post(handlers::team::add_team_member))
        .route("/api/teams/:team_id/members/:user_id", delete(handlers::team::remove_team_member))

        // Asset management routes (admin only)
        .route("/api/assets", post(handlers::asset::create_asset))
        .route("/api/assets/:id", put(handlers::asset::update_asset))
        .route("/api/assets/:id", delete(handlers::asset::delete_asset))

        // Report management routes (admin only)
        .route("/api/reports", post(handlers::report::create_report))
        .route("/api/reports/:id", put(handlers::report::update_report))
        .route("/api/reports/:id", delete(handlers::report::delete_report))

        // Plugin management routes (admin only)
        .route("/api/plugins", post(handlers::plugin::install_plugin))
        .route("/api/plugins/:id", put(handlers::plugin::update_plugin))
        .route("/api/plugins/:id", delete(handlers::plugin::uninstall_plugin))
        .route("/api/plugins/:id/toggle", post(handlers::plugin::toggle_plugin))

        // Security routes
        .route("/api/security/ip-whitelist", get(handlers::security::get_ip_whitelist))
        .route("/api/security/ip-whitelist", post(handlers::security::add_ip_whitelist))
        .route("/api/security/ip-whitelist/:id", delete(handlers::security::remove_ip_whitelist))
        .route("/api/security/permissions/user/:user_id", get(handlers::security::get_user_permissions))
        .route("/api/security/permissions", post(handlers::security::grant_user_permission))
        .route("/api/security/permissions/:id", delete(handlers::security::revoke_user_permission))
        
        // Audit routes
        .route("/api/audit/logs", get(handlers::audit::get_audit_logs))
        .route("/api/audit/logs", post(handlers::audit::create_audit_log))
        .route("/api/audit/logs/:id", get(handlers::audit::get_audit_log_by_id))
        .route("/api/audit/stats", get(handlers::audit::get_audit_stats))
        
        // FIXED: Middleware chain corretto per admin routes con State
        .layer(middleware::from_fn(require_admin))
        .layer(middleware::from_fn_with_state(state.clone(), require_auth))
        .with_state(state.clone());

    // Static file serving for uploads
    let static_routes = Router::new()
        .nest_service("/uploads", ServeDir::new("uploads"));

    // Combina tutte le routes
    Router::new()
        .merge(public_routes)
        .merge(protected_routes)
        .merge(admin_routes)
        .merge(static_routes)
        .layer(cors)
}