// src/api/mod.rs
// FIXED: Convertito completamente da Extension a State per Axum 0.6

use axum::{
    extract::State,
    middleware as axum_middleware,
    routing::{delete, get, post, put},
    Router,
    Json,
    http::StatusCode,
};
use serde_json::json;
use sqlx::PgPool;
use std::sync::Arc;
use tower_http::services::ServeDir;
use tower_cookies::CookieManagerLayer;
use tracing::info;
use crate::auth::{Auth, require_auth, require_admin};
use crate::config::Config;
use crate::handlers;
use crate::network;
use crate::state::AppState; // FIXED: Import from lib.rs
use crate::middleware::{create_cors_layer, add_security_headers, create_rate_limiter_layer, spawn_cleanup_task};

// Enhanced health check function with database connectivity check
async fn health_check(
    State(app_state): State<AppState>,
) -> Result<Json<serde_json::Value>, StatusCode> {
    // Check database connectivity
    let db_healthy = sqlx::query("SELECT 1")
        .fetch_one(&*app_state.pool)
        .await
        .is_ok();

    let overall_status = if db_healthy { "healthy" } else { "degraded" };
    let status_code = if db_healthy { StatusCode::OK } else { StatusCode::SERVICE_UNAVAILABLE };

    let response = json!({
        "status": overall_status,
        "timestamp": chrono::Utc::now().to_rfc3339(),
        "version": env!("CARGO_PKG_VERSION"),
        "checks": {
            "database": if db_healthy { "healthy" } else { "unhealthy" },
            "api": "healthy"
        }
    });

    if db_healthy {
        Ok(Json(response))
    } else {
        Err(status_code)
    }
}

// Readiness check for Kubernetes/container orchestration
async fn readiness_check(
    State(app_state): State<AppState>,
) -> Result<Json<serde_json::Value>, StatusCode> {
    // More strict check for readiness - verify we can actually query the database
    let ready = sqlx::query_scalar::<_, i64>("SELECT COUNT(*) FROM users LIMIT 1")
        .fetch_optional(&*app_state.pool)
        .await
        .is_ok();

    if ready {
        Ok(Json(json!({
            "status": "ready",
            "timestamp": chrono::Utc::now().to_rfc3339()
        })))
    } else {
        Err(StatusCode::SERVICE_UNAVAILABLE)
    }
}

pub fn create_router(pool: Arc<PgPool>, auth: Arc<Auth>, config: Arc<Config>) -> Router {
    // Create shared application state
    let state = AppState {
        pool: pool.clone(),
        auth: auth.clone(),
        config: config.clone(),
    };

    // Security configuration
    info!("üîí Configuring security middleware...");

    // CORS configuration from config file
    let cors = create_cors_layer(&config.security.cors);
    if !config.security.cors.allowed_origins.is_empty() {
        info!("‚úÖ CORS configured with allowed origins: {:?}", config.security.cors.allowed_origins);
    } else {
        info!("‚ö†Ô∏è  CORS configured in permissive mode (development)");
    }

    // Security headers - we'll apply via middleware later
    info!("‚úÖ Security headers middleware enabled");

    // Rate limiting (if enabled)
    let rate_limit_enabled = config.security.rate_limit.enabled;
    let rate_limiter = if rate_limit_enabled {
        let limiter = create_rate_limiter_layer(
            config.security.rate_limit.requests_per_minute,
            config.security.rate_limit.burst_size,
        );
        spawn_cleanup_task(limiter.clone());
        info!("‚úÖ Rate limiting enabled: {} req/min, burst: {}",
            config.security.rate_limit.requests_per_minute,
            config.security.rate_limit.burst_size);
        Some(limiter)
    } else {
        info!("‚ö†Ô∏è  Rate limiting disabled");
        None
    };

    // Routes pubbliche (non richiedono autenticazione)
    let public_routes = Router::new()
        .route("/api/auth/register", post(handlers::auth::register))
        .route("/api/auth/login", post(handlers::auth::login))
        .route("/api/auth/forgot-password", post(handlers::auth::forgot_password))
        .route("/api/auth/password-reset/initiate", post(handlers::password_reset::initiate_password_reset))
        .route("/api/auth/password-reset/confirm", post(handlers::password_reset::confirm_password_reset))
        .route("/api/auth/password-reset/:token/status", get(handlers::password_reset::get_password_reset_status))
        .route("/api/health", get(health_check))
        .route("/api/ready", get(readiness_check))
        .with_state(state.clone());

    // Routes protette - richiedono autenticazione
    let protected_routes = Router::new()
        // Dashboard route
        .route("/api/dashboard/stats", get(handlers::dashboard::get_dashboard_stats))

        // User routes - il proprio profilo
        .route("/api/users/me", get(handlers::user::get_current_user))
        .route("/api/users/me", put(handlers::user::update_current_user))
        .route("/api/users/me/password", put(handlers::user::change_password))
        .route("/api/users/me/avatar", post(handlers::user::upload_avatar))
        .route("/api/users/me/sessions", get(handlers::user::get_user_sessions))
        .route("/api/users/me/sessions/:id", delete(handlers::user::revoke_session))
        .route("/api/users/me/2fa/enable", post(handlers::user::enable_two_factor))
        .route("/api/users/me/2fa/disable", post(handlers::user::disable_two_factor))
        .route("/api/users/me/2fa/verify", post(handlers::user::verify_two_factor))
        .route("/api/users/me/security", get(handlers::user::get_security_settings))
        .route("/api/users/me/security", put(handlers::user::update_security_settings))
        .route("/api/users/me/reputation", get(handlers::user::get_reputation_events))
        .route("/api/users/me/avatar", delete(handlers::user::delete_avatar))
        .route("/api/users/me/notifications", get(handlers::user::get_notification_settings))
        .route("/api/users/me/notifications", put(handlers::user::update_notification_settings))
        .route("/api/users/me/api-keys", get(handlers::user::list_api_keys))
        .route("/api/users/me/api-keys", post(handlers::user::create_api_key))
        .route("/api/users/me/api-keys/:key_id", delete(handlers::user::revoke_api_key))

        // Vulnerability routes
        .route("/api/vulnerabilities", get(handlers::vulnerability::list_vulnerabilities))
        .route("/api/vulnerabilities/my-assigned", get(handlers::vulnerability::get_my_assigned_vulnerabilities))
        .route("/api/vulnerabilities/:id", get(handlers::vulnerability::get_vulnerability))

        // Team routes (visualizzazione per utenti autenticati)
        .route("/api/teams", get(handlers::team::list_teams))
        .route("/api/teams/:id", get(handlers::team::get_team))
        .route("/api/teams/:id/members", get(handlers::team::get_team_members))

        // Asset routes (visualizzazione per utenti autenticati)
        .route("/api/assets", get(handlers::asset::list_assets))
        .route("/api/assets/:id", get(handlers::asset::get_asset))

        // Report routes (visualizzazione per utenti autenticati)
        .route("/api/reports", get(handlers::report::list_reports))
        .route("/api/reports/:id", get(handlers::report::get_report))
        .route("/api/reports/:id/download", get(handlers::report::download_report))
        .route("/api/reports/:id/generate", post(handlers::report::generate_report))
        .route("/api/reports/:id/send", post(handlers::report::send_report_email))
        .route("/api/reports/:id/duplicate", post(handlers::report::duplicate_report))
        .route("/api/reports/generate-management", post(handlers::management_report::generate_management_report))

        // Plugin routes (visualizzazione per utenti autenticati)
        .route("/api/plugins", get(handlers::plugin::list_plugins))
        .route("/api/plugins/:id", get(handlers::plugin::get_plugin))

        // Scanner routes (list available scanners - all authenticated users)
        .route("/api/scanners", get(handlers::scanner_import::list_scanners))

        // Network routes (tutti gli utenti autenticati possono usare)
        .route("/api/network/scan", post(network::handler::start_network_scan))
        .route("/api/network/scan/:scan_id", get(network::handler::get_scan_status))
        .route("/api/network/topology", get(network::handler::get_network_topology))
        .route("/api/network/devices/:device_id", get(network::handler::get_device_details))
        .route("/api/network/remediation", post(network::handler::execute_remediation))

        // Comments routes (authenticated users can comment)
        .route("/api/comments/entity/:entity_type/:entity_id", get(handlers::comments::get_comments))
        .route("/api/comments", post(handlers::comments::create_comment))
        .route("/api/comments/:comment_id", put(handlers::comments::update_comment))
        .route("/api/comments/:comment_id", delete(handlers::comments::delete_comment))
        .route("/api/mentions/me", get(handlers::comments::get_user_mentions))

        // Risk scoring routes (authenticated users can view)
        .route("/api/risk/statistics", get(handlers::risk_scoring::get_risk_statistics))
        .route("/api/risk/sla/breaches", get(handlers::risk_scoring::get_sla_breaches))

        // Workload tracking routes (authenticated users)
        .route("/api/workload/me", get(handlers::workload::get_my_workload))

        // Notification rules routes (authenticated users can view)
        .route("/api/notification-rules", get(handlers::notification_rules::list_notification_rules))
        .route("/api/notification-rules/:id", get(handlers::notification_rules::get_notification_rule))
        .route("/api/notification-channels", get(handlers::notification_rules::list_notification_channels))

        // JIRA integration routes (authenticated users can view)
        .route("/api/jira/configurations", get(handlers::jira_integration::list_jira_configurations))
        .route("/api/jira/configurations/:id", get(handlers::jira_integration::get_jira_configuration))
        .route("/api/jira/tickets", get(handlers::jira_integration::list_jira_tickets))

        // Assignment rules routes (authenticated users can view and test)
        .route("/api/assignment-rules", get(handlers::assignment_rules::list_assignment_rules))
        .route("/api/assignment-rules/:id", get(handlers::assignment_rules::get_assignment_rule))

        // Risk acceptance routes (authenticated users can view)
        .route("/api/risk-acceptance", get(handlers::risk_acceptance::list_risk_acceptances))
        .route("/api/risk-acceptance/:id", get(handlers::risk_acceptance::get_risk_acceptance))

        // Resolution scoring routes (authenticated users)
        .route("/api/resolutions/my-stats", get(handlers::resolution_scoring::get_user_resolution_stats))
        .route("/api/resolutions/leaderboard", get(handlers::resolution_scoring::get_resolution_leaderboard))
        .route("/api/resolutions/teams/leaderboard", get(handlers::resolution_scoring::get_team_leaderboard))
        .route("/api/resolutions/teams/:team_id/stats", get(handlers::resolution_scoring::get_team_resolution_stats))

        // Auth routes protette
        .route("/api/auth/logout", post(handlers::auth::logout))
        .route("/api/auth/refresh", post(handlers::auth::refresh_token))

        // FIXED: Middleware corretto per Axum 0.6 con State
        .layer(axum_middleware::from_fn_with_state(state.clone(), require_auth))
        .with_state(state.clone());

    // Routes admin - richiedono ruolo admin
    let admin_routes = Router::new()
        // User management routes
        .route("/api/users", get(handlers::user::list_users))
        .route("/api/users", post(handlers::user::create_user))
        .route("/api/users/:id", get(handlers::user::get_user))
        .route("/api/users/:id", put(handlers::user::update_user))
        .route("/api/users/:id", delete(handlers::user::delete_user))
        .route("/api/users/:id/lock", post(handlers::user::lock_user))
        .route("/api/users/:id/unlock", post(handlers::user::unlock_user))
        .route("/api/users/:id/sessions", get(handlers::user::get_user_sessions_admin))
        .route("/api/users/:id/sessions/revoke-all", post(handlers::user::revoke_all_user_sessions))
        
        // Vulnerability management routes
        .route("/api/vulnerabilities", post(handlers::vulnerability::create_vulnerability))
        .route("/api/vulnerabilities/:id", put(handlers::vulnerability::update_vulnerability))
        .route("/api/vulnerabilities/:id", delete(handlers::vulnerability::delete_vulnerability))
        .route("/api/vulnerabilities/:id/assign", post(handlers::vulnerability::assign_to_team))
        .route("/api/vulnerabilities/:id/assign-user", post(handlers::vulnerability::assign_to_user))

        // Team management routes (admin only)
        .route("/api/teams", post(handlers::team::create_team))
        .route("/api/teams/:id", put(handlers::team::update_team))
        .route("/api/teams/:id", delete(handlers::team::delete_team))
        .route("/api/teams/:id/members", post(handlers::team::add_team_member))
        .route("/api/teams/:team_id/members/:user_id", delete(handlers::team::remove_team_member))
        .route("/api/teams/:id/assign-user", post(handlers::team::assign_user_to_team))
        .route("/api/teams/:team_id/members/:member_id/role", put(handlers::team::update_team_member_role))
        .route("/api/teams/:team_id/members/:user_id", delete(handlers::team::remove_user_from_team))

        // Asset management routes (admin only)
        .route("/api/assets", post(handlers::asset::create_asset))
        .route("/api/assets/:id", put(handlers::asset::update_asset))
        .route("/api/assets/:id", delete(handlers::asset::delete_asset))

        // Report management routes (admin only)
        .route("/api/reports", post(handlers::report::create_report))
        .route("/api/reports/:id", put(handlers::report::update_report))
        .route("/api/reports/:id", delete(handlers::report::delete_report))

        // Plugin management routes (admin only)
        .route("/api/plugins", post(handlers::plugin::install_plugin))
        .route("/api/plugins/:id", put(handlers::plugin::update_plugin))
        .route("/api/plugins/:id", delete(handlers::plugin::uninstall_plugin))
        .route("/api/plugins/:id/toggle", post(handlers::plugin::toggle_plugin))
        .route("/api/plugins/upload", post(handlers::plugin::upload_plugin))
        .route("/api/plugins/scan", post(handlers::plugin::scan_plugins))
        .route("/api/plugins/:id/execute", post(handlers::plugin::execute_plugin))

        // Security routes
        .route("/api/security/ip-whitelist", get(handlers::security::get_ip_whitelist))
        .route("/api/security/ip-whitelist", post(handlers::security::add_ip_whitelist))
        .route("/api/security/ip-whitelist/:id", delete(handlers::security::remove_ip_whitelist))
        .route("/api/security/permissions/user/:user_id", get(handlers::security::get_user_permissions))
        .route("/api/security/permissions", post(handlers::security::grant_user_permission))
        .route("/api/security/permissions/:id", delete(handlers::security::revoke_user_permission))
        
        // Audit routes
        .route("/api/audit/logs", get(handlers::audit::get_audit_logs))
        .route("/api/audit/logs", post(handlers::audit::create_audit_log))
        .route("/api/audit/logs/:id", get(handlers::audit::get_audit_log_by_id))
        .route("/api/audit/stats", get(handlers::audit::get_audit_stats))

        // Scanner import routes (admin only)
        .route("/api/scanners/import", post(handlers::scanner_import::import_scan_json))
        .route("/api/scanners/import/:scanner/:format", post(handlers::scanner_import::import_scan_file))

        // Risk scoring admin routes
        .route("/api/risk/vulnerabilities/:id/calculate", post(handlers::risk_scoring::calculate_risk_score))
        .route("/api/risk/sla/mark-breaches", post(handlers::risk_scoring::mark_sla_breaches))

        // Workload tracking admin routes
        .route("/api/workload/users", get(handlers::workload::list_users_workload))
        .route("/api/workload/users/:id", get(handlers::workload::get_user_workload))
        .route("/api/workload/teams", get(handlers::workload::list_teams_workload))
        .route("/api/workload/teams/:id", get(handlers::workload::get_team_workload))

        // Notification rules admin routes
        .route("/api/notification-rules", post(handlers::notification_rules::create_notification_rule))
        .route("/api/notification-rules/:id", put(handlers::notification_rules::update_notification_rule))
        .route("/api/notification-rules/:id", delete(handlers::notification_rules::delete_notification_rule))
        .route("/api/notification-rules/:id/test", post(handlers::notification_rules::test_notification_rule))
        .route("/api/notification-channels", post(handlers::notification_rules::create_notification_channel))
        .route("/api/notification-channels/:id", delete(handlers::notification_rules::delete_notification_channel))

        // JIRA integration admin routes
        .route("/api/jira/configurations", post(handlers::jira_integration::create_jira_configuration))
        .route("/api/jira/configurations/:id", put(handlers::jira_integration::update_jira_configuration))
        .route("/api/jira/configurations/:id", delete(handlers::jira_integration::delete_jira_configuration))
        .route("/api/jira/test-connection", post(handlers::jira_integration::test_jira_connection))
        .route("/api/jira/tickets", post(handlers::jira_integration::create_jira_ticket))
        .route("/api/jira/tickets/:id/sync", post(handlers::jira_integration::sync_jira_ticket))

        // Compliance reports admin routes
        .route("/api/compliance/generate", post(handlers::compliance_reports::generate_compliance_report))
        .route("/api/compliance/reports", get(handlers::compliance_reports::list_compliance_reports))

        // Assignment rules admin routes
        .route("/api/assignment-rules", post(handlers::assignment_rules::create_assignment_rule))
        .route("/api/assignment-rules/:id", put(handlers::assignment_rules::update_assignment_rule))
        .route("/api/assignment-rules/:id", delete(handlers::assignment_rules::delete_assignment_rule))
        .route("/api/assignment-rules/test", post(handlers::assignment_rules::test_assignment_rule))

        // Risk acceptance admin routes
        .route("/api/risk-acceptance", post(handlers::risk_acceptance::create_risk_acceptance))
        .route("/api/risk-acceptance/:id/approve", post(handlers::risk_acceptance::approve_risk_acceptance))
        .route("/api/risk-acceptance/:id/reject", post(handlers::risk_acceptance::reject_risk_acceptance))
        .route("/api/risk-acceptance/:id/renew", post(handlers::risk_acceptance::renew_risk_acceptance))
        .route("/api/risk-acceptance/:id/review", post(handlers::risk_acceptance::review_risk_acceptance))

        // Resolution scoring admin routes
        .route("/api/resolutions", post(handlers::resolution_scoring::record_vulnerability_resolution))
        .route("/api/resolutions/:id/verify", post(handlers::resolution_scoring::verify_resolution))

        // SOAR webhooks admin routes
        .route("/api/soar/webhooks", get(handlers::soar_webhooks::list_webhooks))
        .route("/api/soar/webhooks", post(handlers::soar_webhooks::create_webhook))
        .route("/api/soar/webhooks/:id", delete(handlers::soar_webhooks::delete_webhook))
        .route("/api/soar/webhooks/:id/trigger", post(handlers::soar_webhooks::trigger_webhook))

        // FIXED: Middleware chain corretto per admin routes con State
        .layer(axum_middleware::from_fn(require_admin))
        .layer(axum_middleware::from_fn_with_state(state.clone(), require_auth))
        .with_state(state.clone());

    // Static file serving for uploads
    let static_routes = Router::new()
        .nest_service("/uploads", ServeDir::new("uploads"));

    // Combina tutte le routes
    let mut router = Router::new()
        .merge(public_routes)
        .merge(protected_routes)
        .merge(admin_routes)
        .merge(static_routes);

    // Apply security middleware layers in correct order
    // Note: Layers are applied in reverse order (first layer = outermost)

    // 1. Cookie manager (must be outermost to manage cookies for all requests)
    router = router.layer(CookieManagerLayer::new());

    // 2. Security headers (applies to all responses)
    let headers_config = config.security.headers.clone();
    router = router.layer(axum_middleware::from_fn(move |req, next| {
        let config = headers_config.clone();
        async move {
            add_security_headers(req, next, config).await
        }
    }));

    // 3. CORS (before authentication)
    router = router.layer(cors);

    // 4. Rate limiting (if enabled) - applies before other processing
    if let Some(limiter) = rate_limiter {
        let config_clone = config.clone();
        router = router.layer(axum_middleware::from_fn(move |req, next| {
            let limiter = limiter.clone();
            async move {
                crate::middleware::rate_limit_middleware(req, next, limiter).await
            }
        }));
    }

    info!("‚úÖ API router configured with all security middleware");

    router
}