// src/components/remediation/CreateRemediationPlanDialog.tsx
// P4: Create remediation plan wizard dialog

import React, { useState } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Box,
  Typography,
  Stepper,
  Step,
  StepLabel,
  CircularProgress,
  Alert,
  List,
  ListItem,
  ListItemText,
  Chip,
} from '@mui/material';
import { DateTimePicker } from '@mui/x-date-pickers/DateTimePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';
import { remediationApi, CreateRemediationPlanRequest } from '../../api/remediation';

interface CreateRemediationPlanDialogProps {
  open: boolean;
  selectedDeviceIds: string[];
  onClose: () => void;
  onSuccess?: () => void;
}

interface Team {
  id: string;
  name: string;
}

const CreateRemediationPlanDialog: React.FC<CreateRemediationPlanDialogProps> = ({
  open,
  selectedDeviceIds,
  onClose,
  onSuccess,
}) => {
  const queryClient = useQueryClient();
  const [activeStep, setActiveStep] = useState(0);
  const [formData, setFormData] = useState<CreateRemediationPlanRequest>({
    name: '',
    description: '',
    assigned_team_id: '',
    priority: 50,
    device_ids: selectedDeviceIds,
  });
  const [dueDate, setDueDate] = useState<Dayjs | null>(null);

  const steps = ['Plan Details', 'Configuration', 'Review'];

  // Fetch teams for assignment
  const { data: teams } = useQuery<Team[]>({
    queryKey: ['teams'],
    queryFn: async () => {
      // TODO: Replace with actual API call
      return [];
    },
    enabled: open,
  });

  const createPlanMutation = useMutation({
    mutationFn: (request: CreateRemediationPlanRequest) => remediationApi.createPlan(request),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['remediation-plans'] });
      handleClose();
      onSuccess?.();
    },
  });

  const handleNext = () => {
    setActiveStep((prevActiveStep) => prevActiveStep + 1);
  };

  const handleBack = () => {
    setActiveStep((prevActiveStep) => prevActiveStep - 1);
  };

  const handleClose = () => {
    setActiveStep(0);
    setFormData({
      name: '',
      description: '',
      assigned_team_id: '',
      priority: 50,
      device_ids: selectedDeviceIds,
    });
    setDueDate(null);
    onClose();
  };

  const handleSubmit = () => {
    const request: CreateRemediationPlanRequest = {
      ...formData,
      due_date: dueDate ? dueDate.toISOString() : undefined,
      device_ids: selectedDeviceIds,
    };
    createPlanMutation.mutate(request);
  };

  const canProceed = () => {
    if (activeStep === 0) {
      return formData.name.trim().length > 0;
    }
    return true;
  };

  const renderStepContent = (step: number) => {
    switch (step) {
      case 0:
        return (
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
            <Alert severity="info">
              Creating remediation plan for {selectedDeviceIds.length} selected device{selectedDeviceIds.length > 1 ? 's' : ''}
            </Alert>

            <TextField
              fullWidth
              label="Plan Name"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              required
              placeholder="e.g., Q1 2024 Critical Fixes"
            />

            <TextField
              fullWidth
              multiline
              rows={4}
              label="Description"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              placeholder="Describe the remediation plan goals and scope..."
            />
          </Box>
        );

      case 1:
        return (
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
            <FormControl fullWidth>
              <InputLabel>Assigned Team</InputLabel>
              <Select
                value={formData.assigned_team_id}
                label="Assigned Team"
                onChange={(e) => setFormData({ ...formData, assigned_team_id: e.target.value })}
              >
                <MenuItem value="">
                  <em>None</em>
                </MenuItem>
                {teams?.map((team) => (
                  <MenuItem key={team.id} value={team.id}>
                    {team.name}
                  </MenuItem>
                ))}
              </Select>
            </FormControl>

            <FormControl fullWidth>
              <InputLabel>Priority</InputLabel>
              <Select
                value={formData.priority}
                label="Priority"
                onChange={(e) => setFormData({ ...formData, priority: Number(e.target.value) })}
              >
                <MenuItem value={100}>Critical (100)</MenuItem>
                <MenuItem value={75}>High (75)</MenuItem>
                <MenuItem value={50}>Medium (50)</MenuItem>
                <MenuItem value={25}>Low (25)</MenuItem>
              </Select>
            </FormControl>

            <LocalizationProvider dateAdapter={AdapterDayjs}>
              <DateTimePicker
                label="Due Date (Optional)"
                value={dueDate}
                onChange={(newValue) => setDueDate(newValue)}
                slotProps={{
                  textField: {
                    fullWidth: true,
                  },
                }}
              />
            </LocalizationProvider>

            <Alert severity="info">
              Devices will be automatically prioritized based on vulnerability severity, EPSS scores, and device criticality.
            </Alert>
          </Box>
        );

      case 2:
        return (
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
            <Typography variant="h6" gutterBottom>
              Review Plan Details
            </Typography>

            <List>
              <ListItem>
                <ListItemText primary="Plan Name" secondary={formData.name} />
              </ListItem>
              {formData.description && (
                <ListItem>
                  <ListItemText primary="Description" secondary={formData.description} />
                </ListItem>
              )}
              <ListItem>
                <ListItemText
                  primary="Priority"
                  secondary={
                    <Chip
                      label={formData.priority}
                      size="small"
                      color={formData.priority && formData.priority >= 75 ? 'error' : 'default'}
                    />
                  }
                />
              </ListItem>
              {formData.assigned_team_id && (
                <ListItem>
                  <ListItemText
                    primary="Assigned Team"
                    secondary={teams?.find((t) => t.id === formData.assigned_team_id)?.name || 'N/A'}
                  />
                </ListItem>
              )}
              {dueDate && (
                <ListItem>
                  <ListItemText primary="Due Date" secondary={dueDate.format('MMMM D, YYYY h:mm A')} />
                </ListItem>
              )}
              <ListItem>
                <ListItemText
                  primary="Devices"
                  secondary={`${selectedDeviceIds.length} device${selectedDeviceIds.length > 1 ? 's' : ''} will be added with auto-prioritization`}
                />
              </ListItem>
            </List>

            {createPlanMutation.isError && (
              <Alert severity="error">
                Failed to create remediation plan. Please try again.
              </Alert>
            )}
          </Box>
        );

      default:
        return null;
    }
  };

  return (
    <Dialog open={open} onClose={handleClose} maxWidth="md" fullWidth>
      <DialogTitle>Create Remediation Plan</DialogTitle>
      <DialogContent>
        <Box sx={{ mt: 2 }}>
          <Stepper activeStep={activeStep} sx={{ mb: 4 }}>
            {steps.map((label) => (
              <Step key={label}>
                <StepLabel>{label}</StepLabel>
              </Step>
            ))}
          </Stepper>

          {renderStepContent(activeStep)}
        </Box>
      </DialogContent>
      <DialogActions>
        <Button onClick={handleClose}>Cancel</Button>
        <Box sx={{ flex: '1 1 auto' }} />
        {activeStep > 0 && (
          <Button onClick={handleBack}>
            Back
          </Button>
        )}
        {activeStep < steps.length - 1 ? (
          <Button
            variant="contained"
            onClick={handleNext}
            disabled={!canProceed()}
          >
            Next
          </Button>
        ) : (
          <Button
            variant="contained"
            onClick={handleSubmit}
            disabled={createPlanMutation.isPending}
            startIcon={createPlanMutation.isPending ? <CircularProgress size={20} /> : null}
          >
            Create Plan
          </Button>
        )}
      </DialogActions>
    </Dialog>
  );
};

export default CreateRemediationPlanDialog;
