// DeviceDetailView.tsx - Entuity-style device detail view
// Shows comprehensive device information with health status

import React, { useState } from 'react';
import {
  Box,
  Grid,
  Tabs,
  Tab,
  Typography,
} from '@mui/material';
import KeyInfoDashlet, { KeyInfoItem } from './dashlets/KeyInfoDashlet';
import ChartDashlet, { ChartSeries } from './dashlets/ChartDashlet';
import TableDashlet, { TableColumn } from './dashlets/TableDashlet';
import { NetworkDevice, NetworkPort } from '../types/network';
import { entuityColors } from '../theme/entuityTheme';

interface DeviceDetailViewProps {
  device: NetworkDevice;
  onRefresh?: () => void;
}

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

const TabPanel: React.FC<TabPanelProps> = ({ children, value, index }) => (
  <div role="tabpanel" hidden={value !== index}>
    {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
  </div>
);

const DeviceDetailView: React.FC<DeviceDetailViewProps> = ({ device, onRefresh }) => {
  const [tabValue, setTabValue] = useState(0);

  // Prepare primary info for Key Info dashlet
  const vm = device.vulnerabilityMetrics;
  const primaryInfo: KeyInfoItem[] = [
    { label: 'IP Address', value: device.ipAddress },
    { label: 'Type', value: device.type },
    {
      label: 'Risk Score',
      value: vm?.riskScore ?? 0,
      unit: '/100',
      severity: (vm?.riskScore ?? 0) > 80 ? 'critical' : (vm?.riskScore ?? 0) > 60 ? 'high' : (vm?.riskScore ?? 0) > 40 ? 'medium' : 'low',
    },
    {
      label: 'Total Vulnerabilities',
      value: vm?.totalVulnerabilities ?? 0,
      severity: (vm?.criticalCount ?? 0) > 0 ? 'critical' : (vm?.highCount ?? 0) > 0 ? 'high' : 'none',
    },
    {
      label: 'Critical',
      value: vm?.criticalCount ?? 0,
      severity: (vm?.criticalCount ?? 0) > 0 ? 'critical' : 'none',
    },
    {
      label: 'High',
      value: vm?.highCount ?? 0,
      severity: (vm?.highCount ?? 0) > 0 ? 'high' : 'none',
    },
  ];

  // Prepare secondary info (configuration details)
  const rm = device.remediationInfo;
  const assignment = device.assignment;
  const secondaryInfo: KeyInfoItem[] = [
    { label: 'Last Scan', value: vm?.lastScanDate ? new Date(vm.lastScanDate).toLocaleString() : 'Never' },
    { label: 'Next Scan', value: vm?.nextScanDate ? new Date(vm.nextScanDate).toLocaleString() : 'Not scheduled' },
    { label: 'Scan Status', value: vm?.scanStatus ?? 'Unknown' },
    { label: 'Compliance Score', value: vm?.complianceScore ? `${vm.complianceScore}%` : 'N/A' },
    { label: 'Last Remediation', value: rm?.lastRemediationDate ? new Date(rm.lastRemediationDate).toLocaleString() : 'Never' },
    { label: 'Remediation Type', value: rm?.lastRemediationType ?? 'N/A' },
    { label: 'Assigned Team', value: assignment?.assignedTeamName ?? 'Unassigned' },
    { label: 'Assigned User', value: assignment?.assignedUserName ?? 'Unassigned' },
  ];

  // Generate mock chart data (in production, this would come from API)
  const generateMockChartData = (metricName: string, currentValue: number) => {
    const data = [];
    const now = Date.now();
    for (let i = 24; i >= 0; i--) {
      data.push({
        timestamp: new Date(now - i * 60 * 60 * 1000).toISOString(),
        value: Math.max(0, Math.min(100, currentValue + (Math.random() - 0.5) * 20)),
      });
    }
    return data;
  };

  // Vulnerability Trend Chart Series
  const vulnerabilityTrendSeries: ChartSeries[] = [
    {
      name: 'Critical',
      data: generateMockChartData('critical', vm?.criticalCount ?? 3),
      color: entuityColors.critical,
    },
    {
      name: 'High',
      data: generateMockChartData('high', vm?.highCount ?? 8),
      color: entuityColors.high,
    },
    {
      name: 'Medium',
      data: generateMockChartData('medium', vm?.mediumCount ?? 15),
      color: entuityColors.warning,
    },
  ];

  // Risk Score History Chart Series
  const riskScoreSeries: ChartSeries[] = [
    {
      name: 'Risk Score',
      data: generateMockChartData('risk', vm?.riskScore ?? 65),
      color: entuityColors.critical,
      unit: '/100',
    },
  ];

  // Network Ports table columns
  const portColumns: TableColumn[] = [
    { id: 'number', label: 'Port', numeric: true },
    { id: 'name', label: 'Name' },
    { id: 'type', label: 'Type' },
    { id: 'status', label: 'Status' },
    {
      id: 'speed',
      label: 'Speed',
      numeric: true,
      format: (value) => `${value} Mbps`,
    },
    { id: 'duplex', label: 'Duplex' },
  ];

  // Prepare port data
  const portRows = (device.ports || []).map((port) => ({
    id: port.id,
    number: port.number,
    name: port.name,
    type: port.type,
    status: (port.status === 'disabled' ? 'offline' : port.status) as 'online' | 'up' | 'offline' | 'down' | 'maintenance' | 'warning' | undefined,
    speed: port.speed,
    duplex: port.duplex,
  }));

  return (
    <Box>
      <Typography variant="h5" gutterBottom>
        {device.name}
      </Typography>

      <Tabs
        value={tabValue}
        onChange={(_, newValue) => setTabValue(newValue)}
        sx={{ borderBottom: 1, borderColor: 'divider', mb: 2 }}
      >
        <Tab label="Overview" />
        <Tab label="Vulnerability Analytics" />
        <Tab label="Network Ports" />
        <Tab label="System Configuration" />
      </Tabs>

      {/* Overview Tab */}
      <TabPanel value={tabValue} index={0}>
        <Grid container spacing={3}>
          <Grid item xs={12}>
            <KeyInfoDashlet
              title={`${device.name} - Overview`}
              status={device.status}
              severity={device.severity}
              primaryInfo={primaryInfo}
              secondaryInfo={secondaryInfo}
              incidentCount={device.incidentCount}
              lastUpdated={device.lastSeen}
            />
          </Grid>
        </Grid>
      </TabPanel>

      {/* Vulnerability Analytics Tab */}
      <TabPanel value={tabValue} index={1}>
        <Grid container spacing={3}>
          <Grid item xs={12} md={6}>
            <ChartDashlet
              title="Vulnerability Trend"
              subtitle="Last 30 days by severity"
              chartType="line"
              series={vulnerabilityTrendSeries}
              currentValue={vm?.totalVulnerabilities}
              currentUnit=" vulns"
              onRefresh={onRefresh}
              timeRange="30d"
            />
          </Grid>
          <Grid item xs={12} md={6}>
            <ChartDashlet
              title="Risk Score History"
              subtitle="Overall risk trend"
              chartType="area"
              series={riskScoreSeries}
              currentValue={vm?.riskScore}
              currentUnit="/100"
              threshold={{ warning: 60, critical: 80 }}
              onRefresh={onRefresh}
              timeRange="30d"
            />
          </Grid>
        </Grid>
      </TabPanel>

      {/* Ports Tab */}
      <TabPanel value={tabValue} index={2}>
        <TableDashlet
          title="Network Ports"
          subtitle={`${portRows.length} ports configured`}
          columns={portColumns}
          rows={portRows}
          onRefresh={onRefresh}
          searchable
          sortable
        />
      </TabPanel>

      {/* System Configuration Tab */}
      <TabPanel value={tabValue} index={3}>
        <Grid container spacing={3}>
          <Grid item xs={12} md={6}>
            <KeyInfoDashlet
              title="System Information"
              status={device.status}
              severity="none"
              primaryInfo={[
                { label: 'Device ID', value: device.id },
                { label: 'IP Address', value: device.ipAddress },
                { label: 'MAC Address', value: device.macAddress ?? 'N/A' },
                { label: 'Device Type', value: device.type },
              ]}
              secondaryInfo={[
                { label: 'Manufacturer', value: device.manufacturer ?? 'Unknown' },
                { label: 'Model', value: device.model ?? 'Unknown' },
                { label: 'OS Version', value: device.osVersion ?? 'Unknown' },
                { label: 'Last Seen', value: new Date(device.lastSeen).toLocaleString() },
              ]}
              lastUpdated={device.lastSeen}
            />
          </Grid>
          <Grid item xs={12} md={6}>
            <KeyInfoDashlet
              title="Location & Assignment"
              status={device.status}
              severity="none"
              primaryInfo={[
                { label: 'Building', value: device.location?.building ?? 'Not specified' },
                { label: 'Floor', value: device.location?.floor ?? 'N/A' },
                { label: 'Room', value: device.location?.room ?? 'N/A' },
                { label: 'Data Center', value: device.location?.datacenter ?? 'N/A' },
              ]}
              secondaryInfo={[
                { label: 'Assigned Team', value: assignment?.assignedTeamName ?? 'Unassigned' },
                { label: 'Assigned User', value: assignment?.assignedUserName ?? 'Unassigned' },
                { label: 'Assignment Date', value: assignment?.assignedDate ? new Date(assignment.assignedDate).toLocaleString() : 'N/A' },
              ]}
            />
          </Grid>
          <Grid item xs={12}>
            <KeyInfoDashlet
              title="Remediation Summary"
              status={device.status}
              severity={rm && rm.pendingRemediations > 0 ? 'high' : 'none'}
              primaryInfo={[
                { label: 'Pending Remediations', value: rm?.pendingRemediations ?? 0, severity: (rm?.pendingRemediations ?? 0) > 0 ? 'high' : 'none' },
                { label: 'Applied Remediations', value: rm?.appliedRemediations ?? 0 },
                { label: 'Failed Remediations', value: rm?.failedRemediations ?? 0, severity: (rm?.failedRemediations ?? 0) > 0 ? 'critical' : 'none' },
              ]}
              secondaryInfo={[
                { label: 'Last Remediation Date', value: rm?.lastRemediationDate ? new Date(rm.lastRemediationDate).toLocaleString() : 'Never' },
                { label: 'Last Remediation Type', value: rm?.lastRemediationType ?? 'N/A' },
              ]}
            />
          </Grid>
        </Grid>
      </TabPanel>
    </Box>
  );
};

export default DeviceDetailView;
