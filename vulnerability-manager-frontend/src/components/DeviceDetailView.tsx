// DeviceDetailView.tsx - Entuity-style device detail view
// Shows comprehensive device information with health status

import React, { useState } from 'react';
import {
  Box,
  Grid,
  Tabs,
  Tab,
  Typography,
} from '@mui/material';
import KeyInfoDashlet, { KeyInfoItem } from './dashlets/KeyInfoDashlet';
import ChartDashlet, { ChartSeries } from './dashlets/ChartDashlet';
import TableDashlet, { TableColumn } from './dashlets/TableDashlet';
import { NetworkDevice, NetworkPort } from '../types/network';
import { entuityColors } from '../theme/entuityTheme';

interface DeviceDetailViewProps {
  device: NetworkDevice;
  onRefresh?: () => void;
}

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

const TabPanel: React.FC<TabPanelProps> = ({ children, value, index }) => (
  <div role="tabpanel" hidden={value !== index}>
    {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
  </div>
);

const DeviceDetailView: React.FC<DeviceDetailViewProps> = ({ device, onRefresh }) => {
  const [tabValue, setTabValue] = useState(0);

  // Prepare primary info for Key Info dashlet
  const primaryInfo: KeyInfoItem[] = [
    { label: 'IP Address', value: device.ipAddress },
    { label: 'Type', value: device.type },
    { label: 'Last Seen', value: new Date(device.lastSeen).toLocaleString() },
    {
      label: 'CPU Usage',
      value: device.metrics?.cpuUsage ?? 0,
      unit: '%',
      severity: (device.metrics?.cpuUsage ?? 0) > 90 ? 'critical' : (device.metrics?.cpuUsage ?? 0) > 70 ? 'high' : 'none',
    },
    {
      label: 'Memory Usage',
      value: device.metrics?.memoryUsage ?? 0,
      unit: '%',
      severity: (device.metrics?.memoryUsage ?? 0) > 90 ? 'critical' : (device.metrics?.memoryUsage ?? 0) > 70 ? 'high' : 'none',
    },
    {
      label: 'Uptime',
      value: device.metrics?.uptime ? `${Math.floor(device.metrics.uptime / 3600)}h` : 'N/A',
    },
  ];

  // Prepare secondary info (configuration details)
  const secondaryInfo: KeyInfoItem[] = [
    { label: 'MAC Address', value: device.macAddress ?? 'N/A' },
    { label: 'Manufacturer', value: device.manufacturer ?? 'Unknown' },
    { label: 'Model', value: device.model ?? 'Unknown' },
    { label: 'OS Version', value: device.osVersion ?? 'Unknown' },
    { label: 'Location', value: device.location?.address ?? 'Not specified' },
  ];

  // Generate mock chart data (in production, this would come from API)
  const generateMockChartData = (metricName: string, currentValue: number) => {
    const data = [];
    const now = Date.now();
    for (let i = 24; i >= 0; i--) {
      data.push({
        timestamp: new Date(now - i * 60 * 60 * 1000).toISOString(),
        value: Math.max(0, Math.min(100, currentValue + (Math.random() - 0.5) * 20)),
      });
    }
    return data;
  };

  // CPU Chart Series
  const cpuSeries: ChartSeries[] = [
    {
      name: 'CPU Usage',
      data: generateMockChartData('cpu', device.metrics?.cpuUsage ?? 50),
      color: entuityColors.charts.cpu,
      unit: '%',
    },
  ];

  // Memory Chart Series
  const memorySeries: ChartSeries[] = [
    {
      name: 'Memory Usage',
      data: generateMockChartData('memory', device.metrics?.memoryUsage ?? 60),
      color: entuityColors.charts.memory,
      unit: '%',
    },
  ];

  // Network Ports table columns
  const portColumns: TableColumn[] = [
    { id: 'number', label: 'Port', numeric: true },
    { id: 'name', label: 'Name' },
    { id: 'type', label: 'Type' },
    { id: 'status', label: 'Status' },
    {
      id: 'speed',
      label: 'Speed',
      numeric: true,
      format: (value) => `${value} Mbps`,
    },
    { id: 'duplex', label: 'Duplex' },
  ];

  // Prepare port data
  const portRows = (device.ports || []).map((port) => ({
    id: port.id,
    number: port.number,
    name: port.name,
    type: port.type,
    status: port.status,
    speed: port.speed,
    duplex: port.duplex,
  }));

  return (
    <Box>
      <Typography variant="h5" gutterBottom>
        {device.name}
      </Typography>

      <Tabs
        value={tabValue}
        onChange={(_, newValue) => setTabValue(newValue)}
        sx={{ borderBottom: 1, borderColor: 'divider', mb: 2 }}
      >
        <Tab label="Overview" />
        <Tab label="Performance" />
        <Tab label="Ports" />
        <Tab label="Configuration" />
      </Tabs>

      {/* Overview Tab */}
      <TabPanel value={tabValue} index={0}>
        <Grid container spacing={3}>
          <Grid item xs={12}>
            <KeyInfoDashlet
              title={`${device.name} - Overview`}
              status={device.status}
              severity={device.severity}
              primaryInfo={primaryInfo}
              secondaryInfo={secondaryInfo}
              incidentCount={device.incidentCount}
              lastUpdated={device.lastSeen}
            />
          </Grid>
        </Grid>
      </TabPanel>

      {/* Performance Tab */}
      <TabPanel value={tabValue} index={1}>
        <Grid container spacing={3}>
          <Grid item xs={12} md={6}>
            <ChartDashlet
              title="CPU Utilization"
              subtitle="Last 24 hours"
              chartType="area"
              series={cpuSeries}
              currentValue={device.metrics?.cpuUsage}
              currentUnit="%"
              threshold={{ warning: 70, critical: 90 }}
              onRefresh={onRefresh}
              timeRange="24h"
            />
          </Grid>
          <Grid item xs={12} md={6}>
            <ChartDashlet
              title="Memory Utilization"
              subtitle="Last 24 hours"
              chartType="area"
              series={memorySeries}
              currentValue={device.metrics?.memoryUsage}
              currentUnit="%"
              threshold={{ warning: 70, critical: 90 }}
              onRefresh={onRefresh}
              timeRange="24h"
            />
          </Grid>
        </Grid>
      </TabPanel>

      {/* Ports Tab */}
      <TabPanel value={tabValue} index={2}>
        <TableDashlet
          title="Network Ports"
          subtitle={`${portRows.length} ports configured`}
          columns={portColumns}
          rows={portRows}
          onRefresh={onRefresh}
          searchable
          sortable
        />
      </TabPanel>

      {/* Configuration Tab */}
      <TabPanel value={tabValue} index={3}>
        <Grid container spacing={3}>
          <Grid item xs={12}>
            <KeyInfoDashlet
              title="Device Configuration"
              status={device.status}
              severity="none"
              primaryInfo={[
                { label: 'Device ID', value: device.id },
                { label: 'IP Address', value: device.ipAddress },
                { label: 'MAC Address', value: device.macAddress ?? 'N/A' },
              ]}
              secondaryInfo={[
                { label: 'Manufacturer', value: device.manufacturer ?? 'Unknown' },
                { label: 'Model', value: device.model ?? 'Unknown' },
                { label: 'OS Version', value: device.osVersion ?? 'Unknown' },
                { label: 'Type', value: device.type },
                { label: 'Location', value: device.location?.address ?? 'Not specified' },
                { label: 'Latitude', value: device.location?.lat?.toString() ?? 'N/A' },
                { label: 'Longitude', value: device.location?.lng?.toString() ?? 'N/A' },
              ]}
              lastUpdated={device.lastSeen}
            />
          </Grid>
        </Grid>
      </TabPanel>
    </Box>
  );
};

export default DeviceDetailView;
