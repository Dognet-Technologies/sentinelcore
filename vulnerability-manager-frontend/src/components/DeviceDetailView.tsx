// DeviceDetailView.tsx - Entuity-style device detail view
// Shows comprehensive device information with health status and inline editing

import React, { useState } from 'react';
import {
  Box,
  Grid,
  Tabs,
  Tab,
  Typography,
  Button,
  TextField,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  Card,
  CardContent,
  CardActions,
  Alert,
} from '@mui/material';
import { Edit as EditIcon, Save as SaveIcon, Cancel as CancelIcon } from '@mui/icons-material';
import KeyInfoDashlet, { KeyInfoItem } from './dashlets/KeyInfoDashlet';
import ChartDashlet, { ChartSeries } from './dashlets/ChartDashlet';
import TableDashlet, { TableColumn } from './dashlets/TableDashlet';
import { NetworkDevice, NetworkPort } from '../types/network';
import { entuityColors } from '../theme/entuityTheme';
import api from '../services/api';

interface DeviceDetailViewProps {
  device: NetworkDevice;
  onRefresh?: () => void;
}

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

const TabPanel: React.FC<TabPanelProps> = ({ children, value, index }) => (
  <div role="tabpanel" hidden={value !== index}>
    {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
  </div>
);

const DeviceDetailView: React.FC<DeviceDetailViewProps> = ({ device, onRefresh }) => {
  const [tabValue, setTabValue] = useState(0);
  const [isEditing, setIsEditing] = useState(false);
  const [editedDevice, setEditedDevice] = useState(device);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  // Handle save device changes
  const handleSave = async () => {
    setSaving(true);
    setError(null);
    setSuccess(false);

    try {
      await api.put(`/api/network/devices/${device.id}`, {
        location: editedDevice.location,
        owner: editedDevice.owner,
        criticality: editedDevice.criticality,
        tags: editedDevice.tags,
        notes: editedDevice.notes,
        manufacturer: editedDevice.manufacturer,
        model: editedDevice.model,
        osVersion: editedDevice.osVersion,
        is_internet_facing: editedDevice.is_internet_facing,
        has_public_ip: editedDevice.has_public_ip,
      });

      setSuccess(true);
      setIsEditing(false);

      if (onRefresh) {
        onRefresh();
      }
    } catch (err: any) {
      setError(err.response?.data?.error || 'Failed to update device');
    } finally {
      setSaving(false);
    }
  };

  const handleCancel = () => {
    setEditedDevice(device);
    setIsEditing(false);
    setError(null);
    setSuccess(false);
  };

  // Prepare primary info for Key Info dashlet
  const vm = device.vulnerabilityMetrics;
  const primaryInfo: KeyInfoItem[] = [
    { label: 'IP Address', value: device.ipAddress },
    { label: 'Type', value: device.type },
    {
      label: 'Risk Score',
      value: vm?.riskScore ?? 0,
      unit: '/100',
      severity: (vm?.riskScore ?? 0) > 80 ? 'critical' : (vm?.riskScore ?? 0) > 60 ? 'high' : (vm?.riskScore ?? 0) > 40 ? 'medium' : 'low',
    },
    {
      label: 'Total Vulnerabilities',
      value: vm?.totalVulnerabilities ?? 0,
      severity: (vm?.criticalCount ?? 0) > 0 ? 'critical' : (vm?.highCount ?? 0) > 0 ? 'high' : 'none',
    },
    {
      label: 'Critical',
      value: vm?.criticalCount ?? 0,
      severity: (vm?.criticalCount ?? 0) > 0 ? 'critical' : 'none',
    },
    {
      label: 'High',
      value: vm?.highCount ?? 0,
      severity: (vm?.highCount ?? 0) > 0 ? 'high' : 'none',
    },
  ];

  // Prepare secondary info (configuration details)
  const rm = device.remediationInfo;
  const assignment = device.assignment;
  const secondaryInfo: KeyInfoItem[] = [
    { label: 'Last Scan', value: vm?.lastScanDate ? new Date(vm.lastScanDate).toLocaleString() : 'Never' },
    { label: 'Next Scan', value: vm?.nextScanDate ? new Date(vm.nextScanDate).toLocaleString() : 'Not scheduled' },
    { label: 'Scan Status', value: vm?.scanStatus ?? 'Unknown' },
    { label: 'Compliance Score', value: vm?.complianceScore ? `${vm.complianceScore}%` : 'N/A' },
    { label: 'Last Remediation', value: rm?.lastRemediationDate ? new Date(rm.lastRemediationDate).toLocaleString() : 'Never' },
    { label: 'Remediation Type', value: rm?.lastRemediationType ?? 'N/A' },
    { label: 'Assigned Team', value: assignment?.assignedTeamName ?? 'Unassigned' },
    { label: 'Assigned User', value: assignment?.assignedUserName ?? 'Unassigned' },
  ];

  // Vulnerability Trend Chart Series
  const vulnerabilityTrendSeries: ChartSeries[] = [
    {
      name: 'Critical',
      data: [],
      color: entuityColors.critical,
    },
    {
      name: 'High',
      data: [],
      color: entuityColors.high,
    },
    {
      name: 'Medium',
      data: [],
      color: entuityColors.warning,
    },
  ];

  // Risk Score History Chart Series
  const riskScoreSeries: ChartSeries[] = [
    {
      name: 'Risk Score',
      data: [],
      color: entuityColors.critical,
      unit: '/100',
    },
  ];

  // Network Ports table columns
  const portColumns: TableColumn[] = [
    { id: 'number', label: 'Port', numeric: true },
    { id: 'name', label: 'Name' },
    { id: 'type', label: 'Type' },
    { id: 'status', label: 'Status' },
    {
      id: 'speed',
      label: 'Speed',
      numeric: true,
      format: (value) => `${value} Mbps`,
    },
    { id: 'duplex', label: 'Duplex' },
  ];

  // Prepare port data
  const portRows = (device.ports || []).map((port) => ({
    id: port.id,
    number: port.number,
    name: port.name,
    type: port.type,
    status: (port.status === 'disabled' ? 'offline' : port.status) as 'online' | 'up' | 'offline' | 'down' | 'maintenance' | 'warning' | undefined,
    speed: port.speed,
    duplex: port.duplex,
  }));

  return (
    <Box>
      <Typography variant="h5" gutterBottom>
        {device.name}
      </Typography>

      <Tabs
        value={tabValue}
        onChange={(_, newValue) => setTabValue(newValue)}
        sx={{ borderBottom: 1, borderColor: 'divider', mb: 2 }}
      >
        <Tab label="Overview" />
        <Tab label="Vulnerability Analytics" />
        <Tab label="Network Ports" />
        <Tab label="System Configuration" />
        <Tab label="Device Management" />
      </Tabs>

      {/* Overview Tab */}
      <TabPanel value={tabValue} index={0}>
        <Grid container spacing={3}>
          <Grid item xs={12}>
            <KeyInfoDashlet
              title={`${device.name} - Overview`}
              status={device.status}
              severity={device.severity}
              primaryInfo={primaryInfo}
              secondaryInfo={secondaryInfo}
              incidentCount={device.incidentCount}
              lastUpdated={device.lastSeen}
            />
          </Grid>
        </Grid>
      </TabPanel>

      {/* Vulnerability Analytics Tab */}
      <TabPanel value={tabValue} index={1}>
        <Grid container spacing={3}>
          <Grid item xs={12} md={6}>
            <ChartDashlet
              title="Vulnerability Trend"
              subtitle="Last 30 days by severity"
              chartType="line"
              series={vulnerabilityTrendSeries}
              currentValue={vm?.totalVulnerabilities}
              currentUnit=" vulns"
              onRefresh={onRefresh}
              timeRange="30d"
            />
          </Grid>
          <Grid item xs={12} md={6}>
            <ChartDashlet
              title="Risk Score History"
              subtitle="Overall risk trend"
              chartType="area"
              series={riskScoreSeries}
              currentValue={vm?.riskScore}
              currentUnit="/100"
              threshold={{ warning: 60, critical: 80 }}
              onRefresh={onRefresh}
              timeRange="30d"
            />
          </Grid>
        </Grid>
      </TabPanel>

      {/* Ports Tab */}
      <TabPanel value={tabValue} index={2}>
        <TableDashlet
          title="Network Ports"
          subtitle={`${portRows.length} ports configured`}
          columns={portColumns}
          rows={portRows}
          onRefresh={onRefresh}
          searchable
          sortable
        />
      </TabPanel>

      {/* System Configuration Tab */}
      <TabPanel value={tabValue} index={3}>
        <Grid container spacing={3}>
          <Grid item xs={12} md={6}>
            <KeyInfoDashlet
              title="System Information"
              status={device.status}
              severity="none"
              primaryInfo={[
                { label: 'Device ID', value: device.id },
                { label: 'IP Address', value: device.ipAddress },
                { label: 'MAC Address', value: device.macAddress ?? 'N/A' },
                { label: 'Device Type', value: device.type },
              ]}
              secondaryInfo={[
                { label: 'Manufacturer', value: device.manufacturer ?? 'Unknown' },
                { label: 'Model', value: device.model ?? 'Unknown' },
                { label: 'OS Version', value: device.osVersion ?? 'Unknown' },
                { label: 'Last Seen', value: new Date(device.lastSeen).toLocaleString() },
              ]}
              lastUpdated={device.lastSeen}
            />
          </Grid>
          <Grid item xs={12} md={6}>
            <KeyInfoDashlet
              title="Location & Assignment"
              status={device.status}
              severity="none"
              primaryInfo={[
                { label: 'Location', value: device.location ?? 'Not specified' },
              ]}
              secondaryInfo={[
                { label: 'Assigned Team', value: assignment?.assignedTeamName ?? 'Unassigned' },
                { label: 'Assigned User', value: assignment?.assignedUserName ?? 'Unassigned' },
                { label: 'Assignment Date', value: assignment?.assignedDate ? new Date(assignment.assignedDate).toLocaleString() : 'N/A' },
              ]}
            />
          </Grid>
          <Grid item xs={12}>
            <KeyInfoDashlet
              title="Remediation Summary"
              status={device.status}
              severity={rm && rm.pendingRemediations > 0 ? 'high' : 'none'}
              primaryInfo={[
                { label: 'Pending Remediations', value: rm?.pendingRemediations ?? 0, severity: (rm?.pendingRemediations ?? 0) > 0 ? 'high' : 'none' },
                { label: 'Applied Remediations', value: rm?.appliedRemediations ?? 0 },
                { label: 'Failed Remediations', value: rm?.failedRemediations ?? 0, severity: (rm?.failedRemediations ?? 0) > 0 ? 'critical' : 'none' },
              ]}
              secondaryInfo={[
                { label: 'Last Remediation Date', value: rm?.lastRemediationDate ? new Date(rm.lastRemediationDate).toLocaleString() : 'Never' },
                { label: 'Last Remediation Type', value: rm?.lastRemediationType ?? 'N/A' },
              ]}
            />
          </Grid>
        </Grid>
      </TabPanel>

      {/* Device Management Tab - Editable Configuration */}
      <TabPanel value={tabValue} index={4}>
        <Grid container spacing={3}>
          {error && (
            <Grid item xs={12}>
              <Alert severity="error" onClose={() => setError(null)}>{error}</Alert>
            </Grid>
          )}
          {success && (
            <Grid item xs={12}>
              <Alert severity="success" onClose={() => setSuccess(false)}>Device updated successfully!</Alert>
            </Grid>
          )}

          <Grid item xs={12}>
            <Card>
              <CardContent>
                <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                  <Typography variant="h6">Device Information</Typography>
                  {!isEditing && (
                    <Button
                      variant="outlined"
                      startIcon={<EditIcon />}
                      onClick={() => setIsEditing(true)}
                    >
                      Edit
                    </Button>
                  )}
                </Box>

                <Grid container spacing={2}>
                  <Grid item xs={12} md={6}>
                    <TextField
                      fullWidth
                      label="Manufacturer"
                      value={editedDevice.manufacturer || ''}
                      onChange={(e) => setEditedDevice({ ...editedDevice, manufacturer: e.target.value })}
                      disabled={!isEditing}
                    />
                  </Grid>
                  <Grid item xs={12} md={6}>
                    <TextField
                      fullWidth
                      label="Model"
                      value={editedDevice.model || ''}
                      onChange={(e) => setEditedDevice({ ...editedDevice, model: e.target.value })}
                      disabled={!isEditing}
                    />
                  </Grid>
                  <Grid item xs={12} md={6}>
                    <TextField
                      fullWidth
                      label="OS Version"
                      value={editedDevice.osVersion || ''}
                      onChange={(e) => setEditedDevice({ ...editedDevice, osVersion: e.target.value })}
                      disabled={!isEditing}
                    />
                  </Grid>
                  <Grid item xs={12} md={6}>
                    <TextField
                      fullWidth
                      label="Owner"
                      value={editedDevice.owner || ''}
                      onChange={(e) => setEditedDevice({ ...editedDevice, owner: e.target.value })}
                      disabled={!isEditing}
                    />
                  </Grid>
                  <Grid item xs={12} md={6}>
                    <TextField
                      fullWidth
                      label="Location"
                      value={editedDevice.location || ''}
                      onChange={(e) => setEditedDevice({ ...editedDevice, location: e.target.value })}
                      disabled={!isEditing}
                    />
                  </Grid>
                  <Grid item xs={12} md={6}>
                    <FormControl fullWidth disabled={!isEditing}>
                      <InputLabel>Criticality</InputLabel>
                      <Select
                        value={editedDevice.criticality || 'medium'}
                        onChange={(e) => setEditedDevice({ ...editedDevice, criticality: e.target.value })}
                        label="Criticality"
                      >
                        <MenuItem value="low">Low</MenuItem>
                        <MenuItem value="medium">Medium</MenuItem>
                        <MenuItem value="high">High</MenuItem>
                        <MenuItem value="critical">Critical</MenuItem>
                      </Select>
                    </FormControl>
                  </Grid>
                  <Grid item xs={12}>
                    <TextField
                      fullWidth
                      label="Tags (comma-separated)"
                      value={editedDevice.tags?.join(', ') || ''}
                      onChange={(e) => setEditedDevice({
                        ...editedDevice,
                        tags: e.target.value.split(',').map(t => t.trim()).filter(t => t)
                      })}
                      disabled={!isEditing}
                      helperText="Separate tags with commas"
                    />
                  </Grid>
                  <Grid item xs={12}>
                    <TextField
                      fullWidth
                      multiline
                      rows={4}
                      label="Notes"
                      value={editedDevice.notes || ''}
                      onChange={(e) => setEditedDevice({ ...editedDevice, notes: e.target.value })}
                      disabled={!isEditing}
                    />
                  </Grid>
                </Grid>
              </CardContent>
              {isEditing && (
                <CardActions sx={{ justifyContent: 'flex-end', px: 2, pb: 2 }}>
                  <Button
                    variant="outlined"
                    startIcon={<CancelIcon />}
                    onClick={handleCancel}
                    disabled={saving}
                  >
                    Cancel
                  </Button>
                  <Button
                    variant="contained"
                    startIcon={<SaveIcon />}
                    onClick={handleSave}
                    disabled={saving}
                  >
                    {saving ? 'Saving...' : 'Save Changes'}
                  </Button>
                </CardActions>
              )}
            </Card>
          </Grid>
        </Grid>
      </TabPanel>
    </Box>
  );
};

export default DeviceDetailView;
