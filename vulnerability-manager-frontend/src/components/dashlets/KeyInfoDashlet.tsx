// KeyInfoDashlet.tsx - Entuity-style Key Info dashlet
// Displays status information along with configuration details

import React, { useState } from 'react';
import {
  Card,
  CardHeader,
  CardContent,
  Box,
  Typography,
  Stack,
  Chip,
  Divider,
  Grid,
  IconButton,
  useTheme,
} from '@mui/material';
import {
  Circle as CircleIcon,
  Info as InfoIcon,
  Warning as WarningIcon,
  Error as ErrorIcon,
  CheckCircle as CheckCircleIcon,
  MoreVert as MoreVertIcon,
} from '@mui/icons-material';
import { entuityColors, getDeviceStatusColor, getSeverityColor } from '../../theme/entuityTheme';

export interface KeyInfoItem {
  label: string;
  value: string | number;
  unit?: string;
  severity?: 'critical' | 'high' | 'medium' | 'low' | 'info' | 'none';
  icon?: React.ReactNode;
}

export interface KeyInfoDashletProps {
  title: string;
  status: 'online' | 'offline' | 'warning' | 'maintenance' | 'unknown';
  severity?: 'critical' | 'high' | 'medium' | 'low' | 'info' | 'none';
  primaryInfo: KeyInfoItem[];
  secondaryInfo?: KeyInfoItem[];
  incidentCount?: number;
  lastUpdated?: string;
  description?: string;
}

const getStatusIcon = (status: string) => {
  switch (status) {
    case 'online':
      return <CheckCircleIcon sx={{ color: entuityColors.device.online }} />;
    case 'offline':
      return <ErrorIcon sx={{ color: entuityColors.device.offline }} />;
    case 'warning':
    case 'maintenance':
      return <WarningIcon sx={{ color: entuityColors.device.maintenance }} />;
    default:
      return <InfoIcon sx={{ color: entuityColors.device.unknown }} />;
  }
};

const KeyInfoDashlet: React.FC<KeyInfoDashletProps> = ({
  title,
  status,
  severity = 'none',
  primaryInfo,
  secondaryInfo = [],
  incidentCount = 0,
  lastUpdated,
  description,
}) => {
  const theme = useTheme();
  const [showInfo, setShowInfo] = useState(false);
  const statusColor = getDeviceStatusColor(status);
  const severityColor = severity !== 'none' ? getSeverityColor(severity) : statusColor;

  return (
    <Card
      sx={{
        position: 'relative',
        height: '100%',
        border: `2px solid ${severityColor}`,
        borderRadius: 2,
      }}
    >
      <CardHeader
        avatar={getStatusIcon(status)}
        action={
          description && (
            <IconButton
              size="small"
              onClick={() => setShowInfo(!showInfo)}
            >
              <MoreVertIcon />
            </IconButton>
          )
        }
        title={
          <Stack direction="row" spacing={1} alignItems="center">
            <Typography variant="h6">{title}</Typography>
            {incidentCount > 0 && (
              <Chip
                size="small"
                label={`${incidentCount} incidents`}
                sx={{
                  backgroundColor: entuityColors.critical,
                  color: 'white',
                  fontWeight: 600,
                }}
              />
            )}
          </Stack>
        }
        subheader={
          status ? (
            <Stack direction="row" spacing={1} mt={0.5}>
              <Chip
                size="small"
                label={status.toUpperCase()}
                sx={{
                  backgroundColor: statusColor,
                  color: 'white',
                  fontWeight: 600,
                }}
              />
              {severity !== 'none' && (
                <Chip
                  size="small"
                  label={severity.toUpperCase()}
                  sx={{
                    backgroundColor: severityColor,
                    color: 'white',
                    fontWeight: 600,
                  }}
                />
              )}
            </Stack>
          ) : null
        }
        sx={{
          pb: 1,
          backgroundColor: `${severityColor}10`,
        }}
      />

      <CardContent>
        {/* Primary Information */}
        <Box mb={2}>
          <Typography
            variant="caption"
            sx={{
              color: entuityColors.text.secondary,
              fontWeight: 600,
              textTransform: 'uppercase',
            }}
          >
            Status Information
          </Typography>
          <Grid container spacing={2} mt={0.5}>
            {primaryInfo.map((item, index) => (
              <Grid item xs={12} sm={6} key={index}>
                <Box
                  sx={{
                    p: 1.5,
                    backgroundColor: theme.palette.background.default,
                    borderRadius: 1,
                    borderLeft: item.severity
                      ? `4px solid ${getSeverityColor(item.severity)}`
                      : 'none',
                  }}
                >
                  <Typography
                    variant="caption"
                    sx={{ color: entuityColors.text.secondary }}
                  >
                    {item.label}
                  </Typography>
                  <Stack direction="row" spacing={0.5} alignItems="baseline">
                    <Typography variant="h6" sx={{ fontWeight: 600 }}>
                      {item.value}
                    </Typography>
                    {item.unit && (
                      <Typography variant="caption" sx={{ color: entuityColors.text.secondary }}>
                        {item.unit}
                      </Typography>
                    )}
                    {item.icon && <Box sx={{ ml: 1 }}>{item.icon}</Box>}
                  </Stack>
                </Box>
              </Grid>
            ))}
          </Grid>
        </Box>

        {/* Secondary Information (Configuration Details) */}
        {secondaryInfo.length > 0 && (
          <>
            <Divider sx={{ my: 2 }} />
            <Box>
              <Typography
                variant="caption"
                sx={{
                  color: entuityColors.text.secondary,
                  fontWeight: 600,
                  textTransform: 'uppercase',
                }}
              >
                Configuration Details
              </Typography>
              <Stack spacing={1} mt={1}>
                {secondaryInfo.map((item, index) => (
                  <Stack
                    key={index}
                    direction="row"
                    justifyContent="space-between"
                    alignItems="center"
                    sx={{
                      p: 1,
                      borderRadius: 1,
                      '&:hover': {
                        backgroundColor: theme.palette.background.default,
                      },
                    }}
                  >
                    <Typography variant="body2" sx={{ color: entuityColors.text.secondary }}>
                      {item.label}
                    </Typography>
                    <Stack direction="row" spacing={0.5} alignItems="baseline">
                      <Typography variant="body2" sx={{ fontWeight: 600 }}>
                        {item.value}
                      </Typography>
                      {item.unit && (
                        <Typography variant="caption" sx={{ color: entuityColors.text.secondary }}>
                          {item.unit}
                        </Typography>
                      )}
                    </Stack>
                  </Stack>
                ))}
              </Stack>
            </Box>
          </>
        )}

        {/* Last Updated */}
        {lastUpdated && (
          <Box mt={2}>
            <Typography
              variant="caption"
              sx={{ color: entuityColors.text.secondary, fontStyle: 'italic' }}
            >
              Last updated: {new Date(lastUpdated).toLocaleString()}
            </Typography>
          </Box>
        )}
      </CardContent>

      {/* Info Overlay */}
      {description && showInfo && (
        <Box
          sx={{
            position: 'absolute',
            top: 0,
            left: 0,
            width: '100%',
            height: '100%',
            backgroundColor: 'rgba(0, 0, 0, 0.95)',
            color: 'white',
            p: 3,
            zIndex: 1000,
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'center',
            cursor: 'pointer',
            overflow: 'auto',
          }}
          onClick={() => setShowInfo(false)}
        >
          <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
            ℹ️ {title}
          </Typography>
          <Typography variant="body2" sx={{ lineHeight: 1.6, opacity: 0.95 }}>
            {description}
          </Typography>
          <Typography variant="caption" sx={{ mt: 2, opacity: 0.7 }}>
            Clicca ovunque per chiudere
          </Typography>
        </Box>
      )}
    </Card>
  );
};

export default KeyInfoDashlet;
