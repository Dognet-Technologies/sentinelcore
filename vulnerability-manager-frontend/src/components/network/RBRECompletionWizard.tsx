import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Stack,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Alert,
  AlertTitle,
  Typography,
  Box,
  LinearProgress,
  Tooltip,
} from '@mui/material';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import apiClient from '../../services/api';

interface Device {
  id: string;
  hostname?: string;
  ipAddress: string;
  business_criticality?: string;
  exposure_level?: string;
  vulnerabilityMetrics?: {
    totalVulnerabilities?: number;
    criticalCount?: number;
    highCount?: number;
    mediumCount?: number;
    lowCount?: number;
  };
}

interface RBRECompletionWizardProps {
  open: boolean;
  onClose: () => void;
  devices: Device[];
  onComplete?: () => void;
}

interface DeviceWithMissingData {
  device: Device;
  missingFields: string[];
}

const RBRECompletionWizard: React.FC<RBRECompletionWizardProps> = ({
  open,
  onClose,
  devices,
  onComplete,
}) => {
  const queryClient = useQueryClient();
  const [currentDeviceIndex, setCurrentDeviceIndex] = useState(0);
  const [editedBusinessCriticality, setEditedBusinessCriticality] = useState<string>('');
  const [editedExposureLevel, setEditedExposureLevel] = useState<string>('');
  const [localDevices, setLocalDevices] = useState<Device[]>(devices);

  // Sync local devices when prop changes
  useEffect(() => {
    setLocalDevices(devices);
  }, [devices]);

  // Calculate devices with missing data
  const devicesWithMissingData: DeviceWithMissingData[] = localDevices
    .filter(device => {
      return (
        !device.business_criticality ||
        device.business_criticality === 'supporto' ||
        !device.exposure_level ||
        device.exposure_level === 'internal'
      );
    })
    .map(device => ({
      device,
      missingFields: [
        (!device.business_criticality || device.business_criticality === 'supporto') && 'Business Criticality',
        (!device.exposure_level || device.exposure_level === 'internal') && 'Exposure Level',
      ].filter(Boolean) as string[],
    }));

  const updateDeviceMutation = useMutation({
    mutationFn: async (data: { deviceId: string; updates: any }) => {
      return apiClient.put(`/api/network/devices/${data.deviceId}`, data.updates);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['network-topology'] });
      queryClient.invalidateQueries({ queryKey: ['network-topology-vulnerabilities'] });
      queryClient.invalidateQueries({ queryKey: ['incompleteDevices'] });
      queryClient.invalidateQueries({ queryKey: ['devices'] });
    },
  });

  // Initialize when opening
  useEffect(() => {
    if (open && devicesWithMissingData.length > 0) {
      setCurrentDeviceIndex(0);
      const firstDevice = devicesWithMissingData[0].device;
      setEditedBusinessCriticality(firstDevice.business_criticality || '');
      setEditedExposureLevel(firstDevice.exposure_level || '');
    }
  }, [open, devicesWithMissingData.length]);

  const handleClose = () => {
    setCurrentDeviceIndex(0);
    setEditedBusinessCriticality('');
    setEditedExposureLevel('');
    onClose();
  };

  const handleSaveCurrentDevice = async () => {
    if (devicesWithMissingData.length === 0) return;
    if (!devicesWithMissingData[currentDeviceIndex]) {
      handleClose();
      return;
    }

    const currentDevice = devicesWithMissingData[currentDeviceIndex].device;

    // Calculate next state BEFORE updating localDevices to avoid race conditions
    const isLastDevice = currentDeviceIndex >= devicesWithMissingData.length - 1;
    const nextIndex = currentDeviceIndex + 1;
    const nextDevice = !isLastDevice && devicesWithMissingData[nextIndex]?.device;

    await updateDeviceMutation.mutateAsync({
      deviceId: currentDevice.id,
      updates: {
        business_criticality: editedBusinessCriticality,
        exposure_level: editedExposureLevel,
      },
    });

    // Update local devices with the new values
    setLocalDevices(prev =>
      prev.map(device =>
        device.id === currentDevice.id
          ? {
              ...device,
              business_criticality: editedBusinessCriticality,
              exposure_level: editedExposureLevel,
            }
          : device
      )
    );

    // Move to next device or close if done
    if (!isLastDevice && nextDevice) {
      setCurrentDeviceIndex(nextIndex);
      setEditedBusinessCriticality(nextDevice.business_criticality || '');
      setEditedExposureLevel(nextDevice.exposure_level || '');
    } else {
      // All devices completed
      if (onComplete) {
        onComplete();
      }
      handleClose();
    }
  };

  const handleSkipDevice = () => {
    if (devicesWithMissingData.length === 0 || !devicesWithMissingData[currentDeviceIndex]) {
      handleClose();
      return;
    }

    const isLastDevice = currentDeviceIndex >= devicesWithMissingData.length - 1;
    const nextIndex = currentDeviceIndex + 1;
    const nextDevice = !isLastDevice && devicesWithMissingData[nextIndex]?.device;

    if (!isLastDevice && nextDevice) {
      setCurrentDeviceIndex(nextIndex);
      setEditedBusinessCriticality(nextDevice.business_criticality || '');
      setEditedExposureLevel(nextDevice.exposure_level || '');
    } else {
      handleClose();
    }
  };

  const currentDeviceBeingEdited = devicesWithMissingData[currentDeviceIndex]?.device;

  // Helper to render vulnerability tooltip
  const renderVulnerabilityTooltip = (device: Device) => {
    const metrics = device.vulnerabilityMetrics;
    if (!metrics || !metrics.totalVulnerabilities) {
      return 'Nessuna vulnerabilitÃ  rilevata';
    }

    return (
      <Box>
        <Typography variant="body2" fontWeight="bold" sx={{ mb: 0.5 }}>
          Distribuzione VulnerabilitÃ 
        </Typography>
        {metrics.criticalCount ? (
          <Typography variant="caption" display="block" sx={{ color: '#DC2626' }}>
            ðŸ”´ Critical: {metrics.criticalCount}
          </Typography>
        ) : null}
        {metrics.highCount ? (
          <Typography variant="caption" display="block" sx={{ color: '#EA580C' }}>
            ðŸŸ  High: {metrics.highCount}
          </Typography>
        ) : null}
        {metrics.mediumCount ? (
          <Typography variant="caption" display="block" sx={{ color: '#FBBF24' }}>
            ðŸŸ¡ Medium: {metrics.mediumCount}
          </Typography>
        ) : null}
        {metrics.lowCount ? (
          <Typography variant="caption" display="block" sx={{ color: '#3B82F6' }}>
            ðŸ”µ Low: {metrics.lowCount}
          </Typography>
        ) : null}
        <Typography variant="caption" display="block" sx={{ mt: 0.5, fontWeight: 'bold' }}>
          Totale: {metrics.totalVulnerabilities}
        </Typography>
      </Box>
    );
  };

  // Don't show dialog if no devices need completion
  if (devicesWithMissingData.length === 0) {
    return null;
  }

  return (
    <Dialog open={open} onClose={handleClose} maxWidth="sm" fullWidth>
      <DialogTitle>
        Compila Dati RBRE Obbligatori
        <Typography variant="body2" color="text.secondary">
          Dispositivo {currentDeviceIndex + 1} di {devicesWithMissingData.length}
        </Typography>
      </DialogTitle>
      <DialogContent>
        <Stack spacing={3} sx={{ mt: 2 }}>
          {/* Progress Bar */}
          <Box>
            <Typography variant="caption" color="text.secondary">
              Progresso: {currentDeviceIndex} / {devicesWithMissingData.length} completati
            </Typography>
            <LinearProgress
              variant="determinate"
              value={(currentDeviceIndex / devicesWithMissingData.length) * 100}
              sx={{ mt: 1 }}
            />
          </Box>

          {/* Device Info */}
          {currentDeviceBeingEdited && devicesWithMissingData[currentDeviceIndex] && (
            <Alert severity="info">
              <Tooltip
                title={renderVulnerabilityTooltip(currentDeviceBeingEdited)}
                arrow
                placement="right"
              >
                <AlertTitle sx={{ cursor: 'help' }}>
                  {currentDeviceBeingEdited.hostname || currentDeviceBeingEdited.ipAddress}
                  {currentDeviceBeingEdited.vulnerabilityMetrics?.totalVulnerabilities ? (
                    <Typography
                      component="span"
                      variant="caption"
                      sx={{
                        ml: 1,
                        px: 1,
                        py: 0.5,
                        borderRadius: 1,
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        color: '#DC2626',
                        fontWeight: 'bold',
                      }}
                    >
                      {currentDeviceBeingEdited.vulnerabilityMetrics.totalVulnerabilities} vulnerabilitÃ 
                    </Typography>
                  ) : null}
                </AlertTitle>
              </Tooltip>
              <Typography variant="body2">IP: {currentDeviceBeingEdited.ipAddress}</Typography>
              <Typography variant="body2">
                Campi mancanti: {devicesWithMissingData[currentDeviceIndex].missingFields.join(', ')}
              </Typography>
            </Alert>
          )}

          {/* Business Criticality Field */}
          <FormControl fullWidth required>
            <InputLabel>Business Criticality</InputLabel>
            <Select
              value={editedBusinessCriticality}
              onChange={e => setEditedBusinessCriticality(e.target.value)}
              label="Business Criticality"
            >
              <MenuItem value="mission_critical">
                <Stack>
                  <Typography variant="body2" fontWeight="bold">
                    Mission Critical
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    Impatto diretto sulle operazioni core aziendali
                  </Typography>
                </Stack>
              </MenuItem>
              <MenuItem value="core_business">
                <Stack>
                  <Typography variant="body2" fontWeight="bold">
                    Core Business
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    Supporta processi di business importanti
                  </Typography>
                </Stack>
              </MenuItem>
              <MenuItem value="lab_test">
                <Stack>
                  <Typography variant="body2" fontWeight="bold">
                    Lab/Test
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    Ambiente di test o laboratorio
                  </Typography>
                </Stack>
              </MenuItem>
            </Select>
          </FormControl>

          {/* Exposure Level Field */}
          <FormControl fullWidth required>
            <InputLabel>Exposure Level</InputLabel>
            <Select
              value={editedExposureLevel}
              onChange={e => setEditedExposureLevel(e.target.value)}
              label="Exposure Level"
            >
              <MenuItem value="internet_facing">
                <Stack>
                  <Typography variant="body2" fontWeight="bold">
                    Internet Facing
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    Esposto direttamente a Internet
                  </Typography>
                </Stack>
              </MenuItem>
              <MenuItem value="dmz">
                <Stack>
                  <Typography variant="body2" fontWeight="bold">
                    DMZ
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    In zona demilitarizzata
                  </Typography>
                </Stack>
              </MenuItem>
              <MenuItem value="segmented">
                <Stack>
                  <Typography variant="body2" fontWeight="bold">
                    Segmented
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    Rete segmentata/isolata
                  </Typography>
                </Stack>
              </MenuItem>
            </Select>
          </FormControl>
        </Stack>
      </DialogContent>
      <DialogActions>
        <Button onClick={handleClose}>Annulla</Button>
        <Button onClick={handleSkipDevice}>Salta</Button>
        <Button
          variant="contained"
          onClick={handleSaveCurrentDevice}
          disabled={!editedBusinessCriticality || !editedExposureLevel || updateDeviceMutation.isPending}
        >
          {updateDeviceMutation.isPending
            ? 'Salvataggio...'
            : currentDeviceIndex < devicesWithMissingData.length - 1
            ? 'Salva e Continua'
            : 'Salva e Termina'}
        </Button>
      </DialogActions>
    </Dialog>
  );
};

export default RBRECompletionWizard;
