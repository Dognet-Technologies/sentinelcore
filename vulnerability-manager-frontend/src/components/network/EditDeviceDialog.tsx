// src/components/network/EditDeviceDialog.tsx
// P2: Edit device metadata and assignment dialog

import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  Grid,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Chip,
  Box,
  Typography,
  Switch,
  FormControlLabel,
  Autocomplete,
  CircularProgress,
} from '@mui/material';
import { NetworkDeviceWithVulnerabilities, UpdateDeviceRequest, networkApi } from '../../api/network';
import { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';

interface EditDeviceDialogProps {
  open: boolean;
  device: NetworkDeviceWithVulnerabilities | null;
  onClose: () => void;
}

interface User {
  id: string;
  username: string;
  email: string;
}

interface Team {
  id: string;
  name: string;
}

const EditDeviceDialog: React.FC<EditDeviceDialogProps> = ({ open, device, onClose }) => {
  const queryClient = useQueryClient();
  const [formData, setFormData] = useState<UpdateDeviceRequest>({});
  const [tagInput, setTagInput] = useState('');

  // Fetch users for assignment
  const { data: users } = useQuery<User[]>({
    queryKey: ['users'],
    queryFn: async () => {
      // TODO: Replace with actual API call
      return [];
    },
    enabled: open,
  });

  // Fetch teams for assignment
  const { data: teams } = useQuery<Team[]>({
    queryKey: ['teams'],
    queryFn: async () => {
      // TODO: Replace with actual API call
      return [];
    },
    enabled: open,
  });

  useEffect(() => {
    if (device) {
      setFormData({
        hostname: device.hostname || '',
        device_type: device.device_type,
        owner: device.owner || '',
        location: device.location || '',
        criticality: device.criticality || 'medium',
        tags: device.tags || [],
        notes: device.notes || '',
        is_internet_facing: device.is_internet_facing || false,
        has_public_ip: device.has_public_ip || false,
        assigned_user_id: device.assigned_user_id || '',
        assigned_team_id: device.assigned_team_id || '',
      });
    }
  }, [device]);

  const updateMutation = useMutation({
    mutationFn: (data: UpdateDeviceRequest) => networkApi.updateDevice(device!.id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['network-topology'] });
      onClose();
    },
  });

  const handleSubmit = () => {
    updateMutation.mutate(formData);
  };

  const handleAddTag = () => {
    if (tagInput.trim() && formData.tags) {
      setFormData({
        ...formData,
        tags: [...formData.tags, tagInput.trim()],
      });
      setTagInput('');
    }
  };

  const handleRemoveTag = (tagToRemove: string) => {
    setFormData({
      ...formData,
      tags: formData.tags?.filter((tag) => tag !== tagToRemove) || [],
    });
  };

  if (!device) return null;

  return (
    <Dialog open={open} onClose={onClose} maxWidth="md" fullWidth>
      <DialogTitle>
        Edit Device: {device.hostname || device.ip_address}
      </DialogTitle>
      <DialogContent>
        <Grid container spacing={2} sx={{ mt: 1 }}>
          {/* Basic Information */}
          <Grid item xs={12}>
            <Typography variant="subtitle2" fontWeight="bold" gutterBottom>
              Basic Information
            </Typography>
          </Grid>

          <Grid item xs={12} sm={6}>
            <TextField
              fullWidth
              label="Hostname"
              value={formData.hostname || ''}
              onChange={(e) => setFormData({ ...formData, hostname: e.target.value })}
            />
          </Grid>

          <Grid item xs={12} sm={6}>
            <FormControl fullWidth>
              <InputLabel>Device Type</InputLabel>
              <Select
                value={formData.device_type || 'unknown'}
                label="Device Type"
                onChange={(e) => setFormData({ ...formData, device_type: e.target.value })}
              >
                <MenuItem value="router">Router</MenuItem>
                <MenuItem value="switch">Switch</MenuItem>
                <MenuItem value="firewall">Firewall</MenuItem>
                <MenuItem value="server">Server</MenuItem>
                <MenuItem value="workstation">Workstation</MenuItem>
                <MenuItem value="printer">Printer</MenuItem>
                <MenuItem value="iot">IoT Device</MenuItem>
                <MenuItem value="unknown">Unknown</MenuItem>
              </Select>
            </FormControl>
          </Grid>

          <Grid item xs={12} sm={6}>
            <TextField
              fullWidth
              label="Owner"
              value={formData.owner || ''}
              onChange={(e) => setFormData({ ...formData, owner: e.target.value })}
              placeholder="e.g., IT Department"
            />
          </Grid>

          <Grid item xs={12} sm={6}>
            <TextField
              fullWidth
              label="Location"
              value={formData.location || ''}
              onChange={(e) => setFormData({ ...formData, location: e.target.value })}
              placeholder="e.g., Building A, Floor 2"
            />
          </Grid>

          {/* Criticality */}
          <Grid item xs={12}>
            <Typography variant="subtitle2" fontWeight="bold" gutterBottom sx={{ mt: 2 }}>
              Risk Assessment
            </Typography>
          </Grid>

          <Grid item xs={12} sm={6}>
            <FormControl fullWidth>
              <InputLabel>Criticality</InputLabel>
              <Select
                value={formData.criticality || 'medium'}
                label="Criticality"
                onChange={(e) => setFormData({ ...formData, criticality: e.target.value })}
              >
                <MenuItem value="critical">Critical</MenuItem>
                <MenuItem value="high">High</MenuItem>
                <MenuItem value="medium">Medium</MenuItem>
                <MenuItem value="low">Low</MenuItem>
              </Select>
            </FormControl>
          </Grid>

          <Grid item xs={12} sm={6}>
            <FormControlLabel
              control={
                <Switch
                  checked={formData.is_internet_facing || false}
                  onChange={(e) => setFormData({ ...formData, is_internet_facing: e.target.checked })}
                />
              }
              label="Internet Facing"
            />
            <FormControlLabel
              control={
                <Switch
                  checked={formData.has_public_ip || false}
                  onChange={(e) => setFormData({ ...formData, has_public_ip: e.target.checked })}
                />
              }
              label="Has Public IP"
            />
          </Grid>

          {/* Assignment */}
          <Grid item xs={12}>
            <Typography variant="subtitle2" fontWeight="bold" gutterBottom sx={{ mt: 2 }}>
              Assignment
            </Typography>
          </Grid>

          <Grid item xs={12} sm={6}>
            <FormControl fullWidth>
              <InputLabel>Assigned User</InputLabel>
              <Select
                value={formData.assigned_user_id || ''}
                label="Assigned User"
                onChange={(e) => setFormData({ ...formData, assigned_user_id: e.target.value })}
              >
                <MenuItem value="">
                  <em>None</em>
                </MenuItem>
                {users?.map((user) => (
                  <MenuItem key={user.id} value={user.id}>
                    {user.username} ({user.email})
                  </MenuItem>
                ))}
              </Select>
            </FormControl>
          </Grid>

          <Grid item xs={12} sm={6}>
            <FormControl fullWidth>
              <InputLabel>Assigned Team</InputLabel>
              <Select
                value={formData.assigned_team_id || ''}
                label="Assigned Team"
                onChange={(e) => setFormData({ ...formData, assigned_team_id: e.target.value })}
              >
                <MenuItem value="">
                  <em>None</em>
                </MenuItem>
                {teams?.map((team) => (
                  <MenuItem key={team.id} value={team.id}>
                    {team.name}
                  </MenuItem>
                ))}
              </Select>
            </FormControl>
          </Grid>

          {/* Tags */}
          <Grid item xs={12}>
            <Typography variant="subtitle2" fontWeight="bold" gutterBottom sx={{ mt: 2 }}>
              Tags
            </Typography>
            <Box sx={{ display: 'flex', gap: 1, mb: 1 }}>
              <TextField
                fullWidth
                size="small"
                placeholder="Add tag..."
                value={tagInput}
                onChange={(e) => setTagInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleAddTag()}
              />
              <Button variant="outlined" onClick={handleAddTag}>
                Add
              </Button>
            </Box>
            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
              {formData.tags?.map((tag) => (
                <Chip
                  key={tag}
                  label={tag}
                  onDelete={() => handleRemoveTag(tag)}
                  size="small"
                />
              ))}
            </Box>
          </Grid>

          {/* Notes */}
          <Grid item xs={12}>
            <Typography variant="subtitle2" fontWeight="bold" gutterBottom sx={{ mt: 2 }}>
              Notes
            </Typography>
            <TextField
              fullWidth
              multiline
              rows={4}
              value={formData.notes || ''}
              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
              placeholder="Add any additional notes about this device..."
            />
          </Grid>
        </Grid>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>Cancel</Button>
        <Button
          variant="contained"
          onClick={handleSubmit}
          disabled={updateMutation.isPending}
          startIcon={updateMutation.isPending ? <CircularProgress size={20} /> : null}
        >
          Save Changes
        </Button>
      </DialogActions>
    </Dialog>
  );
};

export default EditDeviceDialog;
