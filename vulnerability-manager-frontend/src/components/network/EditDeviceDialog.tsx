import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Box,
  CircularProgress,
  Alert,
  Divider,
  Typography,
} from '@mui/material';
import { useMutation } from '@tanstack/react-query';
import apiClient from '../../services/api';
import { NetworkDevice } from '../../types/network';

interface EditDeviceDialogProps {
  open: boolean;
  device: NetworkDevice | null;
  onClose: () => void;
  onSuccess?: () => void;
}

export const EditDeviceDialog: React.FC<EditDeviceDialogProps> = ({
  open,
  device,
  onClose,
  onSuccess,
}) => {
  const [formData, setFormData] = useState({
    hostname: '',
    device_type: '',
    vendor: '',
    os_name: '',
    os_version: '',
    owner: '',
    location: '',
    criticality: '',
    tags: '',
    notes: '',
    is_internet_facing: false,
    has_public_ip: false,
  });

  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (device) {
      setFormData({
        hostname: device.hostname || device.name || '',
        device_type: device.type || '',
        vendor: device.manufacturer || '',
        os_name: device.osVersion?.split(' ')[0] || '',
        os_version: device.osVersion || '',
        owner: device.owner || '',
        location: device.location || '',
        criticality: device.criticality || '',
        tags: device.tags?.join(', ') || '',
        notes: device.notes || '',
        is_internet_facing: device.is_internet_facing || false,
        has_public_ip: device.has_public_ip || false,
      });
    }
  }, [device, open]);

  const updateMutation = useMutation({
    mutationFn: async (data: typeof formData) => {
      if (!device) throw new Error('Device not found');
      const payload = {
        hostname: data.hostname,
        device_type: data.device_type,
        vendor: data.vendor,
        os_name: data.os_name,
        os_version: data.os_version,
        owner: data.owner || undefined,
        location: data.location || undefined,
        criticality: data.criticality || undefined,
        tags: data.tags ? data.tags.split(',').map(t => t.trim()) : undefined,
        notes: data.notes || undefined,
        is_internet_facing: data.is_internet_facing,
        has_public_ip: data.has_public_ip,
      };
      return apiClient.put(`/api/network/devices/${device.id}`, payload);
    },
    onSuccess: () => {
      setError(null);
      onSuccess?.();
      onClose();
    },
    onError: (err: any) => {
      setError(err.response?.data?.error || 'Errore durante il salvataggio');
    },
  });

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | { name?: string; value: unknown }>) => {
    const { name, value } = e.target as HTMLInputElement;
    setFormData(prev => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleSelectChange = (e: any) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleCheckChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: checked,
    }));
  };

  const handleSubmit = () => {
    updateMutation.mutate(formData);
  };

  return (
    <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
      <DialogTitle>Modifica Device: {device?.name}</DialogTitle>
      <DialogContent sx={{ pt: 2 }}>
        {error && (
          <Alert severity="error" sx={{ mb: 2 }}>
            {error}
          </Alert>
        )}

        {updateMutation.isPending && (
          <Box sx={{ display: 'flex', justifyContent: 'center', mb: 2 }}>
            <CircularProgress />
          </Box>
        )}

        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
          <Typography variant="subtitle2" sx={{ mt: 2 }}>
            Informazioni di Base
          </Typography>

          <TextField
            label="Hostname"
            name="hostname"
            value={formData.hostname}
            onChange={handleChange}
            fullWidth
            size="small"
          />

          <FormControl fullWidth size="small">
            <InputLabel>Tipo Device</InputLabel>
            <Select
              name="device_type"
              value={formData.device_type}
              onChange={handleSelectChange}
              label="Tipo Device"
            >
              <MenuItem value="router">Router</MenuItem>
              <MenuItem value="switch">Switch</MenuItem>
              <MenuItem value="firewall">Firewall</MenuItem>
              <MenuItem value="server">Server</MenuItem>
              <MenuItem value="workstation">Workstation</MenuItem>
              <MenuItem value="iot">IoT</MenuItem>
              <MenuItem value="printer">Printer</MenuItem>
              <MenuItem value="unknown">Unknown</MenuItem>
            </Select>
          </FormControl>

          <Divider />

          <Typography variant="subtitle2">Sistema Operativo</Typography>

          <TextField
            label="Vendor"
            name="vendor"
            value={formData.vendor}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. HP, Dell, Cisco"
          />

          <TextField
            label="OS Name"
            name="os_name"
            value={formData.os_name}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. Linux, Windows, iOS"
          />

          <TextField
            label="OS Version"
            name="os_version"
            value={formData.os_version}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. Ubuntu 22.04, Windows Server 2019"
          />

          <Divider />

          <Typography variant="subtitle2">Dettagli Organizzativi</Typography>

          <TextField
            label="Owner"
            name="owner"
            value={formData.owner}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. IT Team, Network Admin"
          />

          <TextField
            label="Location"
            name="location"
            value={formData.location}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. Data Center 1, Floor 3"
          />

          <FormControl fullWidth size="small">
            <InputLabel>Criticality</InputLabel>
            <Select
              name="criticality"
              value={formData.criticality}
              onChange={handleSelectChange}
              label="Criticality"
            >
              <MenuItem value="">None</MenuItem>
              <MenuItem value="critical">Critical</MenuItem>
              <MenuItem value="high">High</MenuItem>
              <MenuItem value="medium">Medium</MenuItem>
              <MenuItem value="low">Low</MenuItem>
            </Select>
          </FormControl>

          <TextField
            label="Tags (comma-separated)"
            name="tags"
            value={formData.tags}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. production, monitored, legacy"
          />

          <TextField
            label="Notes"
            name="notes"
            value={formData.notes}
            onChange={handleChange}
            fullWidth
            size="small"
            multiline
            rows={3}
            placeholder="Note aggiuntive sul device"
          />

          <Divider />

          <Typography variant="subtitle2">Configurazione di Rete</Typography>

          <FormControl fullWidth size="small">
            <InputLabel>Internet Facing</InputLabel>
            <Select
              name="is_internet_facing"
              value={formData.is_internet_facing}
              onChange={handleSelectChange}
              label="Internet Facing"
            >
              <MenuItem value={false as any}>No</MenuItem>
              <MenuItem value={true as any}>Yes</MenuItem>
            </Select>
          </FormControl>

          <FormControl fullWidth size="small">
            <InputLabel>Has Public IP</InputLabel>
            <Select
              name="has_public_ip"
              value={formData.has_public_ip}
              onChange={handleSelectChange}
              label="Has Public IP"
            >
              <MenuItem value={false as any}>No</MenuItem>
              <MenuItem value={true as any}>Yes</MenuItem>
            </Select>
          </FormControl>
        </Box>
      </DialogContent>

      <DialogActions>
        <Button onClick={onClose}>Annulla</Button>
        <Button
          onClick={handleSubmit}
          variant="contained"
          disabled={updateMutation.isPending}
        >
          {updateMutation.isPending ? 'Salvataggio...' : 'Salva'}
        </Button>
      </DialogActions>
    </Dialog>
  );
};

export default EditDeviceDialog;
