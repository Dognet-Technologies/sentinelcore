import React, { useState, useMemo, useEffect } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Stack,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Checkbox,
  FormControlLabel,
  Alert,
  AlertTitle,
  List,
  ListItem,
  ListItemText,
  Divider,
  Link,
  Typography,
  Box,
  LinearProgress,
} from '@mui/material';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import apiClient from '../../services/api';
import { NetworkDevice } from '../../types/network';

interface Team {
  id: string;
  name: string;
}

interface User {
  id: string;
  email: string;
  full_name: string;
}

interface BulkActionsDialogProps {
  open: boolean;
  onClose: () => void;
  selectedDevices: NetworkDevice[];
  actionType: 'assign-team' | 'assign-user' | 'remediation-plan' | null;
}

const BulkActionsDialog: React.FC<BulkActionsDialogProps> = ({
  open,
  onClose,
  selectedDevices,
  actionType,
}) => {
  const queryClient = useQueryClient();
  const [selectedTeamId, setSelectedTeamId] = useState<string>('');
  const [selectedUserId, setSelectedUserId] = useState<string>('');
  const [includeCritical, setIncludeCritical] = useState(true);
  const [includeHigh, setIncludeHigh] = useState(true);
  const [includeMedium, setIncludeMedium] = useState(true);

  // RBRE data completion dialog states
  const [showCompletionDialog, setShowCompletionDialog] = useState(false);
  const [currentDeviceIndex, setCurrentDeviceIndex] = useState(0);
  const [editedBusinessCriticality, setEditedBusinessCriticality] = useState<string>('');
  const [editedExposureLevel, setEditedExposureLevel] = useState<string>('');

  // Keep a local copy of devices that gets updated as we save
  const [localDevices, setLocalDevices] = useState<NetworkDevice[]>(selectedDevices);

  // Sync local devices when selected devices change
  useEffect(() => {
    setLocalDevices(selectedDevices);
  }, [selectedDevices]);

  // Validate devices for RBRE required fields
  const devicesWithMissingData = useMemo(() => {
    if (actionType !== 'remediation-plan') return [];

    return localDevices.filter(device => {
      const missingFields = [];

      // Check business_criticality
      if (!device.business_criticality || device.business_criticality === 'supporto') {
        missingFields.push('Business Criticality');
      }

      // Check exposure_level
      if (!device.exposure_level || device.exposure_level === 'internal') {
        missingFields.push('Exposure Level');
      }

      return missingFields.length > 0;
    }).map(device => ({
      device,
      missingFields: (() => {
        const fields = [];
        if (!device.business_criticality || device.business_criticality === 'supporto') {
          fields.push('Business Criticality');
        }
        if (!device.exposure_level || device.exposure_level === 'internal') {
          fields.push('Exposure Level');
        }
        return fields;
      })()
    }));
  }, [localDevices, actionType]);

  const { data: teams = [] } = useQuery({
    queryKey: ['teams'],
    queryFn: async () => {
      const response = await apiClient.get<Team[]>('/api/teams');
      return response.data;
    },
  });

  const { data: users = [] } = useQuery({
    queryKey: ['users'],
    queryFn: async () => {
      const response = await apiClient.get<User[]>('/api/users');
      return response.data;
    },
  });

  const assignToTeamMutation = useMutation({
    mutationFn: async (teamId: string) => {
      const deviceIds = selectedDevices.map(d => d.id);
      return apiClient.post('/api/vulnerabilities/bulk-assign-team', {
        device_ids: deviceIds,
        team_id: teamId,
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['network-topology'] });
      onClose();
    },
  });

  const assignToUserMutation = useMutation({
    mutationFn: async (userId: string) => {
      const deviceIds = selectedDevices.map(d => d.id);
      return apiClient.post('/api/vulnerabilities/bulk-assign-user', {
        device_ids: deviceIds,
        user_id: userId,
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['network-topology'] });
      onClose();
    },
  });

  const generateRemediationPlanMutation = useMutation({
    mutationFn: async () => {
      const deviceIds = selectedDevices.map(d => d.id);
      const severities = [];
      if (includeCritical) severities.push('critical');
      if (includeHigh) severities.push('high');
      if (includeMedium) severities.push('medium');

      return apiClient.post('/api/rbre/generate-plan', {
        device_ids: deviceIds,
        name: `Remediation Plan - ${new Date().toLocaleDateString()}`,
        description: `Generated from network topology context menu`,
        severity_filter: severities,
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['remediation-plans'] });
      onClose();
    },
  });

  const updateDeviceMutation = useMutation({
    mutationFn: async (data: { deviceId: string; updates: any }) => {
      return apiClient.put(`/api/network/devices/${data.deviceId}`, data.updates);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['network-topology'] });
      queryClient.invalidateQueries({ queryKey: ['network-topology-vulnerabilities'] });
      queryClient.invalidateQueries({ queryKey: ['incompleteDevices'] });
    },
  });

  const handleAssignToTeam = () => {
    if (selectedTeamId) {
      assignToTeamMutation.mutate(selectedTeamId);
    }
  };

  const handleAssignToUser = () => {
    if (selectedUserId) {
      assignToUserMutation.mutate(selectedUserId);
    }
  };

  const handleGenerateRemediationPlan = () => {
    generateRemediationPlanMutation.mutate();
  };

  const handleOpenCompletionDialog = () => {
    if (devicesWithMissingData.length > 0) {
      setCurrentDeviceIndex(0);
      const firstDevice = devicesWithMissingData[0].device;
      setEditedBusinessCriticality(firstDevice.business_criticality || '');
      setEditedExposureLevel(firstDevice.exposure_level || '');
      setShowCompletionDialog(true);
    }
  };

  const handleCloseCompletionDialog = () => {
    setShowCompletionDialog(false);
    setCurrentDeviceIndex(0);
    setEditedBusinessCriticality('');
    setEditedExposureLevel('');
  };

  const handleSaveCurrentDevice = async () => {
    if (devicesWithMissingData.length === 0) return;

    const currentDevice = devicesWithMissingData[currentDeviceIndex].device;

    await updateDeviceMutation.mutateAsync({
      deviceId: currentDevice.id,
      updates: {
        business_criticality: editedBusinessCriticality,
        exposure_level: editedExposureLevel,
      },
    });

    // Update local devices with the new values
    setLocalDevices(prev => prev.map(device =>
      device.id === currentDevice.id
        ? {
            ...device,
            business_criticality: editedBusinessCriticality as any,
            exposure_level: editedExposureLevel as any,
          }
        : device
    ));

    // Move to next device or close if done
    if (currentDeviceIndex < devicesWithMissingData.length - 1) {
      const nextIndex = currentDeviceIndex + 1;
      setCurrentDeviceIndex(nextIndex);
      const nextDevice = devicesWithMissingData[nextIndex].device;
      setEditedBusinessCriticality(nextDevice.business_criticality || '');
      setEditedExposureLevel(nextDevice.exposure_level || '');
    } else {
      // All devices completed
      handleCloseCompletionDialog();
    }
  };

  const handleSkipDevice = () => {
    if (currentDeviceIndex < devicesWithMissingData.length - 1) {
      const nextIndex = currentDeviceIndex + 1;
      setCurrentDeviceIndex(nextIndex);
      const nextDevice = devicesWithMissingData[nextIndex].device;
      setEditedBusinessCriticality(nextDevice.business_criticality || '');
      setEditedExposureLevel(nextDevice.exposure_level || '');
    } else {
      handleCloseCompletionDialog();
    }
  };

  const getTitle = () => {
    switch (actionType) {
      case 'assign-team':
        return 'Assign Devices to Team';
      case 'assign-user':
        return 'Assign Devices to User';
      case 'remediation-plan':
        return 'Generate Remediation Plan';
      default:
        return 'Bulk Action';
    }
  };

  const getContent = () => {
    if (actionType === 'assign-team') {
      return (
        <FormControl fullWidth>
          <InputLabel>Select Team</InputLabel>
          <Select
            value={selectedTeamId}
            onChange={(e) => setSelectedTeamId(e.target.value)}
          >
            {teams.map(team => (
              <MenuItem key={team.id} value={team.id}>
                {team.name}
              </MenuItem>
            ))}
          </Select>
        </FormControl>
      );
    }

    if (actionType === 'assign-user') {
      return (
        <FormControl fullWidth>
          <InputLabel>Select User</InputLabel>
          <Select
            value={selectedUserId}
            onChange={(e) => setSelectedUserId(e.target.value)}
          >
            {users.map(user => (
              <MenuItem key={user.id} value={user.id}>
                {user.full_name} ({user.email})
              </MenuItem>
            ))}
          </Select>
        </FormControl>
      );
    }

    if (actionType === 'remediation-plan') {
      return (
        <Stack spacing={2}>
          {/* Warning for devices with missing RBRE data */}
          {devicesWithMissingData.length > 0 && (
            <Alert severity="warning">
              <AlertTitle>‚ö†Ô∏è Dati obbligatori mancanti per il calcolo RBRE</AlertTitle>
              {devicesWithMissingData.length} dispositivi non hanno i campi obbligatori per il calcolo accurato
              del Risk-Based Prioritization Score. Questo pu√≤ causare una classificazione errata delle priorit√†.
              <Divider sx={{ my: 1 }} />
              <List dense sx={{ maxHeight: 200, overflow: 'auto' }}>
                {devicesWithMissingData.map(({ device, missingFields }, idx) => (
                  <ListItem key={idx}>
                    <ListItemText
                      primary={`${device.name || device.hostname} (${device.ipAddress})`}
                      secondary={`Campi mancanti: ${missingFields.join(', ')}`}
                    />
                  </ListItem>
                ))}
              </List>
              <Divider sx={{ my: 1 }} />
              <Link
                href="#"
                onClick={(e) => {
                  e.preventDefault();
                  handleOpenCompletionDialog();
                }}
                sx={{ cursor: 'pointer' }}
              >
                üìù Compila i dati mancanti prima di procedere
              </Link>
            </Alert>
          )}

          <FormControlLabel
            control={<Checkbox checked={includeCritical} onChange={(e) => setIncludeCritical(e.target.checked)} />}
            label="Include Critical Severity Vulnerabilities"
          />
          <FormControlLabel
            control={<Checkbox checked={includeHigh} onChange={(e) => setIncludeHigh(e.target.checked)} />}
            label="Include High Severity Vulnerabilities"
          />
          <FormControlLabel
            control={<Checkbox checked={includeMedium} onChange={(e) => setIncludeMedium(e.target.checked)} />}
            label="Include Medium Severity Vulnerabilities"
          />
        </Stack>
      );
    }

    return null;
  };

  const isLoading =
    assignToTeamMutation.isPending ||
    assignToUserMutation.isPending ||
    generateRemediationPlanMutation.isPending;

  const getActionButton = () => {
    switch (actionType) {
      case 'assign-team':
        return (
          <Button
            variant="contained"
            onClick={handleAssignToTeam}
            disabled={!selectedTeamId || isLoading}
          >
            Assign
          </Button>
        );
      case 'assign-user':
        return (
          <Button
            variant="contained"
            onClick={handleAssignToUser}
            disabled={!selectedUserId || isLoading}
          >
            Assign
          </Button>
        );
      case 'remediation-plan':
        return (
          <Button
            variant="contained"
            onClick={handleGenerateRemediationPlan}
            disabled={isLoading || devicesWithMissingData.length > 0}
            title={devicesWithMissingData.length > 0 ? 'Completa i dati obbligatori prima di generare il piano' : ''}
          >
            {devicesWithMissingData.length > 0 ? '‚ö†Ô∏è Dati incompleti' : 'Generate'}
          </Button>
        );
      default:
        return null;
    }
  };

  const currentDeviceBeingEdited = devicesWithMissingData[currentDeviceIndex]?.device;

  return (
    <>
      <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
        <DialogTitle>
          {getTitle()} ({selectedDevices.length} devices)
        </DialogTitle>
        <DialogContent>
          <Stack spacing={2} sx={{ mt: 2 }}>
            {getContent()}
          </Stack>
        </DialogContent>
        <DialogActions>
          <Button onClick={onClose}>Cancel</Button>
          {getActionButton()}
        </DialogActions>
      </Dialog>

      {/* RBRE Data Completion Dialog */}
      <Dialog
        open={showCompletionDialog}
        onClose={handleCloseCompletionDialog}
        maxWidth="sm"
        fullWidth
      >
        <DialogTitle>
          Compila Dati RBRE Obbligatori
          <Typography variant="body2" color="text.secondary">
            Dispositivo {currentDeviceIndex + 1} di {devicesWithMissingData.length}
          </Typography>
        </DialogTitle>
        <DialogContent>
          <Stack spacing={3} sx={{ mt: 2 }}>
            {/* Progress Bar */}
            <Box>
              <Typography variant="caption" color="text.secondary">
                Progresso: {currentDeviceIndex} / {devicesWithMissingData.length} completati
              </Typography>
              <LinearProgress
                variant="determinate"
                value={(currentDeviceIndex / devicesWithMissingData.length) * 100}
                sx={{ mt: 1 }}
              />
            </Box>

            {/* Device Info */}
            {currentDeviceBeingEdited && (
              <Alert severity="info">
                <AlertTitle>
                  {currentDeviceBeingEdited.hostname || currentDeviceBeingEdited.ipAddress}
                </AlertTitle>
                <Typography variant="body2">
                  IP: {currentDeviceBeingEdited.ipAddress}
                </Typography>
                <Typography variant="body2">
                  Campi mancanti: {devicesWithMissingData[currentDeviceIndex]?.missingFields.join(', ')}
                </Typography>
              </Alert>
            )}

            {/* Business Criticality Field */}
            <FormControl fullWidth required>
              <InputLabel>Business Criticality</InputLabel>
              <Select
                value={editedBusinessCriticality}
                onChange={(e) => setEditedBusinessCriticality(e.target.value)}
                label="Business Criticality"
              >
                <MenuItem value="mission_critical">
                  <Stack>
                    <Typography variant="body2" fontWeight="bold">Mission Critical</Typography>
                    <Typography variant="caption" color="text.secondary">
                      Impatto diretto sulle operazioni core aziendali
                    </Typography>
                  </Stack>
                </MenuItem>
                <MenuItem value="core_business">
                  <Stack>
                    <Typography variant="body2" fontWeight="bold">Core Business</Typography>
                    <Typography variant="caption" color="text.secondary">
                      Supporta processi di business importanti
                    </Typography>
                  </Stack>
                </MenuItem>
                <MenuItem value="lab_test">
                  <Stack>
                    <Typography variant="body2" fontWeight="bold">Lab/Test</Typography>
                    <Typography variant="caption" color="text.secondary">
                      Ambiente di test o laboratorio
                    </Typography>
                  </Stack>
                </MenuItem>
              </Select>
            </FormControl>

            {/* Exposure Level Field */}
            <FormControl fullWidth required>
              <InputLabel>Exposure Level</InputLabel>
              <Select
                value={editedExposureLevel}
                onChange={(e) => setEditedExposureLevel(e.target.value)}
                label="Exposure Level"
              >
                <MenuItem value="internet_facing">
                  <Stack>
                    <Typography variant="body2" fontWeight="bold">Internet Facing</Typography>
                    <Typography variant="caption" color="text.secondary">
                      Esposto direttamente a Internet
                    </Typography>
                  </Stack>
                </MenuItem>
                <MenuItem value="dmz">
                  <Stack>
                    <Typography variant="body2" fontWeight="bold">DMZ</Typography>
                    <Typography variant="caption" color="text.secondary">
                      In zona demilitarizzata
                    </Typography>
                  </Stack>
                </MenuItem>
                <MenuItem value="segmented">
                  <Stack>
                    <Typography variant="body2" fontWeight="bold">Segmented</Typography>
                    <Typography variant="caption" color="text.secondary">
                      Rete segmentata/isolata
                    </Typography>
                  </Stack>
                </MenuItem>
              </Select>
            </FormControl>
          </Stack>
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseCompletionDialog}>
            Annulla
          </Button>
          <Button onClick={handleSkipDevice}>
            Salta
          </Button>
          <Button
            variant="contained"
            onClick={handleSaveCurrentDevice}
            disabled={!editedBusinessCriticality || !editedExposureLevel || updateDeviceMutation.isPending}
          >
            {updateDeviceMutation.isPending ? 'Salvataggio...' :
              currentDeviceIndex < devicesWithMissingData.length - 1 ? 'Salva e Continua' : 'Salva e Termina'}
          </Button>
        </DialogActions>
      </Dialog>
    </>
  );
};

export default BulkActionsDialog;
