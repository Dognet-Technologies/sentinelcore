import React, { useState } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Stack,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Checkbox,
  FormControlLabel,
} from '@mui/material';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import apiClient from '../../services/api';
import { NetworkDevice } from '../../types/network';

interface Team {
  id: string;
  name: string;
}

interface User {
  id: string;
  email: string;
  full_name: string;
}

interface BulkActionsDialogProps {
  open: boolean;
  onClose: () => void;
  selectedDevices: NetworkDevice[];
  actionType: 'assign-team' | 'assign-user' | 'remediation-plan' | null;
}

const BulkActionsDialog: React.FC<BulkActionsDialogProps> = ({
  open,
  onClose,
  selectedDevices,
  actionType,
}) => {
  const queryClient = useQueryClient();
  const [selectedTeamId, setSelectedTeamId] = useState<string>('');
  const [selectedUserId, setSelectedUserId] = useState<string>('');
  const [includeCritical, setIncludeCritical] = useState(true);
  const [includeHigh, setIncludeHigh] = useState(true);
  const [includeMedium, setIncludeMedium] = useState(true);

  const { data: teams = [] } = useQuery({
    queryKey: ['teams'],
    queryFn: async () => {
      const response = await apiClient.get<Team[]>('/api/teams');
      return response.data;
    },
  });

  const { data: users = [] } = useQuery({
    queryKey: ['users'],
    queryFn: async () => {
      const response = await apiClient.get<User[]>('/api/users');
      return response.data;
    },
  });

  const assignToTeamMutation = useMutation({
    mutationFn: async (teamId: string) => {
      const deviceIds = selectedDevices.map(d => d.id);
      return apiClient.post('/api/vulnerabilities/bulk-assign-team', {
        device_ids: deviceIds,
        team_id: teamId,
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['network-topology'] });
      onClose();
    },
  });

  const assignToUserMutation = useMutation({
    mutationFn: async (userId: string) => {
      const deviceIds = selectedDevices.map(d => d.id);
      return apiClient.post('/api/vulnerabilities/bulk-assign-user', {
        device_ids: deviceIds,
        user_id: userId,
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['network-topology'] });
      onClose();
    },
  });

  const generateRemediationPlanMutation = useMutation({
    mutationFn: async () => {
      const deviceIds = selectedDevices.map(d => d.id);
      const severities = [];
      if (includeCritical) severities.push('critical');
      if (includeHigh) severities.push('high');
      if (includeMedium) severities.push('medium');

      return apiClient.post('/api/rbre/generate-plan', {
        device_ids: deviceIds,
        name: `Remediation Plan - ${new Date().toLocaleDateString()}`,
        description: `Generated from network topology context menu`,
        severity_filter: severities,
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['remediation-plans'] });
      onClose();
    },
  });

  const handleAssignToTeam = () => {
    if (selectedTeamId) {
      assignToTeamMutation.mutate(selectedTeamId);
    }
  };

  const handleAssignToUser = () => {
    if (selectedUserId) {
      assignToUserMutation.mutate(selectedUserId);
    }
  };

  const handleGenerateRemediationPlan = () => {
    generateRemediationPlanMutation.mutate();
  };

  const getTitle = () => {
    switch (actionType) {
      case 'assign-team':
        return 'Assign Devices to Team';
      case 'assign-user':
        return 'Assign Devices to User';
      case 'remediation-plan':
        return 'Generate Remediation Plan';
      default:
        return 'Bulk Action';
    }
  };

  const getContent = () => {
    if (actionType === 'assign-team') {
      return (
        <FormControl fullWidth>
          <InputLabel>Select Team</InputLabel>
          <Select
            value={selectedTeamId}
            onChange={(e) => setSelectedTeamId(e.target.value)}
          >
            {teams.map(team => (
              <MenuItem key={team.id} value={team.id}>
                {team.name}
              </MenuItem>
            ))}
          </Select>
        </FormControl>
      );
    }

    if (actionType === 'assign-user') {
      return (
        <FormControl fullWidth>
          <InputLabel>Select User</InputLabel>
          <Select
            value={selectedUserId}
            onChange={(e) => setSelectedUserId(e.target.value)}
          >
            {users.map(user => (
              <MenuItem key={user.id} value={user.id}>
                {user.full_name} ({user.email})
              </MenuItem>
            ))}
          </Select>
        </FormControl>
      );
    }

    if (actionType === 'remediation-plan') {
      return (
        <Stack spacing={2}>
          <FormControlLabel
            control={<Checkbox checked={includeCritical} onChange={(e) => setIncludeCritical(e.target.checked)} />}
            label="Include Critical Severity Vulnerabilities"
          />
          <FormControlLabel
            control={<Checkbox checked={includeHigh} onChange={(e) => setIncludeHigh(e.target.checked)} />}
            label="Include High Severity Vulnerabilities"
          />
          <FormControlLabel
            control={<Checkbox checked={includeMedium} onChange={(e) => setIncludeMedium(e.target.checked)} />}
            label="Include Medium Severity Vulnerabilities"
          />
        </Stack>
      );
    }

    return null;
  };

  const isLoading =
    assignToTeamMutation.isPending ||
    assignToUserMutation.isPending ||
    generateRemediationPlanMutation.isPending;

  const getActionButton = () => {
    switch (actionType) {
      case 'assign-team':
        return (
          <Button
            variant="contained"
            onClick={handleAssignToTeam}
            disabled={!selectedTeamId || isLoading}
          >
            Assign
          </Button>
        );
      case 'assign-user':
        return (
          <Button
            variant="contained"
            onClick={handleAssignToUser}
            disabled={!selectedUserId || isLoading}
          >
            Assign
          </Button>
        );
      case 'remediation-plan':
        return (
          <Button
            variant="contained"
            onClick={handleGenerateRemediationPlan}
            disabled={isLoading}
          >
            Generate
          </Button>
        );
      default:
        return null;
    }
  };

  return (
    <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
      <DialogTitle>
        {getTitle()} ({selectedDevices.length} devices)
      </DialogTitle>
      <DialogContent>
        <Stack spacing={2} sx={{ mt: 2 }}>
          {getContent()}
        </Stack>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>Cancel</Button>
        {getActionButton()}
      </DialogActions>
    </Dialog>
  );
};

export default BulkActionsDialog;
