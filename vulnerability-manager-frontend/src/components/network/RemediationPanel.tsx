// src/components/network/RemediationPanel.tsx
// Panel per gestire la remediation delle vulnerabilitÃ 

import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Box,
  Typography,
  List,
  ListItem,
  ListItemText,
  ListItemButton,
  Chip,
  Tab,
  Tabs,
  TextField,
  Alert,
  CircularProgress,
  Divider,
} from '@mui/material';
import {
  CheckCircle,
  Error,
  Warning,
  PlayArrow,
} from '@mui/icons-material';
import TerminalEmulator from './TerminalEmulator';

interface NetworkDevice {
  id: string;
  ip_address: string;
  hostname?: string;
  device_type: string;
  os_name?: string;
}

interface Vulnerability {
  id: string;
  title: string;
  severity: string;
  cvss_score: number;
  remediation?: string;
  cve_id?: string;
}

interface RemediationPanelProps {
  device: NetworkDevice;
  onClose: () => void;
}

const RemediationPanel: React.FC<RemediationPanelProps> = ({ device, onClose }) => {
  const [tab, setTab] = useState(0);
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);
  const [loading, setLoading] = useState(true);
  const [executing, setExecuting] = useState(false);
  const [customScript, setCustomScript] = useState('');
  const [showTerminal, setShowTerminal] = useState(false);

  useEffect(() => {
    loadVulnerabilities();
  }, [device.id]);

  const loadVulnerabilities = async () => {
    setLoading(true);
    try {
      const response = await fetch(`/api/network/devices/${device.id}/details`);
      const data = await response.json();
      setVulnerabilities(data.vulnerabilities || []);
    } catch (error) {
      console.error('Failed to load vulnerabilities:', error);
    } finally {
      setLoading(false);
    }
  };

  const executeAutoRemediation = async (vuln: Vulnerability) => {
    if (!vuln.remediation) return;

    setExecuting(true);
    try {
      const response = await fetch(`/api/network/devices/${device.id}/remediate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          vulnerability_id: vuln.id,
          remediation_type: 'auto',
        }),
      });

      const result = await response.json();
      console.log('Remediation result:', result);

      // Reload vulnerabilities
      await loadVulnerabilities();
    } catch (error) {
      console.error('Remediation failed:', error);
    } finally {
      setExecuting(false);
    }
  };

  const executeCustomScript = async () => {
    if (!customScript.trim()) return;

    setExecuting(true);
    try {
      const response = await fetch(`/api/network/devices/${device.id}/remediate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          vulnerability_id: selectedVuln?.id,
          remediation_type: 'script',
          script: customScript,
        }),
      });

      const result = await response.json();
      console.log('Script execution result:', result);
    } catch (error) {
      console.error('Script execution failed:', error);
    } finally {
      setExecuting(false);
    }
  };

  const getSeverityColor = (severity: string) => {
    const colors: Record<string, 'error' | 'warning' | 'info' | 'success'> = {
      critical: 'error',
      high: 'error',
      medium: 'warning',
      low: 'info',
      info: 'success',
    };
    return colors[severity.toLowerCase()] || 'default';
  };

  const getSeverityIcon = (severity: string) => {
    const normalized = severity.toLowerCase();
    if (normalized === 'critical' || normalized === 'high') {
      return <Error color="error" />;
    }
    if (normalized === 'medium') {
      return <Warning color="warning" />;
    }
    return <CheckCircle color="success" />;
  };

  return (
    <Dialog
      open={true}
      onClose={onClose}
      maxWidth="md"
      fullWidth
      PaperProps={{
        sx: { height: '80vh' },
      }}
    >
      <DialogTitle>
        <Box>
          <Typography variant="h6">Fix Vulnerabilities</Typography>
          <Typography variant="caption" color="text.secondary">
            {device.hostname || device.ip_address} ({device.device_type})
          </Typography>
        </Box>
      </DialogTitle>

      <DialogContent dividers>
        <Tabs value={tab} onChange={(_, v) => setTab(v)} sx={{ mb: 2 }}>
          <Tab label="Auto Remediation" />
          <Tab label="Manual Script" />
          <Tab label="Terminal" />
        </Tabs>

        {/* Auto Remediation Tab */}
        {tab === 0 && (
          <Box>
            {loading ? (
              <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
                <CircularProgress />
              </Box>
            ) : vulnerabilities.length === 0 ? (
              <Alert severity="success">No vulnerabilities found!</Alert>
            ) : (
              <List>
                {vulnerabilities.map((vuln) => (
                  <React.Fragment key={vuln.id}>
                    <ListItemButton
                      selected={selectedVuln?.id === vuln.id}
                      onClick={() => setSelectedVuln(vuln)}
                    >
                      <ListItemText
                        primary={
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                            {getSeverityIcon(vuln.severity)}
                            <Typography variant="body1">{vuln.title}</Typography>
                            <Chip
                              label={vuln.severity}
                              size="small"
                              color={getSeverityColor(vuln.severity)}
                            />
                            <Chip label={`CVSS ${vuln.cvss_score}`} size="small" />
                          </Box>
                        }
                        secondary={
                          vuln.remediation ? (
                            <Box sx={{ mt: 1 }}>
                              <Typography variant="caption" color="text.secondary">
                                Suggested: {vuln.remediation.substring(0, 100)}...
                              </Typography>
                              <Box sx={{ mt: 1 }}>
                                <Button
                                  size="small"
                                  variant="contained"
                                  startIcon={<PlayArrow />}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    executeAutoRemediation(vuln);
                                  }}
                                  disabled={executing}
                                >
                                  Apply Fix
                                </Button>
                              </Box>
                            </Box>
                          ) : (
                            <Typography variant="caption" color="text.secondary">
                              No automatic remediation available
                            </Typography>
                          )
                        }
                      />
                    </ListItemButton>
                    <Divider />
                  </React.Fragment>
                ))}
              </List>
            )}
          </Box>
        )}

        {/* Manual Script Tab */}
        {tab === 1 && (
          <Box>
            <Alert severity="warning" sx={{ mb: 2 }}>
              Manual scripts will be executed on the target device. Ensure you have proper authorization.
            </Alert>

            <TextField
              fullWidth
              multiline
              rows={15}
              value={customScript}
              onChange={(e) => setCustomScript(e.target.value)}
              placeholder="Enter your remediation script here...&#10;&#10;Example:&#10;#!/bin/bash&#10;sudo apt update&#10;sudo apt upgrade -y"
              variant="outlined"
              sx={{ fontFamily: 'monospace' }}
            />

            <Box sx={{ mt: 2 }}>
              <Button
                variant="contained"
                startIcon={<PlayArrow />}
                onClick={executeCustomScript}
                disabled={!customScript.trim() || executing}
              >
                {executing ? 'Executing...' : 'Execute Script'}
              </Button>
            </Box>
          </Box>
        )}

        {/* Terminal Tab */}
        {tab === 2 && (
          <Box sx={{ height: '500px' }}>
            <TerminalEmulator deviceId={device.id} ipAddress={device.ip_address} />
          </Box>
        )}
      </DialogContent>

      <DialogActions>
        <Button onClick={onClose}>Close</Button>
      </DialogActions>
    </Dialog>
  );
};

export default RemediationPanel;
