// src/components/quick-wins/SLACountdown.tsx
import React, { useEffect, useState } from 'react';
import { Box, Chip, LinearProgress, Tooltip, Typography } from '@mui/material';
import { AccessTime, Error as ErrorIcon } from '@mui/icons-material';

interface SLACountdownProps {
  deadline: string;
  createdAt: string;
  breached?: boolean;
}

export const SLACountdown: React.FC<SLACountdownProps> = ({ deadline, createdAt, breached = false }) => {
  const [timeLeft, setTimeLeft] = useState('');
  const [progress, setProgress] = useState(0);

  useEffect(() => {
    const calculateTimeLeft = () => {
      const now = new Date().getTime();
      const deadlineTime = new Date(deadline).getTime();
      const createdTime = new Date(createdAt).getTime();
      const totalTime = deadlineTime - createdTime;
      const elapsed = now - createdTime;
      const remaining = deadlineTime - now;

      // Calculate progress (0-100)
      const progressPercent = Math.min(100, Math.max(0, (elapsed / totalTime) * 100));
      setProgress(progressPercent);

      if (remaining <= 0) {
        const overdue = Math.abs(remaining);
        const days = Math.floor(overdue / (1000 * 60 * 60 * 24));
        const hours = Math.floor((overdue % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        setTimeLeft(`${days}d ${hours}h overdue`);
      } else {
        const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
        const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));

        if (days > 0) {
          setTimeLeft(`${days}d ${hours}h`);
        } else if (hours > 0) {
          setTimeLeft(`${hours}h ${minutes}m`);
        } else {
          setTimeLeft(`${minutes}m`);
        }
      }
    };

    calculateTimeLeft();
    const interval = setInterval(calculateTimeLeft, 60000); // Update every minute

    return () => clearInterval(interval);
  }, [deadline, createdAt]);

  const getColor = (): 'error' | 'warning' | 'success' => {
    if (breached || progress >= 100) return 'error';
    if (progress >= 75) return 'warning';
    return 'success';
  };

  return (
    <Box sx={{ width: '100%', maxWidth: 200 }}>
      <Tooltip title={`Deadline: ${new Date(deadline).toLocaleString()}`} arrow>
        <Box>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>
            {breached || progress >= 100 ? (
              <ErrorIcon color="error" fontSize="small" />
            ) : (
              <AccessTime color={getColor()} fontSize="small" />
            )}
            <Typography variant="caption" color={getColor()}>
              {timeLeft}
            </Typography>
          </Box>
          <LinearProgress
            variant="determinate"
            value={progress}
            color={getColor()}
            sx={{ height: 6, borderRadius: 3 }}
          />
        </Box>
      </Tooltip>
    </Box>
  );
};
