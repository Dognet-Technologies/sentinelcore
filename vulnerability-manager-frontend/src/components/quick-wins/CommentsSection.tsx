// src/components/quick-wins/CommentsSection.tsx
import React, { useState } from 'react';
import {
  Box,
  Paper,
  TextField,
  Button,
  Typography,
  Avatar,
  Chip,
  IconButton,
  Divider,
  CircularProgress
} from '@mui/material';
import { Send, Reply, Edit, Delete, AttachFile } from '@mui/icons-material';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { commentsApi, Comment, CreateCommentRequest } from '../../api/comments';

interface CommentsSectionProps {
  entityType: 'vulnerability' | 'asset' | 'remediation_plan';
  entityId: string;
}

export const CommentsSection: React.FC<CommentsSectionProps> = ({ entityType, entityId }) => {
  const [newComment, setNewComment] = useState('');
  const [replyTo, setReplyTo] = useState<string | null>(null);
  const [isInternal, setIsInternal] = useState(false);
  const queryClient = useQueryClient();

  const { data, isLoading } = useQuery({
    queryKey: ['comments', entityType, entityId],
    queryFn: () => commentsApi.getComments(entityType, entityId),
  });

  const createMutation = useMutation({
    mutationFn: (payload: CreateCommentRequest) => commentsApi.createComment(payload),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['comments', entityType, entityId] });
      setNewComment('');
      setReplyTo(null);
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (commentId: string) => commentsApi.deleteComment(entityType, commentId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['comments', entityType, entityId] });
    },
  });

  const handleSubmit = () => {
    if (!newComment.trim()) return;

    createMutation.mutate({
      entity_type: entityType,
      entity_id: entityId,
      comment_text: newComment,
      parent_comment_id: replyTo || undefined,
      is_internal: isInternal,
    });
  };

  const renderComment = (comment: Comment, isReply = false) => (
    <Paper
      key={comment.id}
      elevation={isReply ? 0 : 1}
      sx={{
        p: 2,
        ml: isReply ? 4 : 0,
        mb: 1,
        bgcolor: isReply ? 'grey.50' : 'background.paper',
        borderLeft: isReply ? '3px solid' : 'none',
        borderColor: 'primary.main',
      }}
    >
      <Box sx={{ display: 'flex', gap: 2 }}>
        <Avatar sx={{ width: 40, height: 40 }}>
          {comment.username.charAt(0).toUpperCase()}
        </Avatar>
        <Box sx={{ flex: 1 }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>
            <Typography variant="subtitle2" fontWeight="bold">
              {comment.username}
            </Typography>
            <Typography variant="caption" color="text.secondary">
              {new Date(comment.created_at).toLocaleString()}
            </Typography>
            {comment.is_internal && (
              <Chip label="Internal" size="small" color="warning" />
            )}
            {comment.is_edited && (
              <Chip label="Edited" size="small" variant="outlined" />
            )}
          </Box>
          <Typography variant="body2" sx={{ whiteSpace: 'pre-wrap', mb: 1 }}>
            {comment.comment_text}
          </Typography>
          <Box sx={{ display: 'flex', gap: 1 }}>
            <IconButton size="small" onClick={() => setReplyTo(comment.id)}>
              <Reply fontSize="small" />
            </IconButton>
            <IconButton size="small" onClick={() => deleteMutation.mutate(comment.id)}>
              <Delete fontSize="small" />
            </IconButton>
          </Box>
        </Box>
      </Box>
    </Paper>
  );

  if (isLoading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', p: 3 }}>
        <CircularProgress />
      </Box>
    );
  }

  const comments = data?.comments || [];
  const topLevelComments = comments.filter((c) => !c.parent_comment_id);

  return (
    <Box>
      <Typography variant="h6" gutterBottom>
        Comments ({comments.length})
      </Typography>

      {/* Comment Form */}
      <Paper sx={{ p: 2, mb: 2 }}>
        <TextField
          fullWidth
          multiline
          rows={3}
          placeholder="Write a comment... Use @username to mention someone"
          value={newComment}
          onChange={(e) => setNewComment(e.target.value)}
          sx={{ mb: 1 }}
        />
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <Box sx={{ display: 'flex', gap: 1 }}>
            <Chip
              label="Internal"
              size="small"
              color={isInternal ? 'warning' : 'default'}
              onClick={() => setIsInternal(!isInternal)}
              clickable
            />
            {replyTo && (
              <Chip
                label="Replying..."
                size="small"
                color="primary"
                onDelete={() => setReplyTo(null)}
              />
            )}
          </Box>
          <Button
            variant="contained"
            startIcon={<Send />}
            onClick={handleSubmit}
            disabled={!newComment.trim() || createMutation.isPending}
          >
            {createMutation.isPending ? 'Posting...' : 'Post Comment'}
          </Button>
        </Box>
      </Paper>

      <Divider sx={{ mb: 2 }} />

      {/* Comments List */}
      <Box>
        {topLevelComments.length === 0 ? (
          <Typography variant="body2" color="text.secondary" textAlign="center" p={3}>
            No comments yet. Be the first to comment!
          </Typography>
        ) : (
          topLevelComments.map((comment) => (
            <Box key={comment.id}>
              {renderComment(comment)}
              {/* Render replies */}
              {comments
                .filter((c) => c.parent_comment_id === comment.id)
                .map((reply) => renderComment(reply, true))}
            </Box>
          ))
        )}
      </Box>
    </Box>
  );
};
