import React, { useState, useEffect } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Box,
  CircularProgress,
  Alert,
  Divider,
  Typography,
  Chip,
  Stack,
} from '@mui/material';
import { useMutation } from '@tanstack/react-query';
import apiClient from '../services/api';
import type { Host } from '../types';

interface EditAssetDialogProps {
  open: boolean;
  asset: Host | null;
  onClose: () => void;
  onSuccess?: () => void;
}

export const EditAssetDialog: React.FC<EditAssetDialogProps> = ({
  open,
  asset,
  onClose,
  onSuccess,
}) => {
  const [formData, setFormData] = useState({
    name: '',
    hostname: '',
    asset_type: 'server',
    ip_address: '',
    mac_address: '',
    operating_system: '',
    owner: '',
    location: '',
    tags: '',
    description: '',
  });

  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (asset) {
      setFormData({
        name: asset.name || '',
        hostname: asset.hostname || '',
        asset_type: asset.asset_type || 'server',
        ip_address: asset.ip_address || '',
        mac_address: asset.mac_address || '',
        operating_system: asset.operating_system || asset.os || '',
        owner: asset.owner || '',
        location: asset.location || '',
        tags: asset.tags?.join(', ') || '',
        description: asset.description || '',
      });
    }
  }, [asset, open]);

  const updateMutation = useMutation({
    mutationFn: async (data: typeof formData) => {
      if (!asset) throw new Error('Asset not found');
      const payload = {
        name: data.name,
        hostname: data.hostname,
        asset_type: data.asset_type,
        ip_address: data.ip_address,
        mac_address: data.mac_address || undefined,
        operating_system: data.operating_system,
        owner: data.owner || undefined,
        location: data.location || undefined,
        tags: data.tags ? data.tags.split(',').map(t => t.trim()).filter(t => t) : undefined,
        description: data.description,
      };
      return apiClient.put(`/api/assets/${asset.id}`, payload);
    },
    onSuccess: () => {
      setError(null);
      onSuccess?.();
      onClose();
    },
    onError: (err: any) => {
      setError(err.response?.data?.error || 'Errore durante il salvataggio');
    },
  });

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | { name?: string; value: unknown }>) => {
    const { name, value } = e.target as HTMLInputElement;
    setFormData(prev => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleSelectChange = (e: any) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleSubmit = () => {
    if (!formData.name.trim()) {
      setError('Name is required');
      return;
    }
    updateMutation.mutate(formData);
  };

  return (
    <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth>
      <DialogTitle>Modifica Asset: {asset?.name}</DialogTitle>
      <DialogContent sx={{ pt: 2 }}>
        {error && (
          <Alert severity="error" sx={{ mb: 2 }}>
            {error}
          </Alert>
        )}

        {updateMutation.isPending && (
          <Box sx={{ display: 'flex', justifyContent: 'center', mb: 2 }}>
            <CircularProgress />
          </Box>
        )}

        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
          <TextField
            label="Name"
            name="name"
            value={formData.name}
            onChange={handleChange}
            fullWidth
            size="small"
            required
          />

          <TextField
            label="Hostname"
            name="hostname"
            value={formData.hostname}
            onChange={handleChange}
            fullWidth
            size="small"
          />

          <TextField
            label="IP Address"
            name="ip_address"
            value={formData.ip_address}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. 192.168.1.1 oppure 192.168.1.0/24"
          />

          <FormControl fullWidth size="small">
            <InputLabel>Asset Type</InputLabel>
            <Select
              name="asset_type"
              value={formData.asset_type}
              onChange={handleSelectChange}
              label="Asset Type"
            >
              <MenuItem value="server">Server</MenuItem>
              <MenuItem value="workstation">Workstation</MenuItem>
              <MenuItem value="network">Network Device</MenuItem>
              <MenuItem value="application">Application</MenuItem>
              <MenuItem value="container">Container</MenuItem>
              <MenuItem value="cloud">Cloud</MenuItem>
              <MenuItem value="iot">IoT</MenuItem>
              <MenuItem value="other">Other</MenuItem>
            </Select>
          </FormControl>

          <TextField
            label="Operating System"
            name="operating_system"
            value={formData.operating_system}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. Ubuntu 22.04, Windows Server 2019"
          />

          <Divider />

          <Typography variant="subtitle2">Informazioni Organizzative</Typography>

          <TextField
            label="MAC Address"
            name="mac_address"
            value={formData.mac_address}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. 00:1A:2B:3C:4D:5E"
          />

          <TextField
            label="Owner"
            name="owner"
            value={formData.owner}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. IT Team, Network Admin"
          />

          <TextField
            label="Location"
            name="location"
            value={formData.location}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. Data Center 1, Floor 3"
          />

          <TextField
            label="Tags (comma-separated)"
            name="tags"
            value={formData.tags}
            onChange={handleChange}
            fullWidth
            size="small"
            placeholder="es. production, monitored, legacy"
          />

          <TextField
            label="Description"
            name="description"
            value={formData.description}
            onChange={handleChange}
            fullWidth
            size="small"
            multiline
            rows={3}
            placeholder="Note descrittive per questo asset"
          />
        </Box>
      </DialogContent>

      <DialogActions>
        <Button onClick={onClose}>Annulla</Button>
        <Button
          onClick={handleSubmit}
          variant="contained"
          disabled={updateMutation.isPending}
        >
          {updateMutation.isPending ? 'Salvataggio...' : 'Salva'}
        </Button>
      </DialogActions>
    </Dialog>
  );
};

export default EditAssetDialog;
