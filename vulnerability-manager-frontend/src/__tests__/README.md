# Data Validation Testing Suite

Questa suite di test verifica automaticamente la coerenza, integritÃ  e correttezza dei dati tra backend e frontend.

## Obiettivi

Rispondere alle seguenti domande critiche:

1. **I dati sono concreti?** - Tutti i campi richiesti sono popolati e validi
2. **I dati sono nel contesto corretto?** - I dati mostrati sono appropriati per la pagina/vista
3. **I dati sono consistenti?** - Gli stessi dati (es. host) sono rappresentati allo stesso modo ovunque

## Struttura dei Test

### 1. Data Consistency Tests (`dataConsistency.test.ts`)

Verifica la coerenza dei dati tra entitÃ  correlate:

- **Vulnerability-Asset Consistency**
  - âœ… Tutti gli `asset_id` nelle vulnerabilitÃ  esistono nella tabella assets
  - âœ… Gli indirizzi IP corrispondono tra vulnerabilitÃ  e asset
  - âœ… I conteggi `vulnerability_count` sugli asset sono accurati

- **Vulnerability-Team Consistency**
  - âœ… Tutti i `team_id` nelle vulnerabilitÃ  esistono nella tabella teams
  - âœ… I nomi dei team corrispondono tra vulnerabilitÃ  e team

- **Data Completeness**
  - âœ… Tutti i campi richiesti sono popolati
  - âœ… I punteggi CVSS sono nel range 0-10
  - âœ… I livelli di severity corrispondono ai punteggi CVSS

- **Cross-Reference Integrity**
  - âœ… Tutte le foreign key (asset_id, team_id) sono valide

### 2. Context Validation Tests (`contextValidation.test.ts`)

Verifica che i dati siano appropriati per il contesto:

- **Host Consistency Across Contexts**
  - âœ… Gli stessi host mostrano gli stessi dati nelle vulnerabilitÃ  e nei team
  - âœ… Gli asset referenziati nelle vulnerabilitÃ  esistono nella lista asset

- **Team Assignment Context**
  - âœ… I team mostrano dati consistenti nelle assegnazioni vulnerabilitÃ  e nelle pagine team
  - âœ… I nomi dei team sono consistenti in tutti i contesti

- **Vulnerability Status Context**
  - âš ï¸ Le vulnerabilitÃ  critiche aperte sono assegnate
  - âš ï¸ Le vulnerabilitÃ  in-progress hanno assegnazioni

- **Data Representation Context**
  - âœ… Le stesse entitÃ  sono rappresentate allo stesso modo in viste diverse

### 3. API Integration Tests (`apiIntegration.test.ts`)

Verifica il flusso di dati dalle API al frontend:

- **Vulnerabilities API**
  - âœ… Fetch di tutte le vulnerabilitÃ 
  - âœ… Tutti i campi richiesti sono presenti
  - âœ… Filtri per status e severity funzionano
  - âœ… Fetch di singola vulnerabilitÃ  per ID
  - âœ… Dati relazionali (asset, team) sono inclusi

- **Assets API**
  - âœ… Fetch di tutti gli asset
  - âœ… Conteggi vulnerabilitÃ  sono presenti
  - âœ… Tipi di dati corretti

- **Teams API**
  - âœ… Fetch di tutti i team
  - âœ… Conteggi membri sono presenti

- **Data Transformation**
  - âœ… Campi data sono validi e parsabili
  - âœ… Campi numerici hanno tipi e range corretti
  - âœ… Campi opzionali sono gestiti correttamente

- **Error Handling**
  - âœ… ID invalidi gestiti correttamente
  - âœ… Errori di rete gestiti

- **Performance**
  - âœ… Tempi di risposta < 5 secondi

## Esecuzione dei Test

### Metodo 1: Test Suite Completa (Jest)

```bash
# Esegui tutti i test
npm test

# Esegui solo i test di data consistency
npm test dataConsistency

# Esegui solo i test di context validation
npm test contextValidation

# Esegui solo i test di API integration
npm test apiIntegration

# Esegui in watch mode (utile durante sviluppo)
npm test -- --watch
```

### Metodo 2: Validation Runner Standalone

Esegui il validatore standalone per un report dettagliato:

```bash
# Con npm script
npm run test:data-validation

# O direttamente con ts-node
ts-node src/__tests__/runDataValidation.ts
```

Il validation runner produce un report dettagliato come questo:

```
ğŸ” Starting Data Validation Tests...
================================================================================

ğŸ“Š Validating Vulnerability-Asset Consistency...
ğŸ‘¥ Validating Vulnerability-Team Consistency...
ğŸ”¢ Validating Asset Vulnerability Counts...
âœ… Validating Data Completeness...
ğŸ”— Validating Cross-References...
ğŸ¯ Validating Context Consistency...

================================================================================
ğŸ“‹ DATA VALIDATION REPORT
================================================================================

Vulnerability-Asset Consistency
--------------------------------------------------------------------------------
âœ… Asset ID References
   Checked 10 vulnerabilities against 7 assets

âœ… IP Address Matching
   Validated IP addresses for 10 vulnerabilities

...

================================================================================
SUMMARY
================================================================================
Total Tests:    12
Passed:         12 (100%)
Failed:         0
Total Errors:   0
Total Warnings: 2

ğŸ‰ All data validation tests passed!
================================================================================
```

## Quando Eseguire i Test

### 1. Durante lo Sviluppo

```bash
npm test -- --watch
```

Mantieni i test in esecuzione mentre sviluppi per rilevare immediatamente problemi di integritÃ  dati.

### 2. Prima di Commit

```bash
npm test
```

Assicurati che tutti i test passino prima di committare modifiche.

### 3. Dopo Modifiche al Database

```bash
npm run test:data-validation
```

Dopo aver eseguito migrazioni o seed, verifica l'integritÃ  dei dati.

### 4. In CI/CD Pipeline

Aggiungi al tuo workflow CI/CD:

```yaml
- name: Run Data Validation Tests
  run: |
    npm test
    npm run test:data-validation
```

## Interpretazione dei Risultati

### âœ… Test Passed
Tutti i controlli sono passati. I dati sono coerenti e corretti.

### âŒ Test Failed
Trovati errori critici di integritÃ  dati. Richiede correzione immediata.

### âš ï¸ Warnings
Problemi potenziali che potrebbero richiedere attenzione (es. vulnerabilitÃ  critiche non assegnate).

## Esempi di Problemi Rilevati

### Esempio 1: Foreign Key Invalida

```json
{
  "type": "asset",
  "vuln_id": "12345678-...",
  "reference_id": "99999999-...",
  "error": "Asset not found"
}
```

**Causa**: Una vulnerabilitÃ  referenzia un asset che non esiste piÃ¹.
**Soluzione**: Correggere la foreign key o rimuovere la referenza.

### Esempio 2: Conteggio VulnerabilitÃ  Non Corretto

```json
{
  "asset_id": "abcd1234-...",
  "asset_name": "web-server-01",
  "reported_count": 5,
  "actual_count": 3,
  "difference": -2
}
```

**Causa**: Il campo `vulnerability_count` sull'asset non Ã¨ sincronizzato.
**Soluzione**: Aggiornare il conteggio o implementare trigger/stored procedure per mantenere la sincronizzazione.

### Esempio 3: IP Address Mismatch

```json
{
  "vuln_id": "xyz789-...",
  "vuln_ip": "192.168.1.100",
  "asset_name": "server-db-01",
  "asset_ip": "192.168.1.101"
}
```

**Causa**: L'IP della vulnerabilitÃ  non corrisponde all'IP dell'asset associato.
**Soluzione**: Verificare quale IP sia corretto e aggiornare di conseguenza.

## Aggiungere Nuovi Test

### 1. Aggiungi un nuovo test file

```typescript
// src/__tests__/myNewValidation.test.ts
describe('My New Validation', () => {
  it('should validate something', async () => {
    // Your test logic
  });
});
```

### 2. Oppure estendi il validation runner

```typescript
// In runDataValidation.ts
private async validateMyNewCheck(): Promise<void> {
  console.log('ğŸ” Validating My New Check...');

  // Your validation logic

  this.results.push({
    category: 'My Category',
    test: 'My Test',
    passed: true/false,
    errors: [],
    warnings: [],
    info: 'Test description',
  });
}
```

## Best Practices

1. **Esegui i test regolarmente** - Non solo quando sospetti problemi
2. **Monitora i warning** - Possono indicare problemi futuri
3. **Tieni traccia delle metriche** - Numero di test passati/falliti nel tempo
4. **Automatizza** - Integra nella CI/CD pipeline
5. **Documenta i fix** - Quando risolvi un problema, documenta la causa root

## Troubleshooting

### "Cannot find module '@/api/...'"

Assicurati di avere le dipendenze installate:

```bash
npm install
```

### "Network Error"

Verifica che il backend sia in esecuzione:

```bash
# Terminal 1 - Backend
cd vulnerability-manager
cargo run

# Terminal 2 - Tests
cd vulnerability-manager-frontend
npm test
```

### "Tests timeout"

Aumenta il timeout in Jest config:

```javascript
// jest.config.js
module.exports = {
  testTimeout: 30000, // 30 seconds
};
```

## Contatti

Per domande o suggerimenti sui test, contatta il team di sviluppo.
