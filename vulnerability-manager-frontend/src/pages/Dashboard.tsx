// src/pages/Dashboard.tsx
import React, { useState, useEffect } from 'react';
import {
  Box,
  Grid,
  Card,
  CardContent,
  Typography,
  LinearProgress,
  Avatar,
  useTheme,
  alpha,
  IconButton,
} from '@mui/material';
import {
  BugReport as BugReportIcon,
  Computer as ComputerIcon,
  Error as ErrorIcon,
  MoreVert as MoreVertIcon,
  ArrowUpward as ArrowUpwardIcon,
  ArrowDownward as ArrowDownwardIcon,
  Security as SecurityIcon,
  Assignment as AssignmentIcon,
} from '@mui/icons-material';
import { motion } from 'framer-motion';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend,
  ArcElement,
  Filler,
} from 'chart.js';
import { Line, Doughnut, Bar } from 'react-chartjs-2';
import { useAuth } from '../contexts/AuthContext';
import api from '../services/api';

// Registra i componenti di Chart.js
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend,
  ArcElement,
  Filler
);

// Componente animato per le card
const AnimatedCard = motion(Card);

// Interfacce per i dati
interface TrendData {
  date: string;
  count: number;
}

interface SeverityDistribution {
  critical: number;
  high: number;
  medium: number;
  low: number;
}

interface AssetVulnerabilityCount {
  asset_name: string;
  asset_type: string;
  vulnerability_count: number;
}

interface DashboardStats {
  total_vulnerabilities: number;
  critical_vulnerabilities: number;
  high_vulnerabilities: number;
  medium_vulnerabilities: number;
  low_vulnerabilities: number;
  resolved_vulnerabilities: number;
  total_assets: number;
  total_teams: number;
  total_users: number;
  recent_scans: number;
  vulnerability_trend: TrendData[];
  severity_distribution: SeverityDistribution;
  top_vulnerable_assets: AssetVulnerabilityCount[];
}

interface AuditLog {
  id: string;
  user_id: string;
  action: string;
  entity_type: string;
  entity_id: string;
  created_at: string;
  username?: string;
}

interface RecentActivity {
  id: string;
  type: 'scan' | 'vulnerability' | 'report' | 'user' | 'other';
  title: string;
  description: string;
  timestamp: string;
  severity?: 'critical' | 'high' | 'medium' | 'low';
}

export default function Dashboard() {
  const theme = useTheme();
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState<DashboardStats>({
    total_vulnerabilities: 0,
    critical_vulnerabilities: 0,
    high_vulnerabilities: 0,
    medium_vulnerabilities: 0,
    low_vulnerabilities: 0,
    resolved_vulnerabilities: 0,
    total_assets: 0,
    total_teams: 0,
    total_users: 0,
    recent_scans: 0,
    vulnerability_trend: [],
    severity_distribution: { critical: 0, high: 0, medium: 0, low: 0 },
    top_vulnerable_assets: [],
  });
  const [recentActivities, setRecentActivities] = useState<RecentActivity[]>([]);
  const [weeklyScans, setWeeklyScans] = useState<number[]>([0, 0, 0, 0, 0, 0, 0]);

  useEffect(() => {
    const fetchDashboardData = async () => {
      try {
        setLoading(true);

        // Fetch dashboard stats
        const statsResponse = await api.get('/api/dashboard/stats');
        setStats(statsResponse.data);

        // Fetch recent audit logs for activities
        try {
          const auditResponse = await api.get('/api/audit/logs?limit=5');
          const logs: AuditLog[] = auditResponse.data;

          const activities: RecentActivity[] = logs.map((log) => {
            let type: RecentActivity['type'] = 'other';
            let title = log.action;

            if (log.entity_type === 'vulnerability' || log.action.includes('vulnerability')) {
              type = 'vulnerability';
              title = log.action === 'create' ? 'Nuova vulnerabilità' :
                      log.action === 'update' ? 'Vulnerabilità aggiornata' :
                      log.action === 'delete' ? 'Vulnerabilità eliminata' : log.action;
            } else if (log.entity_type === 'scan' || log.action.includes('scan')) {
              type = 'scan';
              title = 'Scansione eseguita';
            } else if (log.entity_type === 'report' || log.action.includes('report')) {
              type = 'report';
              title = 'Report generato';
            } else if (log.entity_type === 'user') {
              type = 'user';
              title = log.action === 'login' ? 'Accesso utente' : 'Azione utente';
            }

            return {
              id: log.id,
              type,
              title,
              description: `${log.entity_type} - ${log.action}`,
              timestamp: formatTimeAgo(log.created_at),
            };
          });

          setRecentActivities(activities);
        } catch {
          // If audit logs fail, use empty array
          setRecentActivities([]);
        }

        // Calculate weekly scans from vulnerability_trend
        calculateWeeklyScans(statsResponse.data.vulnerability_trend);

      } catch (error) {
        console.error('Error fetching dashboard stats:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchDashboardData();
  }, []);

  // Helper function to format time ago
  const formatTimeAgo = (dateString: string): string => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 60) return `${diffMins} minuti fa`;
    if (diffHours < 24) return `${diffHours} ore fa`;
    if (diffDays < 7) return `${diffDays} giorni fa`;
    return date.toLocaleDateString('it-IT');
  };

  // Calculate weekly scans from trend data
  const calculateWeeklyScans = (trend: TrendData[]) => {
    const days = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
    const weekData = [0, 0, 0, 0, 0, 0, 0];

    const now = new Date();
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

    trend.forEach((item) => {
      const itemDate = new Date(item.date);
      if (itemDate >= weekAgo) {
        const dayIndex = itemDate.getDay();
        weekData[dayIndex] += item.count;
      }
    });

    // Reorder to start from Monday
    const reordered = [...weekData.slice(1), weekData[0]];
    setWeeklyScans(reordered);
  };

  // Calculate percentage change (comparing last 7 days to previous 7 days)
  const calculateChange = (trend: TrendData[], currentValue: number): number => {
    if (trend.length < 14) return 0;

    const last7Days = trend.slice(0, 7).reduce((sum, t) => sum + t.count, 0);
    const prev7Days = trend.slice(7, 14).reduce((sum, t) => sum + t.count, 0);

    if (prev7Days === 0) return last7Days > 0 ? 100 : 0;
    return Math.round(((last7Days - prev7Days) / prev7Days) * 100 * 10) / 10;
  };

  // Prepare trend chart data from API
  const prepareTrendChartData = () => {
    const labels: string[] = [];
    const criticalData: number[] = [];
    const resolvedData: number[] = [];

    // Get last 6 months of data grouped by month
    const monthlyData: { [key: string]: { critical: number; resolved: number } } = {};
    const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];

    stats.vulnerability_trend.forEach((item) => {
      const date = new Date(item.date);
      const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
      const monthLabel = months[date.getMonth()];

      if (!monthlyData[monthKey]) {
        monthlyData[monthKey] = { critical: 0, resolved: 0 };
      }
      monthlyData[monthKey].critical += item.count;
    });

    // Get last 6 months
    const sortedKeys = Object.keys(monthlyData).sort().slice(-6);
    sortedKeys.forEach((key) => {
      const [year, month] = key.split('-');
      labels.push(months[parseInt(month)]);
      criticalData.push(monthlyData[key].critical);
      // Estimate resolved as a percentage of total (this would need a separate API call for accurate data)
      resolvedData.push(Math.floor(monthlyData[key].critical * 0.7));
    });

    // If no data, show empty chart with month labels
    if (labels.length === 0) {
      const now = new Date();
      for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        labels.push(months[d.getMonth()]);
        criticalData.push(0);
        resolvedData.push(0);
      }
    }

    return { labels, criticalData, resolvedData };
  };

  const { labels: trendLabels, criticalData, resolvedData } = prepareTrendChartData();

  // Dati per il grafico a torta delle vulnerabilità
  const vulnerabilityChartData = {
    labels: ['Critiche', 'Alte', 'Medie', 'Basse'],
    datasets: [
      {
        data: [
          stats.critical_vulnerabilities,
          stats.high_vulnerabilities,
          stats.medium_vulnerabilities,
          stats.low_vulnerabilities,
        ],
        backgroundColor: [
          '#FF6B6B',
          '#FFA94D',
          '#4ECDC4',
          '#95E1D3',
        ],
        borderWidth: 0,
        spacing: 2,
      },
    ],
  };

  // Dati per il grafico delle tendenze (da API)
  const trendChartData = {
    labels: trendLabels,
    datasets: [
      {
        label: 'Nuove Vulnerabilità',
        data: criticalData,
        borderColor: '#FF6B6B',
        backgroundColor: alpha('#FF6B6B', 0.1),
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#FF6B6B',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
      },
      {
        label: 'Vulnerabilità Risolte',
        data: resolvedData,
        borderColor: '#4ECDC4',
        backgroundColor: alpha('#4ECDC4', 0.1),
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#4ECDC4',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
      },
    ],
  };

  // Dati per il grafico a barre (da API)
  const barChartData = {
    labels: ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'],
    datasets: [
      {
        label: 'Vulnerabilità Rilevate',
        data: weeklyScans,
        backgroundColor: alpha('#3B82F6', 0.8),
        borderRadius: 8,
        maxBarThickness: 40,
      },
    ],
  };

  // Card delle statistiche moderne
  interface MetricCardProps {
    title: string;
    value: string | number;
    change: number;
    icon: React.ReactNode;
    gradient: string;
  }

  const MetricCard: React.FC<MetricCardProps> = ({ title, value, change, icon, gradient }) => (
    <AnimatedCard
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      sx={{
        height: '100%',
        background: gradient,
        color: 'white',
        position: 'relative',
        overflow: 'hidden',
        border: 'none',
        boxShadow: theme.shadows[10],
      }}
    >
      <CardContent sx={{ position: 'relative', zIndex: 1 }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 2 }}>
          <Box
            sx={{
              width: 48,
              height: 48,
              borderRadius: '12px',
              backgroundColor: alpha('#FFFFFF', 0.2),
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
            }}
          >
            {icon}
          </Box>
          <IconButton size="small" sx={{ color: 'white', opacity: 0.7 }}>
            <MoreVertIcon fontSize="small" />
          </IconButton>
        </Box>

        <Typography variant="h3" sx={{ fontWeight: 700, mb: 1 }}>
          {value}
        </Typography>

        <Typography variant="body2" sx={{ opacity: 0.9, mb: 1 }}>
          {title}
        </Typography>

        {change !== 0 && (
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
            {change > 0 ? (
              <ArrowUpwardIcon sx={{ fontSize: 16 }} />
            ) : (
              <ArrowDownwardIcon sx={{ fontSize: 16 }} />
            )}
            <Typography variant="caption" sx={{ fontWeight: 600 }}>
              {Math.abs(change)}%
            </Typography>
            <Typography variant="caption" sx={{ opacity: 0.7 }}>
              vs ultima settimana
            </Typography>
          </Box>
        )}
      </CardContent>

      {/* Decorative background element */}
      <Box
        sx={{
          position: 'absolute',
          top: -50,
          right: -50,
          width: 150,
          height: 150,
          borderRadius: '50%',
          backgroundColor: alpha('#FFFFFF', 0.1),
        }}
      />
    </AnimatedCard>
  );

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', mt: 4 }}>
        <LinearProgress sx={{ width: '50%' }} />
      </Box>
    );
  }

  const vulnChange = calculateChange(stats.vulnerability_trend, stats.total_vulnerabilities);

  return (
    <Box sx={{ backgroundColor: theme.palette.background.default, minHeight: '100vh', p: 3 }}>
      {/* Header con statistiche */}
      <Box sx={{ mb: 4 }}>
        <Typography variant="h4" sx={{ fontWeight: 700, mb: 1 }}>
          Dashboard Overview
        </Typography>
        <Typography variant="body1" color="text.secondary">
          Benvenuto, {user?.username}. Ecco un riepilogo della situazione attuale.
        </Typography>
      </Box>

      {/* Metriche principali */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        <Grid item xs={12} sm={6} md={3}>
          <MetricCard
            title="Vulnerabilità Totali"
            value={stats.total_vulnerabilities}
            change={vulnChange}
            icon={<BugReportIcon sx={{ fontSize: 24 }} />}
            gradient="linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <MetricCard
            title="Vulnerabilità Critiche"
            value={stats.critical_vulnerabilities}
            change={0}
            icon={<ErrorIcon sx={{ fontSize: 24 }} />}
            gradient="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <MetricCard
            title="Asset Monitorati"
            value={stats.total_assets}
            change={0}
            icon={<ComputerIcon sx={{ fontSize: 24 }} />}
            gradient="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <MetricCard
            title="Scansioni Recenti"
            value={stats.recent_scans}
            change={0}
            icon={<SecurityIcon sx={{ fontSize: 24 }} />}
            gradient="linear-gradient(135deg, #fa709a 0%, #fee140 100%)"
          />
        </Grid>
      </Grid>

      {/* Grafici */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        {/* Grafico trend */}
        <Grid item xs={12} md={8}>
          <Card
            sx={{
              height: '100%',
              boxShadow: theme.shadows[2],
              border: 'none',
              borderRadius: 2,
              overflow: 'hidden',
            }}
          >
            <Box
              sx={{
                px: 3,
                py: 2,
                backgroundColor: theme.palette.mode === 'dark'
                  ? alpha(theme.palette.background.paper, 0.6)
                  : alpha(theme.palette.primary.main, 0.05),
                borderBottom: `1px solid ${theme.palette.divider}`,
              }}
            >
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <Box>
                  <Typography variant="h6" sx={{ fontWeight: 600 }}>
                    Trend Vulnerabilità
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Andamento mensile delle vulnerabilità
                  </Typography>
                </Box>
                <IconButton size="small">
                  <MoreVertIcon />
                </IconButton>
              </Box>
            </Box>
            <CardContent sx={{ p: 3 }}>
              <Box sx={{ height: 300 }}>
                <Line
                  data={trendChartData}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'top' as const,
                        labels: {
                          usePointStyle: true,
                          padding: 20,
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                        },
                      },
                      tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                          size: 14,
                          family: 'Inter',
                        },
                        bodyFont: {
                          size: 13,
                          family: 'Inter',
                        },
                      },
                    },
                    scales: {
                      x: {
                        grid: {
                          display: true,
                          color: theme.palette.mode === 'dark'
                            ? 'rgba(255, 255, 255, 0.1)'
                            : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                          color: theme.palette.text.secondary,
                        },
                      },
                      y: {
                        grid: {
                          display: true,
                          color: theme.palette.mode === 'dark'
                            ? 'rgba(255, 255, 255, 0.1)'
                            : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                          color: theme.palette.text.secondary,
                        },
                      },
                    },
                  }}
                />
              </Box>
            </CardContent>
          </Card>
        </Grid>

        {/* Grafico distribuzione */}
        <Grid item xs={12} md={4}>
          <Card
            sx={{
              height: '100%',
              boxShadow: theme.shadows[2],
              border: 'none',
              borderRadius: 2,
              overflow: 'hidden',
            }}
          >
            <Box
              sx={{
                px: 3,
                py: 2,
                backgroundColor: theme.palette.mode === 'dark'
                  ? alpha(theme.palette.background.paper, 0.6)
                  : alpha(theme.palette.info.main, 0.05),
                borderBottom: `1px solid ${theme.palette.divider}`,
              }}
            >
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <Box>
                  <Typography variant="h6" sx={{ fontWeight: 600 }}>
                    Distribuzione Severità
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Per livello di rischio
                  </Typography>
                </Box>
                <IconButton size="small">
                  <MoreVertIcon />
                </IconButton>
              </Box>
            </Box>
            <CardContent sx={{ p: 3 }}>
              <Box sx={{ height: 200, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <Doughnut
                  data={vulnerabilityChartData}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: 'bottom' as const,
                        labels: {
                          padding: 20,
                          usePointStyle: true,
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                        },
                      },
                      tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                          size: 14,
                          family: 'Inter',
                        },
                        bodyFont: {
                          size: 13,
                          family: 'Inter',
                        },
                      },
                    },
                    cutout: '70%',
                  }}
                />
              </Box>
              <Box sx={{ textAlign: 'center', mt: 2 }}>
                <Typography variant="h4" sx={{ fontWeight: 700 }}>
                  {stats.total_vulnerabilities}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Totale Vulnerabilità
                </Typography>
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* Sezione inferiore */}
      <Grid container spacing={3}>
        {/* Attività settimanale */}
        <Grid item xs={12} md={4}>
          <Card
            sx={{
              height: '100%',
              boxShadow: theme.shadows[2],
              border: 'none',
              borderRadius: 2,
              overflow: 'hidden',
            }}
          >
            <Box
              sx={{
                px: 3,
                py: 2,
                backgroundColor: theme.palette.mode === 'dark'
                  ? alpha(theme.palette.background.paper, 0.6)
                  : alpha(theme.palette.success.main, 0.05),
                borderBottom: `1px solid ${theme.palette.divider}`,
              }}
            >
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                Attività Settimanale
              </Typography>
            </Box>
            <CardContent sx={{ p: 3 }}>
              <Box sx={{ height: 200 }}>
                <Bar
                  data={barChartData}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: false,
                      },
                      tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                          size: 14,
                          family: 'Inter',
                        },
                        bodyFont: {
                          size: 13,
                          family: 'Inter',
                        },
                      },
                    },
                    scales: {
                      x: {
                        grid: {
                          display: true,
                          color: theme.palette.mode === 'dark'
                            ? 'rgba(255, 255, 255, 0.1)'
                            : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                          color: theme.palette.text.secondary,
                        },
                      },
                      y: {
                        grid: {
                          display: true,
                          color: theme.palette.mode === 'dark'
                            ? 'rgba(255, 255, 255, 0.1)'
                            : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                          color: theme.palette.text.secondary,
                        },
                      },
                    },
                  }}
                />
              </Box>
            </CardContent>
          </Card>
        </Grid>

        {/* Asset più vulnerabili (da API) */}
        <Grid item xs={12} md={4}>
          <Card sx={{ height: '100%', boxShadow: theme.shadows[4], border: 'none' }}>
            <CardContent>
              <Typography variant="h6" sx={{ fontWeight: 600, mb: 3 }}>
                Asset Critici
              </Typography>
              <Box sx={{ mt: 2 }}>
                {stats.top_vulnerable_assets.length > 0 ? (
                  stats.top_vulnerable_assets.slice(0, 4).map((asset, index) => {
                    const maxVulns = stats.top_vulnerable_assets[0]?.vulnerability_count || 1;
                    const percentage = Math.round((asset.vulnerability_count / maxVulns) * 100);
                    return (
                      <Box key={asset.asset_name} sx={{ mb: 3 }}>
                        <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                          <Typography variant="body2" sx={{ fontWeight: 500 }}>
                            {asset.asset_name}
                          </Typography>
                          <Typography variant="body2" color="text.secondary">
                            {asset.vulnerability_count} vuln.
                          </Typography>
                        </Box>
                        <LinearProgress
                          variant="determinate"
                          value={percentage}
                          sx={{
                            height: 8,
                            borderRadius: 4,
                            backgroundColor: alpha(theme.palette.primary.main, 0.1),
                            '& .MuiLinearProgress-bar': {
                              borderRadius: 4,
                              backgroundColor: index === 0 ? '#FF6B6B' : index === 1 ? '#FFA94D' : '#4ECDC4',
                            },
                          }}
                        />
                      </Box>
                    );
                  })
                ) : (
                  <Typography variant="body2" color="text.secondary" sx={{ textAlign: 'center', py: 4 }}>
                    Nessun asset con vulnerabilità
                  </Typography>
                )}
              </Box>
            </CardContent>
          </Card>
        </Grid>

        {/* Attività recenti (da API) */}
        <Grid item xs={12} md={4}>
          <Card sx={{ height: '100%', boxShadow: theme.shadows[4], border: 'none' }}>
            <CardContent>
              <Typography variant="h6" sx={{ fontWeight: 600, mb: 3 }}>
                Attività Recenti
              </Typography>
              <Box sx={{ mt: 2 }}>
                {recentActivities.length > 0 ? (
                  recentActivities.map((activity) => (
                    <Box
                      key={activity.id}
                      sx={{
                        p: 2,
                        mb: 2,
                        borderRadius: 2,
                        backgroundColor: alpha(theme.palette.primary.main, 0.05),
                        border: `1px solid ${alpha(theme.palette.primary.main, 0.1)}`,
                        transition: 'all 0.3s',
                        '&:hover': {
                          backgroundColor: alpha(theme.palette.primary.main, 0.08),
                          transform: 'translateY(-2px)',
                        },
                      }}
                    >
                      <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>
                        <Avatar
                          sx={{
                            width: 32,
                            height: 32,
                            backgroundColor:
                              activity.type === 'scan' ? alpha('#3B82F6', 0.1) :
                              activity.type === 'vulnerability' ? alpha('#EF4444', 0.1) :
                              alpha('#10B981', 0.1),
                            color:
                              activity.type === 'scan' ? '#3B82F6' :
                              activity.type === 'vulnerability' ? '#EF4444' :
                              '#10B981',
                            mr: 1.5,
                          }}
                        >
                          {activity.type === 'scan' ? <SecurityIcon sx={{ fontSize: 18 }} /> :
                           activity.type === 'vulnerability' ? <BugReportIcon sx={{ fontSize: 18 }} /> :
                           <AssignmentIcon sx={{ fontSize: 18 }} />}
                        </Avatar>
                        <Box sx={{ flex: 1 }}>
                          <Typography variant="body2" sx={{ fontWeight: 600 }}>
                            {activity.title}
                          </Typography>
                          <Typography variant="caption" color="text.secondary">
                            {activity.timestamp}
                          </Typography>
                        </Box>
                      </Box>
                      <Typography variant="caption" color="text.secondary">
                        {activity.description}
                      </Typography>
                    </Box>
                  ))
                ) : (
                  <Typography variant="body2" color="text.secondary" sx={{ textAlign: 'center', py: 4 }}>
                    Nessuna attività recente
                  </Typography>
                )}
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>
    </Box>
  );
}
