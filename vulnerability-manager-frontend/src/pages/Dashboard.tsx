// src/pages/Dashboard.tsx
import React, { useState, useEffect } from 'react';
import {
  Box,
  Grid,
  Card,
  CardContent,
  Typography,
  LinearProgress,
  Chip,
  Avatar,
  useTheme,
  alpha,
  Paper,
  IconButton,
  Button,
  Stack,
} from '@mui/material';
import {
  BugReport as BugReportIcon,
  Computer as ComputerIcon,
  Group as GroupIcon,
  CheckCircle as CheckCircleIcon,
  Warning as WarningIcon,
  Error as ErrorIcon,
  TrendingUp as TrendingUpIcon,
  TrendingDown as TrendingDownIcon,
  MoreVert as MoreVertIcon,
  ArrowUpward as ArrowUpwardIcon,
  ArrowDownward as ArrowDownwardIcon,
  Security as SecurityIcon,
  Assignment as AssignmentIcon,
  Schedule as ScheduleIcon,
  Refresh as RefreshIcon,
} from '@mui/icons-material';
import { motion } from 'framer-motion';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend,
  ArcElement,
  Filler,
} from 'chart.js';
import { Line, Doughnut, Bar } from 'react-chartjs-2';
import { useAuth } from '../contexts/AuthContext';
<<<<<<< HEAD
import dashboardApi, { DashboardStats as ApiDashboardStats, RecentActivity as ApiRecentActivity } from '../api/dashboard';
=======
import api from '../services/api';
>>>>>>> 54070529ca4023dda12368a2460afbc4608bd835

// Registra i componenti di Chart.js
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Title,
  Tooltip,
  Legend,
  ArcElement,
  Filler
);

// Componente animato per le card
const AnimatedCard = motion(Card);

// Interfacce per i dati
interface TrendData {
  date: string;
  count: number;
}

interface SeverityDistribution {
  critical: number;
  high: number;
  medium: number;
  low: number;
}

interface AssetVulnerabilityCount {
  asset_name: string;
  asset_type: string;
  vulnerability_count: number;
}

interface DashboardStats {
  total_vulnerabilities: number;
  critical_vulnerabilities: number;
  high_vulnerabilities: number;
  medium_vulnerabilities: number;
  low_vulnerabilities: number;
  resolved_vulnerabilities: number;
  total_assets: number;
  total_teams: number;
  total_users: number;
  recent_scans: number;
  vulnerability_trend: TrendData[];
  severity_distribution: SeverityDistribution;
  top_vulnerable_assets: AssetVulnerabilityCount[];
}

interface RecentActivity {
  id: number;
  type: 'scan' | 'vulnerability' | 'report';
  title: string;
  description: string;
  timestamp: string;
  severity?: 'critical' | 'high' | 'medium' | 'low';
}

export default function Dashboard() {
  const theme = useTheme();
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [stats, setStats] = useState<DashboardStats>({
    total_vulnerabilities: 0,
    critical_vulnerabilities: 0,
    high_vulnerabilities: 0,
    medium_vulnerabilities: 0,
    low_vulnerabilities: 0,
    resolved_vulnerabilities: 0,
    total_assets: 0,
    total_teams: 0,
    total_users: 0,
    recent_scans: 0,
    vulnerability_trend: [],
    severity_distribution: { critical: 0, high: 0, medium: 0, low: 0 },
    top_vulnerable_assets: [],
  });

  const [recentActivities, setRecentActivities] = useState<RecentActivity[]>([]);
  const [monthlyTrends, setMonthlyTrends] = useState<any[]>([]);

  useEffect(() => {
<<<<<<< HEAD
    fetchDashboardData();
=======
    const fetchDashboardStats = async () => {
      try {
        setLoading(true);
        const response = await api.get('/dashboard/stats');
        setStats(response.data);
      } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        // Keep default values on error
      } finally {
        setLoading(false);
      }
    };

    fetchDashboardStats();
>>>>>>> 54070529ca4023dda12368a2460afbc4608bd835
  }, []);

  const fetchDashboardData = async () => {
    try {
      setLoading(true);
      setError(null);
      const data = await dashboardApi.getStatistics();

      // Map API data to component state
      setStats({
        totalVulnerabilities: data.total_vulnerabilities,
        criticalVulnerabilities: data.critical_vulnerabilities,
        highVulnerabilities: data.high_vulnerabilities,
        mediumVulnerabilities: data.medium_vulnerabilities,
        lowVulnerabilities: data.low_vulnerabilities,
        totalHosts: data.total_hosts,
        vulnerableHosts: data.total_hosts, // Can be calculated from critical_hosts
        totalTeams: data.total_teams,
        recentScans: data.recent_scans,
      });

      // Map recent activities
      setRecentActivities(
        data.recent_activities.map(activity => ({
          id: activity.id,
          type: activity.activity_type as 'scan' | 'vulnerability' | 'report',
          title: activity.title,
          description: activity.description,
          timestamp: new Date(activity.timestamp).toLocaleString('it-IT'),
          severity: activity.severity as 'critical' | 'high' | 'medium' | 'low' | undefined,
        }))
      );

      // Store monthly trends for charts
      setMonthlyTrends(data.monthly_trends);

      setLoading(false);
    } catch (err: any) {
      console.error('Failed to fetch dashboard data:', err);
      setError(err.message || 'Errore nel caricamento dei dati');
      setLoading(false);
    }
  };

  // Dati per il grafico a torta delle vulnerabilità
  const vulnerabilityChartData = {
    labels: ['Critiche', 'Alte', 'Medie', 'Basse'],
    datasets: [
      {
        data: [
          stats.critical_vulnerabilities,
          stats.high_vulnerabilities,
          stats.medium_vulnerabilities,
          stats.low_vulnerabilities,
        ],
        backgroundColor: [
          '#FF6B6B',
          '#FFA94D',
          '#4ECDC4',
          '#95E1D3',
        ],
        borderWidth: 0,
        spacing: 2,
      },
    ],
  };

  // Dati per il grafico delle tendenze (ultimi 6 mesi)
  const trendChartData = {
    labels: monthlyTrends.map(m => m.month),
    datasets: [
      {
        label: 'Vulnerabilità Critiche',
        data: monthlyTrends.map(m => m.critical),
        borderColor: '#FF6B6B',
        backgroundColor: alpha('#FF6B6B', 0.1),
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#FF6B6B',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
      },
      {
        label: 'Vulnerabilità Totali',
        data: monthlyTrends.map(m => m.total),
        borderColor: '#4ECDC4',
        backgroundColor: alpha('#4ECDC4', 0.1),
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#4ECDC4',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8,
      },
    ],
  };

  // Dati per il grafico a barre
  const barChartData = {
    labels: ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'],
    datasets: [
      {
        label: 'Scansioni',
        data: [12, 19, 3, 5, 2, 3, 8],
        backgroundColor: alpha('#3B82F6', 0.8),
        borderRadius: 8,
        maxBarThickness: 40,
      },
    ],
  };

  // Card delle statistiche moderne
  interface MetricCardProps {
    title: string;
    value: string | number;
    change: number;
    icon: React.ReactNode;
    gradient: string;
  }

  const MetricCard: React.FC<MetricCardProps> = ({ title, value, change, icon, gradient }) => (
    <AnimatedCard
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      sx={{
        height: '100%',
        background: gradient,
        color: 'white',
        position: 'relative',
        overflow: 'hidden',
        border: 'none',
        boxShadow: theme.shadows[10],
      }}
    >
      <CardContent sx={{ position: 'relative', zIndex: 1 }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 2 }}>
          <Box
            sx={{
              width: 48,
              height: 48,
              borderRadius: '12px',
              backgroundColor: alpha('#FFFFFF', 0.2),
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
            }}
          >
            {icon}
          </Box>
          <IconButton size="small" sx={{ color: 'white', opacity: 0.7 }}>
            <MoreVertIcon fontSize="small" />
          </IconButton>
        </Box>
        
        <Typography variant="h3" sx={{ fontWeight: 700, mb: 1 }}>
          {value}
        </Typography>
        
        <Typography variant="body2" sx={{ opacity: 0.9, mb: 1 }}>
          {title}
        </Typography>
        
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
          {change > 0 ? (
            <ArrowUpwardIcon sx={{ fontSize: 16 }} />
          ) : (
            <ArrowDownwardIcon sx={{ fontSize: 16 }} />
          )}
          <Typography variant="caption" sx={{ fontWeight: 600 }}>
            {Math.abs(change)}%
          </Typography>
          <Typography variant="caption" sx={{ opacity: 0.7 }}>
            vs ultimo mese
          </Typography>
        </Box>
      </CardContent>
      
      {/* Decorative background element */}
      <Box
        sx={{
          position: 'absolute',
          top: -50,
          right: -50,
          width: 150,
          height: 150,
          borderRadius: '50%',
          backgroundColor: alpha('#FFFFFF', 0.1),
        }}
      />
    </AnimatedCard>
  );

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', mt: 4 }}>
        <LinearProgress sx={{ width: '50%' }} />
      </Box>
    );
  }

  return (
    <Box sx={{ backgroundColor: theme.palette.background.default, minHeight: '100vh', p: 3 }}>
      {/* Header con statistiche */}
      <Box sx={{ mb: 4, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <Box>
          <Typography variant="h4" sx={{ fontWeight: 700, mb: 1 }}>
            Dashboard Overview
          </Typography>
          <Typography variant="body1" color="text.secondary">
            Benvenuto, {user?.username}. Ecco un riepilogo della situazione attuale.
          </Typography>
        </Box>
        <Button
          variant="outlined"
          startIcon={<RefreshIcon />}
          onClick={fetchDashboardData}
          disabled={loading}
        >
          Aggiorna
        </Button>
      </Box>

      {/* Error message */}
      {error && (
        <Box sx={{ mb: 3 }}>
          <Paper sx={{ p: 2, bgcolor: 'error.main', color: 'white' }}>
            <Typography variant="body1">
              ⚠️ Errore: {error}
            </Typography>
          </Paper>
        </Box>
      )}

      {/* Metriche principali */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        <Grid item xs={12} sm={6} md={3}>
          <MetricCard
            title="Vulnerabilità Totali"
            value={stats.total_vulnerabilities}
            change={12.5}
            icon={<BugReportIcon sx={{ fontSize: 24 }} />}
            gradient="linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <MetricCard
            title="Vulnerabilità Critiche"
            value={stats.critical_vulnerabilities}
            change={-8.3}
            icon={<ErrorIcon sx={{ fontSize: 24 }} />}
            gradient="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <MetricCard
            title="Asset Monitorati"
            value={stats.total_assets}
            change={5.2}
            icon={<ComputerIcon sx={{ fontSize: 24 }} />}
            gradient="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <MetricCard
            title="Scansioni Recenti"
            value={stats.recent_scans}
            change={15.7}
            icon={<SecurityIcon sx={{ fontSize: 24 }} />}
            gradient="linear-gradient(135deg, #fa709a 0%, #fee140 100%)"
          />
        </Grid>
      </Grid>

      {/* Grafici */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        {/* Grafico trend */}
        <Grid item xs={12} md={8}>
          <Card 
            sx={{ 
              height: '100%', 
              boxShadow: theme.shadows[2], 
              border: 'none',
              borderRadius: 2,
              overflow: 'hidden',
            }}
          >
            <Box 
              sx={{ 
                px: 3, 
                py: 2, 
                backgroundColor: theme.palette.mode === 'dark' 
                  ? alpha(theme.palette.background.paper, 0.6)
                  : alpha(theme.palette.primary.main, 0.05),
                borderBottom: `1px solid ${theme.palette.divider}`,
              }}
            >
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <Box>
                  <Typography variant="h6" sx={{ fontWeight: 600 }}>
                    Trend Vulnerabilità
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Andamento mensile delle vulnerabilità
                  </Typography>
                </Box>
                <IconButton size="small">
                  <MoreVertIcon />
                </IconButton>
              </Box>
            </Box>
            <CardContent sx={{ p: 3 }}>
              <Box sx={{ height: 300 }}>
                <Line
                  data={trendChartData}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'top' as const,
                        labels: {
                          usePointStyle: true,
                          padding: 20,
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                        },
                      },
                      tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                          size: 14,
                          family: 'Inter',
                        },
                        bodyFont: {
                          size: 13,
                          family: 'Inter',
                        },
                      },
                    },
                    scales: {
                      x: {
                        grid: {
                          display: true,
                          color: theme.palette.mode === 'dark' 
                            ? 'rgba(255, 255, 255, 0.1)'
                            : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                          color: theme.palette.text.secondary,
                        },
                      },
                      y: {
                        grid: {
                          display: true,
                          color: theme.palette.mode === 'dark' 
                            ? 'rgba(255, 255, 255, 0.1)'
                            : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                          color: theme.palette.text.secondary,
                        },
                      },
                    },
                  }}
                />
              </Box>
            </CardContent>
          </Card>
        </Grid>

        {/* Grafico distribuzione */}
        <Grid item xs={12} md={4}>
          <Card 
            sx={{ 
              height: '100%', 
              boxShadow: theme.shadows[2], 
              border: 'none',
              borderRadius: 2,
              overflow: 'hidden',
            }}
          >
            <Box 
              sx={{ 
                px: 3, 
                py: 2, 
                backgroundColor: theme.palette.mode === 'dark' 
                  ? alpha(theme.palette.background.paper, 0.6)
                  : alpha(theme.palette.info.main, 0.05),
                borderBottom: `1px solid ${theme.palette.divider}`,
              }}
            >
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <Box>
                  <Typography variant="h6" sx={{ fontWeight: 600 }}>
                    Distribuzione Severità
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Per livello di rischio
                  </Typography>
                </Box>
                <IconButton size="small">
                  <MoreVertIcon />
                </IconButton>
              </Box>
            </Box>
            <CardContent sx={{ p: 3 }}>
              <Box sx={{ height: 200, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <Doughnut
                  data={vulnerabilityChartData}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: 'bottom' as const,
                        labels: {
                          padding: 20,
                          usePointStyle: true,
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                        },
                      },
                      tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                          size: 14,
                          family: 'Inter',
                        },
                        bodyFont: {
                          size: 13,
                          family: 'Inter',
                        },
                      },
                    },
                    cutout: '70%',
                  }}
                />
              </Box>
              <Box sx={{ textAlign: 'center', mt: 2 }}>
                <Typography variant="h4" sx={{ fontWeight: 700 }}>
                  {stats.total_vulnerabilities}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  Totale Vulnerabilità
                </Typography>
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* Sezione inferiore */}
      <Grid container spacing={3}>
        {/* Attività settimanale */}
        <Grid item xs={12} md={4}>
          <Card 
            sx={{ 
              height: '100%', 
              boxShadow: theme.shadows[2], 
              border: 'none',
              borderRadius: 2,
              overflow: 'hidden',
            }}
          >
            <Box 
              sx={{ 
                px: 3, 
                py: 2, 
                backgroundColor: theme.palette.mode === 'dark' 
                  ? alpha(theme.palette.background.paper, 0.6)
                  : alpha(theme.palette.success.main, 0.05),
                borderBottom: `1px solid ${theme.palette.divider}`,
              }}
            >
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                Attività Settimanale
              </Typography>
            </Box>
            <CardContent sx={{ p: 3 }}>
              <Box sx={{ height: 200 }}>
                <Bar
                  data={barChartData}
                  options={{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: false,
                      },
                      tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                          size: 14,
                          family: 'Inter',
                        },
                        bodyFont: {
                          size: 13,
                          family: 'Inter',
                        },
                      },
                    },
                    scales: {
                      x: {
                        grid: {
                          display: true,
                          color: theme.palette.mode === 'dark' 
                            ? 'rgba(255, 255, 255, 0.1)'
                            : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                          color: theme.palette.text.secondary,
                        },
                      },
                      y: {
                        grid: {
                          display: true,
                          color: theme.palette.mode === 'dark' 
                            ? 'rgba(255, 255, 255, 0.1)'
                            : 'rgba(0, 0, 0, 0.1)',
                        },
                        ticks: {
                          font: {
                            size: 12,
                            family: 'Inter',
                          },
                          color: theme.palette.text.secondary,
                        },
                      },
                    },
                  }}
                />
              </Box>
            </CardContent>
          </Card>
        </Grid>

        {/* Host più vulnerabili */}
        <Grid item xs={12} md={4}>
          <Card sx={{ height: '100%', boxShadow: theme.shadows[4], border: 'none' }}>
            <CardContent>
              <Typography variant="h6" sx={{ fontWeight: 600, mb: 3 }}>
                Host Critici
              </Typography>
              <Box sx={{ mt: 2 }}>
                {['web-server-01', 'db-server-02', 'app-server-03', 'mail-server-01'].map((host, index) => (
                  <Box key={host} sx={{ mb: 3 }}>
                    <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                      <Typography variant="body2" sx={{ fontWeight: 500 }}>
                        {host}
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        {[85, 72, 65, 58][index]}%
                      </Typography>
                    </Box>
                    <LinearProgress
                      variant="determinate"
                      value={[85, 72, 65, 58][index]}
                      sx={{
                        height: 8,
                        borderRadius: 4,
                        backgroundColor: alpha(theme.palette.primary.main, 0.1),
                        '& .MuiLinearProgress-bar': {
                          borderRadius: 4,
                          backgroundColor: index === 0 ? '#FF6B6B' : index === 1 ? '#FFA94D' : '#4ECDC4',
                        },
                      }}
                    />
                  </Box>
                ))}
              </Box>
            </CardContent>
          </Card>
        </Grid>

        {/* Attività recenti */}
        <Grid item xs={12} md={4}>
          <Card sx={{ height: '100%', boxShadow: theme.shadows[4], border: 'none' }}>
            <CardContent>
              <Typography variant="h6" sx={{ fontWeight: 600, mb: 3 }}>
                Attività Recenti
              </Typography>
              <Box sx={{ mt: 2 }}>
                {recentActivities.map((activity) => (
                  <Box
                    key={activity.id}
                    sx={{
                      p: 2,
                      mb: 2,
                      borderRadius: 2,
                      backgroundColor: alpha(theme.palette.primary.main, 0.05),
                      border: `1px solid ${alpha(theme.palette.primary.main, 0.1)}`,
                      transition: 'all 0.3s',
                      '&:hover': {
                        backgroundColor: alpha(theme.palette.primary.main, 0.08),
                        transform: 'translateY(-2px)',
                      },
                    }}
                  >
                    <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>
                      <Avatar
                        sx={{
                          width: 32,
                          height: 32,
                          backgroundColor: 
                            activity.type === 'scan' ? alpha('#3B82F6', 0.1) :
                            activity.type === 'vulnerability' ? alpha('#EF4444', 0.1) :
                            alpha('#10B981', 0.1),
                          color:
                            activity.type === 'scan' ? '#3B82F6' :
                            activity.type === 'vulnerability' ? '#EF4444' :
                            '#10B981',
                          mr: 1.5,
                        }}
                      >
                        {activity.type === 'scan' ? <SecurityIcon sx={{ fontSize: 18 }} /> :
                         activity.type === 'vulnerability' ? <BugReportIcon sx={{ fontSize: 18 }} /> :
                         <AssignmentIcon sx={{ fontSize: 18 }} />}
                      </Avatar>
                      <Box sx={{ flex: 1 }}>
                        <Typography variant="body2" sx={{ fontWeight: 600 }}>
                          {activity.title}
                        </Typography>
                        <Typography variant="caption" color="text.secondary">
                          {activity.timestamp}
                        </Typography>
                      </Box>
                    </Box>
                    <Typography variant="caption" color="text.secondary">
                      {activity.description}
                    </Typography>
                  </Box>
                ))}
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>
    </Box>
  );
}