// NetworkDashboard.tsx - Example Entuity-style dashboard page
// Demonstrates all dashlet types and network topology visualization

import React, { useState } from 'react';
import {
  Box,
  Container,
  Grid,
  Typography,
  Button,
  Stack,
  Paper,
} from '@mui/material';
import {
  Refresh as RefreshIcon,
  Dashboard as DashboardIcon,
} from '@mui/icons-material';
import NetworkTopology from '../components/NetworkTopology';
import DeviceDetailView from '../components/DeviceDetailView';
import KeyInfoDashlet from '../components/dashlets/KeyInfoDashlet';
import ChartDashlet from '../components/dashlets/ChartDashlet';
import TableDashlet from '../components/dashlets/TableDashlet';
import { NetworkDevice, NetworkTopology as NetworkTopologyType } from '../types/network';
import { entuityColors } from '../theme/entuityTheme';

// Mock data generator
const generateMockNetworkData = (): NetworkTopologyType => {
  const devices: NetworkDevice[] = [
    {
      id: '1',
      name: 'Core-Router-01',
      type: 'router',
      status: 'online',
      ipAddress: '192.168.1.1',
      macAddress: '00:1A:2B:3C:4D:5E',
      severity: 'none',
      incidentCount: 0,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Cisco',
      model: 'ASR 9000',
      osVersion: 'IOS XR 7.5.2',
      metrics: {
        cpuUsage: 45,
        memoryUsage: 62,
        diskUsage: 38,
        uptime: 2592000, // 30 days
        bandwidth: 10000,
      },
      location: {
        lat: 40.7128,
        lng: -74.0060,
        address: 'New York Data Center',
      },
      ports: [
        { id: 'p1', number: 1, name: 'GigabitEthernet0/0/0', type: 'Ethernet', status: 'up', speed: 1000, duplex: 'full' },
        { id: 'p2', number: 2, name: 'GigabitEthernet0/0/1', type: 'Ethernet', status: 'up', speed: 1000, duplex: 'full' },
        { id: 'p3', number: 3, name: 'GigabitEthernet0/0/2', type: 'Ethernet', status: 'down', speed: 1000, duplex: 'full' },
      ],
    },
    {
      id: '2',
      name: 'Switch-Floor-2',
      type: 'switch',
      status: 'online',
      ipAddress: '192.168.2.10',
      macAddress: '00:1A:2B:3C:4D:6F',
      severity: 'medium',
      incidentCount: 2,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Juniper',
      model: 'EX4300',
      osVersion: 'Junos 20.4R3',
      metrics: {
        cpuUsage: 78,
        memoryUsage: 85,
        diskUsage: 42,
        uptime: 1728000, // 20 days
        bandwidth: 1000,
      },
      ports: [
        { id: 'p4', number: 1, name: 'ge-0/0/0', type: 'Ethernet', status: 'up', speed: 1000, duplex: 'full' },
        { id: 'p5', number: 2, name: 'ge-0/0/1', type: 'Ethernet', status: 'up', speed: 1000, duplex: 'full' },
      ],
    },
    {
      id: '3',
      name: 'FW-DMZ-01',
      type: 'firewall',
      status: 'warning',
      ipAddress: '192.168.1.254',
      macAddress: '00:1A:2B:3C:4D:7F',
      severity: 'high',
      incidentCount: 5,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Palo Alto',
      model: 'PA-5220',
      osVersion: 'PAN-OS 10.2',
      metrics: {
        cpuUsage: 92,
        memoryUsage: 88,
        diskUsage: 65,
        uptime: 864000, // 10 days
        bandwidth: 10000,
      },
      ports: [],
    },
    {
      id: '4',
      name: 'Server-DB-Primary',
      type: 'server',
      status: 'online',
      ipAddress: '10.0.10.50',
      severity: 'none',
      incidentCount: 0,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Dell',
      model: 'PowerEdge R750',
      osVersion: 'Ubuntu 22.04 LTS',
      metrics: {
        cpuUsage: 55,
        memoryUsage: 72,
        diskUsage: 68,
        uptime: 5184000, // 60 days
        bandwidth: 10000,
      },
      ports: [],
    },
    {
      id: '5',
      name: 'WAP-Floor-1-A',
      type: 'wireless',
      status: 'online',
      ipAddress: '192.168.3.20',
      severity: 'low',
      incidentCount: 1,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Ubiquiti',
      model: 'UniFi AP AC Pro',
      osVersion: '5.43.35',
      metrics: {
        cpuUsage: 25,
        memoryUsage: 48,
        bandwidth: 1000,
      },
      ports: [],
    },
    {
      id: '6',
      name: 'Printer-Office',
      type: 'endpoint',
      status: 'offline',
      ipAddress: '192.168.4.100',
      severity: 'critical',
      incidentCount: 3,
      lastSeen: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
      manufacturer: 'HP',
      model: 'LaserJet Pro M404',
      metrics: {},
      ports: [],
    },
  ];

  const links = [
    { id: 'l1', source: '1', target: '2', status: 'active' as const, utilization: 45, bandwidth: 1000, type: 'wired' as const },
    { id: 'l2', source: '1', target: '3', status: 'active' as const, utilization: 87, bandwidth: 10000, type: 'wired' as const },
    { id: 'l3', source: '2', target: '4', status: 'active' as const, utilization: 62, bandwidth: 1000, type: 'wired' as const },
    { id: 'l4', source: '2', target: '5', status: 'active' as const, utilization: 32, bandwidth: 1000, type: 'wireless' as const },
    { id: 'l5', source: '2', target: '6', status: 'inactive' as const, utilization: 0, bandwidth: 100, type: 'wired' as const },
  ];

  return {
    devices,
    links,
    lastUpdated: new Date().toISOString(),
  };
};

const NetworkDashboard: React.FC = () => {
  const [networkData] = useState(generateMockNetworkData());
  const [selectedDevice, setSelectedDevice] = useState<NetworkDevice | null>(null);

  const handleRefresh = () => {
    console.log('Refreshing dashboard...');
    // In production, this would fetch fresh data from API
  };

  // Calculate network statistics
  const totalDevices = networkData.devices.length;
  const onlineDevices = networkData.devices.filter(d => d.status === 'online').length;
  const criticalIncidents = networkData.devices.reduce((sum, d) =>
    d.severity === 'critical' ? sum + d.incidentCount : sum, 0
  );
  const avgCpuUsage = Math.round(
    networkData.devices.reduce((sum, d) => sum + (d.metrics?.cpuUsage || 0), 0) / totalDevices
  );

  // Chart data for network bandwidth
  const generateChartData = () => {
    const data = [];
    const now = Date.now();
    for (let i = 24; i >= 0; i--) {
      data.push({
        timestamp: new Date(now - i * 60 * 60 * 1000).toISOString(),
        value: Math.random() * 8000 + 1000,
      });
    }
    return data;
  };

  // Top incidents table
  const incidentColumns = [
    { id: 'device', label: 'Device' },
    { id: 'severity', label: 'Severity' },
    { id: 'count', label: 'Count', numeric: true },
    { id: 'lastSeen', label: 'Last Seen' },
  ];

  const incidentRows = networkData.devices
    .filter(d => d.incidentCount > 0)
    .map(d => ({
      id: d.id,
      device: d.name,
      severity: d.severity,
      count: d.incidentCount,
      lastSeen: new Date(d.lastSeen).toLocaleString(),
    }));

  if (selectedDevice) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <Button
          startIcon={<DashboardIcon />}
          onClick={() => setSelectedDevice(null)}
          sx={{ mb: 2 }}
        >
          Back to Dashboard
        </Button>
        <DeviceDetailView device={selectedDevice} onRefresh={handleRefresh} />
      </Container>
    );
  }

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Header */}
      <Stack direction="row" justifyContent="space-between" alignItems="center" mb={3}>
        <Box>
          <Typography variant="h4" gutterBottom sx={{ fontWeight: 600 }}>
            Network Monitoring Dashboard
          </Typography>
          <Typography variant="body2" color="text.secondary">
            Real-time network topology and performance monitoring
          </Typography>
        </Box>
        <Button
          variant="contained"
          startIcon={<RefreshIcon />}
          onClick={handleRefresh}
        >
          Refresh All
        </Button>
      </Stack>

      {/* Network Overview Cards */}
      <Grid container spacing={3} mb={3}>
        <Grid item xs={12} sm={6} md={3}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h3" sx={{ color: entuityColors.primary.main, fontWeight: 700 }}>
              {totalDevices}
            </Typography>
            <Typography variant="body2" color="text.secondary">
              Total Devices
            </Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h3" sx={{ color: entuityColors.success, fontWeight: 700 }}>
              {onlineDevices}
            </Typography>
            <Typography variant="body2" color="text.secondary">
              Online Devices
            </Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h3" sx={{ color: entuityColors.critical, fontWeight: 700 }}>
              {criticalIncidents}
            </Typography>
            <Typography variant="body2" color="text.secondary">
              Critical Incidents
            </Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h3" sx={{ color: entuityColors.info, fontWeight: 700 }}>
              {avgCpuUsage}%
            </Typography>
            <Typography variant="body2" color="text.secondary">
              Avg CPU Usage
            </Typography>
          </Paper>
        </Grid>
      </Grid>

      {/* Main Dashboard Grid */}
      <Grid container spacing={3}>
        {/* Network Topology - Full width */}
        <Grid item xs={12}>
          <NetworkTopology
            data={networkData}
            onDeviceClick={setSelectedDevice}
            onRefresh={handleRefresh}
            height={600}
          />
        </Grid>

        {/* Key Info Dashlet - Network Status */}
        <Grid item xs={12} md={6}>
          <KeyInfoDashlet
            title="Network Health Status"
            status={criticalIncidents > 0 ? 'warning' : 'online'}
            severity={criticalIncidents > 5 ? 'critical' : criticalIncidents > 0 ? 'high' : 'none'}
            primaryInfo={[
              { label: 'Total Devices', value: totalDevices },
              { label: 'Online', value: onlineDevices, severity: 'none' },
              { label: 'Offline', value: totalDevices - onlineDevices, severity: totalDevices - onlineDevices > 0 ? 'critical' : 'none' },
              { label: 'Avg CPU', value: avgCpuUsage, unit: '%', severity: avgCpuUsage > 80 ? 'high' : 'none' },
            ]}
            secondaryInfo={[
              { label: 'Total Bandwidth', value: '50', unit: 'Gbps' },
              { label: 'Active Links', value: networkData.links.filter(l => l.status === 'active').length },
              { label: 'Total Ports', value: networkData.devices.reduce((sum, d) => sum + (d.ports?.length || 0), 0) },
            ]}
            incidentCount={criticalIncidents}
            lastUpdated={networkData.lastUpdated}
          />
        </Grid>

        {/* Chart Dashlet - Network Bandwidth */}
        <Grid item xs={12} md={6}>
          <ChartDashlet
            title="Network Bandwidth"
            subtitle="Total throughput across all links"
            chartType="area"
            series={[
              {
                name: 'Bandwidth',
                data: generateChartData(),
                color: entuityColors.charts.network,
                unit: 'Mbps',
              },
            ]}
            currentValue={6543}
            currentUnit=" Mbps"
            threshold={{ warning: 7000, critical: 9000 }}
            onRefresh={handleRefresh}
            timeRange="24h"
          />
        </Grid>

        {/* Table Dashlet - Active Incidents */}
        <Grid item xs={12}>
          <TableDashlet
            title="Active Incidents"
            subtitle={`${incidentRows.length} devices with incidents`}
            columns={incidentColumns}
            rows={incidentRows}
            onRowClick={(row) => {
              const device = networkData.devices.find(d => d.id === row.id);
              if (device) setSelectedDevice(device);
            }}
            onRefresh={handleRefresh}
            searchable
            sortable
          />
        </Grid>
      </Grid>
    </Container>
  );
};

export default NetworkDashboard;
