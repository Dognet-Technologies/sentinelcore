import React, { useState, useEffect } from 'react';
import {
  Box,
  Container,
  Paper,
  TextField,
  Button,
  Stack,
  Typography,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Alert,
  CircularProgress,
  Chip,
  Divider,
  FormControlLabel,
  Checkbox,
} from '@mui/material';
import {
  ArrowBack as ArrowBackIcon,
  Edit as EditIcon,
  Save as SaveIcon,
  Cancel as CancelIcon,
} from '@mui/icons-material';
import { useParams, useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import apiClient from '../services/api';
import { useRoleAccess } from '../hooks/useRoleAccess';

interface DeviceDetails {
  id: string;
  hostname: string;
  ip_address: string;
  mac_address?: string;
  device_type: string;
  device_status: string;
  
  business_criticality?: string;
  exposure_level?: string;
  device_use_case?: string;
  data_classification?: string;
  
  compensating_controls?: string;
  patch_availability?: boolean;
  remediation_difficulty?: string;
  deployment_impact?: string;
  
  owner_team_id?: string;
  compliance_requirements?: string[];
  device_notes?: string;
  is_data_processor?: boolean;
  
  created_at: string;
  updated_at: string;
}

interface ValidationResult {
  is_valid: boolean;
  missing_fields: string[];
  warnings: string[];
}

const DeviceDetailsPage: React.FC = () => {
  const { deviceId } = useParams<{ deviceId: string }>();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const { isAdmin, isTeamLeader } = useRoleAccess();
  const canEdit = isAdmin() || isTeamLeader();

  const [isEditing, setIsEditing] = useState(false);
  const [formData, setFormData] = useState<DeviceDetails | null>(null);
  const [validationResult, setValidationResult] = useState<ValidationResult | null>(null);

  const { data: deviceData, isLoading } = useQuery({
    queryKey: ['device', deviceId],
    queryFn: async () => {
      const response = await apiClient.get<DeviceDetails>(`/api/network/devices/${deviceId}`);
      return response.data;
    },
  });

  const { data: validation, isFetching: isValidating } = useQuery({
    queryKey: ['device-validation', deviceId],
    queryFn: async () => {
      const response = await apiClient.get<ValidationResult>(`/api/rbre/validate-device/${deviceId}`);
      return response.data;
    },
  });

  useEffect(() => {
    if (deviceData) {
      setFormData(deviceData);
    }
  }, [deviceData]);

  useEffect(() => {
    if (validation) {
      setValidationResult(validation);
    }
  }, [validation]);

  const updateDeviceMutation = useMutation({
    mutationFn: async (data: DeviceDetails) => {
      return apiClient.put(`/api/network/devices/${deviceId}`, data);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['device', deviceId] });
      queryClient.invalidateQueries({ queryKey: ['device-validation', deviceId] });
      setIsEditing(false);
    },
  });

  const handleSave = () => {
    if (formData) {
      updateDeviceMutation.mutate(formData);
    }
  };

  const handleCancel = () => {
    if (deviceData) {
      setFormData(deviceData);
    }
    setIsEditing(false);
  };

  const handleFieldChange = (field: keyof DeviceDetails, value: any) => {
    if (formData) {
      setFormData({
        ...formData,
        [field]: value,
      });
    }
  };

  if (isLoading || !formData) {
    return (
      <Container maxWidth="lg" sx={{ py: 4 }}>
        <CircularProgress />
      </Container>
    );
  }

  return (
    <Container maxWidth="lg" sx={{ py: 4 }}>
      <Button
        startIcon={<ArrowBackIcon />}
        onClick={() => navigate(-1)}
        sx={{ mb: 2 }}
      >
        Back
      </Button>

      <Paper sx={{ p: 4 }}>
        {/* Header */}
        <Stack direction="row" justifyContent="space-between" alignItems="center" mb={3}>
          <Box>
            <Typography variant="h4">{formData.hostname || formData.ip_address}</Typography>
            <Typography variant="body2" color="text.secondary">
              {formData.ip_address}
            </Typography>
          </Box>
          {canEdit && (
            <Stack direction="row" spacing={1}>
              {!isEditing ? (
                <Button
                  variant="outlined"
                  startIcon={<EditIcon />}
                  onClick={() => setIsEditing(true)}
                >
                  Edit
                </Button>
              ) : (
                <>
                  <Button
                    variant="contained"
                    startIcon={<SaveIcon />}
                    onClick={handleSave}
                    disabled={updateDeviceMutation.isPending}
                  >
                    Save
                  </Button>
                  <Button
                    variant="outlined"
                    startIcon={<CancelIcon />}
                    onClick={handleCancel}
                  >
                    Cancel
                  </Button>
                </>
              )}
            </Stack>
          )}
        </Stack>

        {/* Validation Alert */}
        {validationResult && !validationResult.is_valid && (
          <Alert severity="warning" sx={{ mb: 2 }}>
            <Typography variant="subtitle2" fontWeight={600} mb={1}>
              Missing required fields for RBRE:
            </Typography>
            {validationResult.missing_fields.map((field) => (
              <Chip key={field} label={field} size="small" sx={{ mr: 1, mb: 1 }} />
            ))}
            {validationResult.warnings.length > 0 && (
              <>
                <Typography variant="subtitle2" fontWeight={600} mt={2} mb={1}>
                  Recommended fields:
                </Typography>
                {validationResult.warnings.map((warning) => (
                  <Chip key={warning} label={warning} size="small" variant="outlined" sx={{ mr: 1, mb: 1 }} />
                ))}
              </>
            )}
          </Alert>
        )}

        <Divider sx={{ my: 3 }} />

        {/* Device Information Section */}
        <Typography variant="h6" sx={{ mb: 2 }}>Basic Information</Typography>
        <Stack spacing={2} sx={{ mb: 3 }}>
          <TextField
            label="Hostname"
            value={formData.hostname}
            onChange={(e) => handleFieldChange('hostname', e.target.value)}
            disabled={!isEditing}
            fullWidth
          />
          <TextField
            label="IP Address"
            value={formData.ip_address}
            disabled
            fullWidth
          />
          <TextField
            label="MAC Address"
            value={formData.mac_address || ''}
            disabled
            fullWidth
          />
          <FormControl fullWidth disabled={!isEditing}>
            <InputLabel>Device Type</InputLabel>
            <Select
              value={formData.device_type}
              onChange={(e) => handleFieldChange('device_type', e.target.value)}
            >
              <MenuItem value="router">Router</MenuItem>
              <MenuItem value="switch">Switch</MenuItem>
              <MenuItem value="firewall">Firewall</MenuItem>
              <MenuItem value="server">Server</MenuItem>
              <MenuItem value="workstation">Workstation</MenuItem>
              <MenuItem value="iot">IoT</MenuItem>
              <MenuItem value="unknown">Unknown</MenuItem>
            </Select>
          </FormControl>
        </Stack>

        <Divider sx={{ my: 3 }} />

        {/* RBRE Business Critical Fields */}
        <Typography variant="h6" sx={{ mb: 2 }}>Business & Risk Context (Required for RBRE)</Typography>
        <Stack spacing={2} sx={{ mb: 3 }}>
          <FormControl fullWidth disabled={!isEditing}>
            <InputLabel>Business Criticality *</InputLabel>
            <Select
              value={formData.business_criticality || ''}
              onChange={(e) => handleFieldChange('business_criticality', e.target.value)}
            >
              <MenuItem value="mission_critical">Mission Critical</MenuItem>
              <MenuItem value="core_business">Core Business</MenuItem>
              <MenuItem value="supporto">Support</MenuItem>
              <MenuItem value="lab_test">Lab/Test</MenuItem>
            </Select>
          </FormControl>

          <FormControl fullWidth disabled={!isEditing}>
            <InputLabel>Exposure Level *</InputLabel>
            <Select
              value={formData.exposure_level || ''}
              onChange={(e) => handleFieldChange('exposure_level', e.target.value)}
            >
              <MenuItem value="internet_facing">Internet Facing</MenuItem>
              <MenuItem value="dmz">DMZ</MenuItem>
              <MenuItem value="internal">Internal</MenuItem>
              <MenuItem value="segmented">Segmented</MenuItem>
            </Select>
          </FormControl>

          <FormControl fullWidth disabled={!isEditing}>
            <InputLabel>Use Case *</InputLabel>
            <Select
              value={formData.device_use_case || ''}
              onChange={(e) => handleFieldChange('device_use_case', e.target.value)}
            >
              <MenuItem value="web_server">Web Server</MenuItem>
              <MenuItem value="database">Database</MenuItem>
              <MenuItem value="endpoint">Endpoint</MenuItem>
              <MenuItem value="iot">IoT</MenuItem>
              <MenuItem value="load_balancer">Load Balancer</MenuItem>
              <MenuItem value="firewall">Firewall</MenuItem>
              <MenuItem value="router">Router</MenuItem>
              <MenuItem value="switch">Switch</MenuItem>
              <MenuItem value="nas">NAS</MenuItem>
              <MenuItem value="other">Other</MenuItem>
            </Select>
          </FormControl>

          <FormControl fullWidth disabled={!isEditing}>
            <InputLabel>Data Classification</InputLabel>
            <Select
              value={formData.data_classification || ''}
              onChange={(e) => handleFieldChange('data_classification', e.target.value)}
            >
              <MenuItem value="public">Public</MenuItem>
              <MenuItem value="internal">Internal</MenuItem>
              <MenuItem value="sensitive">Sensitive</MenuItem>
              <MenuItem value="critical">Critical</MenuItem>
            </Select>
          </FormControl>

          <FormControlLabel
            control={
              <Checkbox
                checked={formData.patch_availability || false}
                onChange={(e) => handleFieldChange('patch_availability', e.target.checked)}
                disabled={!isEditing}
              />
            }
            label="Patch Available *"
          />

          <FormControl fullWidth disabled={!isEditing}>
            <InputLabel>Remediation Difficulty *</InputLabel>
            <Select
              value={formData.remediation_difficulty || ''}
              onChange={(e) => handleFieldChange('remediation_difficulty', e.target.value)}
            >
              <MenuItem value="trivial">Trivial (1-2h)</MenuItem>
              <MenuItem value="easy">Easy (4-8h)</MenuItem>
              <MenuItem value="medium">Medium (1-3 days)</MenuItem>
              <MenuItem value="hard">Hard (1-2 weeks)</MenuItem>
              <MenuItem value="very_hard">Very Hard (&gt;1 month)</MenuItem>
            </Select>
          </FormControl>
        </Stack>

        <Divider sx={{ my: 3 }} />

        {/* Optional RBRE Fields */}
        <Typography variant="h6" sx={{ mb: 2 }}>Additional Context (Optional)</Typography>
        <Stack spacing={2}>
          <TextField
            label="Compensating Controls"
            value={formData.compensating_controls || ''}
            onChange={(e) => handleFieldChange('compensating_controls', e.target.value)}
            disabled={!isEditing}
            multiline
            rows={3}
            fullWidth
            helperText="Describe any existing security controls that mitigate vulnerabilities"
          />

          <TextField
            label="Deployment Impact"
            value={formData.deployment_impact || ''}
            onChange={(e) => handleFieldChange('deployment_impact', e.target.value)}
            disabled={!isEditing}
            multiline
            rows={3}
            fullWidth
            helperText="Describe the operational impact of remediation/patching"
          />

          <TextField
            label="Notes"
            value={formData.device_notes || ''}
            onChange={(e) => handleFieldChange('device_notes', e.target.value)}
            disabled={!isEditing}
            multiline
            rows={3}
            fullWidth
          />

          <FormControlLabel
            control={
              <Checkbox
                checked={formData.is_data_processor || false}
                onChange={(e) => handleFieldChange('is_data_processor', e.target.checked)}
                disabled={!isEditing}
              />
            }
            label="Processes Sensitive Data"
          />
        </Stack>

        {/* Metadata */}
        <Divider sx={{ my: 3 }} />
        <Typography variant="caption" color="text.secondary">
          Created: {new Date(formData.created_at).toLocaleString()}
          <br />
          Updated: {new Date(formData.updated_at).toLocaleString()}
        </Typography>
      </Paper>
    </Container>
  );
};

export default DeviceDetailsPage;
