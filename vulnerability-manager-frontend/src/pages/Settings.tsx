// src/pages/Settings.tsx
import React, { useState, useRef } from 'react';
import {
  Box,
  Container,
  Paper,
  Tabs,
  Tab,
  Typography,
  Divider,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Switch,
  TextField,
  Button,
  Grid,
  Card,
  CardContent,
  Alert,
  Snackbar,
  alpha,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  IconButton,
  Chip,
  CircularProgress,
  InputAdornment,
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableRow,
  Tooltip,
} from '@mui/material';
import {
  Palette as PaletteIcon,
  Notifications as NotificationsIcon,
  Security as SecurityIcon,
  Api as ApiIcon,
  Person as PersonIcon,
  Save as SaveIcon,
  PhotoCamera as PhotoCameraIcon,
  Delete as DeleteIcon,
  ContentCopy as CopyIcon,
  Visibility as VisibilityIcon,
  VisibilityOff as VisibilityOffIcon,
  Add as AddIcon,
  Key as KeyIcon,
  Warning as WarningIcon,
} from '@mui/icons-material';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useAuth } from '../contexts/AuthContext';
import { useEnhancedTheme } from '../contexts/EnhancedThemeContext';
import ThemeSelector from '../components/settings/ThemeSelector';
import { AnimatedCard } from '../components/common/AnimatedCard';
import {
  settingsApi,
  NotificationSettings,
  SecuritySettings,
  ApiKey,
  TwoFactorSetup,
} from '../api/settings';

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

const TabPanel: React.FC<TabPanelProps> = ({ children, value, index, ...other }) => {
  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`settings-tabpanel-${index}`}
      aria-labelledby={`settings-tab-${index}`}
      {...other}
    >
      {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
    </div>
  );
};

const Settings: React.FC = () => {
  const queryClient = useQueryClient();
  const { user } = useAuth();
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [activeTab, setActiveTab] = useState(0);
  const [snackbar, setSnackbar] = useState<{ open: boolean; message: string; severity: 'success' | 'error' }>({
    open: false,
    message: '',
    severity: 'success',
  });

  // Dialog states
  const [twoFactorDialog, setTwoFactorDialog] = useState(false);
  const [twoFactorSetup, setTwoFactorSetup] = useState<TwoFactorSetup | null>(null);
  const [twoFactorCode, setTwoFactorCode] = useState('');
  const [disable2FADialog, setDisable2FADialog] = useState(false);
  const [disable2FACode, setDisable2FACode] = useState('');

  const [apiKeyDialog, setApiKeyDialog] = useState(false);
  const [newApiKeyName, setNewApiKeyName] = useState('');
  const [newApiKeyExpiry, setNewApiKeyExpiry] = useState('90');
  const [generatedKey, setGeneratedKey] = useState<string | null>(null);

  const [passwordDialog, setPasswordDialog] = useState(false);
  const [currentPassword, setCurrentPassword] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [showPasswords, setShowPasswords] = useState(false);

  // Profile state
  const [profileData, setProfileData] = useState({
    first_name: '',
    last_name: '',
    email: '',
  });

  // Fetch profile
  const { data: profile, isLoading: profileLoading } = useQuery({
    queryKey: ['profile'],
    queryFn: settingsApi.getProfile,
    onSuccess: (data) => {
      setProfileData({
        first_name: data.first_name || '',
        last_name: data.last_name || '',
        email: data.email || '',
      });
    },
  });

  // Fetch notification settings
  const { data: notificationSettings, isLoading: notificationsLoading } = useQuery({
    queryKey: ['notificationSettings'],
    queryFn: settingsApi.getNotificationSettings,
  });

  // Fetch security settings
  const { data: securitySettings, isLoading: securityLoading } = useQuery({
    queryKey: ['securitySettings'],
    queryFn: settingsApi.getSecuritySettings,
  });

  // Fetch API keys
  const { data: apiKeys = [], isLoading: apiKeysLoading } = useQuery({
    queryKey: ['apiKeys'],
    queryFn: settingsApi.listApiKeys,
  });

  // Mutations
  const updateProfileMutation = useMutation({
    mutationFn: settingsApi.updateProfile,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['profile'] });
      setSnackbar({ open: true, message: 'Profilo aggiornato con successo', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore nell\'aggiornamento del profilo', severity: 'error' });
    },
  });

  const uploadAvatarMutation = useMutation({
    mutationFn: settingsApi.uploadAvatar,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['profile'] });
      setSnackbar({ open: true, message: 'Avatar caricato con successo', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore nel caricamento dell\'avatar', severity: 'error' });
    },
  });

  const deleteAvatarMutation = useMutation({
    mutationFn: settingsApi.deleteAvatar,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['profile'] });
      setSnackbar({ open: true, message: 'Avatar eliminato', severity: 'success' });
    },
  });

  const updateNotificationsMutation = useMutation({
    mutationFn: settingsApi.updateNotificationSettings,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['notificationSettings'] });
      setSnackbar({ open: true, message: 'Preferenze notifiche salvate', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore nel salvataggio', severity: 'error' });
    },
  });

  const updateSecurityMutation = useMutation({
    mutationFn: settingsApi.updateSecuritySettings,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['securitySettings'] });
      setSnackbar({ open: true, message: 'Impostazioni sicurezza salvate', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore nel salvataggio', severity: 'error' });
    },
  });

  const setup2FAMutation = useMutation({
    mutationFn: settingsApi.setup2FA,
    onSuccess: (data) => {
      setTwoFactorSetup(data);
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore nella configurazione 2FA', severity: 'error' });
    },
  });

  const verify2FAMutation = useMutation({
    mutationFn: (code: string) => settingsApi.verify2FA(code),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['securitySettings'] });
      setTwoFactorDialog(false);
      setTwoFactorSetup(null);
      setTwoFactorCode('');
      setSnackbar({ open: true, message: '2FA abilitato con successo', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Codice non valido', severity: 'error' });
    },
  });

  const disable2FAMutation = useMutation({
    mutationFn: (code: string) => settingsApi.disable2FA(code),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['securitySettings'] });
      setDisable2FADialog(false);
      setDisable2FACode('');
      setSnackbar({ open: true, message: '2FA disabilitato', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Codice non valido', severity: 'error' });
    },
  });

  const createApiKeyMutation = useMutation({
    mutationFn: ({ name, expiry }: { name: string; expiry?: number }) =>
      settingsApi.createApiKey(name, expiry),
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['apiKeys'] });
      setGeneratedKey(data.key);
      setNewApiKeyName('');
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore nella creazione della chiave', severity: 'error' });
    },
  });

  const revokeApiKeyMutation = useMutation({
    mutationFn: settingsApi.revokeApiKey,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['apiKeys'] });
      setSnackbar({ open: true, message: 'Chiave API revocata', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore nella revoca della chiave', severity: 'error' });
    },
  });

  const changePasswordMutation = useMutation({
    mutationFn: ({ current, newPwd }: { current: string; newPwd: string }) =>
      settingsApi.changePassword(current, newPwd),
    onSuccess: () => {
      setPasswordDialog(false);
      setCurrentPassword('');
      setNewPassword('');
      setConfirmPassword('');
      setSnackbar({ open: true, message: 'Password cambiata con successo', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore nel cambio password', severity: 'error' });
    },
  });

  // Handlers
  const handleAvatarClick = () => {
    fileInputRef.current?.click();
  };

  const handleAvatarChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        setSnackbar({ open: true, message: 'Il file deve essere inferiore a 5MB', severity: 'error' });
        return;
      }
      uploadAvatarMutation.mutate(file);
    }
  };

  const handleNotificationChange = (key: keyof NotificationSettings, value: boolean) => {
    if (notificationSettings) {
      updateNotificationsMutation.mutate({
        ...notificationSettings,
        [key]: value,
      });
    }
  };

  const handleSecurityChange = (key: keyof SecuritySettings, value: any) => {
    updateSecurityMutation.mutate({ [key]: value });
  };

  const handle2FASetup = () => {
    setTwoFactorDialog(true);
    setup2FAMutation.mutate();
  };

  const handleCreateApiKey = () => {
    if (!newApiKeyName.trim()) return;
    createApiKeyMutation.mutate({
      name: newApiKeyName,
      expiry: newApiKeyExpiry ? parseInt(newApiKeyExpiry) : undefined,
    });
  };

  const handleChangePassword = () => {
    if (newPassword !== confirmPassword) {
      setSnackbar({ open: true, message: 'Le password non corrispondono', severity: 'error' });
      return;
    }
    if (newPassword.length < 8) {
      setSnackbar({ open: true, message: 'La password deve essere di almeno 8 caratteri', severity: 'error' });
      return;
    }
    changePasswordMutation.mutate({ current: currentPassword, newPwd: newPassword });
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    setSnackbar({ open: true, message: 'Copiato negli appunti', severity: 'success' });
  };

  return (
    <Container maxWidth="lg">
      <Box sx={{ mb: 4 }}>
        <Typography variant="h4" fontWeight={700} gutterBottom>
          Impostazioni
        </Typography>
        <Typography variant="body1" color="text.secondary">
          Personalizza l'applicazione secondo le tue preferenze
        </Typography>
      </Box>

      <Paper sx={{ borderRadius: 2, overflow: 'hidden' }}>
        <Box sx={{ display: 'flex', minHeight: 'calc(100vh - 250px)' }}>
          {/* Sidebar con tabs */}
          <Box
            sx={{
              width: 280,
              borderRight: 1,
              borderColor: 'divider',
              background: (theme) =>
                theme.palette.mode === 'dark'
                  ? alpha(theme.palette.background.paper, 0.5)
                  : theme.palette.grey[50],
            }}
          >
            <Tabs
              orientation="vertical"
              value={activeTab}
              onChange={(_, v) => setActiveTab(v)}
              sx={{
                '& .MuiTab-root': {
                  minHeight: 64,
                  alignItems: 'flex-start',
                  textAlign: 'left',
                  px: 3,
                },
              }}
            >
              <Tab icon={<PaletteIcon />} label="Aspetto" iconPosition="start" />
              <Tab icon={<NotificationsIcon />} label="Notifiche" iconPosition="start" />
              <Tab icon={<SecurityIcon />} label="Sicurezza" iconPosition="start" />
              <Tab icon={<ApiIcon />} label="API" iconPosition="start" />
              <Tab icon={<PersonIcon />} label="Profilo" iconPosition="start" />
            </Tabs>
          </Box>

          {/* Contenuto principale */}
          <Box sx={{ flex: 1, overflow: 'auto', p: 4 }}>
            {/* Tab Aspetto */}
            <TabPanel value={activeTab} index={0}>
              <ThemeSelector />
            </TabPanel>

            {/* Tab Notifiche */}
            <TabPanel value={activeTab} index={1}>
              <Typography variant="h5" gutterBottom fontWeight={600}>
                Preferenze Notifiche
              </Typography>
              <Typography variant="body2" color="text.secondary" paragraph>
                Configura come e quando ricevere notifiche dal sistema
              </Typography>

              {notificationsLoading ? (
                <CircularProgress />
              ) : (
                <List>
                  <ListItem>
                    <ListItemText
                      primary="Notifiche Email"
                      secondary="Ricevi notifiche via email per eventi importanti"
                    />
                    <ListItemSecondaryAction>
                      <Switch
                        edge="end"
                        checked={notificationSettings?.email_enabled ?? false}
                        onChange={(e) => handleNotificationChange('email_enabled', e.target.checked)}
                        disabled={updateNotificationsMutation.isPending}
                      />
                    </ListItemSecondaryAction>
                  </ListItem>
                  <Divider />
                  <ListItem>
                    <ListItemText
                      primary="Notifiche Push"
                      secondary="Ricevi notifiche push nel browser"
                    />
                    <ListItemSecondaryAction>
                      <Switch
                        edge="end"
                        checked={notificationSettings?.push_enabled ?? false}
                        onChange={(e) => handleNotificationChange('push_enabled', e.target.checked)}
                        disabled={updateNotificationsMutation.isPending}
                      />
                    </ListItemSecondaryAction>
                  </ListItem>
                  <Divider />
                  <ListItem>
                    <ListItemText
                      primary="Vulnerabilità Critiche"
                      secondary="Notifica immediata per vulnerabilità con CVSS >= 9.0"
                    />
                    <ListItemSecondaryAction>
                      <Switch
                        edge="end"
                        checked={notificationSettings?.critical_alerts ?? false}
                        onChange={(e) => handleNotificationChange('critical_alerts', e.target.checked)}
                        disabled={updateNotificationsMutation.isPending}
                      />
                    </ListItemSecondaryAction>
                  </ListItem>
                  <Divider />
                  <ListItem>
                    <ListItemText
                      primary="Report Settimanale"
                      secondary="Ricevi un riepilogo settimanale delle attività"
                    />
                    <ListItemSecondaryAction>
                      <Switch
                        edge="end"
                        checked={notificationSettings?.weekly_report ?? false}
                        onChange={(e) => handleNotificationChange('weekly_report', e.target.checked)}
                        disabled={updateNotificationsMutation.isPending}
                      />
                    </ListItemSecondaryAction>
                  </ListItem>
                </List>
              )}
            </TabPanel>

            {/* Tab Sicurezza */}
            <TabPanel value={activeTab} index={2}>
              <Typography variant="h5" gutterBottom fontWeight={600}>
                Impostazioni di Sicurezza
              </Typography>
              <Typography variant="body2" color="text.secondary" paragraph>
                Configura le opzioni di sicurezza per il tuo account
              </Typography>

              {securityLoading ? (
                <CircularProgress />
              ) : (
                <Grid container spacing={3}>
                  <Grid item xs={12}>
                    <AnimatedCard>
                      <CardContent>
                        <Typography variant="h6" gutterBottom>
                          Autenticazione a Due Fattori
                        </Typography>
                        <Typography variant="body2" color="text.secondary" paragraph>
                          Aggiungi un ulteriore livello di sicurezza al tuo account usando un'app
                          authenticator (Google Authenticator, Authy, ecc.)
                        </Typography>
                        {securitySettings?.two_factor_enabled ? (
                          <Box display="flex" alignItems="center" gap={2}>
                            <Chip label="Abilitato" color="success" />
                            <Button
                              variant="outlined"
                              color="error"
                              onClick={() => setDisable2FADialog(true)}
                            >
                              Disabilita 2FA
                            </Button>
                          </Box>
                        ) : (
                          <Button variant="contained" color="primary" onClick={handle2FASetup}>
                            Abilita 2FA
                          </Button>
                        )}
                      </CardContent>
                    </AnimatedCard>
                  </Grid>

                  <Grid item xs={12}>
                    <AnimatedCard>
                      <CardContent>
                        <Typography variant="h6" gutterBottom>
                          Cambia Password
                        </Typography>
                        <Typography variant="body2" color="text.secondary" paragraph>
                          Aggiorna la password del tuo account
                        </Typography>
                        <Button variant="outlined" onClick={() => setPasswordDialog(true)}>
                          Cambia Password
                        </Button>
                      </CardContent>
                    </AnimatedCard>
                  </Grid>

                  <Grid item xs={12}>
                    <AnimatedCard>
                      <CardContent>
                        <Typography variant="h6" gutterBottom>
                          Timeout Sessione
                        </Typography>
                        <Typography variant="body2" color="text.secondary" paragraph>
                          Tempo di inattività prima del logout automatico
                        </Typography>
                        <TextField
                          select
                          fullWidth
                          value={securitySettings?.session_timeout_minutes || 30}
                          onChange={(e) =>
                            handleSecurityChange('session_timeout_minutes', parseInt(e.target.value))
                          }
                          SelectProps={{ native: true }}
                          disabled={updateSecurityMutation.isPending}
                        >
                          <option value="15">15 minuti</option>
                          <option value="30">30 minuti</option>
                          <option value="60">1 ora</option>
                          <option value="120">2 ore</option>
                          <option value="480">8 ore</option>
                        </TextField>
                      </CardContent>
                    </AnimatedCard>
                  </Grid>

                  <Grid item xs={12}>
                    <AnimatedCard>
                      <CardContent>
                        <Typography variant="h6" gutterBottom>
                          Whitelist IP
                        </Typography>
                        <Typography variant="body2" color="text.secondary" paragraph>
                          Limita l'accesso solo da indirizzi IP autorizzati
                        </Typography>
                        <Switch
                          checked={securitySettings?.ip_whitelist_enabled ?? false}
                          onChange={(e) =>
                            handleSecurityChange('ip_whitelist_enabled', e.target.checked)
                          }
                          disabled={updateSecurityMutation.isPending}
                        />
                        {securitySettings?.ip_whitelist_enabled && (
                          <TextField
                            fullWidth
                            multiline
                            rows={3}
                            placeholder="Inserisci un IP per riga (es. 192.168.1.1)"
                            value={securitySettings?.ip_whitelist?.join('\n') || ''}
                            onChange={(e) =>
                              handleSecurityChange(
                                'ip_whitelist',
                                e.target.value.split('\n').filter((ip) => ip.trim())
                              )
                            }
                            sx={{ mt: 2 }}
                            disabled={updateSecurityMutation.isPending}
                          />
                        )}
                      </CardContent>
                    </AnimatedCard>
                  </Grid>
                </Grid>
              )}
            </TabPanel>

            {/* Tab API */}
            <TabPanel value={activeTab} index={3}>
              <Typography variant="h5" gutterBottom fontWeight={600}>
                Chiavi API
              </Typography>
              <Typography variant="body2" color="text.secondary" paragraph>
                Gestisci le chiavi API per l'integrazione con tool esterni
              </Typography>

              <Box sx={{ mb: 3 }}>
                <Button
                  variant="contained"
                  startIcon={<AddIcon />}
                  onClick={() => setApiKeyDialog(true)}
                >
                  Genera Nuova Chiave
                </Button>
              </Box>

              {apiKeysLoading ? (
                <CircularProgress />
              ) : apiKeys.length === 0 ? (
                <Alert severity="info">Nessuna chiave API generata</Alert>
              ) : (
                <Table>
                  <TableHead>
                    <TableRow>
                      <TableCell>Nome</TableCell>
                      <TableCell>Prefisso</TableCell>
                      <TableCell>Creata il</TableCell>
                      <TableCell>Ultimo utilizzo</TableCell>
                      <TableCell>Scadenza</TableCell>
                      <TableCell>Azioni</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {apiKeys.map((key) => (
                      <TableRow key={key.id}>
                        <TableCell>{key.name}</TableCell>
                        <TableCell>
                          <code>{key.key_prefix}...</code>
                        </TableCell>
                        <TableCell>
                          {new Date(key.created_at).toLocaleDateString('it-IT')}
                        </TableCell>
                        <TableCell>
                          {key.last_used_at
                            ? new Date(key.last_used_at).toLocaleDateString('it-IT')
                            : 'Mai'}
                        </TableCell>
                        <TableCell>
                          {key.expires_at
                            ? new Date(key.expires_at).toLocaleDateString('it-IT')
                            : 'Mai'}
                        </TableCell>
                        <TableCell>
                          <Tooltip title="Revoca chiave">
                            <IconButton
                              color="error"
                              onClick={() => {
                                if (window.confirm('Sei sicuro di voler revocare questa chiave?')) {
                                  revokeApiKeyMutation.mutate(key.id);
                                }
                              }}
                            >
                              <DeleteIcon />
                            </IconButton>
                          </Tooltip>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              )}
            </TabPanel>

            {/* Tab Profilo */}
            <TabPanel value={activeTab} index={4}>
              <Typography variant="h5" gutterBottom fontWeight={600}>
                Profilo Utente
              </Typography>
              <Typography variant="body2" color="text.secondary" paragraph>
                Gestisci le informazioni del tuo profilo
              </Typography>

              {profileLoading ? (
                <CircularProgress />
              ) : (
                <Grid container spacing={3}>
                  <Grid item xs={12} md={6}>
                    <TextField
                      fullWidth
                      label="Nome"
                      value={profileData.first_name}
                      onChange={(e) =>
                        setProfileData({ ...profileData, first_name: e.target.value })
                      }
                      margin="normal"
                    />
                    <TextField
                      fullWidth
                      label="Cognome"
                      value={profileData.last_name}
                      onChange={(e) =>
                        setProfileData({ ...profileData, last_name: e.target.value })
                      }
                      margin="normal"
                    />
                    <TextField
                      fullWidth
                      label="Email"
                      value={profileData.email}
                      onChange={(e) => setProfileData({ ...profileData, email: e.target.value })}
                      margin="normal"
                      type="email"
                    />
                    <TextField
                      fullWidth
                      label="Username"
                      value={profile?.username || ''}
                      margin="normal"
                      disabled
                    />
                    <TextField
                      fullWidth
                      label="Ruolo"
                      value={profile?.role === 'admin' ? 'Amministratore' : profile?.role || ''}
                      margin="normal"
                      disabled
                    />
                    <Box sx={{ mt: 2 }}>
                      <Button
                        variant="contained"
                        startIcon={<SaveIcon />}
                        onClick={() => updateProfileMutation.mutate(profileData)}
                        disabled={updateProfileMutation.isPending}
                      >
                        Salva Profilo
                      </Button>
                    </Box>
                  </Grid>
                  <Grid item xs={12} md={6}>
                    <Card sx={{ p: 3, textAlign: 'center' }}>
                      <Box
                        sx={{
                          width: 120,
                          height: 120,
                          borderRadius: '50%',
                          background: profile?.avatar_url
                            ? `url(${profile.avatar_url}) center/cover`
                            : (theme) =>
                                `linear-gradient(135deg, ${theme.palette.primary.main}, ${theme.palette.secondary.main})`,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          mx: 'auto',
                          mb: 2,
                          fontSize: 48,
                          fontWeight: 700,
                          color: 'white',
                          position: 'relative',
                          overflow: 'hidden',
                        }}
                      >
                        {!profile?.avatar_url && (user?.username?.charAt(0).toUpperCase() || 'U')}
                      </Box>
                      <input
                        type="file"
                        ref={fileInputRef}
                        onChange={handleAvatarChange}
                        accept="image/*"
                        style={{ display: 'none' }}
                      />
                      <Box display="flex" gap={1} justifyContent="center">
                        <Button
                          variant="outlined"
                          startIcon={<PhotoCameraIcon />}
                          onClick={handleAvatarClick}
                          disabled={uploadAvatarMutation.isPending}
                        >
                          {uploadAvatarMutation.isPending ? 'Caricamento...' : 'Cambia Avatar'}
                        </Button>
                        {profile?.avatar_url && (
                          <IconButton
                            color="error"
                            onClick={() => deleteAvatarMutation.mutate()}
                            disabled={deleteAvatarMutation.isPending}
                          >
                            <DeleteIcon />
                          </IconButton>
                        )}
                      </Box>
                      <Typography variant="caption" color="text.secondary" sx={{ mt: 1, display: 'block' }}>
                        Max 5MB, formati: JPG, PNG, GIF
                      </Typography>
                    </Card>
                  </Grid>
                </Grid>
              )}
            </TabPanel>
          </Box>
        </Box>
      </Paper>

      {/* 2FA Setup Dialog */}
      <Dialog open={twoFactorDialog} onClose={() => setTwoFactorDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Configura Autenticazione a Due Fattori</DialogTitle>
        <DialogContent>
          {setup2FAMutation.isPending ? (
            <Box textAlign="center" py={4}>
              <CircularProgress />
              <Typography sx={{ mt: 2 }}>Generazione QR code...</Typography>
            </Box>
          ) : twoFactorSetup ? (
            <Box>
              <Typography paragraph>
                1. Scansiona il QR code con la tua app authenticator
              </Typography>
              <Box textAlign="center" mb={3}>
                <img
                  src={twoFactorSetup.qr_code_url}
                  alt="QR Code 2FA"
                  style={{ maxWidth: 200, border: '1px solid #ccc', padding: 8 }}
                />
              </Box>
              <Typography variant="body2" paragraph>
                Oppure inserisci manualmente questo codice:
              </Typography>
              <Box
                sx={{
                  p: 2,
                  bgcolor: 'grey.100',
                  borderRadius: 1,
                  fontFamily: 'monospace',
                  mb: 3,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                }}
              >
                <code>{twoFactorSetup.secret}</code>
                <IconButton size="small" onClick={() => copyToClipboard(twoFactorSetup.secret)}>
                  <CopyIcon fontSize="small" />
                </IconButton>
              </Box>
              <Typography paragraph>
                2. Inserisci il codice a 6 cifre dall'app
              </Typography>
              <TextField
                fullWidth
                label="Codice di verifica"
                value={twoFactorCode}
                onChange={(e) => setTwoFactorCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                placeholder="000000"
                inputProps={{ maxLength: 6 }}
              />
              {twoFactorSetup.backup_codes && (
                <Alert severity="warning" sx={{ mt: 2 }}>
                  <Typography variant="body2" fontWeight="bold">
                    Codici di backup (salva in un posto sicuro):
                  </Typography>
                  <Box sx={{ fontFamily: 'monospace', mt: 1 }}>
                    {twoFactorSetup.backup_codes.map((code, i) => (
                      <div key={i}>{code}</div>
                    ))}
                  </Box>
                </Alert>
              )}
            </Box>
          ) : null}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setTwoFactorDialog(false)}>Annulla</Button>
          <Button
            variant="contained"
            onClick={() => verify2FAMutation.mutate(twoFactorCode)}
            disabled={twoFactorCode.length !== 6 || verify2FAMutation.isPending}
          >
            Verifica e Attiva
          </Button>
        </DialogActions>
      </Dialog>

      {/* Disable 2FA Dialog */}
      <Dialog open={disable2FADialog} onClose={() => setDisable2FADialog(false)}>
        <DialogTitle>Disabilita 2FA</DialogTitle>
        <DialogContent>
          <Alert severity="warning" sx={{ mb: 2 }}>
            Disabilitando il 2FA ridurrai la sicurezza del tuo account
          </Alert>
          <TextField
            fullWidth
            label="Codice di verifica"
            value={disable2FACode}
            onChange={(e) => setDisable2FACode(e.target.value.replace(/\D/g, '').slice(0, 6))}
            placeholder="000000"
            inputProps={{ maxLength: 6 }}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setDisable2FADialog(false)}>Annulla</Button>
          <Button
            variant="contained"
            color="error"
            onClick={() => disable2FAMutation.mutate(disable2FACode)}
            disabled={disable2FACode.length !== 6 || disable2FAMutation.isPending}
          >
            Disabilita
          </Button>
        </DialogActions>
      </Dialog>

      {/* API Key Dialog */}
      <Dialog
        open={apiKeyDialog}
        onClose={() => {
          setApiKeyDialog(false);
          setGeneratedKey(null);
          setNewApiKeyName('');
        }}
        maxWidth="sm"
        fullWidth
      >
        <DialogTitle>
          {generatedKey ? 'Chiave API Generata' : 'Genera Nuova Chiave API'}
        </DialogTitle>
        <DialogContent>
          {generatedKey ? (
            <Box>
              <Alert severity="warning" sx={{ mb: 2 }}>
                <Typography variant="body2">
                  Copia questa chiave ora. Non sarà più visibile dopo aver chiuso questa finestra.
                </Typography>
              </Alert>
              <TextField
                fullWidth
                value={generatedKey}
                InputProps={{
                  readOnly: true,
                  endAdornment: (
                    <InputAdornment position="end">
                      <IconButton onClick={() => copyToClipboard(generatedKey)}>
                        <CopyIcon />
                      </IconButton>
                    </InputAdornment>
                  ),
                }}
              />
            </Box>
          ) : (
            <Box>
              <TextField
                fullWidth
                label="Nome della chiave"
                value={newApiKeyName}
                onChange={(e) => setNewApiKeyName(e.target.value)}
                placeholder="es. Integration Nessus"
                sx={{ mb: 2 }}
              />
              <TextField
                fullWidth
                select
                label="Scadenza"
                value={newApiKeyExpiry}
                onChange={(e) => setNewApiKeyExpiry(e.target.value)}
                SelectProps={{ native: true }}
              >
                <option value="30">30 giorni</option>
                <option value="90">90 giorni</option>
                <option value="180">180 giorni</option>
                <option value="365">1 anno</option>
                <option value="">Mai</option>
              </TextField>
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          <Button
            onClick={() => {
              setApiKeyDialog(false);
              setGeneratedKey(null);
              setNewApiKeyName('');
            }}
          >
            {generatedKey ? 'Chiudi' : 'Annulla'}
          </Button>
          {!generatedKey && (
            <Button
              variant="contained"
              onClick={handleCreateApiKey}
              disabled={!newApiKeyName.trim() || createApiKeyMutation.isPending}
            >
              Genera
            </Button>
          )}
        </DialogActions>
      </Dialog>

      {/* Change Password Dialog */}
      <Dialog open={passwordDialog} onClose={() => setPasswordDialog(false)}>
        <DialogTitle>Cambia Password</DialogTitle>
        <DialogContent>
          <TextField
            fullWidth
            type={showPasswords ? 'text' : 'password'}
            label="Password attuale"
            value={currentPassword}
            onChange={(e) => setCurrentPassword(e.target.value)}
            margin="normal"
            InputProps={{
              endAdornment: (
                <InputAdornment position="end">
                  <IconButton onClick={() => setShowPasswords(!showPasswords)}>
                    {showPasswords ? <VisibilityOffIcon /> : <VisibilityIcon />}
                  </IconButton>
                </InputAdornment>
              ),
            }}
          />
          <TextField
            fullWidth
            type={showPasswords ? 'text' : 'password'}
            label="Nuova password"
            value={newPassword}
            onChange={(e) => setNewPassword(e.target.value)}
            margin="normal"
            helperText="Minimo 8 caratteri"
          />
          <TextField
            fullWidth
            type={showPasswords ? 'text' : 'password'}
            label="Conferma nuova password"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            margin="normal"
            error={confirmPassword !== '' && newPassword !== confirmPassword}
            helperText={
              confirmPassword !== '' && newPassword !== confirmPassword
                ? 'Le password non corrispondono'
                : ''
            }
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setPasswordDialog(false)}>Annulla</Button>
          <Button
            variant="contained"
            onClick={handleChangePassword}
            disabled={
              !currentPassword ||
              !newPassword ||
              newPassword !== confirmPassword ||
              changePasswordMutation.isPending
            }
          >
            Cambia Password
          </Button>
        </DialogActions>
      </Dialog>

      {/* Snackbar */}
      <Snackbar
        open={snackbar.open}
        autoHideDuration={4000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}
      >
        <Alert
          onClose={() => setSnackbar({ ...snackbar, open: false })}
          severity={snackbar.severity}
          variant="filled"
        >
          {snackbar.message}
        </Alert>
      </Snackbar>
    </Container>
  );
};

export default Settings;
