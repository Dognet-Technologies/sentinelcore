// src/pages/NetworkDiscovery.tsx
import React, { useEffect, useRef, useState } from 'react';
import {
  Box,
  Paper,
  Typography,
  Button,
  TextField,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Card,
  CardContent,
  Chip,
  Grid,
  IconButton,
  Tooltip,
  CircularProgress,
  Alert,
  List,
  ListItem,
  ListItemText,
  Divider,
  LinearProgress,
} from '@mui/material';
import {
  PlayArrow as PlayIcon,
  ZoomIn as ZoomInIcon,
  ZoomOut as ZoomOutIcon,
  CenterFocusStrong as CenterIcon,
  Refresh as RefreshIcon,
  Computer as ComputerIcon,
  Router as RouterIcon,
  Print as PrintIcon,
  Security as SecurityIcon,
  Storage as StorageIcon,
} from '@mui/icons-material';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import cytoscape from 'cytoscape';
import { networkApi, NetworkDevice, NetworkTopology, StartScanRequest } from '../api/network';

const NetworkDiscovery: React.FC = () => {
  const queryClient = useQueryClient();
  const containerRef = useRef<HTMLDivElement>(null);
  const cyRef = useRef<cytoscape.Core | null>(null);

  const [selectedNode, setSelectedNode] = useState<NetworkDevice | null>(null);
  const [scanDialogOpen, setScanDialogOpen] = useState(false);
  const [scanFormData, setScanFormData] = useState<StartScanRequest>({
    scan_name: 'Network Scan',
    scan_type: 'arp',
    target_range: '192.168.1.0/24',
  });
  const [currentScanId, setCurrentScanId] = useState<string | null>(null);

  // Fetch topology
  const { data: topology, isLoading, refetch } = useQuery<NetworkTopology>({
    queryKey: ['network-topology'],
    queryFn: () => networkApi.getTopology(),
    refetchInterval: currentScanId ? 5000 : false, // Poll every 5s if scan is running
  });

  // Start scan mutation
  const startScanMutation = useMutation({
    mutationFn: (request: StartScanRequest) => networkApi.startScan(request),
    onSuccess: (data) => {
      setCurrentScanId(data.scan_id);
      setScanDialogOpen(false);
    },
  });

  // Poll scan status
  const { data: scanStatus } = useQuery({
    queryKey: ['scan-status', currentScanId],
    queryFn: () => networkApi.getScanStatus(currentScanId!),
    enabled: !!currentScanId,
    refetchInterval: 2000, // Poll every 2s
  });

  // Stop polling when scan is complete
  useEffect(() => {
    if (scanStatus && (scanStatus.status === 'completed' || scanStatus.status === 'failed')) {
      setCurrentScanId(null);
      refetch(); // Refresh topology
    }
  }, [scanStatus, refetch]);

  // Render topology with Cytoscape
  useEffect(() => {
    if (!containerRef.current || !topology || topology.devices.length === 0) return;

    // Prepare nodes
    const nodes = topology.devices.map((device) => ({
      data: {
        id: device.id,
        label: device.hostname || device.ip_address,
        device,
      },
      classes: device.device_type,
    }));

    // Prepare edges
    const edges = topology.links.map((link) => ({
      data: {
        id: link.id,
        source: link.source_device_id,
        target: link.target_device_id,
        label: link.link_type,
      },
    }));

    // Initialize Cytoscape
    const cy = cytoscape({
      container: containerRef.current,
      elements: [...nodes, ...edges],
      style: [
        {
          selector: 'node',
          style: {
            label: 'data(label)',
            'text-valign': 'center',
            'text-halign': 'center',
            'background-color': '#666',
            color: '#fff',
            'text-outline-color': '#666',
            'text-outline-width': 2,
            'font-size': 10,
            width: 50,
            height: 50,
          },
        },
        {
          selector: 'node.router',
          style: {
            'background-color': '#2196F3',
            shape: 'triangle',
            width: 60,
            height: 60,
          },
        },
        {
          selector: 'node.switch',
          style: {
            'background-color': '#00BCD4',
            shape: 'rectangle',
          },
        },
        {
          selector: 'node.firewall',
          style: {
            'background-color': '#F44336',
            shape: 'diamond',
          },
        },
        {
          selector: 'node.server',
          style: {
            'background-color': '#4CAF50',
            shape: 'round-rectangle',
          },
        },
        {
          selector: 'node.workstation',
          style: {
            'background-color': '#FF9800',
            shape: 'ellipse',
          },
        },
        {
          selector: 'node.printer',
          style: {
            'background-color': '#9C27B0',
            shape: 'octagon',
          },
        },
        {
          selector: 'node.iot',
          style: {
            'background-color': '#E91E63',
            shape: 'star',
          },
        },
        {
          selector: 'node.unknown',
          style: {
            'background-color': '#9E9E9E',
            shape: 'ellipse',
          },
        },
        {
          selector: 'edge',
          style: {
            width: 2,
            'line-color': '#ccc',
            'target-arrow-color': '#ccc',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            label: 'data(label)',
            'font-size': 8,
            'text-rotation': 'autorotate',
          },
        },
        {
          selector: ':selected',
          style: {
            'background-color': '#FF5722',
            'line-color': '#FF5722',
            'target-arrow-color': '#FF5722',
            'border-width': 3,
            'border-color': '#FF5722',
          },
        },
      ],
      layout: {
        name: 'cose',
        animate: true,
        animationDuration: 1000,
        nodeRepulsion: () => 10000,
        idealEdgeLength: () => 150,
        edgeElasticity: () => 100,
        nestingFactor: 5,
        gravity: 80,
        numIter: 1000,
        initialTemp: 200,
        coolingFactor: 0.95,
        minTemp: 1.0,
      },
    });

    // Event handlers
    cy.on('tap', 'node', (event) => {
      const node = event.target;
      setSelectedNode(node.data('device'));
    });

    // Store reference
    cyRef.current = cy;

    return () => {
      cy.destroy();
    };
  }, [topology]);

  const handleZoomIn = () => {
    if (cyRef.current) {
      cyRef.current.zoom(cyRef.current.zoom() * 1.2);
    }
  };

  const handleZoomOut = () => {
    if (cyRef.current) {
      cyRef.current.zoom(cyRef.current.zoom() * 0.8);
    }
  };

  const handleCenter = () => {
    if (cyRef.current) {
      cyRef.current.fit();
    }
  };

  const handleStartScan = () => {
    startScanMutation.mutate(scanFormData);
  };

  const getDeviceIcon = (type: string) => {
    switch (type) {
      case 'router':
        return <RouterIcon />;
      case 'server':
        return <StorageIcon />;
      case 'printer':
        return <PrintIcon />;
      case 'firewall':
        return <SecurityIcon />;
      default:
        return <ComputerIcon />;
    }
  };

  const getDeviceTypeColor = (type: string): string => {
    const colors: Record<string, string> = {
      router: '#2196F3',
      switch: '#00BCD4',
      firewall: '#F44336',
      server: '#4CAF50',
      workstation: '#FF9800',
      printer: '#9C27B0',
      iot: '#E91E63',
      unknown: '#9E9E9E',
    };
    return colors[type] || colors.unknown;
  };

  return (
    <Box sx={{ p: 3, height: 'calc(100vh - 100px)' }}>
      {/* Header */}
      <Box sx={{ mb: 3, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <Box>
          <Typography variant="h4" fontWeight="bold">
            Network Discovery
          </Typography>
          <Typography variant="body2" color="text.secondary">
            Scansione e visualizzazione topologia di rete
          </Typography>
        </Box>
        <Box sx={{ display: 'flex', gap: 2 }}>
          <Button
            variant="contained"
            startIcon={<PlayIcon />}
            onClick={() => setScanDialogOpen(true)}
            disabled={!!currentScanId}
          >
            Nuova Scansione
          </Button>
          <Button
            variant="outlined"
            startIcon={<RefreshIcon />}
            onClick={() => refetch()}
            disabled={isLoading}
          >
            Aggiorna
          </Button>
        </Box>
      </Box>

      {/* Scan Progress */}
      {currentScanId && scanStatus && (
        <Alert severity="info" sx={{ mb: 2 }}>
          <Typography variant="body2">
            Scansione in corso: {scanStatus.status} - Dispositivi trovati: {scanStatus.devices_found}
          </Typography>
          <LinearProgress variant="determinate" value={scanStatus.progress_percent} sx={{ mt: 1 }} />
        </Alert>
      )}

      {/* Scan Info */}
      {topology?.scan_info && (
        <Paper sx={{ p: 2, mb: 2 }}>
          <Grid container spacing={2}>
            <Grid item xs={12} sm={3}>
              <Typography variant="caption" color="text.secondary">
                Ultima Scansione
              </Typography>
              <Typography variant="body1">{topology.scan_info.scan_name}</Typography>
            </Grid>
            <Grid item xs={12} sm={3}>
              <Typography variant="caption" color="text.secondary">
                Range
              </Typography>
              <Typography variant="body1">{topology.scan_info.target_range}</Typography>
            </Grid>
            <Grid item xs={12} sm={3}>
              <Typography variant="caption" color="text.secondary">
                Dispositivi
              </Typography>
              <Typography variant="body1">{topology.scan_info.devices_found}</Typography>
            </Grid>
            <Grid item xs={12} sm={3}>
              <Typography variant="caption" color="text.secondary">
                Status
              </Typography>
              <Chip
                label={topology.scan_info.status}
                size="small"
                color={topology.scan_info.status === 'completed' ? 'success' : 'default'}
              />
            </Grid>
          </Grid>
        </Paper>
      )}

      {/* Main Content */}
      <Grid container spacing={2} sx={{ height: 'calc(100% - 200px)' }}>
        {/* Topology View */}
        <Grid item xs={12} md={selectedNode ? 9 : 12}>
          <Paper sx={{ height: '100%', position: 'relative' }}>
            {/* Controls */}
            <Box
              sx={{
                position: 'absolute',
                top: 10,
                right: 10,
                zIndex: 1,
                display: 'flex',
                gap: 1,
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderRadius: 1,
                p: 0.5,
              }}
            >
              <Tooltip title="Zoom In">
                <IconButton onClick={handleZoomIn} size="small">
                  <ZoomInIcon />
                </IconButton>
              </Tooltip>
              <Tooltip title="Zoom Out">
                <IconButton onClick={handleZoomOut} size="small">
                  <ZoomOutIcon />
                </IconButton>
              </Tooltip>
              <Tooltip title="Center">
                <IconButton onClick={handleCenter} size="small">
                  <CenterIcon />
                </IconButton>
              </Tooltip>
            </Box>

            {/* Legend */}
            <Box
              sx={{
                position: 'absolute',
                bottom: 10,
                left: 10,
                zIndex: 1,
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderRadius: 1,
                p: 1.5,
                maxWidth: 200,
              }}
            >
              <Typography variant="caption" fontWeight="bold" gutterBottom display="block">
                Legenda
              </Typography>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                {['router', 'server', 'workstation', 'printer', 'firewall'].map((type) => (
                  <Box key={type} sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                    <Box
                      sx={{
                        width: 12,
                        height: 12,
                        backgroundColor: getDeviceTypeColor(type),
                        borderRadius: '50%',
                      }}
                    />
                    <Typography variant="caption" sx={{ textTransform: 'capitalize' }}>
                      {type}
                    </Typography>
                  </Box>
                ))}
              </Box>
            </Box>

            {/* Cytoscape Container */}
            <Box
              ref={containerRef}
              sx={{
                width: '100%',
                height: '100%',
                minHeight: 500,
              }}
            />

            {/* Loading Overlay */}
            {isLoading && (
              <Box
                sx={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  backgroundColor: 'rgba(255, 255, 255, 0.8)',
                }}
              >
                <Box sx={{ textAlign: 'center' }}>
                  <CircularProgress />
                  <Typography sx={{ mt: 2 }}>Caricamento topologia...</Typography>
                </Box>
              </Box>
            )}

            {/* Empty State */}
            {!isLoading && topology && topology.devices.length === 0 && (
              <Box
                sx={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                }}
              >
                <Box sx={{ textAlign: 'center' }}>
                  <ComputerIcon sx={{ fontSize: 60, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="h6" color="text.secondary" gutterBottom>
                    Nessun dispositivo trovato
                  </Typography>
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
                    Avvia una nuova scansione per scoprire i dispositivi di rete
                  </Typography>
                  <Button variant="contained" startIcon={<PlayIcon />} onClick={() => setScanDialogOpen(true)}>
                    Avvia Scansione
                  </Button>
                </Box>
              </Box>
            )}
          </Paper>
        </Grid>

        {/* Device Details Panel */}
        {selectedNode && (
          <Grid item xs={12} md={3}>
            <Card sx={{ height: '100%', overflow: 'auto' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>
                  {getDeviceIcon(selectedNode.device_type)}
                  <Typography variant="h6">Device Details</Typography>
                </Box>

                <Divider sx={{ mb: 2 }} />

                <List dense>
                  <ListItem>
                    <ListItemText primary="IP Address" secondary={selectedNode.ip_address} />
                  </ListItem>
                  {selectedNode.hostname && (
                    <ListItem>
                      <ListItemText primary="Hostname" secondary={selectedNode.hostname} />
                    </ListItem>
                  )}
                  {selectedNode.mac_address && (
                    <ListItem>
                      <ListItemText primary="MAC Address" secondary={selectedNode.mac_address} />
                    </ListItem>
                  )}
                  <ListItem>
                    <ListItemText
                      primary="Device Type"
                      secondary={
                        <Chip
                          label={selectedNode.device_type}
                          size="small"
                          sx={{ backgroundColor: getDeviceTypeColor(selectedNode.device_type), color: 'white' }}
                        />
                      }
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText primary="Status" secondary={selectedNode.device_status} />
                  </ListItem>
                  {selectedNode.vendor && (
                    <ListItem>
                      <ListItemText primary="Vendor" secondary={selectedNode.vendor} />
                    </ListItem>
                  )}
                  {selectedNode.os_name && (
                    <ListItem>
                      <ListItemText primary="OS" secondary={selectedNode.os_name} />
                    </ListItem>
                  )}
                  {selectedNode.open_ports && selectedNode.open_ports.length > 0 && (
                    <ListItem>
                      <ListItemText
                        primary="Open Ports"
                        secondary={selectedNode.open_ports.slice(0, 10).join(', ') + (selectedNode.open_ports.length > 10 ? '...' : '')}
                      />
                    </ListItem>
                  )}
                </List>

                {selectedNode.services && Object.keys(selectedNode.services).length > 0 && (
                  <>
                    <Typography variant="subtitle2" sx={{ mt: 2, mb: 1 }}>
                      Services
                    </Typography>
                    <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                      {Object.entries(selectedNode.services).slice(0, 5).map(([port, service]) => (
                        <Chip
                          key={port}
                          label={`${port}: ${service.name}`}
                          size="small"
                          variant="outlined"
                        />
                      ))}
                    </Box>
                  </>
                )}
              </CardContent>
            </Card>
          </Grid>
        )}
      </Grid>

      {/* Scan Dialog */}
      <Dialog open={scanDialogOpen} onClose={() => setScanDialogOpen(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Nuova Scansione di Rete</DialogTitle>
        <DialogContent>
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
            <TextField
              label="Nome Scansione"
              value={scanFormData.scan_name}
              onChange={(e) => setScanFormData({ ...scanFormData, scan_name: e.target.value })}
              fullWidth
            />
            <TextField
              label="Tipo Scansione"
              select
              SelectProps={{ native: true }}
              value={scanFormData.scan_type}
              onChange={(e) => setScanFormData({ ...scanFormData, scan_type: e.target.value })}
              fullWidth
            >
              <option value="arp">ARP Scan</option>
              <option value="nmap">Nmap Scan</option>
            </TextField>
            <TextField
              label="Range Target"
              value={scanFormData.target_range}
              onChange={(e) => setScanFormData({ ...scanFormData, target_range: e.target.value })}
              placeholder="192.168.1.0/24"
              helperText="Inserisci il range di IP da scansionare (CIDR notation)"
              fullWidth
            />
          </Box>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setScanDialogOpen(false)}>Annulla</Button>
          <Button
            onClick={handleStartScan}
            variant="contained"
            disabled={startScanMutation.isPending}
            startIcon={startScanMutation.isPending ? <CircularProgress size={20} /> : <PlayIcon />}
          >
            Avvia Scansione
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};

export default NetworkDiscovery;
