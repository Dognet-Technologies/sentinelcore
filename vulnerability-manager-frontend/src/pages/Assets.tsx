// src/pages/Assets.tsx
import React, { useState } from 'react';
import {
  Box,
  Paper,
  Typography,
  Button,
  IconButton,
  TextField,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Chip,
  Alert,
  CircularProgress,
  MenuItem,
  FormControl,
  InputLabel,
  Select,
  Tooltip,
  Grid,
  Snackbar,
} from '@mui/material';
import {
  Add as AddIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Computer as ComputerIcon,
  Storage as StorageIcon,
  Cloud as CloudIcon,
  Router as RouterIcon,
  Dns as DnsIcon,
  Security as SecurityIcon,
} from '@mui/icons-material';
import { DataGrid, GridColDef } from '@mui/x-data-grid';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { format } from 'date-fns';

import { assetsApi } from '../api/assets';
import { useAuth } from '../contexts/AuthContext';
import { Asset } from '../types';

const assetTypes = [
  { value: 'server', label: 'Server', icon: <StorageIcon /> },
  { value: 'workstation', label: 'Workstation', icon: <ComputerIcon /> },
  { value: 'network', label: 'Network Device', icon: <RouterIcon /> },
  { value: 'cloud', label: 'Cloud Resource', icon: <CloudIcon /> },
  { value: 'database', label: 'Database', icon: <DnsIcon /> },
  { value: 'application', label: 'Application', icon: <SecurityIcon /> },
];

const criticalities = ['critical', 'high', 'medium', 'low'];

interface AssetFormData {
  name: string;
  asset_type: string;
  ip_address: string;
  hostname: string;
  description: string;
  criticality: string;
  owner: string;
  location: string;
}

const initialFormData: AssetFormData = {
  name: '',
  asset_type: 'server',
  ip_address: '',
  hostname: '',
  description: '',
  criticality: 'medium',
  owner: '',
  location: '',
};

const Assets: React.FC = () => {
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const isAdmin = user?.role === 'admin';

  const [formOpen, setFormOpen] = useState(false);
  const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null);
  const [formData, setFormData] = useState<AssetFormData>(initialFormData);
  const [formErrors, setFormErrors] = useState<{ name?: string; ip_address?: string }>({});
  const [error, setError] = useState<string | null>(null);
  const [snackbar, setSnackbar] = useState<{ open: boolean; message: string; severity: 'success' | 'error' }>({
    open: false,
    message: '',
    severity: 'success',
  });

  // Fetch assets
  const { data: assets = [], isLoading } = useQuery({
    queryKey: ['assets'],
    queryFn: () => assetsApi.list(),
  });

  // Create mutation
  const createMutation = useMutation({
    mutationFn: assetsApi.create,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['assets'] });
      setSnackbar({ open: true, message: 'Asset creato con successo', severity: 'success' });
      handleCloseForm();
    },
    onError: (err: any) => {
      setSnackbar({ open: true, message: err.response?.data?.error || 'Errore nella creazione dell\'asset', severity: 'error' });
    },
  });

  // Update mutation
  const updateMutation = useMutation({
    mutationFn: ({ id, data }: { id: string; data: Partial<Asset> }) =>
      assetsApi.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['assets'] });
      setSnackbar({ open: true, message: 'Asset aggiornato con successo', severity: 'success' });
      handleCloseForm();
    },
    onError: (err: any) => {
      setSnackbar({ open: true, message: err.response?.data?.error || 'Errore nell\'aggiornamento dell\'asset', severity: 'error' });
    },
  });

  // Delete mutation
  const deleteMutation = useMutation({
    mutationFn: assetsApi.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['assets'] });
      setSnackbar({ open: true, message: 'Asset eliminato con successo', severity: 'success' });
    },
    onError: (err: any) => {
      setSnackbar({ open: true, message: err.response?.data?.error || 'Errore nell\'eliminazione dell\'asset', severity: 'error' });
    },
  });

  const handleOpenForm = (asset?: Asset) => {
    if (asset) {
      setSelectedAsset(asset);
      setFormData({
        name: asset.name || '',
        asset_type: asset.asset_type || 'server',
        ip_address: asset.ip_address || '',
        hostname: asset.hostname || '',
        description: asset.description || '',
        criticality: asset.criticality || 'medium',
        owner: asset.owner || '',
        location: asset.location || '',
      });
    } else {
      setSelectedAsset(null);
      setFormData(initialFormData);
    }
    setError(null);
    setFormOpen(true);
  };

  const handleCloseForm = () => {
    setFormOpen(false);
    setSelectedAsset(null);
    setFormData(initialFormData);
    setFormErrors({});
    setError(null);
  };

  const validateForm = (): boolean => {
    const errors: typeof formErrors = {};

    if (!formData.name.trim()) {
      errors.name = 'Nome asset obbligatorio';
    } else if (formData.name.length < 2) {
      errors.name = 'Nome deve essere almeno 2 caratteri';
    } else if (formData.name.length > 100) {
      errors.name = 'Nome non puÃ² superare 100 caratteri';
    }

    // IP address validation (optional but if provided must be valid)
    if (formData.ip_address) {
      const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      if (!ipRegex.test(formData.ip_address)) {
        errors.ip_address = 'Formato IP non valido (es. 192.168.1.100)';
      }
    }

    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleSubmit = () => {
    if (!validateForm()) {
      return;
    }

    if (selectedAsset) {
      updateMutation.mutate({ id: selectedAsset.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const handleDelete = (id: string) => {
    if (window.confirm('Are you sure you want to delete this asset?')) {
      deleteMutation.mutate(id);
    }
  };

  const getAssetIcon = (type: string) => {
    const found = assetTypes.find(t => t.value === type);
    return found?.icon || <ComputerIcon />;
  };

  const getCriticalityColor = (criticality: string) => {
    switch (criticality) {
      case 'critical': return 'error';
      case 'high': return 'warning';
      case 'medium': return 'info';
      case 'low': return 'success';
      default: return 'default';
    }
  };

  const columns: GridColDef[] = [
    {
      field: 'name',
      headerName: 'Asset Name',
      flex: 1,
      minWidth: 200,
      renderCell: (params) => (
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
          {getAssetIcon(params.row.asset_type)}
          <Typography fontWeight="medium">{params.value}</Typography>
        </Box>
      ),
    },
    {
      field: 'asset_type',
      headerName: 'Type',
      width: 130,
      renderCell: (params) => (
        <Chip
          label={params.value}
          size="small"
          variant="outlined"
        />
      ),
    },
    {
      field: 'ip_address',
      headerName: 'IP Address',
      width: 140,
    },
    {
      field: 'hostname',
      headerName: 'Hostname',
      width: 150,
    },
    {
      field: 'criticality',
      headerName: 'Criticality',
      width: 120,
      renderCell: (params) => (
        <Chip
          label={params.value}
          size="small"
          color={getCriticalityColor(params.value) as any}
        />
      ),
    },
    {
      field: 'owner',
      headerName: 'Owner',
      width: 130,
    },
    {
      field: 'vulnerability_count',
      headerName: 'Vulns',
      width: 80,
      align: 'center',
      renderCell: (params) => (
        <Chip
          label={params.value || 0}
          size="small"
          color={params.value > 0 ? 'error' : 'default'}
          variant="outlined"
        />
      ),
    },
    {
      field: 'created_at',
      headerName: 'Created',
      width: 120,
      valueFormatter: (params: any) => {
        if (!params) return '';
        try {
          return format(new Date(params), 'MMM dd, yyyy');
        } catch {
          return params;
        }
      },
    },
    {
      field: 'actions',
      headerName: 'Actions',
      width: 120,
      sortable: false,
      renderCell: (params) => (
        <Box>
          {isAdmin && (
            <>
              <Tooltip title="Edit">
                <IconButton
                  size="small"
                  onClick={() => handleOpenForm(params.row)}
                >
                  <EditIcon />
                </IconButton>
              </Tooltip>
              <Tooltip title="Delete">
                <IconButton
                  size="small"
                  color="error"
                  onClick={() => handleDelete(params.row.id)}
                >
                  <DeleteIcon />
                </IconButton>
              </Tooltip>
            </>
          )}
        </Box>
      ),
    },
  ];

  if (isLoading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '50vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  return (
    <Box sx={{ p: 3 }}>
      {/* Header */}
      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>
        <Box>
          <Typography variant="h4" fontWeight="bold">
            Assets
          </Typography>
          <Typography variant="body2" color="text.secondary">
            Manage your organization's IT assets
          </Typography>
        </Box>
        {isAdmin && (
          <Button
            variant="contained"
            startIcon={<AddIcon />}
            onClick={() => handleOpenForm()}
          >
            Add Asset
          </Button>
        )}
      </Box>

      {error && (
        <Alert severity="error" sx={{ mb: 2 }} onClose={() => setError(null)}>
          {error}
        </Alert>
      )}

      {/* Assets Grid */}
      <Paper sx={{ height: 600 }}>
        <DataGrid
          rows={assets}
          columns={columns}
          pageSizeOptions={[10, 25, 50]}
          initialState={{
            pagination: { paginationModel: { pageSize: 10 } },
          }}
          disableRowSelectionOnClick
        />
      </Paper>

      {/* Create/Edit Dialog */}
      <Dialog open={formOpen} onClose={handleCloseForm} maxWidth="md" fullWidth>
        <DialogTitle>
          {selectedAsset ? 'Edit Asset' : 'Add New Asset'}
        </DialogTitle>
        <DialogContent>
          <Grid container spacing={2} sx={{ pt: 2 }}>
            <Grid item xs={12} md={6}>
              <TextField
                label="Nome Asset"
                value={formData.name}
                onChange={(e) => {
                  setFormData({ ...formData, name: e.target.value });
                  if (formErrors.name) setFormErrors({ ...formErrors, name: undefined });
                }}
                fullWidth
                required
                error={!!formErrors.name}
                helperText={formErrors.name}
              />
            </Grid>
            <Grid item xs={12} md={6}>
              <FormControl fullWidth>
                <InputLabel>Asset Type</InputLabel>
                <Select
                  value={formData.asset_type}
                  label="Asset Type"
                  onChange={(e) => setFormData({ ...formData, asset_type: e.target.value })}
                >
                  {assetTypes.map((type) => (
                    <MenuItem key={type.value} value={type.value}>
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        {type.icon}
                        {type.label}
                      </Box>
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
            <Grid item xs={12} md={6}>
              <TextField
                label="Indirizzo IP"
                value={formData.ip_address}
                onChange={(e) => {
                  setFormData({ ...formData, ip_address: e.target.value });
                  if (formErrors.ip_address) setFormErrors({ ...formErrors, ip_address: undefined });
                }}
                fullWidth
                placeholder="192.168.1.100"
                error={!!formErrors.ip_address}
                helperText={formErrors.ip_address}
              />
            </Grid>
            <Grid item xs={12} md={6}>
              <TextField
                label="Hostname"
                value={formData.hostname}
                onChange={(e) => setFormData({ ...formData, hostname: e.target.value })}
                fullWidth
                placeholder="server-01.local"
              />
            </Grid>
            <Grid item xs={12} md={6}>
              <FormControl fullWidth>
                <InputLabel>Criticality</InputLabel>
                <Select
                  value={formData.criticality}
                  label="Criticality"
                  onChange={(e) => setFormData({ ...formData, criticality: e.target.value })}
                >
                  {criticalities.map((c) => (
                    <MenuItem key={c} value={c}>
                      <Chip label={c} size="small" color={getCriticalityColor(c) as any} />
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
            <Grid item xs={12} md={6}>
              <TextField
                label="Owner"
                value={formData.owner}
                onChange={(e) => setFormData({ ...formData, owner: e.target.value })}
                fullWidth
                placeholder="IT Department"
              />
            </Grid>
            <Grid item xs={12} md={6}>
              <TextField
                label="Location"
                value={formData.location}
                onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                fullWidth
                placeholder="Data Center A"
              />
            </Grid>
            <Grid item xs={12}>
              <TextField
                label="Description"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                fullWidth
                multiline
                rows={3}
              />
            </Grid>
          </Grid>
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseForm}>Cancel</Button>
          <Button
            variant="contained"
            onClick={handleSubmit}
            disabled={createMutation.isPending || updateMutation.isPending}
          >
            {selectedAsset ? 'Update' : 'Create'}
          </Button>
        </DialogActions>
      </Dialog>

      <Snackbar
        open={snackbar.open}
        autoHideDuration={4000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}
      >
        <Alert
          onClose={() => setSnackbar({ ...snackbar, open: false })}
          severity={snackbar.severity}
          variant="filled"
        >
          {snackbar.message}
        </Alert>
      </Snackbar>
    </Box>
  );
};

export default Assets;
