// src/pages/NotificationRules.tsx
import React, { useState } from 'react';
import {
  Box,
  Container,
  Typography,
  Button,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  IconButton,
  Switch,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControlLabel,
  Checkbox,
  Alert
} from '@mui/material';
import { Add, Edit, Delete, PlayArrow } from '@mui/icons-material';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { notificationsApi, CreateNotificationRuleRequest } from '../api/notifications';

export const NotificationRulesPage: React.FC = () => {
  const [open, setOpen] = useState(false);
  const [editingRule, setEditingRule] = useState<any>(null);
  const queryClient = useQueryClient();

  const { data: rules, isLoading } = useQuery({
    queryKey: ['notification-rules'],
    queryFn: () => notificationsApi.listRules(),
  });

  const { data: channels } = useQuery({
    queryKey: ['notification-channels'],
    queryFn: () => notificationsApi.listChannels(),
  });

  const createMutation = useMutation({
    mutationFn: (payload: CreateNotificationRuleRequest) => notificationsApi.createRule(payload),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['notification-rules'] });
      setOpen(false);
      setEditingRule(null);
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (ruleId: string) => notificationsApi.deleteRule(ruleId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['notification-rules'] });
    },
  });

  const [formData, setFormData] = useState<CreateNotificationRuleRequest>({
    name: '',
    description: '',
    priority: 100,
    is_enabled: true,
    conditions: {},
    channels: [],
    immediate: true,
    throttle_minutes: 0,
    include_details: true,
  });

  const handleSubmit = () => {
    createMutation.mutate(formData);
  };

  return (
    <Container maxWidth="xl">
      <Box sx={{ py: 4 }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 3 }}>
          <Typography variant="h4">Notification Rules</Typography>
          <Button
            variant="contained"
            startIcon={<Add />}
            onClick={() => setOpen(true)}
          >
            Create Rule
          </Button>
        </Box>

        <Alert severity="info" sx={{ mb: 3 }}>
          Configure intelligent notification routing based on vulnerability severity, risk score, and other conditions.
        </Alert>

        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Name</TableCell>
                <TableCell>Priority</TableCell>
                <TableCell>Channels</TableCell>
                <TableCell>Enabled</TableCell>
                <TableCell>Immediate</TableCell>
                <TableCell>Actions</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {rules?.map((rule) => (
                <TableRow key={rule.id}>
                  <TableCell>
                    <Typography variant="body2" fontWeight="bold">
                      {rule.name}
                    </Typography>
                    <Typography variant="caption" color="text.secondary">
                      {rule.description}
                    </Typography>
                  </TableCell>
                  <TableCell>
                    <Chip label={rule.priority} size="small" />
                  </TableCell>
                  <TableCell>
                    {rule.channels.length} channel(s)
                  </TableCell>
                  <TableCell>
                    <Chip
                      label={rule.is_enabled ? 'Enabled' : 'Disabled'}
                      color={rule.is_enabled ? 'success' : 'default'}
                      size="small"
                    />
                  </TableCell>
                  <TableCell>
                    <Chip
                      label={rule.immediate ? 'Immediate' : 'Batch'}
                      size="small"
                      color={rule.immediate ? 'primary' : 'default'}
                    />
                  </TableCell>
                  <TableCell>
                    <IconButton size="small" onClick={() => { setEditingRule(rule); setOpen(true); }}>
                      <Edit fontSize="small" />
                    </IconButton>
                    <IconButton size="small" onClick={() => deleteMutation.mutate(rule.id)}>
                      <Delete fontSize="small" />
                    </IconButton>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>

        {/* Create/Edit Dialog */}
        <Dialog open={open} onClose={() => setOpen(false)} maxWidth="md" fullWidth>
          <DialogTitle>{editingRule ? 'Edit Rule' : 'Create Notification Rule'}</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 2 }}>
              <TextField
                label="Rule Name"
                fullWidth
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              />
              <TextField
                label="Description"
                fullWidth
                multiline
                rows={2}
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              />
              <TextField
                label="Priority"
                type="number"
                fullWidth
                value={formData.priority}
                onChange={(e) => setFormData({ ...formData, priority: parseInt(e.target.value) })}
                helperText="Lower number = higher priority"
              />
              <FormControlLabel
                control={
                  <Checkbox
                    checked={formData.is_enabled}
                    onChange={(e) => setFormData({ ...formData, is_enabled: e.target.checked })}
                  />
                }
                label="Enabled"
              />
              <FormControlLabel
                control={
                  <Checkbox
                    checked={formData.immediate}
                    onChange={(e) => setFormData({ ...formData, immediate: e.target.checked })}
                  />
                }
                label="Send Immediately"
              />
              <TextField
                label="Throttle (minutes)"
                type="number"
                fullWidth
                value={formData.throttle_minutes}
                onChange={(e) => setFormData({ ...formData, throttle_minutes: parseInt(e.target.value) })}
                helperText="Minimum time between notifications for same condition"
              />
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setOpen(false)}>Cancel</Button>
            <Button
              variant="contained"
              onClick={handleSubmit}
              disabled={!formData.name || createMutation.isPending}
            >
              {createMutation.isPending ? 'Saving...' : 'Save'}
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </Container>
  );
};
