// src/pages/WorkloadDashboard.tsx
// P5: Workload tracking and resolver metrics dashboard

import React, { useState } from 'react';
import {
  Box,
  Paper,
  Typography,
  Grid,
  Card,
  CardContent,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  LinearProgress,
  Tabs,
  Tab,
  Avatar,
  List,
  ListItem,
  ListItemAvatar,
  ListItemText,
} from '@mui/material';
import {
  Person as PersonIcon,
  Group as GroupIcon,
  Assignment as AssignmentIcon,
  BugReport as BugReportIcon,
  CheckCircle as CheckCircleIcon,
  Schedule as ScheduleIcon,
} from '@mui/icons-material';
import { useQuery } from '@tanstack/react-query';
import { workloadApi, UserWorkload, TeamWorkload } from '../api/workload';

const WorkloadDashboard: React.FC = () => {
  const [activeTab, setActiveTab] = useState(0);

  // Fetch my workload
  const { data: myWorkload, isLoading: myWorkloadLoading } = useQuery<UserWorkload>({
    queryKey: ['my-workload'],
    queryFn: () => workloadApi.getMyWorkload(),
  });

  // Fetch all users' workload (admin)
  const { data: usersWorkload, isLoading: usersLoading } = useQuery<UserWorkload[]>({
    queryKey: ['users-workload'],
    queryFn: () => workloadApi.listUsersWorkload(),
  });

  // Fetch all teams' workload
  const { data: teamsWorkload, isLoading: teamsLoading } = useQuery<TeamWorkload[]>({
    queryKey: ['teams-workload'],
    queryFn: () => workloadApi.listTeamsWorkload(),
  });

  const getVulnerabilityProgress = (workload: UserWorkload): number => {
    const total = workload.total_vulnerabilities;
    if (total === 0) return 100;
    const resolved = workload.resolved_vulnerabilities + workload.closed_vulnerabilities;
    return (resolved / total) * 100;
  };

  const getSeverityColor = (severity: string): string => {
    const colors: Record<string, string> = {
      critical: '#D32F2F',
      high: '#FF6F00',
      medium: '#FFA000',
      low: '#1976D2',
    };
    return colors[severity] || '#9E9E9E';
  };

  return (
    <Box sx={{ p: 3 }}>
      {/* Header */}
      <Box sx={{ mb: 3 }}>
        <Typography variant="h4" fontWeight="bold" gutterBottom>
          Workload Dashboard
        </Typography>
        <Typography variant="body2" color="text.secondary">
          Track team and individual remediation progress
        </Typography>
      </Box>

      {/* My Workload Summary */}
      {myWorkload && (
        <Grid container spacing={3} sx={{ mb: 3 }}>
          <Grid item xs={12} sm={6} md={3}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                  <AssignmentIcon color="primary" />
                  <Typography variant="caption" color="text.secondary">
                    Assigned Devices
                  </Typography>
                </Box>
                <Typography variant="h4">{myWorkload.assigned_devices}</Typography>
              </CardContent>
            </Card>
          </Grid>

          <Grid item xs={12} sm={6} md={3}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                  <BugReportIcon color="error" />
                  <Typography variant="caption" color="text.secondary">
                    Total Vulnerabilities
                  </Typography>
                </Box>
                <Typography variant="h4">{myWorkload.total_vulnerabilities}</Typography>
                <Box sx={{ display: 'flex', gap: 0.5, mt: 1 }}>
                  {myWorkload.critical_count > 0 && (
                    <Chip label={`${myWorkload.critical_count} C`} size="small" sx={{ bgcolor: '#D32F2F', color: 'white' }} />
                  )}
                  {myWorkload.high_count > 0 && (
                    <Chip label={`${myWorkload.high_count} H`} size="small" sx={{ bgcolor: '#FF6F00', color: 'white' }} />
                  )}
                </Box>
              </CardContent>
            </Card>
          </Grid>

          <Grid item xs={12} sm={6} md={3}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                  <CheckCircleIcon color="success" />
                  <Typography variant="caption" color="text.secondary">
                    Resolved
                  </Typography>
                </Box>
                <Typography variant="h4">{myWorkload.resolved_vulnerabilities + myWorkload.closed_vulnerabilities}</Typography>
                <LinearProgress
                  variant="determinate"
                  value={getVulnerabilityProgress(myWorkload)}
                  sx={{ mt: 1 }}
                  color="success"
                />
              </CardContent>
            </Card>
          </Grid>

          <Grid item xs={12} sm={6} md={3}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                  <ScheduleIcon color="info" />
                  <Typography variant="caption" color="text.secondary">
                    Avg Resolution Time
                  </Typography>
                </Box>
                <Typography variant="h4">
                  {myWorkload.avg_resolution_hours ? `${myWorkload.avg_resolution_hours.toFixed(1)}h` : 'N/A'}
                </Typography>
              </CardContent>
            </Card>
          </Grid>
        </Grid>
      )}

      {/* Tabs */}
      <Paper sx={{ mb: 3 }}>
        <Tabs value={activeTab} onChange={(_, newValue) => setActiveTab(newValue)}>
          <Tab icon={<PersonIcon />} label="Users" />
          <Tab icon={<GroupIcon />} label="Teams" />
        </Tabs>
      </Paper>

      {/* Users Table */}
      {activeTab === 0 && (
        <Paper>
          <TableContainer>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>User</TableCell>
                  <TableCell align="right">Devices</TableCell>
                  <TableCell align="right">Total Vulns</TableCell>
                  <TableCell align="right">Critical</TableCell>
                  <TableCell align="right">High</TableCell>
                  <TableCell align="right">Open</TableCell>
                  <TableCell align="right">Resolved</TableCell>
                  <TableCell align="right">Progress</TableCell>
                  <TableCell align="right">Avg Time</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {usersLoading && (
                  <TableRow>
                    <TableCell colSpan={9} align="center">
                      <LinearProgress />
                    </TableCell>
                  </TableRow>
                )}
                {usersWorkload?.map((user) => (
                  <TableRow key={user.user_id} hover>
                    <TableCell>
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Avatar sx={{ width: 32, height: 32 }}>
                          {user.username.charAt(0).toUpperCase()}
                        </Avatar>
                        <Box>
                          <Typography variant="body2" fontWeight="medium">
                            {user.username}
                          </Typography>
                          <Typography variant="caption" color="text.secondary">
                            {user.role}
                          </Typography>
                        </Box>
                      </Box>
                    </TableCell>
                    <TableCell align="right">{user.assigned_devices}</TableCell>
                    <TableCell align="right">{user.total_vulnerabilities}</TableCell>
                    <TableCell align="right">
                      {user.critical_count > 0 && (
                        <Chip
                          label={user.critical_count}
                          size="small"
                          sx={{ bgcolor: '#D32F2F', color: 'white', minWidth: 40 }}
                        />
                      )}
                    </TableCell>
                    <TableCell align="right">
                      {user.high_count > 0 && (
                        <Chip
                          label={user.high_count}
                          size="small"
                          sx={{ bgcolor: '#FF6F00', color: 'white', minWidth: 40 }}
                        />
                      )}
                    </TableCell>
                    <TableCell align="right">{user.open_vulnerabilities}</TableCell>
                    <TableCell align="right">
                      {user.resolved_vulnerabilities + user.closed_vulnerabilities}
                    </TableCell>
                    <TableCell align="right">
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        <LinearProgress
                          variant="determinate"
                          value={getVulnerabilityProgress(user)}
                          sx={{ flexGrow: 1, minWidth: 60 }}
                          color={getVulnerabilityProgress(user) > 75 ? 'success' : 'primary'}
                        />
                        <Typography variant="caption">
                          {getVulnerabilityProgress(user).toFixed(0)}%
                        </Typography>
                      </Box>
                    </TableCell>
                    <TableCell align="right">
                      {user.avg_resolution_hours ? `${user.avg_resolution_hours.toFixed(1)}h` : '-'}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </Paper>
      )}

      {/* Teams Table */}
      {activeTab === 1 && (
        <Paper>
          <TableContainer>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>Team</TableCell>
                  <TableCell align="right">Members</TableCell>
                  <TableCell align="right">Devices</TableCell>
                  <TableCell align="right">Total Vulns</TableCell>
                  <TableCell align="right">Critical</TableCell>
                  <TableCell align="right">High</TableCell>
                  <TableCell align="right">Open</TableCell>
                  <TableCell align="right">Plans</TableCell>
                  <TableCell align="right">Active Plans</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {teamsLoading && (
                  <TableRow>
                    <TableCell colSpan={9} align="center">
                      <LinearProgress />
                    </TableCell>
                  </TableRow>
                )}
                {teamsWorkload?.map((team) => (
                  <TableRow key={team.team_id} hover>
                    <TableCell>
                      <Box>
                        <Typography variant="body2" fontWeight="medium">
                          {team.team_name}
                        </Typography>
                        {team.contact_email && (
                          <Typography variant="caption" color="text.secondary">
                            {team.contact_email}
                          </Typography>
                        )}
                      </Box>
                    </TableCell>
                    <TableCell align="right">{team.team_members}</TableCell>
                    <TableCell align="right">{team.assigned_devices}</TableCell>
                    <TableCell align="right">{team.total_vulnerabilities}</TableCell>
                    <TableCell align="right">
                      {team.critical_count > 0 && (
                        <Chip
                          label={team.critical_count}
                          size="small"
                          sx={{ bgcolor: '#D32F2F', color: 'white', minWidth: 40 }}
                        />
                      )}
                    </TableCell>
                    <TableCell align="right">
                      {team.high_count > 0 && (
                        <Chip
                          label={team.high_count}
                          size="small"
                          sx={{ bgcolor: '#FF6F00', color: 'white', minWidth: 40 }}
                        />
                      )}
                    </TableCell>
                    <TableCell align="right">{team.open_vulnerabilities}</TableCell>
                    <TableCell align="right">{team.total_plans}</TableCell>
                    <TableCell align="right">
                      <Chip
                        label={team.active_plans}
                        size="small"
                        color={team.active_plans > 0 ? 'primary' : 'default'}
                      />
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </Paper>
      )}
    </Box>
  );
};

export default WorkloadDashboard;
