import React, { useState } from 'react';
import {
  Box,
  Container,
  Paper,
  Button,
  Stack,
  Typography,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Checkbox,
  FormControlLabel,
  Alert,
  CircularProgress,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  Card,
  CardContent,
} from '@mui/material';
import {
  PlayArrow as PlayArrowIcon,
  GetApp as GetAppIcon,
  Add as AddIcon,
} from '@mui/icons-material';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import apiClient from '../services/api';
import { useRoleAccess } from '../hooks/useRoleAccess';

interface RemediationPlanData {
  device_ids: string[];
  name: string;
  description?: string;
}

interface RemediationPlan {
  id: string;
  name: string;
  description?: string;
  status: string;
  total_devices: number;
  critical_count: number;
  high_count: number;
  medium_count: number;
  low_count: number;
  estimated_hours_total: number;
  estimated_start_date?: string;
  estimated_completion_date?: string;
}

const RemediationPlanPage: React.FC = () => {
  const queryClient = useQueryClient();
  const { isAdmin, isTeamLeader } = useRoleAccess();
  const canGenerate = isAdmin() || isTeamLeader();

  const [showDialog, setShowDialog] = useState(false);
  const [planName, setPlanName] = useState('');
  const [planDescription, setPlanDescription] = useState('');
  const [selectedDevices, setSelectedDevices] = useState<string[]>([]);

  // Fetch remediation plans
  const { data: plans = [] } = useQuery({
    queryKey: ['remediation-plans'],
    queryFn: async () => {
      const response = await apiClient.get<RemediationPlan[]>('/api/remediation-plans');
      return response.data;
    },
  });

  // Fetch network devices for selection
  const { data: devices = [] } = useQuery({
    queryKey: ['network-devices'],
    queryFn: async () => {
      const response = await apiClient.get<{ devices: any[] }>('/api/network/topology');
      return response.data.devices || [];
    },
  });

  // Generate plan mutation
  const generatePlanMutation = useMutation({
    mutationFn: async (data: RemediationPlanData) => {
      return apiClient.post('/api/rbre/generate-plan', data);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['remediation-plans'] });
      setShowDialog(false);
      setPlanName('');
      setPlanDescription('');
      setSelectedDevices([]);
    },
  });

  const handleGeneratePlan = () => {
    if (!planName || selectedDevices.length === 0) {
      return;
    }

    generatePlanMutation.mutate({
      device_ids: selectedDevices,
      name: planName,
      description: planDescription,
    });
  };

  const handleDeviceToggle = (deviceId: string) => {
    setSelectedDevices((prev) =>
      prev.includes(deviceId)
        ? prev.filter((id) => id !== deviceId)
        : [...prev, deviceId]
    );
  };

  const getPriorityColor = (tier: string) => {
    switch (tier.toLowerCase()) {
      case 'critical':
        return '#DC2626';
      case 'high':
        return '#EA580C';
      case 'medium':
        return '#FBBF24';
      case 'low':
        return '#3B82F6';
      default:
        return '#6B7280';
    }
  };

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Header */}
      <Stack direction="row" justifyContent="space-between" alignItems="center" mb={3}>
        <Box>
          <Typography variant="h4">Remediation Plans</Typography>
          <Typography variant="body2" color="text.secondary">
            Risk-Based Remediation Plans generated by RBRE engine
          </Typography>
        </Box>
        {canGenerate && (
          <Button
            variant="contained"
            startIcon={<AddIcon />}
            onClick={() => setShowDialog(true)}
          >
            Generate Plan
          </Button>
        )}
      </Stack>

      {/* Plans List */}
      {plans.length === 0 ? (
        <Paper sx={{ p: 4, textAlign: 'center' }}>
          <Typography variant="h6" color="text.secondary" mb={2}>
            No remediation plans yet
          </Typography>
          {canGenerate && (
            <Button
              variant="contained"
              startIcon={<AddIcon />}
              onClick={() => setShowDialog(true)}
            >
              Create Your First Plan
            </Button>
          )}
        </Paper>
      ) : (
        <Stack spacing={2}>
          {plans.map((plan) => (
            <Card key={plan.id}>
              <CardContent>
                <Stack direction="row" justifyContent="space-between" alignItems="start" mb={2}>
                  <Box>
                    <Typography variant="h6">{plan.name}</Typography>
                    {plan.description && (
                      <Typography variant="body2" color="text.secondary">
                        {plan.description}
                      </Typography>
                    )}
                  </Box>
                  <Chip label={plan.status} variant="outlined" />
                </Stack>

                <Stack direction="row" spacing={2} mb={2}>
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Devices
                    </Typography>
                    <Typography variant="h6">{plan.total_devices}</Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Critical
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#DC2626' }}>
                      {plan.critical_count}
                    </Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      High
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#EA580C' }}>
                      {plan.high_count}
                    </Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Medium
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#FBBF24' }}>
                      {plan.medium_count}
                    </Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Low
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#3B82F6' }}>
                      {plan.low_count}
                    </Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Est. Hours
                    </Typography>
                    <Typography variant="h6">
                      {Math.round(plan.estimated_hours_total)}h
                    </Typography>
                  </Box>
                </Stack>

                {plan.estimated_start_date && (
                  <Typography variant="caption" color="text.secondary">
                    Timeline: {new Date(plan.estimated_start_date).toLocaleDateString()} to{' '}
                    {new Date(plan.estimated_completion_date!).toLocaleDateString()}
                  </Typography>
                )}

                <Stack direction="row" spacing={1} mt={2}>
                  <Button size="small" startIcon={<PlayArrowIcon />}>
                    Execute
                  </Button>
                  <Button size="small" startIcon={<GetAppIcon />}>
                    Export
                  </Button>
                </Stack>
              </CardContent>
            </Card>
          ))}
        </Stack>
      )}

      {/* Generate Plan Dialog */}
      <Dialog open={showDialog} onClose={() => setShowDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Generate Remediation Plan</DialogTitle>
        <DialogContent>
          <Stack spacing={3} sx={{ mt: 2 }}>
            <TextField
              label="Plan Name"
              fullWidth
              value={planName}
              onChange={(e) => setPlanName(e.target.value)}
              placeholder="e.g., Q1 2024 Patch Cycle"
            />

            <TextField
              label="Description"
              fullWidth
              multiline
              rows={3}
              value={planDescription}
              onChange={(e) => setPlanDescription(e.target.value)}
              placeholder="Optional notes about this plan"
            />

            <Box>
              <Typography variant="subtitle2" mb={1}>
                Select Devices ({selectedDevices.length} selected)
              </Typography>
              <Paper variant="outlined" sx={{ maxHeight: 300, overflow: 'auto', p: 1 }}>
                <Stack spacing={0.5}>
                  {devices.map((device: any) => (
                    <FormControlLabel
                      key={device.id}
                      control={
                        <Checkbox
                          checked={selectedDevices.includes(device.id)}
                          onChange={() => handleDeviceToggle(device.id)}
                        />
                      }
                      label={`${device.hostname || device.ip_address || 'Unknown'} (${device.device_type || 'unknown'})`}
                    />
                  ))}
                </Stack>
              </Paper>
            </Box>

            {selectedDevices.length > 0 && (
              <Alert severity="info">
                Planning remediation for {selectedDevices.length} device{selectedDevices.length !== 1 ? 's' : ''}
              </Alert>
            )}
          </Stack>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setShowDialog(false)}>Cancel</Button>
          <Button
            variant="contained"
            onClick={handleGeneratePlan}
            disabled={!planName || selectedDevices.length === 0 || generatePlanMutation.isPending}
            startIcon={generatePlanMutation.isPending && <CircularProgress size={20} />}
          >
            {generatePlanMutation.isPending ? 'Generating...' : 'Generate'}
          </Button>
        </DialogActions>
      </Dialog>
    </Container>
  );
};

export default RemediationPlanPage;
