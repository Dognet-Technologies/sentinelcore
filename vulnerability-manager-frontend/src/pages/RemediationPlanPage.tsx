import React, { useState, useMemo } from 'react';
import {
  Box,
  Paper,
  Button,
  Stack,
  Typography,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Checkbox,
  FormControlLabel,
  Alert,
  CircularProgress,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  Card,
  CardContent,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  IconButton,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  Grid,
  InputAdornment,
} from '@mui/material';
import {
  GetApp as GetAppIcon,
  Add as AddIcon,
  ExpandMore as ExpandMoreIcon,
  Close as CloseIcon,
  Search as SearchIcon,
} from '@mui/icons-material';
import StatsCard from '../components/common/StatsCard';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import apiClient from '../services/api';
import { useRoleAccess } from '../hooks/useRoleAccess';
import RBRECompletionWizard from '../components/network/RBRECompletionWizard';

interface RemediationPlanData {
  device_ids: string[];
  name: string;
  description?: string;
  assigned_team_id?: string;
}

interface RemediationPlanItem {
  id: string;
  vulnerability_id: string;
  device_id: string;
  rps_score: number;
  technical_severity: number;
  exploit_probability: number;
  asset_criticality_score: number;
  exposure_factor: number;
  threat_context: number;
  time_factor: number;
  rps_explanation: string;
  estimated_hours: number;
  status: string;
  vulnerability?: {
    cve_id: string;
    title: string;
    cvss_score: number;
    severity: string;
  };
  device?: {
    hostname: string;
    ip_address: string;
  };
}

interface RemediationPhase {
  id: string;
  phase_number: number;
  phase_name: string;
  target_severity: string;
  status: string;
  vulnerability_count: number;
  items: RemediationPlanItem[];
}

interface RemediationPlan {
  id: string;
  name: string;
  description?: string;
  status: string;
  total_devices: number;
  critical_count: number;
  high_count: number;
  medium_count: number;
  low_count: number;
  estimated_hours_total: number;
  estimated_start_date?: string;
  estimated_completion_date?: string;
  phases?: RemediationPhase[];
}

interface DeviceValidation {
  device_id: string;
  is_valid: boolean;
  missing_fields: string[];
  warnings: string[];
}

const RemediationPlanPage: React.FC = () => {
  const queryClient = useQueryClient();
  const { isAdmin, isTeamLeader } = useRoleAccess();
  const canGenerate = isAdmin() || isTeamLeader();

  const [showDialog, setShowDialog] = useState(false);
  const [planName, setPlanName] = useState('');
  const [planDescription, setPlanDescription] = useState('');
  const [selectedDevices, setSelectedDevices] = useState<string[]>([]);
  const [assignedTeamId, setAssignedTeamId] = useState<string>('');
  const [selectedPlan, setSelectedPlan] = useState<RemediationPlan | null>(null);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [deviceValidations, setDeviceValidations] = useState<Map<string, DeviceValidation>>(new Map());
  const [searchTerm, setSearchTerm] = useState('');
  const [showRBREWizard, setShowRBREWizard] = useState(false);

  // Fetch remediation plans
  const { data: plans = [] } = useQuery({
    queryKey: ['remediation-plans'],
    queryFn: async () => {
      const response = await apiClient.get<RemediationPlan[]>('/api/remediation-plans');
      return response.data;
    },
  });

  // Fetch devices with open/in-progress vulnerabilities for selection
  const { data: devices = [] } = useQuery({
    queryKey: ['devices-for-remediation'],
    queryFn: async () => {
      const response = await apiClient.get<any[]>('/api/rbre/devices-for-remediation');
      return response.data;
    },
  });

  // Fetch teams for assignment
  const { data: teams = [] } = useQuery({
    queryKey: ['teams'],
    queryFn: async () => {
      const response = await apiClient.get<any[]>('/api/teams');
      return response.data || [];
    },
  });

  // Fetch plan details
  const { data: planDetails, isLoading: isLoadingDetails } = useQuery({
    queryKey: ['remediation-plan-details', selectedPlan?.id],
    queryFn: async () => {
      if (!selectedPlan?.id) return null;
      const response = await apiClient.get<RemediationPlan>(
        `/api/remediation-plans/${selectedPlan.id}/details`
      );
      return response.data;
    },
    enabled: !!selectedPlan?.id && showDetailModal,
  });

  // Filter plans based on search
  const filteredPlans = useMemo(() => {
    if (!searchTerm) return plans;
    return plans.filter(plan =>
      plan.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      plan.description?.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [plans, searchTerm]);

  // Calculate statistics
  const stats = useMemo(() => {
    return {
      total: plans.length,
      open: plans.filter(p => p.status === 'open').length,
      in_progress: plans.filter(p => p.status === 'in_progress').length,
      completed: plans.filter(p => p.status === 'completed').length,
    };
  }, [plans]);

  // Get full device objects for selected device IDs
  const selectedDeviceObjects = useMemo(() => {
    return devices.filter(device => selectedDevices.includes(device.id));
  }, [devices, selectedDevices]);

  // Generate plan mutation
  const generatePlanMutation = useMutation({
    mutationFn: async (data: RemediationPlanData) => {
      return apiClient.post('/api/rbre/generate-plan', data);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['remediation-plans'] });
      setShowDialog(false);
      setPlanName('');
      setPlanDescription('');
      setSelectedDevices([]);
      setAssignedTeamId('');
    },
  });

  // Delete plan mutation
  const deletePlanMutation = useMutation({
    mutationFn: async (planId: string) => {
      return apiClient.delete(`/api/remediation-plans/${planId}`);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['remediation-plans'] });
      setShowDetailModal(false);
    },
  });

  // Update plan status mutation
  const updatePlanStatusMutation = useMutation({
    mutationFn: async ({ planId, status }: { planId: string; status: string }) => {
      return apiClient.put(`/api/remediation-plans/${planId}`, { status });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['remediation-plans'] });
      queryClient.invalidateQueries({ queryKey: ['remediation-plan-details'] });
    },
  });

  // Export plan mutation
  const exportPlanMutation = useMutation({
    mutationFn: async (planId: string) => {
      const response = await apiClient.get(`/api/remediation-plans/${planId}/export`, {
        responseType: 'blob',
      });
      return response.data;
    },
    onSuccess: (data: Blob) => {
      const url = window.URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url;
      a.download = `remediation-plan-${selectedPlan?.name?.replace(/\s+/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    },
  });

  const handleValidateDevices = async (deviceIds: string[]) => {
    const validations = new Map<string, DeviceValidation>();
    
    for (const deviceId of deviceIds) {
      try {
        const response = await apiClient.get<DeviceValidation>(
          `/api/rbre/validate-device/${deviceId}`
        );
        validations.set(deviceId, response.data);
      } catch (error) {
        console.error(`Failed to validate device ${deviceId}:`, error);
        validations.set(deviceId, {
          device_id: deviceId,
          is_valid: false,
          missing_fields: ['Unable to fetch validation status'],
          warnings: [],
        });
      }
    }
    
    setDeviceValidations(validations);
    return validations;
  };

  const handleGeneratePlan = async () => {
    if (!planName || selectedDevices.length === 0) {
      return;
    }

    // Validate devices first
    const validations = await handleValidateDevices(selectedDevices);

    const invalidDevices = Array.from(validations.values()).filter(v => !v.is_valid);

    if (invalidDevices.length > 0) {
      // Open RBRE wizard to complete missing data
      setShowRBREWizard(true);
      return;
    }

    generatePlanMutation.mutate({
      device_ids: selectedDevices,
      name: planName,
      description: planDescription,
      assigned_team_id: assignedTeamId || undefined,
    });
  };

  const handleRBREWizardComplete = () => {
    // After completing the wizard, try generating the plan again
    generatePlanMutation.mutate({
      device_ids: selectedDevices,
      name: planName,
      description: planDescription,
      assigned_team_id: assignedTeamId || undefined,
    });
  };

  const handleDeviceToggle = (deviceId: string) => {
    setSelectedDevices((prev) =>
      prev.includes(deviceId)
        ? prev.filter((id) => id !== deviceId)
        : [...prev, deviceId]
    );
  };

  const handleViewPlanDetails = (plan: RemediationPlan) => {
    setSelectedPlan(plan);
    setShowDetailModal(true);
  };

  const handleDeletePlan = (planId: string) => {
    if (window.confirm('Are you sure you want to delete this remediation plan?')) {
      deletePlanMutation.mutate(planId);
    }
  };

  const handleUpdatePlanStatus = (planId: string, status: string) => {
    updatePlanStatusMutation.mutate({ planId, status });
  };

  const handleExportPlan = (planId: string) => {
    exportPlanMutation.mutate(planId);
  };

  const getPriorityColor = (tier: string) => {
    switch (tier.toLowerCase()) {
      case 'critical':
        return '#DC2626';
      case 'high':
        return '#EA580C';
      case 'medium':
        return '#FBBF24';
      case 'low':
        return '#3B82F6';
      default:
        return '#6B7280';
    }
  };

  return (
    <Box>
      {/* Header */}
      <Stack direction="row" justifyContent="space-between" alignItems="center" mb={3}>
        <Box>
          <Typography variant="h4">Remediation Plans</Typography>
          <Typography variant="body2" color="text.secondary">
            Risk-Based Remediation Plans generated by RBRE engine
          </Typography>
        </Box>
        {canGenerate && (
          <Button
            variant="contained"
            startIcon={<AddIcon />}
            onClick={() => setShowDialog(true)}
          >
            Generate Plan
          </Button>
        )}
      </Stack>

      {/* Statistics Cards */}
      <Grid container spacing={3} sx={{ mb: 3 }}>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Totale Piani"
            value={stats.total}
            description="Numero totale di Remediation Plans generati dal sistema RBRE (Risk-Based Remediation Engine). Ogni piano organizza le vulnerabilità per priorità di rischio e fornisce una roadmap strutturata per la remediation. Include piani aperti, in lavorazione e completati."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Aperti"
            value={stats.open}
            color="info"
            description="Remediation Plans con stato 'Open' che sono stati generati ma non ancora avviati. Questi piani sono pronti per essere assegnati ai team e iniziare l'esecuzione. Un piano aperto contiene già la prioritizzazione RPS (Risk Priority Score) e le fasi di remediation."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="In Lavorazione"
            value={stats.in_progress}
            color="warning"
            description="Remediation Plans attualmente in esecuzione. I team stanno lavorando attivamente su questi piani per risolvere le vulnerabilità seguendo le fasi e priorità definite dall'algoritmo RBRE. Include il monitoraggio delle ore stimate e del progresso per fase."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Completati"
            value={stats.completed}
            color="success"
            description="Remediation Plans completati con successo. Tutte le vulnerabilità incluse nel piano sono state risolte o chiuse. I piani completati forniscono metriche storiche utili per valutare l'efficacia del processo di remediation e stimare tempi per piani futuri."
          />
        </Grid>
      </Grid>

      {/* Search Field */}
      {plans.length > 0 && (
        <Box sx={{ mb: 3 }}>
          <TextField
            fullWidth
            variant="outlined"
            placeholder="Cerca remediation plans..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            InputProps={{
              startAdornment: (
                <InputAdornment position="start">
                  <SearchIcon />
                </InputAdornment>
              ),
            }}
          />
        </Box>
      )}

      {/* Plans List */}
      {filteredPlans.length === 0 && searchTerm ? (
        <Paper sx={{ p: 4, textAlign: 'center' }}>
          <Typography variant="h6" color="text.secondary" mb={2}>
            Nessun piano trovato per "{searchTerm}"
          </Typography>
        </Paper>
      ) : plans.length === 0 ? (
        <Paper sx={{ p: 4, textAlign: 'center' }}>
          <Typography variant="h6" color="text.secondary" mb={2}>
            No remediation plans yet
          </Typography>
          {canGenerate && (
            <Button
              variant="contained"
              startIcon={<AddIcon />}
              onClick={() => setShowDialog(true)}
            >
              Create Your First Plan
            </Button>
          )}
        </Paper>
      ) : (
        <Stack spacing={2}>
          {filteredPlans.map((plan) => (
            <Card key={plan.id}>
              <CardContent>
                <Stack direction="row" justifyContent="space-between" alignItems="start" mb={2}>
                  <Box>
                    <Typography variant="h6">{plan.name}</Typography>
                    {plan.description && (
                      <Typography variant="body2" color="text.secondary">
                        {plan.description}
                      </Typography>
                    )}
                  </Box>
                  <Chip label={plan.status} variant="outlined" />
                </Stack>

                <Stack direction="row" spacing={2} mb={2}>
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Devices
                    </Typography>
                    <Typography variant="h6">{plan.total_devices}</Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Critical
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#DC2626' }}>
                      {plan.critical_count}
                    </Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      High
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#EA580C' }}>
                      {plan.high_count}
                    </Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Medium
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#FBBF24' }}>
                      {plan.medium_count}
                    </Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Low
                    </Typography>
                    <Typography variant="h6" sx={{ color: '#3B82F6' }}>
                      {plan.low_count}
                    </Typography>
                  </Box>

                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Est. Hours
                    </Typography>
                    <Typography variant="h6">
                      {Math.round(plan.estimated_hours_total)}h
                    </Typography>
                  </Box>
                </Stack>

                {plan.estimated_start_date && (
                  <Typography variant="caption" color="text.secondary">
                    Timeline: {new Date(plan.estimated_start_date).toLocaleDateString()} to{' '}
                    {new Date(plan.estimated_completion_date!).toLocaleDateString()}
                  </Typography>
                )}

                <Stack direction="row" spacing={1} mt={2}>
                  <Button 
                    size="small" 
                    onClick={() => handleViewPlanDetails(plan)}
                    variant="outlined"
                  >
                    View Details
                  </Button>
                  <Button 
                    size="small" 
                    startIcon={<GetAppIcon />}
                    onClick={() => handleExportPlan(plan.id)}
                    disabled={exportPlanMutation.isPending}
                  >
                    {exportPlanMutation.isPending ? 'Exporting...' : 'Export'}
                  </Button>
                  <Button 
                    size="small"
                    color="error"
                    onClick={() => handleDeletePlan(plan.id)}
                    disabled={deletePlanMutation.isPending}
                  >
                    {deletePlanMutation.isPending ? 'Deleting...' : 'Delete'}
                  </Button>
                </Stack>
              </CardContent>
            </Card>
          ))}
        </Stack>
      )}

      {/* Plan Details Modal */}
      <Dialog 
        open={showDetailModal} 
        onClose={() => setShowDetailModal(false)} 
        maxWidth="lg" 
        fullWidth
      >
        <DialogTitle>
          <Stack direction="row" justifyContent="space-between" alignItems="center">
            <Typography variant="h6">
              {selectedPlan?.name || 'Plan Details'}
            </Typography>
            <IconButton onClick={() => setShowDetailModal(false)}>
              <CloseIcon />
            </IconButton>
          </Stack>
        </DialogTitle>
        <DialogContent>
          {isLoadingDetails ? (
            <Stack alignItems="center" justifyContent="center" minHeight={300}>
              <CircularProgress />
            </Stack>
          ) : planDetails ? (
            <Stack spacing={2} sx={{ mt: 2 }}>
              {planDetails.description && (
                <Alert severity="info">{planDetails.description}</Alert>
              )}
              
              {(!planDetails.phases || planDetails.phases.length === 0) && (
                <Alert severity="warning">
                  <Typography variant="subtitle2" sx={{ fontWeight: 'bold', mb: 1 }}>
                    No Remediation Phases Generated
                  </Typography>
                  <Typography variant="body2">
                    This plan was created but no vulnerabilities were found or matched the remediation criteria for the selected devices. 
                    Please verify that the devices have vulnerabilities and required RBRE configuration fields are populated.
                  </Typography>
                </Alert>
              )}

              <Box>
                <Typography variant="subtitle2" fontWeight="bold" mb={1}>
                  Plan Summary
                </Typography>
                <Stack direction="row" spacing={2} flexWrap="wrap">
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Status
                    </Typography>
                    {canGenerate ? (
                      <FormControl size="small" sx={{ minWidth: 120 }}>
                        <Select
                          value={planDetails?.status || ''}
                          onChange={(e) => selectedPlan && handleUpdatePlanStatus(selectedPlan.id, e.target.value)}
                          disabled={updatePlanStatusMutation.isPending}
                        >
                          <MenuItem value="draft">Draft</MenuItem>
                          <MenuItem value="active">Active</MenuItem>
                          <MenuItem value="in_progress">In Progress</MenuItem>
                          <MenuItem value="completed">Completed</MenuItem>
                          <MenuItem value="resolved">Resolved</MenuItem>
                          <MenuItem value="cancelled">Cancelled</MenuItem>
                        </Select>
                      </FormControl>
                    ) : (
                      <Chip label={planDetails.status} size="small" />
                    )}
                  </Box>
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Total Devices
                    </Typography>
                    <Typography variant="body2">{planDetails.total_devices}</Typography>
                  </Box>
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Est. Hours
                    </Typography>
                    <Typography variant="body2">
                      {Math.round(planDetails.estimated_hours_total)}h
                    </Typography>
                  </Box>
                  <Box>
                    <Typography variant="caption" color="text.secondary">
                      Timeline
                    </Typography>
                    <Typography variant="body2">
                      {planDetails.estimated_start_date
                        ? new Date(planDetails.estimated_start_date).toLocaleDateString()
                        : 'N/A'}{' '}
                      -{' '}
                      {planDetails.estimated_completion_date
                        ? new Date(planDetails.estimated_completion_date).toLocaleDateString()
                        : 'N/A'}
                    </Typography>
                  </Box>
                </Stack>
              </Box>

              <Box>
                <Typography variant="subtitle2" fontWeight="bold" mb={2}>
                  Remediation Phases
                </Typography>
                {planDetails.phases && planDetails.phases.length > 0 ? (
                  planDetails.phases.map((phase) => (
                    <Accordion key={phase.id} defaultExpanded={phase.phase_number === 1}>
                      <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                        <Box sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
                          <Typography variant="subtitle2" sx={{ mr: 2 }}>
                            {phase.phase_name}
                          </Typography>
                          <Chip
                            label={`${phase.vulnerability_count} vulnerabilities`}
                            size="small"
                            variant="outlined"
                            sx={{ mr: 1 }}
                          />
                          <Chip label={phase.status} size="small" />
                        </Box>
                      </AccordionSummary>
                      <AccordionDetails>
                        <TableContainer>
                          <Table size="small">
                            <TableHead>
                              <TableRow sx={{ backgroundColor: '#f5f5f5' }}>
                                <TableCell>CVE</TableCell>
                                <TableCell>Vulnerability</TableCell>
                                <TableCell>Device</TableCell>
                                <TableCell align="right">RPS Score</TableCell>
                                <TableCell align="right">Est. Hours</TableCell>
                                <TableCell>Status</TableCell>
                              </TableRow>
                            </TableHead>
                            <TableBody>
                              {phase.items.map((item) => (
                                <TableRow key={item.id}>
                                  <TableCell>
                                    <Typography variant="caption" sx={{ fontFamily: 'monospace' }}>
                                      {item.vulnerability?.cve_id || 'N/A'}
                                    </Typography>
                                  </TableCell>
                                  <TableCell>
                                    <Stack>
                                      <Typography variant="body2" noWrap sx={{ maxWidth: 300 }}>
                                        {item.vulnerability?.title || 'Unknown'}
                                      </Typography>
                                      <Typography
                                        variant="caption"
                                        color="text.secondary"
                                        title={item.rps_explanation}
                                      >
                                        {item.rps_explanation?.substring(0, 60)}...
                                      </Typography>
                                    </Stack>
                                  </TableCell>
                                  <TableCell>
                                    <Stack spacing={0.5}>
                                      <Typography variant="body2">
                                        {item.device?.hostname || 'Unknown'}
                                      </Typography>
                                      <Typography variant="caption" color="text.secondary">
                                        {item.device?.ip_address}
                                      </Typography>
                                    </Stack>
                                  </TableCell>
                                  <TableCell align="right">
                                    <Chip
                                      label={item.rps_score.toFixed(1)}
                                      size="small"
                                      sx={{
                                        backgroundColor:
                                          item.rps_score >= 70
                                            ? '#DC2626'
                                            : item.rps_score >= 40
                                            ? '#EA580C'
                                            : item.rps_score >= 20
                                            ? '#FBBF24'
                                            : '#3B82F6',
                                        color: 'white',
                                        fontWeight: 'bold',
                                      }}
                                    />
                                  </TableCell>
                                  <TableCell align="right">
                                    {item.estimated_hours}h
                                  </TableCell>
                                  <TableCell>
                                    <Chip label={item.status} size="small" variant="outlined" />
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </TableContainer>
                      </AccordionDetails>
                    </Accordion>
                  ))
                ) : (
                  <Stack spacing={2}>
                    <Alert severity="warning">
                      No vulnerabilities found for the selected devices or no remediation phases were generated
                    </Alert>
                    <Typography variant="body2" color="text.secondary">
                      This could mean:
                    </Typography>
                    <ul style={{ marginTop: 0, paddingLeft: 20 }}>
                      <li>
                        <Typography variant="caption" color="text.secondary">
                          The selected devices have no known vulnerabilities
                        </Typography>
                      </li>
                      <li>
                        <Typography variant="caption" color="text.secondary">
                          The devices are missing RBRE configuration fields (update in Host page)
                        </Typography>
                      </li>
                      <li>
                        <Typography variant="caption" color="text.secondary">
                          No vulnerabilities matched the remediation criteria
                        </Typography>
                      </li>
                    </ul>
                  </Stack>
                )}
              </Box>
            </Stack>
          ) : (
            <Alert severity="error">Failed to load plan details</Alert>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setShowDetailModal(false)}>Close</Button>
          {canGenerate && selectedPlan && (
            <>
              <Button
                startIcon={<GetAppIcon />}
                variant="outlined"
                onClick={() => handleExportPlan(selectedPlan.id)}
                disabled={exportPlanMutation.isPending}
              >
                {exportPlanMutation.isPending ? 'Exporting...' : 'Export'}
              </Button>
              <Button
                color="error"
                onClick={() => {
                  handleDeletePlan(selectedPlan.id);
                }}
                disabled={deletePlanMutation.isPending}
              >
                {deletePlanMutation.isPending ? 'Deleting...' : 'Delete Plan'}
              </Button>
            </>
          )}
        </DialogActions>
      </Dialog>

      {/* Generate Plan Dialog */}
      <Dialog open={showDialog} onClose={() => setShowDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Generate Remediation Plan</DialogTitle>
        <DialogContent>
          <Stack spacing={3} sx={{ mt: 2 }}>
            <TextField
              label="Plan Name"
              fullWidth
              value={planName}
              onChange={(e) => setPlanName(e.target.value)}
              placeholder="e.g., Q1 2024 Patch Cycle"
            />

            <TextField
              label="Description"
              fullWidth
              multiline
              rows={3}
              value={planDescription}
              onChange={(e) => setPlanDescription(e.target.value)}
              placeholder="Optional notes about this plan"
            />

            <FormControl fullWidth>
              <InputLabel>Assign to Team (Optional)</InputLabel>
              <Select
                value={assignedTeamId}
                label="Assign to Team (Optional)"
                onChange={(e) => setAssignedTeamId(e.target.value)}
              >
                <MenuItem value="">
                  <em>None</em>
                </MenuItem>
                {teams.map((team: any) => (
                  <MenuItem key={team.id} value={team.id}>
                    {team.name}
                  </MenuItem>
                ))}
              </Select>
            </FormControl>

            <Box>
              <Typography variant="subtitle2" mb={1}>
                Select Devices ({selectedDevices.length} selected)
              </Typography>
              <Paper variant="outlined" sx={{ maxHeight: 300, overflow: 'auto', p: 1 }}>
                <Stack spacing={0.5}>
                  {devices.map((device: any) => {
                    const validation = deviceValidations.get(device.id);
                    const hasWarnings = validation && !validation.is_valid;
                    
                    return (
                      <FormControlLabel
                        key={device.id}
                        control={
                          <Checkbox
                            checked={selectedDevices.includes(device.id)}
                            onChange={() => handleDeviceToggle(device.id)}
                          />
                        }
                        label={
                          <Stack spacing={0.3} sx={{ width: '100%' }}>
                            <Stack direction="row" justifyContent="space-between" alignItems="center">
                              <Typography variant="body2">
                                {device.hostname || device.ip_address || 'Unknown'} ({device.device_type || 'unknown'})
                              </Typography>
                              <Chip 
                                label={`${device.vulnerability_count || 0} vulnerabilities`}
                                size="small"
                                variant="filled"
                                sx={{ ml: 1 }}
                              />
                            </Stack>
                            {hasWarnings && (
                              <Typography variant="caption" color="warning.main">
                                ⚠️ Missing: {validation!.missing_fields.slice(0, 2).join(', ')}
                              </Typography>
                            )}
                          </Stack>
                        }
                      />
                    );
                  })}
                </Stack>
              </Paper>
            </Box>

            {selectedDevices.length > 0 && (
              <Stack spacing={1}>
                <Alert severity="info">
                  Planning remediation for {selectedDevices.length} device{selectedDevices.length !== 1 ? 's' : ''}
                </Alert>
                {Array.from(deviceValidations.values()).some(v => !v.is_valid) && (
                  <Alert severity="warning">
                    Some devices are missing RBRE configuration fields. Please update device settings in the Host page after plan creation to ensure accurate risk scoring.
                  </Alert>
                )}
              </Stack>
            )}
          </Stack>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setShowDialog(false)}>Cancel</Button>
          <Button
            variant="contained"
            onClick={handleGeneratePlan}
            disabled={!planName || selectedDevices.length === 0 || generatePlanMutation.isPending}
            startIcon={generatePlanMutation.isPending && <CircularProgress size={20} />}
          >
            {generatePlanMutation.isPending ? 'Generating...' : 'Generate Plan'}
          </Button>
        </DialogActions>
      </Dialog>

      {/* RBRE Data Completion Wizard */}
      <RBRECompletionWizard
        open={showRBREWizard}
        onClose={() => setShowRBREWizard(false)}
        devices={selectedDeviceObjects.map(device => ({
          id: device.id,
          hostname: device.hostname,
          ipAddress: device.ip_address,
          business_criticality: device.business_criticality,
          exposure_level: device.exposure_level,
        }))}
        onComplete={handleRBREWizardComplete}
      />
    </Box>
  );
};

export default RemediationPlanPage;
