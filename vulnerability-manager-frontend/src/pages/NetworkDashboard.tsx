// NetworkDashboard.tsx - Comprehensive Vulnerability Management Dashboard
// Entuity-style interface focused on vulnerability metrics and asset security

import React, { useState, useEffect } from 'react';
import {
  Box,
  Container,
  Grid,
  Typography,
  Button,
  Stack,
  Paper,
  CircularProgress,
  Alert,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
} from '@mui/material';
import {
  Refresh as RefreshIcon,
  Dashboard as DashboardIcon,
  PlayArrow as PlayIcon,
} from '@mui/icons-material';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import NetworkTopology from '../components/NetworkTopology';
import DeviceDetailView from '../components/DeviceDetailView';
import KeyInfoDashlet from '../components/dashlets/KeyInfoDashlet';
import ChartDashlet from '../components/dashlets/ChartDashlet';
import TableDashlet from '../components/dashlets/TableDashlet';
import { NetworkDevice, NetworkTopology as NetworkTopologyType } from '../types/network';
import { entuityColors } from '../theme/entuityTheme';
import apiClient from '../services/api';
import { networkApi, StartScanRequest, NetworkTopologyWithVulnerabilities } from '../api/network';


// Generate realistic vulnerability management mock data
const generateVulnerabilityData = (): NetworkTopologyType => {
  const devices: NetworkDevice[] = [
    {
      id: '1',
      name: 'CORE-RTR-DC1',
      type: 'router',
      status: 'online',
      ipAddress: '10.0.1.1',
      macAddress: '00:1A:2B:3C:4D:5E',
      severity: 'high',
      incidentCount: 3,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Cisco',
      model: 'ASR 9010',
      osVersion: 'IOS XR 7.5.2',
      location: {
        building: 'HQ Building A',
        floor: '2nd Floor',
        room: 'Server Room A',
        datacenter: 'Primary DC',
      },
      vulnerabilityMetrics: {
        totalVulnerabilities: 12,
        criticalCount: 1,
        highCount: 4,
        mediumCount: 5,
        lowCount: 2,
        resolvedCount: 8,
        riskScore: 68,
        lastScanDate: new Date(Date.now() - 3600000 * 6).toISOString(), // 6h ago
        nextScanDate: new Date(Date.now() + 3600000 * 18).toISOString(), // in 18h
        scanStatus: 'completed',
        complianceScore: 75,
      },
      remediationInfo: {
        lastRemediationDate: new Date(Date.now() - 86400000 * 2).toISOString(), // 2 days ago
        lastRemediationType: 'Firmware Update',
        pendingRemediations: 3,
        appliedRemediations: 5,
        failedRemediations: 0,
      },
      assignment: {
        assignedTeamId: 'team-net',
        assignedTeamName: 'Network Infrastructure',
        assignedUserId: 'user-john',
        assignedUserName: 'John Smith',
        assignedDate: new Date(Date.now() - 86400000 * 7).toISOString(),
      },
      ports: [
        { id: 'p1', number: 1, name: 'GigabitEthernet0/0/0', type: 'Ethernet', status: 'up', speed: 1000, duplex: 'full' },
        { id: 'p2', number: 2, name: 'GigabitEthernet0/0/1', type: 'Ethernet', status: 'up', speed: 1000, duplex: 'full' },
      ],
    },
    {
      id: '2',
      name: 'SW-ACCESS-F2',
      type: 'switch',
      status: 'online',
      ipAddress: '10.0.2.10',
      macAddress: '00:1A:2B:3C:4D:6F',
      severity: 'critical',
      incidentCount: 8,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Juniper',
      model: 'EX4300-48T',
      osVersion: 'Junos 20.4R3',
      location: {
        building: 'HQ Building A',
        floor: '2nd Floor',
        room: 'IDF-02',
        datacenter: 'Primary DC',
      },
      vulnerabilityMetrics: {
        totalVulnerabilities: 23,
        criticalCount: 5,
        highCount: 9,
        mediumCount: 7,
        lowCount: 2,
        resolvedCount: 4,
        riskScore: 89,
        lastScanDate: new Date(Date.now() - 3600000 * 2).toISOString(),
        nextScanDate: new Date(Date.now() + 3600000 * 22).toISOString(),
        scanStatus: 'completed',
        complianceScore: 52,
      },
      remediationInfo: {
        lastRemediationDate: new Date(Date.now() - 86400000 * 15).toISOString(),
        lastRemediationType: 'Configuration Hardening',
        pendingRemediations: 8,
        appliedRemediations: 3,
        failedRemediations: 2,
      },
      assignment: {
        assignedTeamId: 'team-net',
        assignedTeamName: 'Network Infrastructure',
        assignedUserId: 'user-maria',
        assignedUserName: 'Maria Garcia',
        assignedDate: new Date(Date.now() - 86400000 * 3).toISOString(),
      },
      ports: [],
    },
    {
      id: '3',
      name: 'FW-PERIMETER-01',
      type: 'firewall',
      status: 'warning',
      ipAddress: '10.0.1.254',
      macAddress: '00:1A:2B:3C:4D:7F',
      severity: 'medium',
      incidentCount: 5,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Palo Alto Networks',
      model: 'PA-5220',
      osVersion: 'PAN-OS 10.2.3',
      location: {
        building: 'HQ Building A',
        floor: 'Ground Floor',
        room: 'DMZ Zone',
        datacenter: 'Primary DC',
      },
      vulnerabilityMetrics: {
        totalVulnerabilities: 8,
        criticalCount: 0,
        highCount: 2,
        mediumCount: 4,
        lowCount: 2,
        resolvedCount: 12,
        riskScore: 45,
        lastScanDate: new Date(Date.now() - 3600000 * 1).toISOString(),
        nextScanDate: new Date(Date.now() + 3600000 * 23).toISOString(),
        scanStatus: 'completed',
        complianceScore: 88,
      },
      remediationInfo: {
        lastRemediationDate: new Date(Date.now() - 86400000 * 5).toISOString(),
        lastRemediationType: 'Security Policy Update',
        pendingRemediations: 2,
        appliedRemediations: 10,
        failedRemediations: 1,
      },
      assignment: {
        assignedTeamId: 'team-sec',
        assignedTeamName: 'Security Operations',
        assignedUserId: 'user-alex',
        assignedUserName: 'Alex Johnson',
        assignedDate: new Date(Date.now() - 86400000 * 1).toISOString(),
      },
      ports: [],
    },
    {
      id: '4',
      name: 'DB-PROD-PRIMARY',
      type: 'database',
      status: 'online',
      ipAddress: '10.0.10.50',
      severity: 'low',
      incidentCount: 2,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Dell',
      model: 'PowerEdge R750',
      osVersion: 'Ubuntu 22.04.3 LTS',
      location: {
        building: 'HQ Building B',
        floor: '3rd Floor',
        room: 'Database Room',
        datacenter: 'Primary DC',
      },
      vulnerabilityMetrics: {
        totalVulnerabilities: 6,
        criticalCount: 0,
        highCount: 1,
        mediumCount: 3,
        lowCount: 2,
        resolvedCount: 15,
        riskScore: 32,
        lastScanDate: new Date(Date.now() - 3600000 * 4).toISOString(),
        nextScanDate: new Date(Date.now() + 3600000 * 20).toISOString(),
        scanStatus: 'completed',
        complianceScore: 92,
      },
      remediationInfo: {
        lastRemediationDate: new Date(Date.now() - 86400000 * 1).toISOString(),
        lastRemediationType: 'Security Patch',
        pendingRemediations: 1,
        appliedRemediations: 14,
        failedRemediations: 0,
      },
      assignment: {
        assignedTeamId: 'team-db',
        assignedTeamName: 'Database Administration',
        assignedUserId: 'user-sarah',
        assignedUserName: 'Sarah Chen',
        assignedDate: new Date(Date.now() - 86400000 * 30).toISOString(),
      },
      ports: [],
    },
    {
      id: '5',
      name: 'AP-FLOOR3-A',
      type: 'wireless',
      status: 'online',
      ipAddress: '10.0.3.20',
      severity: 'info',
      incidentCount: 1,
      lastSeen: new Date().toISOString(),
      manufacturer: 'Ubiquiti',
      model: 'UniFi AP AC Pro',
      osVersion: '5.43.35.12758',
      location: {
        building: 'HQ Building A',
        floor: '3rd Floor',
        room: 'Open Office',
      },
      vulnerabilityMetrics: {
        totalVulnerabilities: 3,
        criticalCount: 0,
        highCount: 0,
        mediumCount: 2,
        lowCount: 1,
        resolvedCount: 8,
        riskScore: 18,
        lastScanDate: new Date(Date.now() - 3600000 * 12).toISOString(),
        nextScanDate: new Date(Date.now() + 3600000 * 12).toISOString(),
        scanStatus: 'completed',
        complianceScore: 95,
      },
      remediationInfo: {
        lastRemediationDate: new Date(Date.now() - 86400000 * 7).toISOString(),
        lastRemediationType: 'Firmware Upgrade',
        pendingRemediations: 1,
        appliedRemediations: 7,
        failedRemediations: 0,
      },
      assignment: {
        assignedTeamId: 'team-net',
        assignedTeamName: 'Network Infrastructure',
        assignedUserId: 'user-john',
        assignedUserName: 'John Smith',
        assignedDate: new Date(Date.now() - 86400000 * 14).toISOString(),
      },
      ports: [],
    },
    {
      id: '6',
      name: 'STORAGE-NAS-01',
      type: 'storage',
      status: 'offline',
      ipAddress: '10.0.4.100',
      severity: 'critical',
      incidentCount: 12,
      lastSeen: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
      manufacturer: 'Synology',
      model: 'DS3622xs+',
      osVersion: 'DSM 7.1.1',
      location: {
        building: 'HQ Building B',
        floor: 'Basement',
        room: 'Storage Room',
        datacenter: 'Secondary Storage',
      },
      vulnerabilityMetrics: {
        totalVulnerabilities: 18,
        criticalCount: 6,
        highCount: 8,
        mediumCount: 3,
        lowCount: 1,
        resolvedCount: 2,
        riskScore: 94,
        lastScanDate: new Date(Date.now() - 86400000 * 5).toISOString(),
        nextScanDate: new Date().toISOString(),
        scanStatus: 'failed',
        complianceScore: 38,
      },
      remediationInfo: {
        lastRemediationDate: new Date(Date.now() - 86400000 * 30).toISOString(),
        lastRemediationType: 'None',
        pendingRemediations: 12,
        appliedRemediations: 1,
        failedRemediations: 3,
      },
      assignment: {
        assignedTeamId: 'team-storage',
        assignedTeamName: 'Storage Team',
        assignedDate: new Date(Date.now() - 86400000 * 2).toISOString(),
      },
      ports: [],
    },
    {
      id: '7',
      name: 'SRV-WEB-PROD-01',
      type: 'server',
      status: 'online',
      ipAddress: '10.0.5.10',
      severity: 'high',
      incidentCount: 4,
      lastSeen: new Date().toISOString(),
      manufacturer: 'HPE',
      model: 'ProLiant DL380 Gen10',
      osVersion: 'Red Hat Enterprise Linux 8.7',
      location: {
        building: 'HQ Building A',
        floor: '2nd Floor',
        room: 'Application Servers',
        datacenter: 'Primary DC',
      },
      vulnerabilityMetrics: {
        totalVulnerabilities: 14,
        criticalCount: 2,
        highCount: 6,
        mediumCount: 4,
        lowCount: 2,
        resolvedCount: 10,
        riskScore: 72,
        lastScanDate: new Date(Date.now() - 3600000 * 3).toISOString(),
        nextScanDate: new Date(Date.now() + 3600000 * 21).toISOString(),
        scanStatus: 'completed',
        complianceScore: 68,
      },
      remediationInfo: {
        lastRemediationDate: new Date(Date.now() - 86400000 * 4).toISOString(),
        lastRemediationType: 'OS Security Patch',
        pendingRemediations: 4,
        appliedRemediations: 8,
        failedRemediations: 1,
      },
      assignment: {
        assignedTeamId: 'team-app',
        assignedTeamName: 'Application Team',
        assignedUserId: 'user-mike',
        assignedUserName: 'Mike Wilson',
        assignedDate: new Date(Date.now() - 86400000 * 5).toISOString(),
      },
      ports: [],
    },
  ];

  const links = [
    { id: 'l1', source: '1', target: '2', status: 'active' as const, utilization: 45, bandwidth: 1000, type: 'wired' as const },
    { id: 'l2', source: '1', target: '3', status: 'active' as const, utilization: 87, bandwidth: 10000, type: 'wired' as const },
    { id: 'l3', source: '2', target: '4', status: 'active' as const, utilization: 62, bandwidth: 1000, type: 'wired' as const },
    { id: 'l4', source: '2', target: '5', status: 'active' as const, utilization: 32, bandwidth: 1000, type: 'wireless' as const },
    { id: 'l5', source: '2', target: '6', status: 'inactive' as const, utilization: 0, bandwidth: 1000, type: 'wired' as const },
    { id: 'l6', source: '3', target: '7', status: 'active' as const, utilization: 78, bandwidth: 1000, type: 'wired' as const },
  ];

  return {
    devices,
    links,
    lastUpdated: new Date().toISOString(),
  };
};

// Fetch real network topology from backend API
const fetchNetworkTopology = async (): Promise<NetworkTopologyType> => {
  try {
    const response = await apiClient.get<any>('/api/network/topology-with-vulnerabilities');

    // Map backend response to frontend NetworkDevice type
    const mappedDevices = response.data.devices.map((device: any) => ({
      ...device,
      // Map device_type to type for frontend compatibility
      // Backend returns device_type as enum (Router, Server, etc)
      type: device.device_type?.toLowerCase() || 'unknown',
      // Ensure all required fields are present
      severity: device.severity || 'none',
      incidentCount: device.incident_count || 0,
      lastSeen: device.last_seen,
      macAddress: device.mac_address,
      vulnerabilityMetrics: device.vulnerability_metrics ? {
        totalVulnerabilities: device.vulnerability_metrics.total_vulnerabilities,
        criticalCount: device.vulnerability_metrics.critical_count,
        highCount: device.vulnerability_metrics.high_count,
        mediumCount: device.vulnerability_metrics.medium_count,
        lowCount: device.vulnerability_metrics.low_count,
        resolvedCount: device.vulnerability_metrics.resolved_count,
        riskScore: device.vulnerability_metrics.risk_score,
        lastScanDate: device.vulnerability_metrics.last_scan_date,
        scanStatus: device.vulnerability_metrics.scan_status,
        complianceScore: device.vulnerability_metrics.compliance_score,
      } : undefined,
      remediationInfo: device.remediation_info,
      assignment: device.assignment,
    }));

    return {
      devices: mappedDevices,
      links: response.data.links || [],
      lastUpdated: response.data.last_updated || new Date().toISOString(),
    };
  } catch (error) {
    console.error('Failed to fetch network topology:', error);
    // Return fallback data on error
    return generateVulnerabilityData();
  }
};

const NetworkDashboard: React.FC = () => {
  const queryClient = useQueryClient();
  const [networkData, setNetworkData] = useState<NetworkTopologyType | null>(null);
  const [selectedDevice, setSelectedDevice] = useState<NetworkDevice | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Network scan state
  const [scanDialogOpen, setScanDialogOpen] = useState(false);
  const [scanFormData, setScanFormData] = useState<StartScanRequest>({
    scan_name: 'Network Scan',
    scan_type: 'arp',
    target_range: '192.168.1.0/24',
  });
  const [currentScanId, setCurrentScanId] = useState<string | null>(null);

  // Start scan mutation
  const startScanMutation = useMutation({
    mutationFn: (request: StartScanRequest) => networkApi.startScan(request),
    onSuccess: (data) => {
      setCurrentScanId(data.scan_id);
      setScanDialogOpen(false);
    },
  });

  // Poll scan status
  const { data: scanStatus } = useQuery({
    queryKey: ['scan-status', currentScanId],
    queryFn: () => networkApi.getScanStatus(currentScanId!),
    enabled: !!currentScanId,
    refetchInterval: 2000, // Poll every 2s
  });

  // Stop polling when scan is complete
  useEffect(() => {
    if (scanStatus && (scanStatus.status === 'completed' || scanStatus.status === 'failed')) {
      setCurrentScanId(null);
      loadNetworkTopology(); // Refresh topology
    }
  }, [scanStatus]);

  // Load network topology on component mount
  useEffect(() => {
    loadNetworkTopology();
  }, []);

  const loadNetworkTopology = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchNetworkTopology();
      setNetworkData(data);
    } catch (err) {
      console.error('Error loading network topology:', err);
      setError('Failed to load network data. Using fallback data.');
      // Use fallback data on error
      setNetworkData(generateVulnerabilityData());
    } finally {
      setLoading(false);
    }
  };

  const handleRefresh = () => {
    loadNetworkTopology();
  };

  // Show loading state
  if (loading || !networkData) {
    return (
      <Container maxWidth="xl" sx={{ mt: 4, mb: 4, display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', minHeight: '60vh' }}>
        <CircularProgress size={60} sx={{ mb: 2 }} />
        <Typography variant="h6" color="text.secondary">
          Loading network topology...
        </Typography>
      </Container>
    );
  }

  // Show error alert if there was an error
  const errorAlert = error && (
    <Alert severity="warning" sx={{ mb: 2 }} onClose={() => setError(null)}>
      {error}
    </Alert>
  );

  // Calculate vulnerability statistics
  const totalDevices = networkData.devices.length;
  const onlineDevices = networkData.devices.filter(d => d.status === 'online').length;
  const criticalDevices = networkData.devices.filter(d => d.severity === 'critical').length;
  const totalVulnerabilities = networkData.devices.reduce((sum, d) =>
    sum + (d.vulnerabilityMetrics?.totalVulnerabilities || 0), 0
  );
  const criticalVulnerabilities = networkData.devices.reduce((sum, d) =>
    sum + (d.vulnerabilityMetrics?.criticalCount || 0), 0
  );
  const avgRiskScore = Math.round(
    networkData.devices.reduce((sum, d) => sum + (d.vulnerabilityMetrics?.riskScore || 0), 0) / totalDevices
  );

  // Chart data for vulnerability trend
  const generateTrendData = () => {
    const data = [];
    const now = Date.now();
    for (let i = 30; i >= 0; i--) {
      data.push({
        timestamp: new Date(now - i * 24 * 60 * 60 * 1000).toISOString(),
        value: Math.round(totalVulnerabilities * (0.8 + Math.random() * 0.4)),
      });
    }
    return data;
  };

  // Devices with critical vulnerabilities table
  const criticalDevicesColumns = [
    { id: 'name', label: 'Device Name' },
    { id: 'ipAddress', label: 'IP Address' },
    { id: 'severity', label: 'Severity' },
    { id: 'criticalCount', label: 'Critical Vulns', numeric: true },
    { id: 'riskScore', label: 'Risk Score', numeric: true },
    { id: 'assignedTeam', label: 'Assigned Team' },
  ];

  const criticalDevicesRows = networkData.devices
    .filter(d => (d.vulnerabilityMetrics?.criticalCount || 0) > 0)
    .map(d => ({
      id: d.id,
      name: d.name,
      ipAddress: d.ipAddress,
      severity: d.severity,
      criticalCount: d.vulnerabilityMetrics?.criticalCount || 0,
      riskScore: d.vulnerabilityMetrics?.riskScore || 0,
      assignedTeam: d.assignment?.assignedTeamName || 'Unassigned',
    }));

  if (selectedDevice) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <Button
          startIcon={<DashboardIcon />}
          onClick={() => setSelectedDevice(null)}
          sx={{ mb: 2 }}
        >
          Back to Dashboard
        </Button>
        <DeviceDetailView device={selectedDevice} onRefresh={handleRefresh} />
      </Container>
    );
  }

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Error Alert */}
      {errorAlert}

      {/* Header */}
      <Stack direction="row" justifyContent="space-between" alignItems="center" mb={3}>
        <Box>
          <Typography variant="h4" gutterBottom sx={{ fontWeight: 600 }}>
            Network Topology & Vulnerability Dashboard
          </Typography>
          <Typography variant="body2" color="text.secondary">
            Real-time asset vulnerability monitoring • Last updated: {new Date(networkData.lastUpdated).toLocaleString()}
            {currentScanId && scanStatus && ` • Scanning: ${scanStatus.devices_found} devices found (${scanStatus.progress_percent}%)`}
          </Typography>
        </Box>
        <Stack direction="row" spacing={2}>
          <Button
            variant="outlined"
            startIcon={<PlayIcon />}
            onClick={() => setScanDialogOpen(true)}
            disabled={!!currentScanId}
          >
            {currentScanId ? 'Scanning...' : 'Start Network Scan'}
          </Button>
          <Button
            variant="contained"
            startIcon={<RefreshIcon />}
            onClick={handleRefresh}
          >
            Refresh All
          </Button>
        </Stack>
      </Stack>

      {/* Vulnerability Overview Cards */}
      <Grid container spacing={3} mb={3}>
        <Grid item xs={12} sm={6} md={3}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h3" sx={{ color: entuityColors.primary.main, fontWeight: 700 }}>
              {totalDevices}
            </Typography>
            <Typography variant="body2" color="text.secondary">
              Total Assets
            </Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h3" sx={{ color: entuityColors.critical, fontWeight: 700 }}>
              {criticalDevices}
            </Typography>
            <Typography variant="body2" color="text.secondary">
              Critical Risk Assets
            </Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h3" sx={{ color: entuityColors.high, fontWeight: 700 }}>
              {criticalVulnerabilities}
            </Typography>
            <Typography variant="body2" color="text.secondary">
              Critical Vulnerabilities
            </Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Paper sx={{ p: 2, textAlign: 'center' }}>
            <Typography variant="h3" sx={{ color: avgRiskScore > 70 ? entuityColors.critical : entuityColors.warning, fontWeight: 700 }}>
              {avgRiskScore}
            </Typography>
            <Typography variant="body2" color="text.secondary">
              Average Risk Score
            </Typography>
          </Paper>
        </Grid>
      </Grid>

      {/* Main Dashboard Grid */}
      <Grid container spacing={3}>
        {/* Network Topology - Full width */}
        <Grid item xs={12}>
          <NetworkTopology
            data={networkData}
            onDeviceClick={setSelectedDevice}
            onRefresh={handleRefresh}
            height={600}
          />
        </Grid>

        {/* Vulnerability Summary */}
        <Grid item xs={12} md={6}>
          <KeyInfoDashlet
            title="Vulnerability Summary"
            status={criticalVulnerabilities > 0 ? 'warning' : 'online'}
            severity={criticalVulnerabilities > 10 ? 'critical' : criticalVulnerabilities > 0 ? 'high' : 'none'}
            primaryInfo={[
              { label: 'Total Vulnerabilities', value: totalVulnerabilities, severity: criticalVulnerabilities > 0 ? 'high' : 'none' },
              { label: 'Critical', value: criticalVulnerabilities, severity: criticalVulnerabilities > 0 ? 'critical' : 'none' },
              { label: 'High', value: networkData.devices.reduce((sum, d) => sum + (d.vulnerabilityMetrics?.highCount || 0), 0), severity: 'high' },
              { label: 'Medium', value: networkData.devices.reduce((sum, d) => sum + (d.vulnerabilityMetrics?.mediumCount || 0), 0), severity: 'medium' },
            ]}
            secondaryInfo={[
              { label: 'Assets Scanned', value: `${onlineDevices}/${totalDevices}` },
              { label: 'Avg Compliance', value: `${Math.round(networkData.devices.reduce((sum, d) => sum + (d.vulnerabilityMetrics?.complianceScore || 0), 0) / totalDevices)}%` },
              { label: 'Pending Remediations', value: networkData.devices.reduce((sum, d) => sum + (d.remediationInfo?.pendingRemediations || 0), 0) },
            ]}
            incidentCount={criticalVulnerabilities}
            lastUpdated={networkData.lastUpdated}
          />
        </Grid>

        {/* Vulnerability Trend Chart */}
        <Grid item xs={12} md={6}>
          <ChartDashlet
            title="Vulnerability Trend"
            subtitle="Total vulnerabilities over last 30 days"
            chartType="line"
            series={[
              {
                name: 'Vulnerabilities',
                data: generateTrendData(),
                color: entuityColors.critical,
              },
            ]}
            currentValue={totalVulnerabilities}
            currentUnit=" vulns"
            threshold={{ warning: 50, critical: 100 }}
            onRefresh={handleRefresh}
            timeRange="30d"
          />
        </Grid>

        {/* Devices with Critical Vulnerabilities Table */}
        <Grid item xs={12}>
          <TableDashlet
            title="Critical Risk Assets"
            subtitle={`${criticalDevicesRows.length} assets with critical vulnerabilities`}
            columns={criticalDevicesColumns}
            rows={criticalDevicesRows}
            onRowClick={(row) => {
              const device = networkData.devices.find(d => d.id === row.id);
              if (device) setSelectedDevice(device);
            }}
            onRefresh={handleRefresh}
            searchable
            sortable
          />
        </Grid>
      </Grid>

      {/* Network Scan Dialog */}
      <Dialog open={scanDialogOpen} onClose={() => setScanDialogOpen(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Start Network Scan</DialogTitle>
        <DialogContent>
          <Stack spacing={2} sx={{ mt: 1 }}>
            <TextField
              label="Scan Name"
              fullWidth
              value={scanFormData.scan_name}
              onChange={(e) => setScanFormData({ ...scanFormData, scan_name: e.target.value })}
            />
            <TextField
              select
              label="Scan Type"
              fullWidth
              value={scanFormData.scan_type}
              onChange={(e) => setScanFormData({ ...scanFormData, scan_type: e.target.value })}
            >
              <MenuItem value="arp">ARP Scan (Fast)</MenuItem>
              <MenuItem value="ping">Ping Scan</MenuItem>
              <MenuItem value="full">Full Port Scan</MenuItem>
            </TextField>
            <TextField
              label="Target Range (CIDR)"
              fullWidth
              value={scanFormData.target_range}
              onChange={(e) => setScanFormData({ ...scanFormData, target_range: e.target.value })}
              placeholder="192.168.1.0/24"
              helperText="Enter network range in CIDR notation"
            />
          </Stack>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setScanDialogOpen(false)}>Cancel</Button>
          <Button
            variant="contained"
            onClick={() => startScanMutation.mutate(scanFormData)}
            disabled={startScanMutation.isPending}
            startIcon={startScanMutation.isPending ? <CircularProgress size={20} /> : <PlayIcon />}
          >
            {startScanMutation.isPending ? 'Starting...' : 'Start Scan'}
          </Button>
        </DialogActions>
      </Dialog>
    </Container>
  );
};

export default NetworkDashboard;
