// src/pages/JiraIntegration.tsx
import React, { useState } from 'react';
import {
  Box,
  Container,
  Typography,
  Button,
  Paper,
  Grid,
  Card,
  CardContent,
  CardActions,
  Chip,
  IconButton,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControlLabel,
  Switch,
  Alert,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Link
} from '@mui/material';
import { Add, Edit, Delete, Sync, CheckCircle, Error as ErrorIcon, OpenInNew } from '@mui/icons-material';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { jiraApi, CreateJiraConfigurationRequest } from '../api/jira';

export const JiraIntegrationPage: React.FC = () => {
  const [openConfig, setOpenConfig] = useState(false);
  const [editingConfig, setEditingConfig] = useState<any>(null);
  const queryClient = useQueryClient();

  const { data: configurations } = useQuery({
    queryKey: ['jira-configurations'],
    queryFn: () => jiraApi.listConfigurations(),
  });

  const { data: tickets } = useQuery({
    queryKey: ['jira-tickets'],
    queryFn: () => jiraApi.listTickets(),
  });

  const createConfigMutation = useMutation({
    mutationFn: (payload: CreateJiraConfigurationRequest) => jiraApi.createConfiguration(payload),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['jira-configurations'] });
      setOpenConfig(false);
      setEditingConfig(null);
    },
  });

  const deleteConfigMutation = useMutation({
    mutationFn: (configId: string) => jiraApi.deleteConfiguration(configId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['jira-configurations'] });
    },
  });

  const [formData, setFormData] = useState<CreateJiraConfigurationRequest>({
    name: '',
    base_url: '',
    username: '',
    api_token: '',
    default_project_key: '',
    default_issue_type: 'Task',
    is_enabled: true,
    auto_create_tickets: false,
    auto_sync: true,
  });

  const handleSubmit = () => {
    createConfigMutation.mutate(formData);
  };

  return (
    <Container maxWidth="xl">
      <Box sx={{ py: 4 }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 3 }}>
          <Typography variant="h4">JIRA Integration</Typography>
          <Button
            variant="contained"
            startIcon={<Add />}
            onClick={() => setOpenConfig(true)}
          >
            Add Configuration
          </Button>
        </Box>

        <Alert severity="info" sx={{ mb: 3 }}>
          Automatically create and sync JIRA tickets for critical vulnerabilities. Configure multiple JIRA instances.
        </Alert>

        {/* Configurations */}
        <Typography variant="h6" gutterBottom>
          JIRA Configurations
        </Typography>
        <Grid container spacing={2} sx={{ mb: 4 }}>
          {configurations?.map((config) => (
            <Grid item xs={12} md={6} lg={4} key={config.id}>
              <Card>
                <CardContent>
                  <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', mb: 2 }}>
                    <Typography variant="h6">{config.name}</Typography>
                    <Chip
                      label={config.is_enabled ? 'Active' : 'Inactive'}
                      color={config.is_enabled ? 'success' : 'default'}
                      size="small"
                    />
                  </Box>
                  <Typography variant="body2" color="text.secondary" gutterBottom>
                    {config.base_url}
                  </Typography>
                  <Typography variant="body2">
                    Project: {config.default_project_key || 'N/A'}
                  </Typography>
                  <Box sx={{ mt: 2, display: 'flex', gap: 1 }}>
                    {config.auto_create_tickets && (
                      <Chip label="Auto-Create" size="small" color="primary" />
                    )}
                    {config.auto_sync && (
                      <Chip label="Auto-Sync" size="small" color="info" />
                    )}
                  </Box>
                </CardContent>
                <CardActions>
                  <IconButton size="small" onClick={() => { setEditingConfig(config); setOpenConfig(true); }}>
                    <Edit />
                  </IconButton>
                  <IconButton size="small" onClick={() => deleteConfigMutation.mutate(config.id)}>
                    <Delete />
                  </IconButton>
                </CardActions>
              </Card>
            </Grid>
          ))}
        </Grid>

        {/* Synced Tickets */}
        <Typography variant="h6" gutterBottom>
          Synced Tickets
        </Typography>
        <TableContainer component={Paper}>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>JIRA Key</TableCell>
                <TableCell>Vulnerability</TableCell>
                <TableCell>Status</TableCell>
                <TableCell>Priority</TableCell>
                <TableCell>Sync Status</TableCell>
                <TableCell>Actions</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {tickets?.slice(0, 10).map((ticket) => (
                <TableRow key={ticket.id}>
                  <TableCell>
                    <Link href={ticket.jira_url} target="_blank" rel="noopener" sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                      {ticket.jira_issue_key}
                      <OpenInNew fontSize="small" />
                    </Link>
                  </TableCell>
                  <TableCell>{ticket.vulnerability_title || ticket.entity_id}</TableCell>
                  <TableCell>
                    <Chip label={ticket.jira_status || 'Open'} size="small" />
                  </TableCell>
                  <TableCell>
                    <Chip label={ticket.jira_priority || 'Medium'} size="small" color="warning" />
                  </TableCell>
                  <TableCell>
                    {ticket.sync_status === 'synced' ? (
                      <Chip label="Synced" size="small" color="success" icon={<CheckCircle />} />
                    ) : (
                      <Chip label={ticket.sync_status} size="small" color="error" icon={<ErrorIcon />} />
                    )}
                  </TableCell>
                  <TableCell>
                    <IconButton size="small">
                      <Sync fontSize="small" />
                    </IconButton>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </TableContainer>

        {/* Create/Edit Config Dialog */}
        <Dialog open={openConfig} onClose={() => setOpenConfig(false)} maxWidth="md" fullWidth>
          <DialogTitle>{editingConfig ? 'Edit Configuration' : 'Add JIRA Configuration'}</DialogTitle>
          <DialogContent>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 2 }}>
              <TextField
                label="Configuration Name"
                fullWidth
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              />
              <TextField
                label="JIRA Base URL"
                fullWidth
                placeholder="https://your-company.atlassian.net"
                value={formData.base_url}
                onChange={(e) => setFormData({ ...formData, base_url: e.target.value })}
              />
              <TextField
                label="Username / Email"
                fullWidth
                value={formData.username}
                onChange={(e) => setFormData({ ...formData, username: e.target.value })}
              />
              <TextField
                label="API Token"
                type="password"
                fullWidth
                value={formData.api_token}
                onChange={(e) => setFormData({ ...formData, api_token: e.target.value })}
                helperText="Generate from JIRA Account Settings"
              />
              <TextField
                label="Default Project Key"
                fullWidth
                placeholder="VULN"
                value={formData.default_project_key}
                onChange={(e) => setFormData({ ...formData, default_project_key: e.target.value })}
              />
              <TextField
                label="Default Issue Type"
                fullWidth
                value={formData.default_issue_type}
                onChange={(e) => setFormData({ ...formData, default_issue_type: e.target.value })}
              />
              <FormControlLabel
                control={
                  <Switch
                    checked={formData.is_enabled}
                    onChange={(e) => setFormData({ ...formData, is_enabled: e.target.checked })}
                  />
                }
                label="Enabled"
              />
              <FormControlLabel
                control={
                  <Switch
                    checked={formData.auto_create_tickets}
                    onChange={(e) => setFormData({ ...formData, auto_create_tickets: e.target.checked })}
                  />
                }
                label="Auto-Create Tickets for Critical Vulnerabilities"
              />
              <FormControlLabel
                control={
                  <Switch
                    checked={formData.auto_sync}
                    onChange={(e) => setFormData({ ...formData, auto_sync: e.target.checked })}
                  />
                }
                label="Bidirectional Sync"
              />
            </Box>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setOpenConfig(false)}>Cancel</Button>
            <Button
              variant="contained"
              onClick={handleSubmit}
              disabled={!formData.name || !formData.base_url || createConfigMutation.isPending}
            >
              {createConfigMutation.isPending ? 'Saving...' : 'Save'}
            </Button>
          </DialogActions>
        </Dialog>
      </Box>
    </Container>
  );
};
