import React, { useState, useEffect } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  IconButton,
  TextField,
  InputAdornment,
  Chip,
  Grid,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Alert,
  Tooltip,
  LinearProgress,
  Menu,
  MenuItem,
  ListItemIcon,
  ListItemText,
} from '@mui/material';
import { DataGrid, GridColDef, GridRenderCellParams, GridRowSelectionModel } from '@mui/x-data-grid';
import {
  Add as AddIcon,
  Search as SearchIcon,
  Computer as ComputerIcon,
  Security as SecurityIcon,
  Warning as WarningIcon,
  CheckCircle as CheckCircleIcon,
  Error as ErrorIcon,
  Refresh as RefreshIcon,
  Edit as EditIcon,
  Dashboard as DashboardIcon,
  Delete as DeleteIcon,
  Visibility as VisibilityIcon,
} from '@mui/icons-material';
import { api } from '../api/api';
import type { Host } from '../types';
import { NetworkDevice } from '../types/network';
import EditAssetDialog from '../components/EditAssetDialog';
import StatsCard from '../components/common/StatsCard';
import DeviceDetailView from '../components/DeviceDetailView';

// Convert Host to NetworkDevice for DeviceDetailView
const convertHostToNetworkDevice = (host: Host): NetworkDevice => {
  const vulnCount = host.vulnerability_count || 0;
  return {
    id: host.id,
    name: host.name || host.hostname || 'Unknown',
    hostname: host.hostname,
    type: 'endpoint' as const,
    status: 'online' as const,
    ipAddress: host.ip_address || 'N/A',
    macAddress: host.mac_address,
    location: host.location,
    vendor: host.vendor,
    manufacturer: host.vendor,
    osVersion: host.os_version || host.os || host.operating_system,
    os_version: host.os_version,
    owner: host.owner,
    criticality: host.criticality,
    tags: host.tags || [],
    notes: host.notes,
    vulnerabilityMetrics: {
      totalVulnerabilities: vulnCount,
      criticalCount: 0, // Would need detailed data from backend
      highCount: 0,
      mediumCount: 0,
      lowCount: 0,
      resolvedCount: 0,
      riskScore: Math.min(vulnCount * 10, 100), // Simple calculation
      lastScanDate: host.last_scan,
      scanStatus: 'completed' as const,
    },
    severity: vulnCount >= 5 ? 'critical' : vulnCount > 0 ? 'high' : 'none',
    incidentCount: vulnCount,
    lastSeen: host.updated_at,
  };
};

const Hosts: React.FC = () => {
  const [hosts, setHosts] = useState<Host[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [openDialog, setOpenDialog] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [selectedAsset, setSelectedAsset] = useState<Host | null>(null);
  const [selectedHost, setSelectedHost] = useState<Host | null>(null);
  const [formData, setFormData] = useState({
    hostname: '',
    ip_address: '',
    os: '',
    description: '',
  });
  const [error, setError] = useState<string | null>(null);
  const [scanning, setScanning] = useState(false);
  const [selectedRows, setSelectedRows] = useState<GridRowSelectionModel>([]);
  const [contextMenu, setContextMenu] = useState<{ mouseX: number; mouseY: number } | null>(null);

  useEffect(() => {
    fetchHosts();
  }, []);

  const fetchHosts = async () => {
    try {
      setLoading(true);
      // Fetch from topology endpoint to include both assets and network_devices
      const response = await api.get('/api/network/topology-with-vulnerabilities');

      // Map devices from topology to Host format
      const mappedHosts = response.data.devices.map((device: any) => {
        const vulnData = device.vulnerabilities || device.vulnerability_metrics;

        return {
          id: device.id,
          name: device.hostname || device.name || device.ip_address || 'Unknown',
          hostname: device.hostname,
          ip_address: device.ip_address,
          mac_address: device.mac_address,
          operating_system: device.os_name || device.operating_system,
          os_version: device.os_version,
          vendor: device.vendor,
          asset_type: device.device_type?.toLowerCase() || device.asset_type || 'unknown',
          description: device.description,
          notes: device.notes,
          owner: device.owner,
          location: device.location,
          criticality: device.criticality,
          tags: device.tags,
          vulnerability_count: vulnData?.total || 0,
          last_scan: device.last_seen || device.updated_at,
          created_at: device.created_at,
          updated_at: device.updated_at || device.last_seen,
        };
      });

      setHosts(mappedHosts);
      setSelectedHost(prev => {
        if (!prev) return prev;
        const refreshed = mappedHosts.find((h: any) => h.id === prev.id);
        return refreshed || prev;
      });
    } catch (err) {
      setError('Errore nel caricamento degli host');
      console.error('Error fetching hosts:', err);
    } finally {
      setLoading(false);
    }
  };

  const handleScan = async () => {
    try {
      setScanning(true);
      await api.post('/api/network/scan', { scan_type: 'quick', target_range: '192.168.1.0/24' });
      fetchHosts();
    } catch (err) {
      setError('Errore durante la scansione');
      console.error('Error scanning hosts:', err);
    } finally {
      setScanning(false);
    }
  };

  const handleSubmit = async () => {
    try {
      // Transform form data to match backend Asset schema
      const payload = {
        name: formData.hostname || 'Unnamed Host',
        asset_type: 'server',  // Default asset type
        hostname: formData.hostname,
        ip_address: formData.ip_address ? `${formData.ip_address}/32` : null,  // Add CIDR notation
        operating_system: formData.os,
        description: formData.description,
      };
      await api.post('/api/assets', payload);
      setOpenDialog(false);
      setFormData({
        hostname: '',
        ip_address: '',
        os: '',
        description: '',
      });
      fetchHosts();
    } catch (err) {
      setError('Errore nel salvataggio dell\'host');
      console.error('Error saving host:', err);
    }
  };

  // Handle context menu
  const handleContextMenu = (event: React.MouseEvent) => {
    event.preventDefault();
    if (selectedRows.length === 0) return;
    setContextMenu(
      contextMenu === null
        ? { mouseX: event.clientX + 2, mouseY: event.clientY - 6 }
        : null
    );
  };

  const handleCloseContextMenu = () => {
    setContextMenu(null);
  };

  // Handle bulk delete
  const handleBulkDelete = async () => {
    if (selectedRows.length === 0) return;
    if (window.confirm(`Sei sicuro di voler eliminare ${selectedRows.length} host?`)) {
      try {
        await Promise.all(selectedRows.map((id) => api.delete(`/api/assets/${id}`)));
        setSelectedRows([]);
        fetchHosts();
      } catch (err) {
        setError('Errore durante l\'eliminazione degli host');
        console.error('Error deleting hosts:', err);
      }
    }
    handleCloseContextMenu();
  };

  const getStatusIcon = (vulnerabilityCount: number) => {
    if (vulnerabilityCount === 0) {
      return <CheckCircleIcon color="success" />;
    } else if (vulnerabilityCount < 5) {
      return <WarningIcon color="warning" />;
    } else {
      return <ErrorIcon color="error" />;
    }
  };

  const getStatusColor = (vulnerabilityCount: number) => {
    if (vulnerabilityCount === 0) return 'success';
    if (vulnerabilityCount < 5) return 'warning';
    return 'error';
  };

  const filteredHosts = hosts.filter(host =>
    host.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    host.hostname?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    host.ip_address?.includes(searchTerm) ||
    host.os?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const columns: GridColDef[] = [
    {
      field: 'status',
      headerName: 'Stato',
      width: 80,
      renderCell: (params: GridRenderCellParams) => (
        <Tooltip title={`${params.row.vulnerability_count || 0} vulnerabilità`}>
          {getStatusIcon(params.row.vulnerability_count || 0)}
        </Tooltip>
      ),
    },
    {
      field: 'name',
      headerName: 'Nome',
      width: 200,
      renderCell: (params: GridRenderCellParams) => (
        <Box
          sx={{
            display: 'flex',
            alignItems: 'center',
            gap: 1,
          }}
        >
          <ComputerIcon fontSize="small" color="action" />
          {params.value || params.row.hostname || 'N/D'}
        </Box>
      ),
    },
    {
      field: 'hostname',
      headerName: 'Hostname',
      width: 200,
      renderCell: (params: GridRenderCellParams) => (
        params.value || <Typography color="text.secondary">N/D</Typography>
      ),
    },
    {
      field: 'ip_address',
      headerName: 'Indirizzo IP',
      width: 150,
    },
    {
      field: 'os',
      headerName: 'Sistema Operativo',
      width: 200,
      renderCell: (params: GridRenderCellParams) => (
        params.value || <Typography color="text.secondary">N/D</Typography>
      ),
    },
    {
      field: 'vulnerability_count',
      headerName: 'Vulnerabilità',
      width: 150,
      renderCell: (params: GridRenderCellParams) => {
        const count = params.value || 0;
        return (
          <Chip
            icon={<SecurityIcon />}
            label={count}
            color={getStatusColor(count)}
            size="small"
          />
        );
      },
    },
    {
      field: 'last_scan',
      headerName: 'Ultima Scansione',
      width: 180,
      renderCell: (params: GridRenderCellParams) => {
        if (!params.value) {
          return <Typography color="text.secondary">Mai scansionato</Typography>;
        }
        return new Date(params.value).toLocaleString('it-IT');
      },
    },
    {
      field: 'description',
      headerName: 'Descrizione',
      flex: 1,
      renderCell: (params: GridRenderCellParams) => (
        params.value || <Typography color="text.secondary">-</Typography>
      ),
    },
    {
      field: 'actions',
      headerName: 'Azioni',
      width: 120,
      renderCell: (params: GridRenderCellParams) => (
        <Box sx={{ display: 'flex', gap: 0.5 }}>
          <Tooltip title="Dettagli completi">
            <IconButton
              size="small"
              onClick={(e) => {
                e.stopPropagation();
                setSelectedHost(params.row);
              }}
            >
              <VisibilityIcon fontSize="small" />
            </IconButton>
          </Tooltip>
          <Tooltip title="Modifica rapida">
            <IconButton
              size="small"
              onClick={(e) => {
                e.stopPropagation();
                setSelectedAsset(params.row);
                setEditDialogOpen(true);
              }}
            >
              <EditIcon fontSize="small" />
            </IconButton>
          </Tooltip>
        </Box>
      ),
    },
  ];

  const stats = {
    total: hosts.length,
    secure: hosts.filter(h => (h.vulnerability_count || 0) === 0).length,
    warning: hosts.filter(h => (h.vulnerability_count || 0) > 0 && (h.vulnerability_count || 0) < 5).length,
    critical: hosts.filter(h => (h.vulnerability_count || 0) >= 5).length,
  };

  // Show DeviceDetailView when a host is selected
  if (selectedHost) {
    const networkDevice = convertHostToNetworkDevice(selectedHost);
    return (
      <Box>
        <Button
          startIcon={<DashboardIcon />}
          onClick={() => setSelectedHost(null)}
          sx={{ mb: 2 }}
        >
          Torna alla lista Host
        </Button>
        <DeviceDetailView device={networkDevice} onRefresh={fetchHosts} />
      </Box>
    );
  }

  return (
    <Box>
      <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 3 }}>
        <Typography variant="h4" component="h1">
          Gestione Host
        </Typography>
        <Button
          variant="contained"
          startIcon={<AddIcon />}
          onClick={() => setOpenDialog(true)}
        >
          Aggiungi Host
        </Button>
      </Box>

      {error && (
        <Alert severity="error" sx={{ mb: 2 }} onClose={() => setError(null)}>
          {error}
        </Alert>
      )}

      <Grid container spacing={3} sx={{ mb: 3 }}>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Host Totali"
            value={stats.total}
            description="Numero totale di host (asset) registrati nel sistema di gestione vulnerabilità. Include server, workstation, dispositivi di rete e altri asset IT monitorati. Ogni host può avere vulnerabilità associate e viene scansionato periodicamente per identificare nuove vulnerabilità."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Host Sicuri"
            value={stats.secure}
            color="success"
            description="Host senza vulnerabilità attive rilevate. Questi host hanno passato tutte le scansioni di sicurezza senza identificare vulnerabilità aperte. Tuttavia, potrebbero comunque richiedere patch di sicurezza regolari e monitoraggio continuo per mantenere lo stato sicuro."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Attenzione"
            value={stats.warning}
            color="warning"
            description="Host con 1-4 vulnerabilità attive rilevate. Questi host richiedono attenzione ma non sono in stato critico. Le vulnerabilità potrebbero essere di severità bassa o media. Pianificare la remediation secondo le priorità e gli SLA definiti per evitare accumulo di debito tecnico."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Critici"
            value={stats.critical}
            color="error"
            description="Host con 5 o più vulnerabilità attive o con almeno una vulnerabilità critica. Questi host rappresentano un rischio elevato per la sicurezza dell'infrastruttura e richiedono remediation immediata. Considerare l'isolamento dalla rete o misure di mitigazione temporanee fino alla risoluzione."
          />
        </Grid>
      </Grid>

      <Card>
        <CardContent>
          <Box sx={{ mb: 2 }}>
            <TextField
              fullWidth
              variant="outlined"
              placeholder="Cerca host..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              InputProps={{
                startAdornment: (
                  <InputAdornment position="start">
                    <SearchIcon />
                  </InputAdornment>
                ),
              }}
            />
          </Box>

          <Box onContextMenu={handleContextMenu}>
            <DataGrid
              rows={filteredHosts}
              columns={columns}
              initialState={{
                pagination: {
                  paginationModel: { pageSize: 25 },
                },
              }}
              pageSizeOptions={[10, 25, 50]}
              checkboxSelection
              rowSelectionModel={selectedRows}
              onRowSelectionModelChange={setSelectedRows}
              disableRowSelectionOnClick
              autoHeight
              loading={loading}
              sx={{
                '& .MuiDataGrid-cell:focus': {
                  outline: 'none',
                },
              }}
            />
          </Box>
        </CardContent>
      </Card>

      <Dialog open={openDialog} onClose={() => setOpenDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Aggiungi Nuovo Host</DialogTitle>
        <DialogContent>
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 2 }}>
            <TextField
              fullWidth
              label="Hostname"
              value={formData.hostname}
              onChange={(e) => setFormData({ ...formData, hostname: e.target.value })}
              required
            />
            <TextField
              fullWidth
              label="Indirizzo IP"
              value={formData.ip_address}
              onChange={(e) => setFormData({ ...formData, ip_address: e.target.value })}
              required
              placeholder="192.168.1.1"
            />
            <TextField
              fullWidth
              label="Sistema Operativo"
              value={formData.os}
              onChange={(e) => setFormData({ ...formData, os: e.target.value })}
              placeholder="Windows Server 2019, Ubuntu 20.04, etc."
            />
            <TextField
              fullWidth
              label="Descrizione"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              multiline
              rows={3}
            />
          </Box>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpenDialog(false)}>Annulla</Button>
          <Button onClick={handleSubmit} variant="contained">
            Aggiungi
          </Button>
        </DialogActions>
      </Dialog>

      {/* Context Menu */}
      <Menu
        open={contextMenu !== null}
        onClose={handleCloseContextMenu}
        anchorReference="anchorPosition"
        anchorPosition={
          contextMenu !== null
            ? { top: contextMenu.mouseY, left: contextMenu.mouseX }
            : undefined
        }
      >
        <MenuItem onClick={handleBulkDelete}>
          <ListItemIcon>
            <DeleteIcon fontSize="small" />
          </ListItemIcon>
          <ListItemText>Elimina tutto ({selectedRows.length})</ListItemText>
        </MenuItem>
      </Menu>

      <EditAssetDialog
        open={editDialogOpen}
        asset={selectedAsset}
        onClose={() => {
          setEditDialogOpen(false);
          setSelectedAsset(null);
        }}
        onSuccess={() => {
          fetchHosts();
        }}
      />
    </Box>
  );
};

export default Hosts;