// src/pages/Vulnerabilities.tsx
import React, { useState, useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  Box,
  Typography,
  Button,
  Chip,
  IconButton,
  TextField,
  MenuItem,
  Grid,
  FormControl,
  InputLabel,
  Select,
  Alert,
  CircularProgress,
  Snackbar,
  Card,
  CardContent,
  InputAdornment,
  useTheme,
  Menu,
  ListItemIcon,
  ListItemText,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Slider,
} from '@mui/material';
import {
  Add as AddIcon,
  Download as DownloadIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Assignment as AssignmentIcon,
  Refresh as RefreshIcon,
  Person as PersonIcon,
  Search as SearchIcon,
  MoreVert as MoreVertIcon,
  CheckCircle as CheckCircleIcon,
  Assessment as AssessmentIcon,
} from '@mui/icons-material';
import { DataGrid, GridColDef, GridRowSelectionModel } from '@mui/x-data-grid';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { format } from 'date-fns';

import { vulnerabilitiesApi } from '../api/vulnerabilities';
import { teamsApi } from '../api/teams';
import { useAuth } from '../contexts/AuthContext';
import {
  Vulnerability,
  VulnerabilityStatus,
  VulnerabilitySeverity,
  VulnerabilityFilter,
  Team,
} from '../types';
import VulnerabilityDetail from '../components/vulnerabilities/VulnerabilityDetail';
import VulnerabilityForm from '../components/vulnerabilities/VulnerabilityForm';
import { RiskScoreBadge } from '../components/quick-wins/RiskScoreBadge';
import { SLACountdown } from '../components/quick-wins/SLACountdown';
import { getSeverityColor, getVulnerabilityStatusColor } from '../theme/entuityTheme';
import StatsCard from '../components/common/StatsCard';

const Vulnerabilities: React.FC = () => {
  const theme = useTheme();
  const { id } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  const queryClient = useQueryClient();

  // Export to CSV function
  const exportToCSV = () => {
    if (vulnerabilities.length === 0) {
      setSnackbar({ open: true, message: 'Nessuna vulnerabilità da esportare', severity: 'info' });
      return;
    }

    const headers = [
      'ID', 'Titolo', 'Severità', 'Stato', 'CVSS', 'EPSS', 'CVE', 'CWE',
      'IP', 'Hostname', 'Porta', 'Protocollo', 'Team Assegnato', 'Utente Assegnato',
      'Sorgente', 'Data Scoperta', 'Descrizione', 'Remediation'
    ];

    const dataToExport = selectedRows.length > 0
      ? vulnerabilities.filter(v => selectedRows.includes(v.id))
      : vulnerabilities;

    const csvRows = dataToExport.map(v => [
      v.id,
      `"${(v.title || '').replace(/"/g, '""')}"`,
      v.severity,
      v.status,
      v.cvss_score,
      v.epss_score || '',
      v.cve_id || '',
      v.cwe_id || '',
      v.ip_address,
      v.hostname || '',
      v.port || '',
      v.protocol || '',
      v.assigned_team_name || '',
      v.assigned_user_name || '',
      v.source || '',
      v.discovered_at ? format(new Date(v.discovered_at), 'yyyy-MM-dd HH:mm') : '',
      `"${(v.description || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
      `"${(v.remediation || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`
    ].join(','));

    const csvContent = [headers.join(','), ...csvRows].join('\n');
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `vulnerabilities_${format(new Date(), 'yyyy-MM-dd_HHmm')}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    setSnackbar({
      open: true,
      message: `Esportate ${dataToExport.length} vulnerabilità`,
      severity: 'success'
    });
  };

  const [selectedRows, setSelectedRows] = useState<GridRowSelectionModel>([]);
  const [formOpen, setFormOpen] = useState(false);
  const [selectedVulnerability, setSelectedVulnerability] = useState<Vulnerability | undefined>(undefined);
  const [selectedTeamId, setSelectedTeamId] = useState('');
  const [selectedUserId, setSelectedUserId] = useState('');
  const [filters, setFilters] = useState<VulnerabilityFilter>({});
  const [searchTerm, setSearchTerm] = useState('');
  const [snackbar, setSnackbar] = useState<{ open: boolean; message: string; severity: 'success' | 'error' | 'info' }>({
    open: false,
    message: '',
    severity: 'info'
  });

  // Context menu and bulk actions state
  const [contextMenu, setContextMenu] = useState<{ mouseX: number; mouseY: number } | null>(null);
  const [statusDialogOpen, setStatusDialogOpen] = useState(false);
  const [riskDialogOpen, setRiskDialogOpen] = useState(false);
  const [selectedStatus, setSelectedStatus] = useState<VulnerabilityStatus>(VulnerabilityStatus.Open);
  const [selectedRisk, setSelectedRisk] = useState<number>(50);

  const isAdmin = user?.role === 'admin';
  const isTeamLeader = user?.role === 'team_leader';

  // Fetch vulnerabilities
  const { data: vulnerabilities = [], isLoading, refetch } = useQuery({
    queryKey: ['vulnerabilities', filters],
    queryFn: () => vulnerabilitiesApi.list(filters),
  });

  // Fetch teams for assignment
  const { data: teams = [] } = useQuery({
    queryKey: ['teams'],
    queryFn: () => teamsApi.list(),
  });

  // Fetch team members for user assignment
  const { data: teamMembers = [] } = useQuery({
    queryKey: ['teamMembers', selectedTeamId],
    queryFn: () => selectedTeamId ? teamsApi.getMembers(selectedTeamId) : Promise.resolve([]),
    enabled: !!selectedTeamId,
  });

  // Delete mutation
  const deleteMutation = useMutation({
    mutationFn: vulnerabilitiesApi.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSnackbar({ open: true, message: 'Vulnerabilità eliminata', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante l\'eliminazione', severity: 'error' });
    }
  });

  // Assign to team mutation
  const assignTeamMutation = useMutation({
    mutationFn: ({ vulnerabilityId, teamId }: { vulnerabilityId: string; teamId: string }) =>
      vulnerabilitiesApi.assignToTeam(vulnerabilityId, teamId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSelectedRows([]);
      setSelectedTeamId('');
      setSnackbar({ open: true, message: 'Vulnerabilità assegnate al team', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante l\'assegnazione', severity: 'error' });
    }
  });

  // Assign to user mutation
  const assignUserMutation = useMutation({
    mutationFn: ({ vulnerabilityId, userId }: { vulnerabilityId: string; userId: string }) =>
      vulnerabilitiesApi.assignToUser(vulnerabilityId, userId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSelectedRows([]);
      setSelectedUserId('');
      setSnackbar({ open: true, message: 'Vulnerabilità assegnate all\'utente', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante l\'assegnazione', severity: 'error' });
    }
  });

  // Check for new vulnerabilities mutation
  const checkNewMutation = useMutation({
    mutationFn: vulnerabilitiesApi.checkNew,
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSnackbar({
        open: true,
        message: `Controllo completato: ${data.found} trovate, ${data.imported} importate`,
        severity: 'success'
      });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante il controllo', severity: 'error' });
    }
  });

  // Bulk update mutation
  const bulkUpdateMutation = useMutation({
    mutationFn: async ({ ids, data }: { ids: string[]; data: Partial<Vulnerability> }) => {
      await Promise.all(ids.map(id => vulnerabilitiesApi.update(id, data)));
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSelectedRows([]);
      setSnackbar({ open: true, message: 'Vulnerabilità aggiornate con successo', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante l\'aggiornamento', severity: 'error' });
    }
  });

  // Bulk delete mutation
  const bulkDeleteMutation = useMutation({
    mutationFn: async (ids: string[]) => {
      await Promise.all(ids.map(id => vulnerabilitiesApi.delete(id)));
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSelectedRows([]);
      setSnackbar({ open: true, message: 'Vulnerabilità eliminate con successo', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante l\'eliminazione', severity: 'error' });
    }
  });

  // Handle opening form for add/edit
  const handleOpenForm = (vulnerability?: Vulnerability) => {
    setSelectedVulnerability(vulnerability);
    setFormOpen(true);
  };

  const handleCloseForm = () => {
    setFormOpen(false);
    setSelectedVulnerability(undefined);
  };

  // DataGrid columns
  const columns: GridColDef[] = [
    {
      field: 'severity',
      headerName: 'Severità',
      width: 100,
      renderCell: (params) => (
        <Chip
          label={params.value}
          size="small"
          sx={{
            backgroundColor: getSeverityColor(params.value),
            color: 'white',
            fontWeight: 'bold',
          }}
        />
      ),
    },
    {
      field: 'title',
      headerName: 'Titolo',
      flex: 1,
      minWidth: 200,
    },
    {
      field: 'ip_address',
      headerName: 'IP Address',
      width: 150,
    },
    {
      field: 'hostname',
      headerName: 'Hostname',
      width: 150,
    },
    {
      field: 'cvss_score',
      headerName: 'CVSS',
      width: 80,
      renderCell: (params) => (
        <Typography variant="body2" fontWeight="bold">
          {params.value}
        </Typography>
      ),
    },
    {
      field: 'epss_score',
      headerName: 'EPSS',
      width: 80,
      renderCell: (params) => (
        <Typography variant="body2">
          {params.value ? `${(params.value * 100).toFixed(1)}%` : '-'}
        </Typography>
      ),
    },
    {
      field: 'risk_score',
      headerName: 'Risk Score',
      width: 140,
      renderCell: (params) => {
        const row = params.row;
        if (row.risk_score !== undefined && row.risk_tier) {
          return <RiskScoreBadge score={row.risk_score} tier={row.risk_tier} showDetails />;
        }
        return <Typography variant="body2" color="text.secondary">-</Typography>;
      },
    },
    {
      field: 'sla_deadline',
      headerName: 'SLA',
      width: 200,
      renderCell: (params) => {
        const row = params.row;
        if (row.sla_deadline && row.discovered_at) {
          return (
            <SLACountdown
              deadline={row.sla_deadline}
              createdAt={row.discovered_at}
              breached={row.sla_breached || false}
            />
          );
        }
        return <Typography variant="body2" color="text.secondary">No SLA</Typography>;
      },
    },
    {
      field: 'status',
      headerName: 'Stato',
      width: 120,
      renderCell: (params) => (
        <Chip
          label={params.value}
          size="small"
          variant="outlined"
          sx={{
            borderColor: getVulnerabilityStatusColor(params.value),
            color: getVulnerabilityStatusColor(params.value),
          }}
        />
      ),
    },
    {
      field: 'assigned_user_name',
      headerName: 'Assegnato a',
      width: 130,
      renderCell: (params) => params.value || '-',
    },
    {
      field: 'discovered_at',
      headerName: 'Scoperta',
      width: 120,
      renderCell: (params) => {
        try {
          return format(new Date(params.value), 'dd/MM/yyyy');
        } catch {
          return params.value || '-';
        }
      },
    },
    {
      field: 'actions',
      headerName: 'Azioni',
      width: 120,
      sortable: false,
      renderCell: (params) => (
        <Box>
          <IconButton
            size="small"
            onClick={(e) => {
              e.stopPropagation();
              handleOpenForm(params.row);
            }}
            title="Modifica"
          >
            <EditIcon fontSize="small" />
          </IconButton>
          {isAdmin && (
            <IconButton
              size="small"
              onClick={(e) => {
                e.stopPropagation();
                if (window.confirm('Sei sicuro di voler eliminare questa vulnerabilità?')) {
                  deleteMutation.mutate(params.row.id);
                }
              }}
              color="error"
              title="Elimina"
            >
              <DeleteIcon fontSize="small" />
            </IconButton>
          )}
        </Box>
      ),
    },
  ];

  // Filter vulnerabilities based on selected detail and search term
  const filteredVulnerabilities = useMemo(() => {
    let filtered = vulnerabilities;
    
    if (searchTerm) {
      filtered = filtered.filter(v =>
        v.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        v.ip_address?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        v.hostname?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        v.cve_id?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        v.cwe_id?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        v.description?.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }
    
    if (!id) return filtered;
    return filtered.filter((v) => v.id === id);
  }, [vulnerabilities, id, searchTerm]);

  // Calculate statistics
  const stats = useMemo(() => {
    return {
      total: vulnerabilities.length,
      open: vulnerabilities.filter(v => v.status === 'open').length,
      in_progress: vulnerabilities.filter(v => v.status === 'in_progress').length,
      critical: vulnerabilities.filter(v => v.severity === 'critical').length,
    };
  }, [vulnerabilities]);

  // Handle filter change
  const handleFilterChange = (field: keyof VulnerabilityFilter, value: any) => {
    setFilters((prev) => ({
      ...prev,
      [field]: value || undefined,
    }));
  };

  // Handle bulk assign to team
  const handleBulkAssignTeam = () => {
    if (selectedRows.length === 0 || !selectedTeamId) return;

    selectedRows.forEach((rowId) => {
      assignTeamMutation.mutate({
        vulnerabilityId: rowId as string,
        teamId: selectedTeamId,
      });
    });
  };

  // Handle bulk assign to user
  const handleBulkAssignUser = () => {
    if (selectedRows.length === 0 || !selectedUserId) return;

    selectedRows.forEach((rowId) => {
      assignUserMutation.mutate({
        vulnerabilityId: rowId as string,
        userId: selectedUserId,
      });
    });
  };

  // Handle take charge (assign to self, keep status as Open)
  const handleTakeCharge = () => {
    if (selectedRows.length === 0 || !user?.id) return;

    selectedRows.forEach((rowId) => {
      // Only assign to user, don't change status (stays as Open)
      assignUserMutation.mutate({
        vulnerabilityId: rowId as string,
        userId: user.id,
      }, {
        onSuccess: () => {
          // Invalidate both vulnerabilities and my-vulnerabilities queries
          queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
          queryClient.invalidateQueries({ queryKey: ['my-vulnerabilities'] });
        }
      });
    });
  };

  // Handle context menu
  const handleContextMenu = (event: React.MouseEvent) => {
    event.preventDefault();
    if (selectedRows.length === 0) return;
    setContextMenu(
      contextMenu === null
        ? { mouseX: event.clientX + 2, mouseY: event.clientY - 6 }
        : null
    );
  };

  const handleCloseContextMenu = () => {
    setContextMenu(null);
  };

  // Handle bulk delete
  const handleBulkDelete = () => {
    if (selectedRows.length === 0) return;
    if (window.confirm(`Sei sicuro di voler eliminare ${selectedRows.length} vulnerabilità?`)) {
      bulkDeleteMutation.mutate(selectedRows as string[]);
    }
    handleCloseContextMenu();
  };

  // Handle bulk assign status
  const handleBulkAssignStatus = () => {
    if (selectedRows.length === 0) return;
    bulkUpdateMutation.mutate({
      ids: selectedRows as string[],
      data: { status: selectedStatus }
    });
    setStatusDialogOpen(false);
    handleCloseContextMenu();
  };

  // Handle bulk assign risk
  const handleBulkAssignRisk = () => {
    if (selectedRows.length === 0) return;
    bulkUpdateMutation.mutate({
      ids: selectedRows as string[],
      data: { risk_score: selectedRisk }
    });
    setRiskDialogOpen(false);
    handleCloseContextMenu();
  };

  return (
    <Box>
      <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
        <Typography variant="h4">Vulnerabilità</Typography>
        <Box display="flex" gap={2}>
          {/* Check for new vulnerabilities button */}
          <Button
            startIcon={checkNewMutation.isPending ? <CircularProgress size={20} /> : <RefreshIcon />}
            onClick={() => checkNewMutation.mutate()}
            disabled={checkNewMutation.isPending}
            variant="outlined"
            color="secondary"
          >
            Controlla
          </Button>
          <Button
            startIcon={<DownloadIcon />}
            variant="outlined"
            onClick={exportToCSV}
          >
            {selectedRows.length > 0 ? `Esporta (${selectedRows.length})` : 'Esporta'}
          </Button>
          {(isAdmin || isTeamLeader) && (
            <Button
              startIcon={<AddIcon />}
              variant="contained"
              onClick={() => handleOpenForm()}
            >
              Aggiungi
            </Button>
          )}
        </Box>
      </Box>

      {/* Statistics Cards */}
      <Grid container spacing={3} sx={{ mb: 3 }}>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Totale Vulnerabilità"
            value={stats.total}
            description="Numero totale di vulnerabilità presenti nel sistema, indipendentemente dallo stato. Include vulnerabilità aperte, in lavorazione, risolte e chiuse. Questo dato rappresenta il volume complessivo di vulnerabilità scoperte e tracciare nel tempo permette di valutare l'esposizione totale dell'infrastruttura."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Aperte"
            value={stats.open}
            color="error"
            description="Vulnerabilità con stato 'Open' (aperte) che non sono ancora state assegnate o prese in carico. Queste vulnerabilità richiedono attenzione immediata e devono essere assegnate a un team o utente per iniziare il processo di remediation. Un numero elevato indica un backlog di lavoro da smaltire."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="In Lavorazione"
            value={stats.in_progress}
            color="warning"
            description="Vulnerabilità con stato 'In Progress' (in lavorazione) che sono state assegnate e su cui si sta attivamente lavorando. Questo contatore mostra quante vulnerabilità sono correntemente in fase di analisi, testing o remediation da parte dei team di sicurezza."
          />
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StatsCard
            title="Critiche"
            value={stats.critical}
            color="error"
            description="Numero di vulnerabilità con severità 'Critical' indipendentemente dallo stato. Le vulnerabilità critiche hanno CVSS score &gt;= 9.0 e rappresentano rischi gravi per la sicurezza che potrebbero consentire compromissione completa dei sistemi. Richiedono remediation immediata entro 24-48 ore secondo gli SLA."
          />
        </Grid>
      </Grid>

      {/* Bulk actions */}
      {(isAdmin || isTeamLeader) && selectedRows.length > 0 && (
        <Alert
          severity="info"
          sx={{ mb: 3, mt: 2 }}
          action={
            <Box display="flex" gap={1} alignItems="center" flexWrap="wrap">
              {/* Take charge button */}
              <Button
                size="small"
                variant="contained"
                color="primary"
                startIcon={<PersonIcon />}
                onClick={handleTakeCharge}
                disabled={!user?.id || assignUserMutation.isPending}
              >
                Prendi in Carico
              </Button>

              {/* Team assignment */}
              <FormControl size="small" sx={{ minWidth: 150 }}>
                <Select
                  value={selectedTeamId}
                  onChange={(e) => setSelectedTeamId(e.target.value)}
                  displayEmpty
                  size="small"
                >
                  <MenuItem value="">
                    <em>Seleziona team</em>
                  </MenuItem>
                  {teams.map((team) => (
                    <MenuItem key={team.id} value={team.id}>
                      {team.name}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
              <Button
                size="small"
                startIcon={<AssignmentIcon />}
                onClick={handleBulkAssignTeam}
                disabled={!selectedTeamId || assignTeamMutation.isPending}
              >
                Team
              </Button>

              {/* User assignment (shown when team is selected) */}
              {selectedTeamId && teamMembers.length > 0 && (
                <>
                  <FormControl size="small" sx={{ minWidth: 150 }}>
                    <Select
                      value={selectedUserId}
                      onChange={(e) => setSelectedUserId(e.target.value)}
                      displayEmpty
                      size="small"
                    >
                      <MenuItem value="">
                        <em>Seleziona utente</em>
                      </MenuItem>
                      {teamMembers.map((member: any) => (
                        <MenuItem key={member.user_id} value={member.user_id}>
                          {member.user_email || member.user?.email || `User ${member.user_id}`}
                        </MenuItem>
                      ))}
                    </Select>
                  </FormControl>
                  <Button
                    size="small"
                    startIcon={<PersonIcon />}
                    onClick={handleBulkAssignUser}
                    disabled={!selectedUserId || assignUserMutation.isPending}
                  >
                    Utente
                  </Button>
                </>
              )}
            </Box>
          }
        >
          {selectedRows.length} vulnerabilità selezionate
        </Alert>
      )}

      {/* Main content */}
      <Card sx={{ mb: 3 }}>
        <CardContent>
          <Box sx={{ mb: 2 }}>
            <TextField
              fullWidth
              variant="outlined"
              placeholder="Cerca vulnerabilità..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              InputProps={{
                startAdornment: (
                  <InputAdornment position="start">
                    <SearchIcon />
                  </InputAdornment>
                ),
              }}
            />
          </Box>

          <Box onContextMenu={handleContextMenu}>
            <DataGrid
              rows={filteredVulnerabilities}
              columns={columns}
              loading={isLoading}
              checkboxSelection={isAdmin || isTeamLeader}
              rowSelectionModel={selectedRows}
              onRowSelectionModelChange={setSelectedRows}
              onRowClick={(params) => navigate(`/vulnerabilities/${params.row.id}`)}
              initialState={{
                pagination: {
                  paginationModel: { pageSize: 25 },
                },
              }}
              pageSizeOptions={[10, 25, 50]}
              disableRowSelectionOnClick
              autoHeight
              sx={{
                '& .MuiDataGrid-cell:focus': {
                  outline: 'none',
                },
                '& .MuiDataGrid-row': {
                  cursor: 'pointer',
                },
              }}
            />
          </Box>
        </CardContent>
      </Card>

      {/* Detail panel */}
      {id && (
        <Grid container spacing={3}>
          <Grid item xs={12} lg={4}>
            <VulnerabilityDetail
              vulnerabilityId={id}
              onClose={() => navigate('/vulnerabilities')}
              onEdit={(vuln) => handleOpenForm(vuln)}
            />
          </Grid>
        </Grid>
      )}

      {/* Add/Edit Form Dialog */}
      {formOpen && (
        <VulnerabilityForm
          open={formOpen}
          onClose={handleCloseForm}
          onSuccess={() => {
            handleCloseForm();
            queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
          }}
          vulnerability={selectedVulnerability}
        />
      )}

      {/* Context Menu */}
      <Menu
        open={contextMenu !== null}
        onClose={handleCloseContextMenu}
        anchorReference="anchorPosition"
        anchorPosition={
          contextMenu !== null
            ? { top: contextMenu.mouseY, left: contextMenu.mouseX }
            : undefined
        }
      >
        <MenuItem onClick={handleBulkDelete} disabled={!isAdmin}>
          <ListItemIcon>
            <DeleteIcon fontSize="small" />
          </ListItemIcon>
          <ListItemText>Elimina tutto ({selectedRows.length})</ListItemText>
        </MenuItem>
        <MenuItem onClick={() => { setStatusDialogOpen(true); handleCloseContextMenu(); }}>
          <ListItemIcon>
            <CheckCircleIcon fontSize="small" />
          </ListItemIcon>
          <ListItemText>Assegna stato ({selectedRows.length})</ListItemText>
        </MenuItem>
        <MenuItem onClick={() => { setRiskDialogOpen(true); handleCloseContextMenu(); }}>
          <ListItemIcon>
            <AssessmentIcon fontSize="small" />
          </ListItemIcon>
          <ListItemText>Assegna rischio ({selectedRows.length})</ListItemText>
        </MenuItem>
      </Menu>

      {/* Status Assignment Dialog */}
      <Dialog open={statusDialogOpen} onClose={() => setStatusDialogOpen(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Assegna Stato</DialogTitle>
        <DialogContent>
          <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
            Assegna uno stato a {selectedRows.length} vulnerabilità selezionate
          </Typography>
          <FormControl fullWidth sx={{ mt: 2 }}>
            <InputLabel>Stato</InputLabel>
            <Select
              value={selectedStatus}
              label="Stato"
              onChange={(e) => setSelectedStatus(e.target.value as VulnerabilityStatus)}
            >
              <MenuItem value="open">Aperta</MenuItem>
              <MenuItem value="in_progress">In Lavorazione</MenuItem>
              <MenuItem value="resolved">Risolta</MenuItem>
              <MenuItem value="false_positive">Falso Positivo</MenuItem>
              <MenuItem value="accepted_risk">Rischio Accettato</MenuItem>
              <MenuItem value="closed">Chiusa</MenuItem>
            </Select>
          </FormControl>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setStatusDialogOpen(false)}>Annulla</Button>
          <Button onClick={handleBulkAssignStatus} variant="contained">Assegna</Button>
        </DialogActions>
      </Dialog>

      {/* Risk Assignment Dialog */}
      <Dialog open={riskDialogOpen} onClose={() => setRiskDialogOpen(false)} maxWidth="sm" fullWidth>
        <DialogTitle>Assegna Risk Score</DialogTitle>
        <DialogContent>
          <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
            Assegna un punteggio di rischio a {selectedRows.length} vulnerabilità selezionate
          </Typography>
          <Box sx={{ mt: 4, px: 2 }}>
            <Typography gutterBottom>Risk Score: {selectedRisk}</Typography>
            <Slider
              value={selectedRisk}
              onChange={(_, value) => setSelectedRisk(value as number)}
              min={1}
              max={100}
              marks={[
                { value: 1, label: '1' },
                { value: 25, label: '25' },
                { value: 50, label: '50' },
                { value: 75, label: '75' },
                { value: 100, label: '100' },
              ]}
              valueLabelDisplay="auto"
            />
          </Box>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setRiskDialogOpen(false)}>Annulla</Button>
          <Button onClick={handleBulkAssignRisk} variant="contained">Assegna</Button>
        </DialogActions>
      </Dialog>

      {/* Snackbar for notifications */}
      <Snackbar
        open={snackbar.open}
        autoHideDuration={4000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
      >
        <Alert
          onClose={() => setSnackbar({ ...snackbar, open: false })}
          severity={snackbar.severity}
          variant="filled"
        >
          {snackbar.message}
        </Alert>
      </Snackbar>
    </Box>
  );
};
export default Vulnerabilities;
