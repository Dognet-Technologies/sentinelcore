// src/pages/Vulnerabilities.tsx
import React, { useState, useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  Box,
  Paper,
  Typography,
  Button,
  Chip,
  IconButton,
  TextField,
  MenuItem,
  Grid,
  Drawer,
  FormControl,
  InputLabel,
  Select,
  Alert,
  useTheme,
  CircularProgress,
  Snackbar,
} from '@mui/material';
import {
  Add as AddIcon,
  FilterList as FilterListIcon,
  Download as DownloadIcon,
  Close as CloseIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Assignment as AssignmentIcon,
  Refresh as RefreshIcon,
  Person as PersonIcon,
} from '@mui/icons-material';
import { DataGrid, GridColDef, GridRowSelectionModel } from '@mui/x-data-grid';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { format } from 'date-fns';

import { vulnerabilitiesApi } from '../api/vulnerabilities';
import { teamsApi } from '../api/teams';
import { useAuth } from '../contexts/AuthContext';
import {
  Vulnerability,
  VulnerabilityStatus,
  VulnerabilitySeverity,
  VulnerabilityFilter,
  Team,
} from '../types';
import VulnerabilityDetail from '../components/vulnerabilities/VulnerabilityDetail';
import VulnerabilityForm from '../components/vulnerabilities/VulnerabilityForm';
import { RiskScoreBadge } from '../components/quick-wins/RiskScoreBadge';
import { SLACountdown } from '../components/quick-wins/SLACountdown';
import { getSeverityColor, getVulnerabilityStatusColor } from '../theme/entuityTheme';

const Vulnerabilities: React.FC = () => {
  const theme = useTheme();
  const { id } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  const queryClient = useQueryClient();

  // Export to CSV function
  const exportToCSV = () => {
    if (vulnerabilities.length === 0) {
      setSnackbar({ open: true, message: 'Nessuna vulnerabilità da esportare', severity: 'info' });
      return;
    }

    const headers = [
      'ID', 'Titolo', 'Severità', 'Stato', 'CVSS', 'EPSS', 'CVE', 'CWE',
      'IP', 'Hostname', 'Porta', 'Protocollo', 'Team Assegnato', 'Utente Assegnato',
      'Sorgente', 'Data Scoperta', 'Descrizione', 'Remediation'
    ];

    const dataToExport = selectedRows.length > 0
      ? vulnerabilities.filter(v => selectedRows.includes(v.id))
      : vulnerabilities;

    const csvRows = dataToExport.map(v => [
      v.id,
      `"${(v.title || '').replace(/"/g, '""')}"`,
      v.severity,
      v.status,
      v.cvss_score,
      v.epss_score || '',
      v.cve_id || '',
      v.cwe_id || '',
      v.ip_address,
      v.hostname || '',
      v.port || '',
      v.protocol || '',
      v.assigned_team_name || '',
      v.assigned_user_name || '',
      v.source || '',
      v.discovered_at ? format(new Date(v.discovered_at), 'yyyy-MM-dd HH:mm') : '',
      `"${(v.description || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
      `"${(v.remediation || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`
    ].join(','));

    const csvContent = [headers.join(','), ...csvRows].join('\n');
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `vulnerabilities_${format(new Date(), 'yyyy-MM-dd_HHmm')}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    setSnackbar({
      open: true,
      message: `Esportate ${dataToExport.length} vulnerabilità`,
      severity: 'success'
    });
  };

  const [selectedRows, setSelectedRows] = useState<GridRowSelectionModel>([]);
  const [filterOpen, setFilterOpen] = useState(false);
  const [formOpen, setFormOpen] = useState(false);
  const [selectedVulnerability, setSelectedVulnerability] = useState<Vulnerability | undefined>(undefined);
  const [selectedTeamId, setSelectedTeamId] = useState('');
  const [selectedUserId, setSelectedUserId] = useState('');
  const [filters, setFilters] = useState<VulnerabilityFilter>({});
  const [snackbar, setSnackbar] = useState<{ open: boolean; message: string; severity: 'success' | 'error' | 'info' }>({
    open: false,
    message: '',
    severity: 'info'
  });

  const isAdmin = user?.role === 'admin';
  const isTeamLeader = user?.role === 'team_leader';

  // Fetch vulnerabilities
  const { data: vulnerabilities = [], isLoading, refetch } = useQuery({
    queryKey: ['vulnerabilities', filters],
    queryFn: () => vulnerabilitiesApi.list(filters),
  });

  // Fetch teams for assignment
  const { data: teams = [] } = useQuery({
    queryKey: ['teams'],
    queryFn: () => teamsApi.list(),
  });

  // Fetch team members for user assignment
  const { data: teamMembers = [] } = useQuery({
    queryKey: ['teamMembers', selectedTeamId],
    queryFn: () => selectedTeamId ? teamsApi.getMembers(selectedTeamId) : Promise.resolve([]),
    enabled: !!selectedTeamId,
  });

  // Delete mutation
  const deleteMutation = useMutation({
    mutationFn: vulnerabilitiesApi.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSnackbar({ open: true, message: 'Vulnerabilità eliminata', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante l\'eliminazione', severity: 'error' });
    }
  });

  // Assign to team mutation
  const assignTeamMutation = useMutation({
    mutationFn: ({ vulnerabilityId, teamId }: { vulnerabilityId: string; teamId: string }) =>
      vulnerabilitiesApi.assignToTeam(vulnerabilityId, teamId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSelectedRows([]);
      setSelectedTeamId('');
      setSnackbar({ open: true, message: 'Vulnerabilità assegnate al team', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante l\'assegnazione', severity: 'error' });
    }
  });

  // Assign to user mutation
  const assignUserMutation = useMutation({
    mutationFn: ({ vulnerabilityId, userId }: { vulnerabilityId: string; userId: string }) =>
      vulnerabilitiesApi.assignToUser(vulnerabilityId, userId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSelectedRows([]);
      setSelectedUserId('');
      setSnackbar({ open: true, message: 'Vulnerabilità assegnate all\'utente', severity: 'success' });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante l\'assegnazione', severity: 'error' });
    }
  });

  // Check for new vulnerabilities mutation
  const checkNewMutation = useMutation({
    mutationFn: vulnerabilitiesApi.checkNew,
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
      setSnackbar({
        open: true,
        message: `Controllo completato: ${data.found} trovate, ${data.imported} importate`,
        severity: 'success'
      });
    },
    onError: () => {
      setSnackbar({ open: true, message: 'Errore durante il controllo', severity: 'error' });
    }
  });



  // Handle opening form for add/edit
  const handleOpenForm = (vulnerability?: Vulnerability) => {
    setSelectedVulnerability(vulnerability);
    setFormOpen(true);
  };

  const handleCloseForm = () => {
    setFormOpen(false);
    setSelectedVulnerability(undefined);
  };

  // DataGrid columns
  const columns: GridColDef[] = [
    {
      field: 'severity',
      headerName: 'Severità',
      width: 100,
      renderCell: (params) => (
        <Chip
          label={params.value}
          size="small"
          sx={{
            backgroundColor: getSeverityColor(params.value),
            color: 'white',
            fontWeight: 'bold',
          }}
        />
      ),
    },
    {
      field: 'title',
      headerName: 'Titolo',
      flex: 1,
      minWidth: 200,
    },
    {
      field: 'ip_address',
      headerName: 'IP Address',
      width: 150,
    },
    {
      field: 'hostname',
      headerName: 'Hostname',
      width: 150,
    },
    {
      field: 'cvss_score',
      headerName: 'CVSS',
      width: 80,
      renderCell: (params) => (
        <Typography variant="body2" fontWeight="bold">
          {params.value}
        </Typography>
      ),
    },
    {
      field: 'epss_score',
      headerName: 'EPSS',
      width: 80,
      renderCell: (params) => (
        <Typography variant="body2">
          {params.value ? `${(params.value * 100).toFixed(1)}%` : '-'}
        </Typography>
      ),
    },
    {
      field: 'risk_score',
      headerName: 'Risk Score',
      width: 140,
      renderCell: (params) => {
        const row = params.row;
        if (row.risk_score !== undefined && row.risk_tier) {
          return <RiskScoreBadge score={row.risk_score} tier={row.risk_tier} showDetails />;
        }
        return <Typography variant="body2" color="text.secondary">-</Typography>;
      },
    },
    {
      field: 'sla_deadline',
      headerName: 'SLA',
      width: 200,
      renderCell: (params) => {
        const row = params.row;
        if (row.sla_deadline && row.discovered_at) {
          return (
            <SLACountdown
              deadline={row.sla_deadline}
              createdAt={row.discovered_at}
              breached={row.sla_breached || false}
            />
          );
        }
        return <Typography variant="body2" color="text.secondary">No SLA</Typography>;
      },
    },
    {
      field: 'status',
      headerName: 'Stato',
      width: 120,
      renderCell: (params) => (
        <Chip
          label={params.value}
          size="small"
          variant="outlined"
          sx={{
            borderColor: getVulnerabilityStatusColor(params.value),
            color: getVulnerabilityStatusColor(params.value),
          }}
        />
      ),
    },
    {
      field: 'assigned_user_name',
      headerName: 'Assegnato a',
      width: 130,
      renderCell: (params) => params.value || '-',
    },
    {
      field: 'discovered_at',
      headerName: 'Scoperta',
      width: 120,
      renderCell: (params) => {
        try {
          return format(new Date(params.value), 'dd/MM/yyyy');
        } catch {
          return params.value || '-';
        }
      },
    },
    {
      field: 'actions',
      headerName: 'Azioni',
      width: 120,
      sortable: false,
      renderCell: (params) => (
        <Box>
          <IconButton
            size="small"
            onClick={(e) => {
              e.stopPropagation();
              handleOpenForm(params.row);
            }}
            title="Modifica"
          >
            <EditIcon fontSize="small" />
          </IconButton>
          {isAdmin && (
            <IconButton
              size="small"
              onClick={(e) => {
                e.stopPropagation();
                if (window.confirm('Sei sicuro di voler eliminare questa vulnerabilità?')) {
                  deleteMutation.mutate(params.row.id);
                }
              }}
              color="error"
              title="Elimina"
            >
              <DeleteIcon fontSize="small" />
            </IconButton>
          )}
        </Box>
      ),
    },
  ];

  // Filter vulnerabilities based on selected detail
  const filteredVulnerabilities = useMemo(() => {
    if (!id) return vulnerabilities;
    return vulnerabilities.filter((v) => v.id === id);
  }, [vulnerabilities, id]);

  // Handle filter change
  const handleFilterChange = (field: keyof VulnerabilityFilter, value: any) => {
    setFilters((prev) => ({
      ...prev,
      [field]: value || undefined,
    }));
  };

  // Handle bulk assign to team
  const handleBulkAssignTeam = () => {
    if (selectedRows.length === 0 || !selectedTeamId) return;

    selectedRows.forEach((rowId) => {
      assignTeamMutation.mutate({
        vulnerabilityId: rowId as string,
        teamId: selectedTeamId,
      });
    });
  };

  // Handle bulk assign to user
  const handleBulkAssignUser = () => {
    if (selectedRows.length === 0 || !selectedUserId) return;

    selectedRows.forEach((rowId) => {
      assignUserMutation.mutate({
        vulnerabilityId: rowId as string,
        userId: selectedUserId,
      });
    });
  };

  return (
    <Box>
      <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
        <Typography variant="h4">Vulnerabilità</Typography>
        <Box display="flex" gap={2}>
          {/* Check for new vulnerabilities button */}
          <Button
            startIcon={checkNewMutation.isPending ? <CircularProgress size={20} /> : <RefreshIcon />}
            onClick={() => checkNewMutation.mutate()}
            disabled={checkNewMutation.isPending}
            variant="outlined"
            color="secondary"
          >
            Controlla
          </Button>
          <Button
            startIcon={<FilterListIcon />}
            onClick={() => setFilterOpen(true)}
          >
            Filtri
          </Button>
          <Button
            startIcon={<DownloadIcon />}
            variant="outlined"
            onClick={exportToCSV}
          >
            {selectedRows.length > 0 ? `Esporta (${selectedRows.length})` : 'Esporta'}
          </Button>
          {(isAdmin || isTeamLeader) && (
            <Button
              startIcon={<AddIcon />}
              variant="contained"
              onClick={() => handleOpenForm()}
            >
              Aggiungi
            </Button>
          )}
        </Box>
      </Box>

      {/* Bulk actions */}
      {(isAdmin || isTeamLeader) && selectedRows.length > 0 && (
        <Alert
          severity="info"
          sx={{ mb: 2 }}
          action={
            <Box display="flex" gap={1} alignItems="center" flexWrap="wrap">
              {/* Team assignment */}
              <FormControl size="small" sx={{ minWidth: 150 }}>
                <Select
                  value={selectedTeamId}
                  onChange={(e) => setSelectedTeamId(e.target.value)}
                  displayEmpty
                  size="small"
                >
                  <MenuItem value="">
                    <em>Seleziona team</em>
                  </MenuItem>
                  {teams.map((team) => (
                    <MenuItem key={team.id} value={team.id}>
                      {team.name}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
              <Button
                size="small"
                startIcon={<AssignmentIcon />}
                onClick={handleBulkAssignTeam}
                disabled={!selectedTeamId || assignTeamMutation.isPending}
              >
                Team
              </Button>

              {/* User assignment (shown when team is selected) */}
              {selectedTeamId && teamMembers.length > 0 && (
                <>
                  <FormControl size="small" sx={{ minWidth: 150 }}>
                    <Select
                      value={selectedUserId}
                      onChange={(e) => setSelectedUserId(e.target.value)}
                      displayEmpty
                      size="small"
                    >
                      <MenuItem value="">
                        <em>Seleziona utente</em>
                      </MenuItem>
                      {teamMembers.map((member: any) => (
                        <MenuItem key={member.user_id} value={member.user_id}>
                          {member.user_email || member.user?.email || `User ${member.user_id}`}
                        </MenuItem>
                      ))}
                    </Select>
                  </FormControl>
                  <Button
                    size="small"
                    startIcon={<PersonIcon />}
                    onClick={handleBulkAssignUser}
                    disabled={!selectedUserId || assignUserMutation.isPending}
                  >
                    Utente
                  </Button>
                </>
              )}
            </Box>
          }
        >
          {selectedRows.length} vulnerabilità selezionate
        </Alert>
      )}

      {/* Main content */}
      <Grid container spacing={3}>
        <Grid item xs={12} lg={id ? 8 : 12}>
          <Paper sx={{ height: 600 }}>
            <DataGrid
              rows={filteredVulnerabilities}
              columns={columns}
              loading={isLoading}
              checkboxSelection={isAdmin || isTeamLeader}
              rowSelectionModel={selectedRows}
              onRowSelectionModelChange={setSelectedRows}
              onRowClick={(params) => navigate(`/vulnerabilities/${params.row.id}`)}
              sx={{
                '& .MuiDataGrid-row': {
                  cursor: 'pointer',
                },
              }}
            />
          </Paper>
        </Grid>

        {/* Detail panel */}
        {id && (
          <Grid item xs={12} lg={4}>
            <VulnerabilityDetail
              vulnerabilityId={id}
              onClose={() => navigate('/vulnerabilities')}
              onEdit={(vuln) => handleOpenForm(vuln)}
            />
          </Grid>
        )}
      </Grid>

      {/* Filter drawer */}
      <Drawer
        anchor="right"
        open={filterOpen}
        onClose={() => setFilterOpen(false)}
        sx={{ '& .MuiDrawer-paper': { width: 320, p: 3 } }}
      >
        <Box>
          <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
            <Typography variant="h6">Filtri</Typography>
            <IconButton onClick={() => setFilterOpen(false)}>
              <CloseIcon />
            </IconButton>
          </Box>

          <Grid container spacing={2}>
            <Grid item xs={12}>
              <FormControl fullWidth>
                <InputLabel>Stato</InputLabel>
                <Select
                  value={filters.status || ''}
                  onChange={(e) => handleFilterChange('status', e.target.value)}
                  label="Stato"
                >
                  <MenuItem value="">Tutti</MenuItem>
                  <MenuItem value={VulnerabilityStatus.Open}>Aperto</MenuItem>
                  <MenuItem value={VulnerabilityStatus.InProgress}>In corso</MenuItem>
                  <MenuItem value={VulnerabilityStatus.Resolved}>Risolto</MenuItem>
                  <MenuItem value={VulnerabilityStatus.Closed}>Chiuso</MenuItem>
                </Select>
              </FormControl>
            </Grid>

            <Grid item xs={12}>
              <FormControl fullWidth>
                <InputLabel>Severità</InputLabel>
                <Select
                  value={filters.severity || ''}
                  onChange={(e) => handleFilterChange('severity', e.target.value)}
                  label="Severità"
                >
                  <MenuItem value="">Tutte</MenuItem>
                  <MenuItem value={VulnerabilitySeverity.Critical}>Critico</MenuItem>
                  <MenuItem value={VulnerabilitySeverity.High}>Alto</MenuItem>
                  <MenuItem value={VulnerabilitySeverity.Medium}>Medio</MenuItem>
                  <MenuItem value={VulnerabilitySeverity.Low}>Basso</MenuItem>
                  <MenuItem value={VulnerabilitySeverity.Info}>Info</MenuItem>
                </Select>
              </FormControl>
            </Grid>

            <Grid item xs={12}>
              <TextField
                fullWidth
                label="IP Address"
                value={filters.ip_address || ''}
                onChange={(e) => handleFilterChange('ip_address', e.target.value)}
              />
            </Grid>

            <Grid item xs={12}>
              <TextField
                fullWidth
                label="Hostname"
                value={filters.hostname || ''}
                onChange={(e) => handleFilterChange('hostname', e.target.value)}
              />
            </Grid>

            <Grid item xs={12}>
              <TextField
                fullWidth
                label="CVE ID"
                value={filters.cve_id || ''}
                onChange={(e) => handleFilterChange('cve_id', e.target.value)}
              />
            </Grid>

            <Grid item xs={12}>
              <FormControl fullWidth>
                <InputLabel>Team Assegnato</InputLabel>
                <Select
                  value={filters.assigned_team_id || ''}
                  onChange={(e) => handleFilterChange('assigned_team_id', e.target.value)}
                  label="Team Assegnato"
                >
                  <MenuItem value="">Tutti</MenuItem>
                  {teams.map((team) => (
                    <MenuItem key={team.id} value={team.id}>
                      {team.name}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>

            <Grid item xs={12}>
              <Button
                fullWidth
                variant="outlined"
                onClick={() => {
                  setFilters({});
                  setFilterOpen(false);
                }}
              >
                Ripristina Filtri
              </Button>
            </Grid>
          </Grid>
        </Box>
      </Drawer>

      {/* Add/Edit Form Dialog */}
      {formOpen && (
        <VulnerabilityForm
          open={formOpen}
          onClose={handleCloseForm}
          onSuccess={() => {
            handleCloseForm();
            queryClient.invalidateQueries({ queryKey: ['vulnerabilities'] });
          }}
          vulnerability={selectedVulnerability}
        />
      )}

      {/* Snackbar for notifications */}
      <Snackbar
        open={snackbar.open}
        autoHideDuration={4000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
      >
        <Alert
          onClose={() => setSnackbar({ ...snackbar, open: false })}
          severity={snackbar.severity}
          variant="filled"
        >
          {snackbar.message}
        </Alert>
      </Snackbar>
    </Box>
  );
};
export default Vulnerabilities;
