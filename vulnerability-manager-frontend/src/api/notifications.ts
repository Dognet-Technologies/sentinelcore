// src/api/notifications.ts
// Notification rules API client

import apiClient from './client';

export interface NotificationChannel {
  id: string;
  name: string;
  channel_type: 'email' | 'slack' | 'telegram' | 'teams' | 'webhook' | 'pagerduty' | 'opsgenie';
  is_enabled: boolean;
  configuration: any;
  created_at: string;
  updated_at: string;
}

export interface NotificationRule {
  id: string;
  name: string;
  description?: string;
  priority: number;
  is_enabled: boolean;
  conditions: any;
  channels: string[];
  email_recipients?: string[];
  user_ids?: string[];
  team_ids?: string[];
  role_filter?: string;
  immediate: boolean;
  throttle_minutes: number;
  quiet_hours_start?: string;
  quiet_hours_end?: string;
  message_template?: string;
  include_details: boolean;
  created_at: string;
  updated_at: string;
}

export interface CreateNotificationRuleRequest {
  name: string;
  description?: string;
  priority?: number;
  is_enabled?: boolean;
  conditions: any;
  channels: string[];
  email_recipients?: string[];
  user_ids?: string[];
  team_ids?: string[];
  role_filter?: string;
  immediate?: boolean;
  throttle_minutes?: number;
  quiet_hours_start?: string;
  quiet_hours_end?: string;
  message_template?: string;
  include_details?: boolean;
}

export interface UpdateNotificationRuleRequest {
  name?: string;
  description?: string;
  priority?: number;
  is_enabled?: boolean;
  conditions?: any;
  channels?: string[];
  email_recipients?: string[];
  user_ids?: string[];
  team_ids?: string[];
  role_filter?: string;
  immediate?: boolean;
  throttle_minutes?: number;
  quiet_hours_start?: string;
  quiet_hours_end?: string;
  message_template?: string;
  include_details?: boolean;
}

export interface CreateNotificationChannelRequest {
  name: string;
  channel_type: string;
  is_enabled?: boolean;
  configuration: any;
}

export interface TestRuleRequest {
  vulnerability_data: any;
}

export interface TestRuleResponse {
  matches: boolean;
  message: string;
}

export const notificationsApi = {
  // Notification Rules
  listRules: async (): Promise<NotificationRule[]> => {
    const response = await apiClient.get('/api/notification-rules');
    return response.data;
  },

  getRule: async (ruleId: string): Promise<NotificationRule> => {
    const response = await apiClient.get(`/api/notification-rules/${ruleId}`);
    return response.data;
  },

  createRule: async (data: CreateNotificationRuleRequest): Promise<NotificationRule> => {
    const response = await apiClient.post('/api/notification-rules', data);
    return response.data;
  },

  updateRule: async (ruleId: string, data: UpdateNotificationRuleRequest): Promise<NotificationRule> => {
    const response = await apiClient.put(`/api/notification-rules/${ruleId}`, data);
    return response.data;
  },

  deleteRule: async (ruleId: string): Promise<void> => {
    await apiClient.delete(`/api/notification-rules/${ruleId}`);
  },

  testRule: async (ruleId: string, data: TestRuleRequest): Promise<TestRuleResponse> => {
    const response = await apiClient.post(`/api/notification-rules/${ruleId}/test`, data);
    return response.data;
  },

  // Notification Channels
  listChannels: async (): Promise<NotificationChannel[]> => {
    const response = await apiClient.get('/api/notification-channels');
    return response.data;
  },

  createChannel: async (data: CreateNotificationChannelRequest): Promise<NotificationChannel> => {
    const response = await apiClient.post('/api/notification-channels', data);
    return response.data;
  },

  deleteChannel: async (channelId: string): Promise<void> => {
    await apiClient.delete(`/api/notification-channels/${channelId}`);
  },
};
