// src/api/risk.ts
// Risk scoring and SLA API client

import apiClient from './client';

export interface RiskScore {
  vulnerability_id: string;
  risk_score: {
    total_score: number;
    tier: 'Critical' | 'High' | 'Medium' | 'Low' | 'Info';
    components: {
      cvss: number;
      epss: number;
      business_impact: number;
      asset_exposure: number;
      exploit_availability: number;
    };
  };
  calculated_at: string;
}

export interface SLABreach {
  vulnerability_id: string;
  title: string;
  risk_tier: string;
  sla_deadline: string;
  days_overdue: number;
}

export interface RiskTierStats {
  tier: string;
  count: number;
  percentage: number;
}

export interface RiskStatistics {
  total_vulnerabilities: number;
  by_tier: RiskTierStats[];
  avg_risk_score: number;
  critical_count: number;
  sla_breached_count: number;
}

export const riskApi = {
  // Get risk statistics
  getRiskStatistics: async (teamId?: string): Promise<RiskStatistics> => {
    const params = teamId ? { team_id: teamId } : {};
    const response = await apiClient.get('/risk/statistics', { params });
    return response.data;
  },

  // Get SLA breaches
  getSLABreaches: async (): Promise<{ breaches: SLABreach[]; total: number }> => {
    const response = await apiClient.get('/risk/sla/breaches');
    return response.data;
  },

  // Calculate risk score for vulnerability (admin only)
  calculateRiskScore: async (vulnerabilityId: string): Promise<RiskScore> => {
    const response = await apiClient.post(`/risk/vulnerabilities/${vulnerabilityId}/calculate`);
    return response.data;
  },

  // Mark SLA breaches (admin only)
  markSLABreaches: async (): Promise<{ marked: number; message: string }> => {
    const response = await apiClient.post('/risk/sla/mark-breaches');
    return response.data;
  },
};
