import apiClient from './client';

export interface NetworkDevice {
  id: string;
  ip_address: string;
  mac_address?: string;
  hostname?: string;
  device_type: 'router' | 'switch' | 'firewall' | 'server' | 'workstation' | 'iot' | 'printer' | 'unknown';
  device_status: 'online' | 'offline' | 'unknown';
  vendor?: string;
  os_name?: string;
  os_version?: string;
  open_ports?: number[];
  services?: Record<string, { name: string; version?: string }>;
  first_seen: string;
  last_seen: string;
  created_at: string;
  updated_at: string;
}

export interface NetworkLink {
  id: string;
  source_device_id: string;
  target_device_id: string;
  link_type: string;
  latency_ms?: number;
  hop_count?: number;
  created_at: string;
}

export interface NetworkScan {
  id: string;
  scan_name: string;
  scan_type: string;
  target_range: string;
  status: string;
  devices_found: number;
  started_at?: string;
  completed_at?: string;
  created_by: string;
  created_at: string;
}

export interface NetworkTopology {
  devices: NetworkDevice[];
  links: NetworkLink[];
  scan_info?: NetworkScan;
}

export interface StartScanRequest {
  scan_name: string;
  scan_type: string;
  target_range: string;
}

export interface ScanProgress {
  scan_id: string;
  status: string;
  progress_percent: number;
  devices_found: number;
  message?: string;
}

// Enhanced types for P1-P5
export interface VulnerabilitySummary {
  total: number;
  critical: number;
  high: number;
  medium: number;
  low: number;
  info: number;
  epss_average?: number;
  epss_max?: number;
  cvss_average?: number;
  cvss_max?: number;
}

export interface NetworkDeviceWithVulnerabilities extends NetworkDevice {
  assigned_user_id?: string;
  assigned_team_id?: string;
  owner?: string;
  location?: string;
  criticality?: 'critical' | 'high' | 'medium' | 'low';
  tags?: string[];
  notes?: string;
  is_internet_facing?: boolean;
  has_public_ip?: boolean;
  vulnerabilities: VulnerabilitySummary;
}

export interface NetworkTopologyWithVulnerabilities {
  devices: NetworkDeviceWithVulnerabilities[];
  links: NetworkLink[];
  scan_info?: NetworkScan;
}

export interface UpdateDeviceRequest {
  hostname?: string;
  device_type?: string;
  owner?: string;
  location?: string;
  criticality?: string;
  tags?: string[];
  notes?: string;
  is_internet_facing?: boolean;
  has_public_ip?: boolean;
  assigned_user_id?: string;
  assigned_team_id?: string;
}

export interface BulkAssignRequest {
  device_ids: string[];
  user_id?: string;
  team_id?: string;
}

// Network Range types for Discovery workflow
export interface NetworkRange {
  id: string;
  network_range: string;
  description?: string;
  is_local_network?: boolean;
  enabled?: boolean;
  last_scan_at?: string;
  last_ping_scan_at?: string;
  last_deep_scan_at?: string;
  hosts_found?: number;
  created_at?: string;
  updated_at?: string;
}

export interface CreateNetworkRangeRequest {
  network_range: string;
  description?: string;
  is_local_network?: boolean;
  enabled?: boolean;
}

export interface UpdateNetworkRangeRequest {
  description?: string;
  is_local_network?: boolean;
  enabled?: boolean;
}

export interface DiscoveryScanResponse {
  scan_id: string;
  message: string;
  devices_found?: number;
}

export const networkApi = {
  // Start a new network scan
  startScan: async (request: StartScanRequest): Promise<ScanProgress> => {
    const response = await apiClient.post('/api/network/scan', request);
    return response.data;
  },

  // Get scan status
  getScanStatus: async (scanId: string): Promise<ScanProgress> => {
    const response = await apiClient.get(`/api/network/scan/${scanId}`);
    return response.data;
  },

  // Get network topology (basic)
  getTopology: async (): Promise<NetworkTopology> => {
    const response = await apiClient.get('/api/network/topology');
    return response.data;
  },

  // Get network topology with vulnerabilities (P1)
  getTopologyWithVulnerabilities: async (): Promise<NetworkTopologyWithVulnerabilities> => {
    const response = await apiClient.get('/api/network/topology-with-vulnerabilities');
    return response.data;
  },

  // Get device details
  getDeviceDetails: async (deviceId: string): Promise<any> => {
    const response = await apiClient.get(`/api/network/devices/${deviceId}`);
    return response.data;
  },

  // Get device vulnerabilities (P1)
  getDeviceVulnerabilities: async (deviceId: string): Promise<any> => {
    const response = await apiClient.get(`/api/network/devices/${deviceId}/vulnerabilities`);
    return response.data;
  },

  // Update device (P2)
  updateDevice: async (deviceId: string, data: UpdateDeviceRequest): Promise<NetworkDevice> => {
    const response = await apiClient.put(`/api/network/devices/${deviceId}`, data);
    return response.data;
  },

  // Bulk assign devices (P3)
  bulkAssignDevices: async (request: BulkAssignRequest): Promise<any> => {
    const response = await apiClient.post('/api/network/devices/bulk-assign', request);
    return response.data;
  },

  // Execute remediation
  executeRemediation: async (deviceId: string, request: any): Promise<any> => {
    const response = await apiClient.post('/api/network/remediation', request);
    return response.data;
  },

  // Network Ranges Management (Discovery workflow)

  // List all network ranges
  listNetworkRanges: async (): Promise<NetworkRange[]> => {
    const response = await apiClient.get('/api/network/ranges');
    return response.data;
  },

  // Create a new network range
  createNetworkRange: async (request: CreateNetworkRangeRequest): Promise<NetworkRange> => {
    const response = await apiClient.post('/api/network/ranges', request);
    return response.data;
  },

  // Update a network range
  updateNetworkRange: async (rangeId: string, request: UpdateNetworkRangeRequest): Promise<NetworkRange> => {
    const response = await apiClient.put(`/api/network/ranges/${rangeId}`, request);
    return response.data;
  },

  // Delete a network range
  deleteNetworkRange: async (rangeId: string): Promise<void> => {
    await apiClient.delete(`/api/network/ranges/${rangeId}`);
  },

  // Network Discovery Scan Triggers

  // Trigger discovery scan (ping scan) for a network range
  triggerDiscoveryScan: async (rangeId: string): Promise<DiscoveryScanResponse> => {
    const response = await apiClient.post(`/api/network/ranges/${rangeId}/discovery-scan`);
    return response.data;
  },

  // Trigger deep scan for a single device
  triggerDeepScan: async (deviceId: string): Promise<DiscoveryScanResponse> => {
    const response = await apiClient.post(`/api/network/devices/${deviceId}/deep-scan`);
    return response.data;
  },

  // Trigger deep scan for all devices in a network range
  triggerRangeDeepScan: async (rangeId: string): Promise<DiscoveryScanResponse> => {
    const response = await apiClient.post(`/api/network/ranges/${rangeId}/deep-scan`);
    return response.data;
  },
};
