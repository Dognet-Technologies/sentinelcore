// src/api/remediation.ts
// P4: Remediation plans API client

import apiClient from './client';

export interface RemediationPlan {
  id: string;
  name: string;
  description?: string;
  created_by: string;
  assigned_team_id?: string;
  status: 'draft' | 'active' | 'in_progress' | 'completed' | 'cancelled';
  priority: number;
  due_date?: string;
  started_at?: string;
  completed_at?: string;
  created_at: string;
  updated_at: string;
}

export interface PlanDevice {
  id: string;
  device_id: string;
  device_ip: string;
  device_hostname?: string;
  priority_order: number;
  priority_score: number;
  status: 'pending' | 'in_progress' | 'completed' | 'skipped' | 'failed';
  assigned_user_id?: string;
  vulnerability_count: number;
}

export interface RemediationPlanWithDevices extends RemediationPlan {
  devices: PlanDevice[];
  total_devices: number;
  completed_devices: number;
}

export interface CreateRemediationPlanRequest {
  name: string;
  description?: string;
  assigned_team_id?: string;
  priority?: number;
  due_date?: string;
  device_ids: string[];
}

export interface UpdateRemediationPlanRequest {
  name?: string;
  description?: string;
  assigned_team_id?: string;
  status?: string;
  priority?: number;
  due_date?: string;
}

export interface AddDevicesToPlanRequest {
  device_ids: string[];
  auto_priority?: boolean;
}

export const remediationApi = {
  // List all remediation plans
  listPlans: async (): Promise<RemediationPlan[]> => {
    const response = await apiClient.get('/api/remediation-plans');
    return response.data;
  },

  // Get single plan with devices
  getPlan: async (planId: string): Promise<RemediationPlanWithDevices> => {
    const response = await apiClient.get(`/remediation-plans/${planId}`);
    return response.data;
  },

  // Create new remediation plan
  createPlan: async (request: CreateRemediationPlanRequest): Promise<RemediationPlan> => {
    const response = await apiClient.post('/api/remediation-plans', request);
    return response.data;
  },

  // Update remediation plan
  updatePlan: async (planId: string, request: UpdateRemediationPlanRequest): Promise<RemediationPlan> => {
    const response = await apiClient.put(`/remediation-plans/${planId}`, request);
    return response.data;
  },

  // Delete remediation plan
  deletePlan: async (planId: string): Promise<void> => {
    await apiClient.delete(`/remediation-plans/${planId}`);
  },

  // Add devices to plan
  addDevicesToPlan: async (planId: string, request: AddDevicesToPlanRequest): Promise<any> => {
    const response = await apiClient.post(`/remediation-plans/${planId}/devices`, request);
    return response.data;
  },
};
