// src/api/jira.ts
// JIRA integration API client

import apiClient from './client';

export interface JiraConfiguration {
  id: string;
  name: string;
  base_url: string;
  username?: string;
  auth_type: string;
  default_project_key?: string;
  default_issue_type: string;
  is_enabled: boolean;
  auto_create_tickets: boolean;
  auto_sync: boolean;
  custom_field_mapping: any;
  created_at: string;
  updated_at: string;
}

export interface JiraTicket {
  id: string;
  jira_config_id: string;
  entity_type: string;
  entity_id: string;
  jira_issue_key: string;
  jira_issue_id?: string;
  jira_project_key?: string;
  jira_issue_type?: string;
  jira_status?: string;
  jira_priority?: string;
  jira_assignee?: string;
  jira_url?: string;
  sync_status: string;
  last_sync_at?: string;
  sync_error?: string;
  created_in: string;
  created_at: string;
  updated_at: string;
  vulnerability_title?: string;
  configuration_name?: string;
}

export interface CreateJiraConfigurationRequest {
  name: string;
  base_url: string;
  username?: string;
  api_token?: string;
  auth_type?: string;
  default_project_key?: string;
  default_issue_type?: string;
  is_enabled?: boolean;
  auto_create_tickets?: boolean;
  auto_sync?: boolean;
  webhook_secret?: string;
  custom_field_mapping?: any;
}

export interface UpdateJiraConfigurationRequest {
  name?: string;
  base_url?: string;
  username?: string;
  api_token?: string;
  default_project_key?: string;
  default_issue_type?: string;
  is_enabled?: boolean;
  auto_create_tickets?: boolean;
  auto_sync?: boolean;
  custom_field_mapping?: any;
}

export interface TestConnectionRequest {
  base_url: string;
  username?: string;
  api_token: string;
  auth_type?: string;
}

export interface TestConnectionResponse {
  success: boolean;
  message: string;
  projects?: string[];
}

export interface CreateTicketRequest {
  jira_config_id: string;
  vulnerability_id: string;
  project_key?: string;
  issue_type?: string;
  assignee?: string;
}

export interface CreateTicketResponse {
  ticket: JiraTicket;
  jira_url: string;
}

export interface SyncStatusResponse {
  ticket_id: string;
  sync_status: string;
  last_sync_at?: string;
  message: string;
}

export const jiraApi = {
  // JIRA Configurations
  listConfigurations: async (): Promise<JiraConfiguration[]> => {
    const response = await apiClient.get('/jira/configurations');
    return response.data;
  },

  getConfiguration: async (configId: string): Promise<JiraConfiguration> => {
    const response = await apiClient.get(`/jira/configurations/${configId}`);
    return response.data;
  },

  createConfiguration: async (data: CreateJiraConfigurationRequest): Promise<JiraConfiguration> => {
    const response = await apiClient.post('/jira/configurations', data);
    return response.data;
  },

  updateConfiguration: async (configId: string, data: UpdateJiraConfigurationRequest): Promise<JiraConfiguration> => {
    const response = await apiClient.put(`/jira/configurations/${configId}`, data);
    return response.data;
  },

  deleteConfiguration: async (configId: string): Promise<void> => {
    await apiClient.delete(`/jira/configurations/${configId}`);
  },

  testConnection: async (data: TestConnectionRequest): Promise<TestConnectionResponse> => {
    const response = await apiClient.post('/jira/test-connection', data);
    return response.data;
  },

  // JIRA Tickets
  listTickets: async (): Promise<JiraTicket[]> => {
    const response = await apiClient.get('/jira/tickets');
    return response.data;
  },

  createTicket: async (data: CreateTicketRequest): Promise<CreateTicketResponse> => {
    const response = await apiClient.post('/jira/tickets', data);
    return response.data;
  },

  syncTicket: async (ticketId: string): Promise<SyncStatusResponse> => {
    const response = await apiClient.post(`/jira/tickets/${ticketId}/sync`);
    return response.data;
  },
};
