import apiClient from './client';

// Types
export interface UserProfile {
  id: string;
  username: string;
  email: string;
  first_name?: string;
  last_name?: string;
  role: string;
  avatar_url?: string;
  created_at: string;
  updated_at: string;
}

export interface UpdateProfileData {
  first_name?: string;
  last_name?: string;
  email?: string;
}

export interface NotificationSettings {
  email_enabled: boolean;
  push_enabled: boolean;
  critical_alerts: boolean;
  weekly_report: boolean;
}

export interface SecuritySettings {
  two_factor_enabled: boolean;
  session_timeout_minutes: number;
  ip_whitelist_enabled: boolean;
  ip_whitelist: string[];
}

export interface TwoFactorSetup {
  secret: string;
  qr_code_url: string;
  backup_codes: string[];
}

export interface ApiKey {
  id: string;
  name: string;
  key_prefix: string;
  created_at: string;
  last_used_at?: string;
  expires_at?: string;
}

export interface NewApiKey {
  id: string;
  name: string;
  key: string; // Full key, only shown once
  created_at: string;
}

export const settingsApi = {
  // Profile
  getProfile: async (): Promise<UserProfile> => {
    const response = await apiClient.get('/api/settings/profile');
    return response.data;
  },

  updateProfile: async (data: UpdateProfileData): Promise<UserProfile> => {
    const response = await apiClient.put('/api/settings/profile', data);
    return response.data;
  },

  uploadAvatar: async (file: File): Promise<{ avatar_url: string }> => {
    const formData = new FormData();
    formData.append('avatar', file);
    const response = await apiClient.post('/api/settings/profile/avatar', formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
    });
    return response.data;
  },

  deleteAvatar: async (): Promise<void> => {
    await apiClient.delete('/api/settings/profile/avatar');
  },

  // Notifications
  getNotificationSettings: async (): Promise<NotificationSettings> => {
    const response = await apiClient.get('/api/settings/notifications');
    return response.data;
  },

  updateNotificationSettings: async (data: NotificationSettings): Promise<NotificationSettings> => {
    const response = await apiClient.put('/api/settings/notifications', data);
    return response.data;
  },

  // Security
  getSecuritySettings: async (): Promise<SecuritySettings> => {
    const response = await apiClient.get('/api/settings/security');
    return response.data;
  },

  updateSecuritySettings: async (data: Partial<SecuritySettings>): Promise<SecuritySettings> => {
    const response = await apiClient.put('/api/settings/security', data);
    return response.data;
  },

  // Two-Factor Authentication
  setup2FA: async (): Promise<TwoFactorSetup> => {
    const response = await apiClient.post('/api/settings/security/2fa/setup');
    return response.data;
  },

  verify2FA: async (code: string): Promise<{ success: boolean; backup_codes: string[] }> => {
    const response = await apiClient.post('/api/settings/security/2fa/verify', { code });
    return response.data;
  },

  disable2FA: async (code: string): Promise<void> => {
    await apiClient.post('/api/settings/security/2fa/disable', { code });
  },

  // API Keys
  listApiKeys: async (): Promise<ApiKey[]> => {
    const response = await apiClient.get('/api/settings/api-keys');
    return response.data;
  },

  createApiKey: async (name: string, expires_in_days?: number): Promise<NewApiKey> => {
    const response = await apiClient.post('/api/settings/api-keys', { name, expires_in_days });
    return response.data;
  },

  revokeApiKey: async (keyId: string): Promise<void> => {
    await apiClient.delete(`/api/settings/api-keys/${keyId}`);
  },

  // Password change
  changePassword: async (currentPassword: string, newPassword: string): Promise<void> => {
    await apiClient.post('/api/settings/security/change-password', {
      current_password: currentPassword,
      new_password: newPassword,
    });
  },
};
