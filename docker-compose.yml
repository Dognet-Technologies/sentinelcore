# Docker Compose for SentinelCore
# Production-ready multi-container setup

version: '3.8'

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  database:
    image: postgres:15-alpine
    container_name: sentinelcore-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: vulnerability_manager
      POSTGRES_USER: vlnman
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./vulnerability-manager/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - sentinelcore-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vlnman -d vulnerability_manager"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "127.0.0.1:5432:5432"  # Only expose to localhost

  # ============================================
  # Backend (Rust/Axum API)
  # ============================================
  backend:
    build:
      context: ./vulnerability-manager
      dockerfile: Dockerfile
    container_name: sentinelcore-backend
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: postgresql://vlnman:${DB_PASSWORD:-changeme}@database:5432/vulnerability_manager
      VULN_DATABASE_MAX_CONNECTIONS: 20

      # JWT
      VULN_AUTH_SECRET_KEY: ${JWT_SECRET:?JWT_SECRET must be set}

      # Server
      VULN_SERVER_HOST: 0.0.0.0
      VULN_SERVER_PORT: 8080
      VULN_SERVER_ENABLE_TLS: ${ENABLE_TLS:-false}

      # Security - CORS
      VULN_SECURITY_CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000}

      # Security - Rate Limiting
      VULN_SECURITY_RATE_LIMIT_ENABLED: true
      VULN_SECURITY_RATE_LIMIT_REQUESTS_PER_MINUTE: 60
      VULN_SECURITY_RATE_LIMIT_BURST_SIZE: 100

      # Logging
      RUST_LOG: ${RUST_LOG:-info}
      VULN_LOG_LEVEL: info
      VULN_LOG_FORMAT: json

      # Application
      APP_ENV: production
    volumes:
      - backend_uploads:/app/uploads
      - backend_logs:/var/log/sentinelcore
      - plugins_data:/var/lib/sentinelcore/plugins
    networks:
      - sentinelcore-network
    ports:
      - "8080:8080"
      - "9090:9090"  # Metrics port
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # Frontend (React/Nginx)
  # ============================================
  frontend:
    build:
      context: ./vulnerability-manager-frontend
      dockerfile: Dockerfile
    container_name: sentinelcore-frontend
    restart: unless-stopped
    depends_on:
      - backend
    environment:
      REACT_APP_API_URL: ${API_URL:-http://localhost:8080/api}
    networks:
      - sentinelcore-network
    ports:
      - "3000:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ============================================
  # Reverse Proxy (Nginx) - Optional
  # ============================================
  proxy:
    image: nginx:1.25-alpine
    container_name: sentinelcore-proxy
    restart: unless-stopped
    depends_on:
      - frontend
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
      - nginx_cache:/var/cache/nginx
    networks:
      - sentinelcore-network
    profiles:
      - with-proxy
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local
  backend_uploads:
    driver: local
  backend_logs:
    driver: local
  plugins_data:
    driver: local
  nginx_cache:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  sentinelcore-network:
    driver: bridge
